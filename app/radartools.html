<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Radar Job Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../assets/css/app-styles.css" />
    <script type="module" src="../apps/assets/js/login.js" defer></script>
    <script src="../apps/assets/js/search.js" defer></script>

    <style>
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .product {
            border: 1px solid #ccc;
            padding: 1rem;
            text-align: center;
            border-radius: 12px;
            background-color: var(--secondaryBackgroundColor);
        }

        .product img {
            max-width: 100%;
            max-height: 180px;
            object-fit: contain;
            border-radius: 10px;
        }

        /* --- Top nav links bar --- */
        .topnav {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, .92);
            backdrop-filter: blur(8px);
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 18px;
        }

        .topnav-row {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .nav-title {
            font-weight: 700;
            white-space: nowrap;
        }

        .linkbar {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
        }

        .linkbar::-webkit-scrollbar {
            display: none;
        }

        .nav-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            text-decoration: none;
            font-size: .92rem;
            white-space: nowrap;
            max-width: 260px;
            overflow: hidden;
            text-overflow: ellipsis;
            color: inherit;
            flex: 0 0 auto;
            border-radius: 999px;
        }

        /* overflow dropdown */
        .more-wrap {
            position: relative;
            flex: 0 0 auto;
        }

        .more-menu {
            position: absolute;
            background: var(--backgroundColor, #fff);
            right: 0;
            top: calc(100% + 8px);
            min-width: 240px;
            max-width: 360px;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .12);
            padding: 6px;
            display: none;
        }

        .more-menu.open {
            display: block;
        }

        .more-item {
            display: block;
            padding: 10px 10px;
            border-radius: 10px;
            text-decoration: none;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .more-item:hover {
            background: rgba(0, 0, 0, .06);
        }

        .hidden {
            display: none !important;
        }

        /* Tools toolbar */

        #toolSearch,
        #categoryFilter,
        #subCategoryFilter {
            flex: 1;
            min-width: 220px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        #exportTools {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
            white-space: nowrap;
        }

        .tool-title {
            margin: 10px 0 6px;
            font-size: 1rem;
            line-height: 1.2;
            overflow: auto;
        }

        .tool-title a {
            text-decoration: none;
        }

        .tool-title a:hover {
            text-decoration: underline;
        }

        /* Image modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 98%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            display: block;
            margin: auto;
            max-width: 90%;
            max-height: 80vh;
            border-radius: 12px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #ccc;
        }

        .modal:not(.hidden) {
            display: block;
        }
    </style>
</head>

<body>

    <header>
        <h1>Radar Job Reference</h1>

        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <button type="submit">Sign in</button>
            </form>
            <button id="logout" style="display:none;">Logout</button>
        </section>
    </header>

    <!-- Links Section (nav across page with overflow dropdown) -->
    <div class="topnav">
        <div class="topnav-row">
            <div class="nav-title">ðŸ”— Links</div>
            <div id="linkBar" class="linkbar"></div>

            <div id="moreWrap" class="more-wrap hidden">
                <button id="moreBtn" class="more-btn" type="button" aria-haspopup="menu" aria-expanded="false">
                    More â–¾
                </button>
                <div id="moreMenu" class="more-menu" role="menu"></div>
            </div>
        </div>
    </div>

    <main>
        <!-- Instruction Block -->
        <section>
            <h2>ðŸ“– Radar Standard Environment</h2>
            <ul>
                <li>Backroom must be clear and organized</li>
                <li>No core drilling or multiple sleeves (unless scoped)</li>
                <li>Max cable run = 295 feet</li>
                <li>Two sensors in stockroom for GAP, one for Athleta/BR</li>
                <li>Use laser to mark sensors, record depth photos</li>
                <li>See milestone plan below for install phases</li>
            </ul>
        </section>

        <!-- Milestones -->
        <section>
            <h2>ðŸ“… Install Milestones</h2>
            <ul>
                <li><strong>Night 1:</strong> Backboard, rack, 40% sensors, photo capture</li>
                <li><strong>Night 2:</strong> 80% completion, move requests end</li>
                <li><strong>Night 3:</strong> 100% complete, walk-through, release code</li>
            </ul>
        </section>

        <!-- Tools List from Firebase -->
        <section>
            <h2>ðŸ§° Tools List</h2>

            <div class="toolbar">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>

                <select id="subCategoryFilter" disabled>
                    <option value="">All Sub-Categories</option>
                </select>

                <input id="toolSearch" type="search"
                    placeholder='Search toolsâ€¦ (supports: quotes, &, |, - , name:, category:, component: )' />
                <button id="exportTools">Export Tools to CSV</button>
            </div>

            <div id="toolGrid" class="product-grid"></div>
        </section>

    </main>

    <!-- Image Modal -->
    <div id="imgModal" class="modal hidden">
        <span id="imgModalClose" class="modal-close">&times;</span>
        <img class="modal-content" id="imgModalImg">
    </div>

    <script type="module">
        import { database, ref, get, onValue } from '../assets/js/firebase-init.js';

        // -------------------------
        // Tools
        // -------------------------
        const toolGrid = document.getElementById("toolGrid");
        const toolSearch = document.getElementById("toolSearch");
        const exportBtn = document.getElementById("exportTools");
        const categoryFilter = document.getElementById("categoryFilter");
        const subCategoryFilter = document.getElementById("subCategoryFilter");

        const allTools = [];
        let affiliateTag = "";

        // Use your SearchEngine if present
        const toolSearchEngine = (window.SearchEngine && window.SearchEngine.create)
            ? window.SearchEngine.create({
                fields: {
                    name: { type: 'string', resolver: r => r.name },
                    category: { type: 'string', resolver: r => r.category },
                    component: { type: 'string', resolver: r => r.component }
                },
                defaultFields: ['name', 'category', 'component'],
                caseSensitive: false
            })
            : null;

        function escapeHtml(s) {
            return String(s ?? "").replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        function normalizeTools(data) {
            const items = [];
            for (const cat in data) {
                for (const comp in data[cat]) {
                    for (const key in data[cat][comp]) {
                        const e = data[cat][comp][key] || {};
                        items.push({
                            name: e.part || key,
                            category: cat || "",
                            component: comp || "",
                            affiliateUrl: e.affiliateUrl || "",
                            imageUrl: e.imageUrl || `assets/img/database/${encodeURIComponent(e.part || key)}.png`
                        });
                    }
                }
            }
            return items;
        }

        function ensureTag(url) {
            try {
                if (!url) return "";
                const u = new URL(url, window.location.origin);
                if (affiliateTag) u.searchParams.set("tag", affiliateTag);
                return u.toString();
            } catch {
                return url || "";
            }
        }

        function rebuildCategoryDropdown() {
            const cats = Array.from(new Set(allTools.map(t => t.category).filter(Boolean)))
                .sort((a, b) => a.localeCompare(b));

            const current = categoryFilter.value || "";
            categoryFilter.innerHTML =
                `<option value="">All Categories</option>` +
                cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

            if (cats.includes(current)) categoryFilter.value = current;
        }

        function rebuildSubCategoryDropdown() {
            const selectedCat = categoryFilter.value || "";
            const comps = Array.from(new Set(
                allTools
                    .filter(t => !selectedCat || t.category === selectedCat)
                    .map(t => t.component)
                    .filter(Boolean)
            )).sort((a, b) => a.localeCompare(b));

            const current = subCategoryFilter.value || "";

            subCategoryFilter.innerHTML =
                `<option value="">All Sub-Categories</option>` +
                comps.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

            subCategoryFilter.disabled = comps.length === 0;

            if (comps.includes(current)) subCategoryFilter.value = current;
            else subCategoryFilter.value = "";
        }

        function applyFilters(records) {
            const cat = categoryFilter.value || "";
            const comp = subCategoryFilter.value || "";
            const q = (toolSearch.value || "").trim();

            let out = records;

            // category/subcategory filters first
            if (cat) out = out.filter(t => t.category === cat);
            if (comp) out = out.filter(t => t.component === comp);

            // then your advanced search syntax
            if (q) {
                if (toolSearchEngine) out = toolSearchEngine.filter(out, q);
                else out = out.filter(t => t.name.toLowerCase().includes(q.toLowerCase()));
            }

            return out;
        }

        function renderTools() {
            toolGrid.innerHTML = "";

            const shown = applyFilters(allTools);

            for (const t of shown) {
                const div = document.createElement("div");
                div.className = "product";

                const link = ensureTag(t.affiliateUrl);

                // name clickable if link exists
                const titleHtml = link
                    ? `<h3 class="tool-title"><a href="${link}" target="_blank" rel="noopener">${escapeHtml(t.name)}</a></h3>`
                    : `<h3 class="tool-title">${escapeHtml(t.name)}</h3>`;

                const metaHtml = `<div class="meta">${escapeHtml(t.category)}${t.component ? " â€¢ " + escapeHtml(t.component) : ""}</div>`;

                div.innerHTML = `
          <img src="${t.imageUrl}" alt="${escapeHtml(t.name)}" />
          ${titleHtml}
          ${metaHtml}
        `;

                toolGrid.appendChild(div);
            }
        }

        function refreshToolUI() {
            rebuildCategoryDropdown();
            rebuildSubCategoryDropdown();
            renderTools();
        }

        categoryFilter.addEventListener("change", () => {
            rebuildSubCategoryDropdown(); // sub-cats depend on category
            renderTools();
        });

        subCategoryFilter.addEventListener("change", renderTools);
        toolSearch.addEventListener("input", renderTools);

        exportBtn.addEventListener("click", () => {
            const shown = applyFilters(allTools); // export what you're looking at
            const csvRows = [["Name", "Category", "Component", "Link"]];
            shown.forEach(t => {
                csvRows.push([
                    t.name,
                    t.category,
                    t.component,
                    ensureTag(t.affiliateUrl)
                ]);
            });

            const csv = csvRows
                .map(r => r.map(c => `"${String(c ?? "").replace(/"/g, '""')}"`).join(","))
                .join("\n");

            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "radar-tools.csv";
            a.click();
            URL.revokeObjectURL(url);
        });

        // Load affiliate tag + tools
        get(ref(database, "public/settings/affiliateTag")).then(snap => affiliateTag = snap.val() || "");

        get(ref(database, "public/inventory")).then(snap => {
            allTools.length = 0;
            allTools.push(...normalizeTools(snap.val() || {}));
            refreshToolUI();
        });

        // -------------------------
        // Links (nav + overflow dropdown)
        // -------------------------
        const linkBar = document.getElementById("linkBar");
        const moreWrap = document.getElementById("moreWrap");
        const moreBtn = document.getElementById("moreBtn");
        const moreMenu = document.getElementById("moreMenu");

        function closeMore() {
            moreMenu.classList.remove("open");
            moreBtn.setAttribute("aria-expanded", "false");
        }

        moreBtn?.addEventListener("click", () => {
            const isOpen = moreMenu.classList.toggle("open");
            moreBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        });

        document.addEventListener("click", (e) => {
            if (!moreWrap.contains(e.target)) closeMore();
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeMore();
        });

        function makeChip(link, cls = "nav-chip") {
            const a = document.createElement("a");
            a.href = link.url;
            a.target = "_blank";
            a.rel = "noopener";
            a.className = cls;
            a.title = link.title || link.url;
            a.textContent = link.title || link.url;
            return a;
        }

        function layoutLinks(links) {
            linkBar.innerHTML = "";
            moreMenu.innerHTML = "";
            closeMore();

            links.map(l => makeChip(l, "nav-chip")).forEach(ch => linkBar.appendChild(ch));

            requestAnimationFrame(() => {
                const overflow = [];
                while (linkBar.scrollWidth > linkBar.clientWidth && linkBar.children.length > 0) {
                    const last = linkBar.lastElementChild;
                    overflow.unshift({ title: last.textContent, url: last.href });
                    last.remove();
                }

                if (overflow.length) {
                    moreWrap.classList.remove("hidden");
                    overflow.forEach(l => moreMenu.appendChild(makeChip(l, "more-item")));
                } else {
                    moreWrap.classList.add("hidden");
                }
            });
        }

        let lastLinks = [];
        function relayoutSoon() {
            if (!lastLinks.length) return;
            layoutLinks(lastLinks);
            setTimeout(() => layoutLinks(lastLinks), 50);
        }
        window.addEventListener("resize", relayoutSoon);

        onValue(ref(database, "public/links"), snap => {
            const data = snap.val() || {};
            lastLinks = Object.values(data)
                .filter(l => l && l.url)
                .sort((a, b) => String(a.title || a.url).localeCompare(String(b.title || b.url)));
            relayoutSoon();
        });

        // Modal logic
        const modal = document.getElementById("imgModal");
        const modalImg = document.getElementById("imgModalImg");
        const modalClose = document.getElementById("imgModalClose");

        document.addEventListener("click", (e) => {
            if (e.target.tagName === "IMG" && e.target.closest(".product")) {
                modalImg.src = e.target.src;
                modal.classList.remove("hidden");
            }
        });

        modalClose.addEventListener("click", () => {
            modal.classList.add("hidden");
            modalImg.src = "";
        });

        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.add("hidden");
                modalImg.src = "";
            }
        });

    </script>
</body>

</html>