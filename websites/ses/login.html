<!DOCTYPE html>
<html lang="en">

<head>
    <title>Smart Electronics Solutions</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="icon" href="img/favicon.ico">
    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="img/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="img/png" sizes="16x16" href="img/favicon-16x16.png">
    <script src="js/index.js" defer></script>
    <style>
        form {
            display: flex;
            flex-direction: column;
        }

        #main-window li {
            margin: 5px;
            list-style-type: decimal;
        }

        #main-window {
            display: flex;
            width: 800px;
        }

        textarea {
            margin: 0 auto;
            width: 800px;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <div class="logo-box">
                <a href="index.html"><img src="img/logo.gif" class="logo"></a>
            </div>
            <div class="name">Smart Electronics Solutions LLC</div>
            <div class="hamburger-box">
                <div class="hamburger">
                    <div class="line"></div>
                    <div class="line"></div>
                    <div class="line"></div>
                </div>
            </div>
            <div class="nav-buttons">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="tel:+18134211337"><img src="img/call-icon.png" alt="Call"></a></li>
                </ul>
            </div>
        </nav>
    </header>
    <div class="ico_container">
        <div class="ico">
            <a href="http://facebook.com"><img class="ico_img" src="img/black-facebook.png" alt="Facebook"></a>
            <a href="http://instagram.com"><img class="ico_img" src="img/black-instagram.png" alt="Instagram"></a>
            <a href="http://linkedin.com"><img class="ico_img" src="img/black-linkedin.png" alt="LinkedIn"></a>
            <a href="http://twitter.com"><img class="ico_img" src="img/black-twitter.png" alt="Twitter"></a>
            <a href="http://youtube.com"><img class="ico_img" src="img/black-youtube.png" alt="YouTube"></a>
        </div>
    </div>
    <main>
        <div id="login-window">
            <div class="toggle-buttons">
                <button id="show-login-btn">Login</button>
                <button id="show-signup-btn">Sign Up</button>
            </div>

            <div id="login-form-container">
                <h2>Login</h2>
                <br>
                <form id="loginForm">
                    <label for="loginUsername">Username:</label>
                    <input type="text" id="loginUsername" required><br>
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" required><br>
                    <input type="submit" value="Login" id="login-submit">
                </form>
            </div>
            <div id="signup-form-container" style="display: none;">
                <h2>Register</h2>
                <br>
                <form class="reg" id="registration-form">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>

                    <label for="first-name">First Name:</label>
                    <input type="text" id="first-name" name="first-name">

                    <label for="last-name">Last Name:</label>
                    <input type="text" id="last-name" name="last-name">

                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" required>

                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>

                    <label for="phone">Phone Number:</label>
                    <input type="tel" id="phone" name="phone">

                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>

                    <label for="confirm-password">Confirm Password:</label>
                    <input type="password" id="confirm-password" name="confirm-password" required>
                    <br>
                    <button type="submit" id="register-submit">Register</button>
                </form>
            </div>
        </div>
    </main>
    <footer>
        <h3><a href="https://luissolutions.github.io">About Us</a> &#183; <a href="contact.html">Contact Us</a> &#183; <a href="#">Insured</a></h3>
        <img id="padlock" src="img/lock.png" alt="Padlock">
    </footer>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const appSettings = {
            databaseURL: "https://notes-fba33-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(appSettings);
        const database = getDatabase(app);

        document.getElementById('show-login-btn').addEventListener('click', () => {
            document.getElementById('login-form-container').style.display = 'block';
            document.getElementById('signup-form-container').style.display = 'none';
        });

        document.getElementById('show-signup-btn').addEventListener('click', () => {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('signup-form-container').style.display = 'block';
        });

        function checkTokenValidity() {
            var tokenData = JSON.parse(localStorage.getItem("sToken"));
            var currentTime = new Date().getTime();
        }

        function handleLoginFormSubmit() {
            document.getElementById("login-submit").addEventListener("click", function (event) {
                event.preventDefault(); // Prevent form submission

                const username = document.getElementById("loginUsername").value;
                const password = document.getElementById("loginPassword").value;

                const usersRef = ref(database, "users");
                const usersListener = onValue(usersRef, snapshot => {
                    const users = snapshot.val();

                    if (users) {
                        const matchingUser = Object.values(users).find(user => user.username === username && user.password === password);

                        if (matchingUser) {
                            const sToken = "7777777";
                            const expirationMinutes = 480;
                            const expirationTime = new Date().getTime() + (expirationMinutes * 60 * 1000);
                            const tokenData = { sToken, expiresAt: expirationTime };
                            localStorage.setItem("sToken", JSON.stringify(tokenData));

                            const delay = expirationTime - new Date().getTime();
                            setTimeout(() => localStorage.removeItem("sToken"), delay);
                            window.location.href = "notes.html";
                            alert("Login Successful");
                        } else {
                            alert("Invalid username or password. Please try again.");
                        }
                    } else {
                        alert("No user data found.");
                    }

                    off(usersRef, usersListener);
                });

                return false;
            });
        }

        document.getElementById("register-submit").addEventListener("click", function (event) {
            event.preventDefault(); // Prevent form submission

            // Check if sToken is present in localStorage
            const tokenData = JSON.parse(localStorage.getItem("sToken"));

            if (!tokenData || tokenData.sToken !== "7777777") {
                alert("You must log in before registering.");
                return;
            }

            const username = document.getElementById("username").value;
            const firstName = document.getElementById("first-name").value;
            const lastName = document.getElementById("last-name").value;
            const address = document.getElementById("address").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirm-password").value;
            const phone = document.getElementById("phone").value;

            if (!username || !email || !password) {
                alert("Please fill out all required fields (Username, Email, Password).");
                return;
            }

            if (password !== confirmPassword) {
                alert("Passwords do not match. Please try again.");
                return;
            }

            var userInfo = {
                email: email,
                username: username,
                password: password,
                phone: phone,
                firstName: firstName,
                lastName: lastName,
                address: address
            };

            var userRef = ref(database, "users/" + email.replace(/\W/g, ""));
            set(userRef, userInfo);

            alert("Registration successful!");

            document.getElementById("registration-form").reset();
        });

        document.addEventListener("DOMContentLoaded", () => {
            handleLoginFormSubmit();
            checkTokenValidity();
        });
    </script>