<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Housing Market Toolkit — Affordability, Buy vs Rent, Rental Math</title>
  <link rel="stylesheet" href="assets/css/styles.css"/>
  <script src="assets/js/html.js" defer></script>
  <script src="assets/js/sidebar.js" defer></script>
  <script type="module" src="assets/js/auth-handling.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    /* Minimal helpers that play nice with your globals */
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .grid.three{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--textColor);color:var(--primaryColor);border-radius:8px;padding:16px;box-shadow:rgba(0,0,0,.06) 0 4px 16px, rgba(0,0,0,.04) 0 0 0 1px}
    .calc-form{background:var(--formBackground);border:1px solid #ccc;border-radius:8px;padding:12px;max-width:560px;margin:1rem auto}
    .calc-form label{display:block;margin:.45rem 0 .25rem;font-weight:700}
    .calc-form input,.calc-form select{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;background:var(--entryBackground);box-sizing:border-box}
    .calc-form .inline{display:flex;gap:12px;flex-wrap:wrap}
    .calc-form .inline>div{flex:1 1 160px}
    .calc-form .btn-row{display:flex;gap:8px;margin-top:.6rem;flex-wrap:wrap}
    .calc-form button{background:var(--secondaryColor);color:var(--textColor);border:none;border-radius:6px;padding:10px 14px;cursor:pointer}
    .calc-form button:hover{background:#d25400}
    .calc-result{margin-top:.75rem;font-weight:700;background:var(--entryBackground);padding:10px;border-radius:6px;border:1px solid #ccc}
    .muted{opacity:.75}
    .warn{color:#b71c1c}
    .ok{color:#10893e}
    canvas{max-width:100%;height:auto}

    /* Tooltips (keeps your style) */
    .tooltip{position:relative;cursor:help;border-bottom:1px dashed currentColor}
    .tooltip::after{content:attr(data-tooltip);position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:var(--primaryColor);color:var(--textColor);padding:.4em .6em;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;z-index:100;box-shadow:rgba(0,0,0,.15) 0 6px 16px}
    .tooltip:hover::after,.tooltip:focus-visible::after{opacity:1}
  </style>
</head>
<body>
  <header></header>
  <nav></nav>

  <div class="header" style="text-align:center">
    <h1>Housing Market Toolkit</h1>
    <p class="muted">Affordability · Buy vs Rent · Mortgage Math · Down-Payment Plan · Rental Investing</p>
  </div>

  <nav>
    <ul style="list-style:none;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:0;padding:0">
      <li><a href="#afford">Affordability</a></li>
      <li><a href="#payment">Mortgage Payment</a></li>
      <li><a href="#buyrent">Buy vs Rent</a></li>
      <li><a href="#downpay">Down-Payment Planner</a></li>
      <li><a href="#rental">Rental Analyzer</a></li>
      <li><a href="#charts">Charts</a></li>
      <li><a href="#notes">Notes</a></li>
    </ul>
  </nav>

  <main>
    <!-- Affordability -->
    <section id="afford" class="card">
      <h2>Affordability Estimator</h2>
      <p class="muted">Targets a conservative debt-to-income (DTI) to estimate a safe home price.</p>
      <form id="affForm" class="calc-form" novalidate>
        <div class="inline">
          <div>
            <label for="af_income">Gross Monthly Income ($)</label>
            <input type="number" id="af_income" value="4500" min="0" step="0.01" required>
          </div>
          <div>
            <label for="af_debt">Monthly Debt Payments ($) <span class="tooltip" data-tooltip="Car, cards, loans… exclude current rent if it will be replaced by the mortgage.">?</span></label>
            <input type="number" id="af_debt" value="300" min="0" step="0.01">
          </div>
          <div>
            <label for="af_frontDTI">Housing DTI % <span class="tooltip" data-tooltip="Front-end DTI: (PITI + HOA) ÷ Income. Many lenders like ≤ 28%.">?</span></label>
            <input type="number" id="af_frontDTI" value="28" step="0.1">
          </div>
          <div>
            <label for="af_backDTI">Total DTI % <span class="tooltip" data-tooltip="Back-end DTI: (PITI + debts) ÷ Income. Often targeted ≤ 36–43%.">?</span></label>
            <input type="number" id="af_backDTI" value="36" step="0.1">
          </div>
        </div>

        <div class="inline">
          <div>
            <label for="af_rate">Interest Rate % (APR)</label>
            <input type="number" id="af_rate" value="6.75" step="0.01">
          </div>
          <div>
            <label for="af_term">Term (years)</label>
            <select id="af_term">
              <option value="30" selected>30</option>
              <option value="20">20</option>
              <option value="15">15</option>
            </select>
          </div>
          <div>
            <label for="af_taxRate">Property Tax (% of price)</label>
            <input type="number" id="af_taxRate" value="1.3" step="0.05">
          </div>
          <div>
            <label for="af_ins">Homeowners Insurance ($/yr)</label>
            <input type="number" id="af_ins" value="1400" step="1">
          </div>
        </div>

        <div class="inline">
          <div>
            <label for="af_hoa">HOA ($/mo)</label>
            <input type="number" id="af_hoa" value="0" step="1">
          </div>
          <div>
            <label for="af_down">Down Payment (%)</label>
            <input type="number" id="af_down" value="10" step="0.1">
          </div>
          <div>
            <label for="af_pmi">PMI % (annual) <span class="tooltip" data-tooltip="If down < 20%, estimate annual PMI as a percent of loan balance (e.g., 0.5–1%).">?</span></label>
            <input type="number" id="af_pmi" value="0.7" step="0.05">
          </div>
        </div>

        <div class="btn-row">
          <button type="submit">Estimate</button>
          <button type="button" id="af_reset">Reset</button>
        </div>
      </form>
      <div id="affResult" class="calc-result" aria-live="polite"></div>
    </section>

    <!-- Mortgage Payment -->
    <section id="payment" class="card">
      <h2>Mortgage Payment (PITI)</h2>
      <form id="payForm" class="calc-form" novalidate>
        <div class="inline">
          <div><label for="mp_price">Home Price ($)</label><input type="number" id="mp_price" value="350000" step="1"></div>
          <div><label for="mp_down">Down %</label><input type="number" id="mp_down" value="10" step="0.1"></div>
          <div><label for="mp_rate">Rate %</label><input type="number" id="mp_rate" value="6.75" step="0.01"></div>
          <div><label for="mp_term">Term (yrs)</label>
            <select id="mp_term"><option>30</option><option>20</option><option>15</option></select>
          </div>
        </div>
        <div class="inline">
          <div><label for="mp_taxRate">Property Tax % of price</label><input type="number" id="mp_taxRate" value="1.3" step="0.05"></div>
          <div><label for="mp_ins">Insurance ($/yr)</label><input type="number" id="mp_ins" value="1400" step="1"></div>
          <div><label for="mp_hoa">HOA ($/mo)</label><input type="number" id="mp_hoa" value="0" step="1"></div>
          <div><label for="mp_pmi">PMI % (annual on loan)</label><input type="number" id="mp_pmi" value="0.7" step="0.05"></div>
        </div>
        <div class="btn-row">
          <button type="submit">Compute PITI</button>
          <button type="button" id="mp_reset">Reset</button>
        </div>
      </form>
      <div id="payResult" class="calc-result" aria-live="polite"></div>
    </section>

    <!-- Buy vs Rent -->
    <section id="buyrent" class="card">
      <h2>Buy vs Rent (Breakeven-style)</h2>
      <form id="brForm" class="calc-form" novalidate>
        <div class="inline">
          <div><label for="br_rent">Current Rent ($/mo)</label><input type="number" id="br_rent" value="1800" step="1"></div>
          <div><label for="br_rentInfl">Rent Infl. %/yr</label><input type="number" id="br_rentInfl" value="3.0" step="0.1"></div>
          <div><label for="br_years">Horizon (yrs)</label><input type="number" id="br_years" value="5" step="1"></div>
        </div>
        <div class="inline">
          <div><label for="br_price">Home Price ($)</label><input type="number" id="br_price" value="350000" step="1"></div>
          <div><label for="br_down">Down %</label><input type="number" id="br_down" value="10" step="0.1"></div>
          <div><label for="br_rate">Rate %</label><input type="number" id="br_rate" value="6.75" step="0.01"></div>
          <div><label for="br_tax">Tax % of price</label><input type="number" id="br_tax" value="1.3" step="0.05"></div>
        </div>
        <div class="inline">
          <div><label for="br_ins">Insurance ($/yr)</label><input type="number" id="br_ins" value="1400" step="1"></div>
          <div><label for="br_hoa">HOA ($/mo)</label><input type="number" id="br_hoa" value="0" step="1"></div>
          <div><label for="br_maint">% for Maint./CapEx <span class="tooltip" data-tooltip="Rule of thumb: 1–2% of home price per year, varies by age/condition.">?</span></label><input type="number" id="br_maint" value="1.0" step="0.1"></div>
          <div><label for="br_app">Home Appreciation %/yr</label><input type="number" id="br_app" value="3.0" step="0.1"></div>
        </div>
        <div class="inline">
          <div><label for="br_selling">Selling Costs % <span class="tooltip" data-tooltip="Agent fees + transfer/closing costs when selling.">?</span></label><input type="number" id="br_selling" value="7" step="0.1"></div>
          <div><label for="br_pmi">PMI % (annual)</label><input type="number" id="br_pmi" value="0.7" step="0.05"></div>
        </div>
        <div class="btn-row">
          <button type="submit">Compare</button>
          <button type="button" id="br_reset">Reset</button>
        </div>
      </form>
      <div id="brResult" class="calc-result" aria-live="polite"></div>
    </section>

    <!-- Down Payment Planner -->
    <section id="downpay" class="card">
      <h2>Down-Payment Planner</h2>
      <form id="dpForm" class="calc-form" novalidate>
        <div class="inline">
          <div><label for="dp_initial">Current Savings ($)</label><input type="number" id="dp_initial" value="10000" step="0.01"></div>
          <div><label for="dp_monthly">Monthly Save ($)</label><input type="number" id="dp_monthly" value="1500" step="0.01"></div>
          <div><label for="dp_months">Months</label><select id="dp_months"><option>12</option><option selected>18</option><option>24</option></select></div>
          <div><label for="dp_apy">APY %</label><input type="number" id="dp_apy" value="4.2" step="0.1"></div>
        </div>
        <div class="btn-row">
          <button type="submit">Project</button>
          <button type="button" id="dp_reset">Reset</button>
        </div>
      </form>
      <div id="dpResult" class="calc-result" aria-live="polite"></div>
      <div class="card" style="margin-top:10px">
        <canvas id="dpChart" height="120" aria-label="Down payment growth chart" role="img"></canvas>
      </div>
    </section>

    <!-- Rental Analyzer -->
    <section id="rental" class="card">
      <h2>Rental Property Analyzer (Cap Rate & Cash-on-Cash)</h2>
      <form id="raForm" class="calc-form" novalidate>
        <div class="inline">
          <div><label for="ra_price">Purchase Price ($)</label><input type="number" id="ra_price" value="300000" step="1"></div>
          <div><label for="ra_down">Down %</label><input type="number" id="ra_down" value="25" step="0.1"></div>
          <div><label for="ra_rate">Rate %</label><input type="number" id="ra_rate" value="7.0" step="0.01"></div>
          <div><label for="ra_term">Term (yrs)</label><select id="ra_term"><option>30</option><option>20</option><option>15</option></select></div>
        </div>
        <div class="inline">
          <div><label for="ra_rent">Monthly Rent ($)</label><input type="number" id="ra_rent" value="2600" step="1"></div>
          <div><label for="ra_vac">Vacancy %</label><input type="number" id="ra_vac" value="6" step="0.1"></div>
          <div><label for="ra_tax">% Tax of price</label><input type="number" id="ra_tax" value="1.3" step="0.05"></div>
          <div><label for="ra_ins">Insurance ($/yr)</label><input type="number" id="ra_ins" value="1400" step="1"></div>
        </div>
        <div class="inline">
          <div><label for="ra_maint">% Maint/CapEx of price</label><input type="number" id="ra_maint" value="1.5" step="0.1"></div>
          <div><label for="ra_mgmt">% Management of rent</label><input type="number" id="ra_mgmt" value="8" step="0.1"></div>
          <div><label for="ra_hoa">HOA ($/mo)</label><input type="number" id="ra_hoa" value="0" step="1"></div>
          <div><label for="ra_closing">Closing + Rehab ($)</label><input type="number" id="ra_closing" value="8000" step="1"></div>
        </div>
        <div class="btn-row">
          <button type="submit">Analyze</button>
          <button type="button" id="ra_reset">Reset</button>
        </div>
      </form>
      <div id="raResult" class="calc-result" aria-live="polite"></div>
    </section>

    <!-- Charts section -->
    <section id="charts" class="card">
      <h2>Amortization Snapshot (first 5 years)</h2>
      <p class="muted">Shows principal vs interest over time for the Mortgage Payment inputs above.</p>
      <canvas id="amChart" height="120" aria-label="Amortization chart" role="img"></canvas>
    </section>

    <section id="notes" class="card">
      <h2>Notes & Tips</h2>
      <ul>
        <li><span class="tooltip" data-tooltip="Principal, Interest, Taxes, Insurance, and HOA if applicable.">PITI</span> should comfortably fit within your target DTI.</li>
        <li>For near-term purchases, keep down-payment funds **safe and liquid** (HYSAs, short T-Bills, no-penalty CDs).</li>
        <li>For rentals, underwrite with **conservative** rents and **generous** expenses; stress-test at +1% rate and –10% rent.</li>
      </ul>
    </section>
  </main>

  <aside></aside>
  <footer class="muted" style="text-align:center;margin:2rem 0 1rem">
    <p>&copy; <span id="year"></span> Housing Toolkit</p>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------- Helpers ----------
    const fmt2 = n => Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    const monthsBetween = (years)=> Math.max(1,Math.round(Number(years||0)*12));

    function pmt(rate, nper, pv){ // monthly payment (interest only part), returns positive
      const r = rate/1200; const n = nper*12;
      if(r===0) return pv/n;
      return pv * r / (1 - Math.pow(1+r, -n));
    }

    function loanPieces(price, downPct, ratePct, termY){
      const down = price*downPct/100;
      const loan = price - down;
      const pi = pmt(ratePct, termY, loan);
      return {down, loan, pi};
    }

    function monthlyPITI(price, downPct, ratePct, termY, taxPct, insYr, hoa, pmiPct){
      const {loan, pi} = loanPieces(price, downPct, ratePct, termY);
      const tax = (price * (taxPct/100)) / 12;
      const ins = (insYr||0)/12;
      const pmi = (downPct<20 ? (loan*(pmiPct/100))/12 : 0);
      return {pi, tax, ins, hoa, pmi, piti: pi+tax+ins+(hoa||0)+pmi};
    }

    function amortizationSeries(loan, ratePct, termY, months=60){
      const r = ratePct/1200; const n = termY*12;
      const pay = r===0 ? loan/n : loan*r/(1 - Math.pow(1+r,-n));
      let bal = loan; const rows=[];
      for(let m=1;m<=Math.min(months,n);m++){
        const interest = r*bal;
        const principal = pay - interest;
        bal = Math.max(0, bal - principal);
        rows.push({m, principal, interest, bal});
      }
      return {pay, rows};
    }

    function bindPersist(formId, ids){
      const key = (id)=> `${formId}:${id}`;
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const saved = localStorage.getItem(key(id));
        if(saved!==null){
          if(el.type==='checkbox') el.checked = saved==='1';
          else el.value = saved;
        }
        el.addEventListener('change', ()=> {
          localStorage.setItem(key(id), el.type==='checkbox' ? (el.checked?'1':'0') : el.value);
        });
      });
      const resetBtn = document.getElementById(formId.replace('Form','_reset'));
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          ids.forEach(id=>localStorage.removeItem(key(id)));
          document.getElementById(formId).reset();
          document.getElementById(formId).dispatchEvent(new Event('submit'));
        });
      }
    }

    // ---------- Affordability ----------
    const affForm = document.getElementById('affForm');
    bindPersist('affForm',['af_income','af_debt','af_frontDTI','af_backDTI','af_rate','af_term','af_taxRate','af_ins','af_hoa','af_down','af_pmi']);
    affForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const inc = Math.max(0, Number(af_income.value||0));
      const debts = Math.max(0, Number(af_debt.value||0));
      const fDTI = Math.max(1, Number(af_frontDTI.value||0))/100;
      const bDTI = Math.max(1, Number(af_backDTI.value||0))/100;
      const rate = Math.max(0, Number(af_rate.value||0));
      const term = Number(af_term.value||30);
      const taxPct = Math.max(0, Number(af_taxRate.value||0));
      const insYr = Math.max(0, Number(af_ins.value||0));
      const hoa = Math.max(0, Number(af_hoa.value||0));
      const downPct = Math.max(0, Number(af_down.value||0));
      const pmiPct = Math.max(0, Number(af_pmi.value||0));

      // Max housing from front-end DTI
      const maxHousing = inc * fDTI; // per month
      // Max housing from back-end DTI
      const maxTotal = inc * bDTI;
      const maxHousingFromBack = Math.max(0, maxTotal - debts);
      const targetHousing = Math.min(maxHousing, maxHousingFromBack);

      // Solve for price via binary search on PITI
      let lo=50000, hi=2000000, mid, price=0;
      for(let i=0;i<40;i++){
        mid = (lo+hi)/2;
        const {piti} = monthlyPITI(mid, downPct, rate, term, taxPct, insYr, hoa, pmiPct);
        if(piti>targetHousing) hi = mid; else lo = mid;
      }
      price = (lo+hi)/2;
      const {down, loan, pi} = loanPieces(price, downPct, rate, term);
      const parts = monthlyPITI(price, downPct, rate, term, taxPct, insYr, hoa, pmiPct);

      affResult.innerHTML = `
        Target Housing (DTI-based): <strong>$${fmt2(targetHousing)}</strong>/mo<br>
        Est. Max Price: <strong>$${fmt2(price)}</strong> (Down: $${fmt2(down)})<br>
        PI: $${fmt2(parts.pi)} · Tax: $${fmt2(parts.tax)} · Ins: $${fmt2(parts.ins)} · HOA: $${fmt2(hoa)} · PMI: $${fmt2(parts.pmi)}<br>
        Est. PITI: <strong>$${fmt2(parts.piti)}</strong>/mo
      `;
    });

    // ---------- Mortgage Payment ----------
    let amChart;
    const payForm = document.getElementById('payForm');
    bindPersist('payForm',['mp_price','mp_down','mp_rate','mp_term','mp_taxRate','mp_ins','mp_hoa','mp_pmi']);
    payForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const price = Math.max(5000, Number(mp_price.value||0));
      const downPct = Math.max(0, Number(mp_down.value||0));
      const rate = Math.max(0, Number(mp_rate.value||0));
      const term = Number(mp_term.value||30);
      const taxPct = Math.max(0, Number(mp_taxRate.value||0));
      const insYr = Math.max(0, Number(mp_ins.value||0));
      const hoa = Math.max(0, Number(mp_hoa.value||0));
      const pmiPct = Math.max(0, Number(mp_pmi.value||0));

      const {down, loan} = loanPieces(price, downPct, rate, term);
      const parts = monthlyPITI(price, downPct, rate, term, taxPct, insYr, hoa, pmiPct);
      payResult.innerHTML = `
        Loan: <strong>$${fmt2(loan)}</strong> (Down: $${fmt2(down)})<br>
        Monthly P&I: <strong>$${fmt2(parts.pi)}</strong><br>
        Taxes: $${fmt2(parts.tax)} · Insurance: $${fmt2(parts.ins)} · HOA: $${fmt2(hoa)} · PMI: $${fmt2(parts.pmi)}<br>
        PITI Total: <strong>$${fmt2(parts.piti)}</strong>/mo
      `;

      // Amortization chart (5 years)
      const amo = amortizationSeries(loan, rate, term, 60);
      const labels = amo.rows.map(r=>'M'+r.m);
      const p = amo.rows.map(r=>r.principal);
      const iVals = amo.rows.map(r=>r.interest);
      const ctx = document.getElementById('amChart');
      if(ctx && typeof Chart!=='undefined'){
        if(amChart) amChart.destroy();
        amChart = new Chart(ctx,{
          type:'bar',
          data:{labels,datasets:[
            {label:'Principal', data:p, stack:'a'},
            {label:'Interest', data:iVals, stack:'a'}
          ]},
          options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{y:{beginAtZero:true}}}
        });
      }
    });

    // ---------- Buy vs Rent ----------
    const brForm = document.getElementById('brForm');
    bindPersist('brForm',['br_rent','br_rentInfl','br_years','br_price','br_down','br_rate','br_tax','br_ins','br_hoa','br_maint','br_app','br_selling','br_pmi']);
    brForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const rent0 = Math.max(0, Number(br_rent.value||0));
      const rentInfl = Math.max(0, Number(br_rentInfl.value||0))/100;
      const yrs = Math.max(1, Number(br_years.value||0));
      const price = Math.max(5000, Number(br_price.value||0));
      const downPct = Math.max(0, Number(br_down.value||0));
      const rate = Math.max(0, Number(br_rate.value||0));
      const taxPct = Math.max(0, Number(br_tax.value||0));
      const insYr = Math.max(0, Number(br_ins.value||0));
      const hoa = Math.max(0, Number(br_hoa.value||0));
      const maintPct = Math.max(0, Number(br_maint.value||0))/100;
      const app = Math.max(0, Number(br_app.value||0))/100;
      const sellPct = Math.max(0, Number(br_selling.value||0))/100;
      const pmiPct = Math.max(0, Number(br_pmi.value||0));

      // Renting cost (sum of rents over horizon)
      let rentCost=0, rent=rent0;
      for(let y=1;y<=yrs;y++){ rentCost += rent*12; rent *= (1+rentInfl); }

      // Buying costs & equity build (rough)
      const {down, loan} = loanPieces(price, downPct, rate, Number(mp_term?.value||30));
      const piti = monthlyPITI(price, downPct, rate, Number(mp_term?.value||30), taxPct, insYr, hoa, pmiPct);
      const maintYr = price*maintPct;
      const annualCost = (piti.piti*12) + maintYr;
      const ownCost = annualCost*yrs + down; // cash outlay (ignores tax effects)
      // Home value after appreciation
      const futurePrice = price * Math.pow(1+app, yrs);
      const sellCosts = futurePrice * sellPct;
      // Approx equity (principal reduction over yrs)
      const amo = amortizationSeries(loan, rate, Number(mp_term?.value||30), yrs*12);
      const principalPaid = amo.rows.reduce((s,r)=>s+r.principal,0);
      const ownerNet = (futurePrice - sellCosts - (loan - principalPaid));
      const buyNetCost = ownCost - ownerNet; // net outlay after owner’s proceeds

      const better = buyNetCost < rentCost ? 'Buying may come out ahead' : 'Renting may come out ahead';
      brResult.innerHTML = `
        Rent cost (total ${yrs} yrs): <strong>$${fmt2(rentCost)}</strong><br>
        Buy outlay (cash & carrying): <strong>$${fmt2(ownCost)}</strong><br>
        Est. owner proceeds/net equity: <strong>$${fmt2(ownerNet)}</strong><br>
        Net cost of buying: <strong>$${fmt2(buyNetCost)}</strong><br>
        → <strong>${better}</strong> at these assumptions.
      `;
    });

    // ---------- Down Payment Planner ----------
    let dpChart;
    const dpForm = document.getElementById('dpForm');
    bindPersist('dpForm',['dp_initial','dp_monthly','dp_months','dp_apy']);
    dpForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const init = Math.max(0, Number(dp_initial.value||0));
      const m = Math.max(0, Number(dp_monthly.value||0));
      const months = Number(dp_months.value||12);
      const apy = Math.max(0, Number(dp_apy.value||0))/100;
      const r = Math.pow(1+apy, 1/12) - 1;

      let bal = init, intAcc=0;
      const rows=[];
      for(let i=1;i<=months;i++){
        bal += m; const interest = bal*r; intAcc += interest; bal += interest;
        rows.push({i, contributions: init + m*i, interest:intAcc, total: bal});
      }
      dpResult.innerHTML = `
        Contributions: <strong>$${fmt2(init + m*months)}</strong><br>
        Interest: <strong>$${fmt2(intAcc)}</strong><br>
        Ending Balance: <strong>$${fmt2(bal)}</strong>
      `;
      const ctx = document.getElementById('dpChart');
      if(ctx && typeof Chart!=='undefined'){
        if(dpChart) dpChart.destroy();
        dpChart = new Chart(ctx,{
          type:'line',
          data:{labels: rows.map(r=>'M'+r.i), datasets:[
            {label:'Contributions', data:rows.map(r=>r.contributions), fill:true},
            {label:'Interest', data:rows.map(r=>r.interest), fill:true}
          ]},
          options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{y:{beginAtZero:true}}}
        });
      }
    });

    // ---------- Rental Analyzer ----------
    const raForm = document.getElementById('raForm');
    bindPersist('raForm',['ra_price','ra_down','ra_rate','ra_term','ra_rent','ra_vac','ra_tax','ra_ins','ra_maint','ra_mgmt','ra_hoa','ra_closing']);
    raForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const price = Math.max(5000, Number(ra_price.value||0));
      const downPct = Math.max(0, Number(ra_down.value||0));
      const rate = Math.max(0, Number(ra_rate.value||0));
      const term = Number(ra_term.value||30);
      const rent = Math.max(0, Number(ra_rent.value||0));
      const vac = Math.max(0, Number(ra_vac.value||0))/100;
      const taxPct = Math.max(0, Number(ra_tax.value||0))/100;
      const insYr = Math.max(0, Number(ra_ins.value||0));
      const maintPct = Math.max(0, Number(ra_maint.value||0))/100;
      const mgmtPct = Math.max(0, Number(ra_mgmt.value||0))/100;
      const hoa = Math.max(0, Number(ra_hoa.value||0));
      const closing = Math.max(0, Number(ra_closing.value||0));

      const {down, loan, pi} = loanPieces(price, downPct, rate, term);
      const effRent = rent*(1-vac);
      const taxes = price*taxPct;
      const maint = price*maintPct;
      const mgmt = (rent*12)*mgmtPct;
      const operExp = taxes + insYr + maint + mgmt + hoa*12;
      const noi = (effRent*12) - operExp;
      const annualDebt = pi*12;
      const cashFlow = noi - annualDebt;
      const capRate = (noi/price)*100;
      const cashNeeded = down + closing;
      const coc = cashNeeded>0 ? (cashFlow/cashNeeded)*100 : 0;

      raResult.innerHTML = `
        NOI: <strong>$${fmt2(noi)}</strong> · Cap Rate: <strong>${capRate.toFixed(2)}%</strong><br>
        Annual Debt Service: $${fmt2(annualDebt)} · Cash Flow/yr: <strong>$${fmt2(cashFlow)}</strong><br>
        Cash Needed (Down + Closing): $${fmt2(cashNeeded)} · Cash-on-Cash: <strong>${coc.toFixed(2)}%</strong>
      `;
    });

    // Auto-run some defaults
    window.addEventListener('load', ()=>{
      payForm?.dispatchEvent(new Event('submit'));
      dpForm?.dispatchEvent(new Event('submit'));
      affForm?.dispatchEvent(new Event('submit'));
      brForm?.dispatchEvent(new Event('submit'));
      raForm?.dispatchEvent(new Event('submit'));
    });
  </script>
</body>
</html>
