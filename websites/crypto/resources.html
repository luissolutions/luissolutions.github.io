<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resources</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/html.js" defer></script>
    <script src="assets/js/sidebar.js" defer></script>
    <script type="module" src="assets/js/auth-handling.js" defer></script>
    <style>
        .crypto-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .crypto-name {
            font-weight: 600;
        }

        .crypto-price {
            min-width: 140px;
            text-align: right;
        }

        .collapsible[hidden] {
            display: none !important;
        }
    </style>
</head>

<body>

    <header></header>

    <nav></nav>

    <main class="links-container">

        <section class="crypto-prices">
            <h2>Current Cryptocurrency Prices</h2>

            <ul id="primary-crypto-list" class="crypto-list">
                <!-- Primary cryptos render here -->
            </ul>

            <button id="toggleMoreCryptos" class="chevron-btn" aria-expanded="false" aria-controls="more-cryptos">
                <span class="chevron"></span>
                <span class="label">More</span>
            </button>

            <div id="more-cryptos" class="collapsible" hidden>
                <ul id="extra-crypto-list" class="crypto-list">
                    <!-- Extra cryptos render here -->
                </ul>
            </div>
        </section>

        <section>
            <div>
                <br>
                <input type="text" placeholder="Insert link" id="linkInput">
                <input type="text" placeholder="Title (optional)" id="titleInput">
                <input type="text" placeholder="Categories (comma separated)" id="categoryInput">
                <br><br>
                <button id="saveLinkButton">Save</button>
                <button id="updateLinkButton" style="display: none;">Update</button>
            </div>

            <div>
                <br>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="linksContainer"></div>
        </section>

    </main>

    <aside></aside>

    <footer></footer>

    <script>
        const primaryCoins = [
            { id: 'bitcoin', symbol: 'BTC', name: 'Bitcoin' },
            { id: 'ethereum', symbol: 'ETH', name: 'Ethereum' },
            { id: 'solana', symbol: 'SOL', name: 'Solana' },
            { id: 'ripple', symbol: 'XRP', name: 'XRP' },
            { id: 'cardano', symbol: 'ADA', name: 'Cardano' },
            { id: 'litecoin', symbol: 'LTC', name: 'Litecoin' }
        ];

        // Shown when “More” is expanded
        const extraCoins = [
            { id: 'hedera-hashgraph', symbol: 'HBAR', name: 'Hedera' },
            { id: 'ondo-finance', symbol: 'ONDO', name: 'Ondo' },
            { id: 'chainlink', symbol: 'LINK', name: 'Chainlink' },
            { id: 'sui', symbol: 'SUI', name: 'Sui' },
            { id: 'near', symbol: 'NEAR', name: 'NEAR Protocol' },
            { id: 'beam-2', symbol: 'BEAM', name: 'Beam' },          // Merit Circle’s BEAM
            { id: 'aethir-token', symbol: 'ATH', name: 'Aethir' },
            { id: 'pengu', symbol: 'PENGU', name: 'Pengu' },         // If this shows "—", update to the exact CoinGecko id you use
            { id: 'injective-protocol', symbol: 'INJ', name: 'Injective' },
            { id: 'gala', symbol: 'GALA', name: 'Gala Games' },
            { id: 'algorand', symbol: 'ALGO', name: 'Algorand' },
            { id: 'tezos', symbol: 'XTZ', name: 'Tezos' },
            { id: 'the-graph', symbol: 'GRT', name: 'The Graph' }
        ];

        const $primaryList = document.getElementById('primary-crypto-list');
        const $extraList = document.getElementById('extra-crypto-list');
        const $toggleBtn = document.getElementById('toggleMoreCryptos');
        const $moreWrap = document.getElementById('more-cryptos');

        // Render list items once (we’ll only update the numbers)
        function renderCryptoLists() {
            function liTemplate(coin) {
                const li = document.createElement('li');
                li.innerHTML = `
        <span class="crypto-name">${coin.name} (${coin.symbol.toUpperCase()}):</span>
        <span class="crypto-price" id="${coin.id}-price">Loading...</span>
      `;
                return li;
            }
            $primaryList.innerHTML = '';
            primaryCoins.forEach(c => $primaryList.appendChild(liTemplate(c)));

            $extraList.innerHTML = '';
            extraCoins.forEach(c => $extraList.appendChild(liTemplate(c)));
        }

        async function fetchCryptoPrices() {
            const allCoins = [...primaryCoins, ...extraCoins];
            const ids = allCoins.map(c => c.id).join(',');

            try {
                const res = await fetch(
                    `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=usd`
                );
                const data = await res.json();

                allCoins.forEach(c => {
                    const el = document.getElementById(`${c.id}-price`);
                    if (!el) return;
                    const val = data?.[c.id]?.usd;
                    el.textContent = (typeof val === 'number')
                        ? `$${val.toLocaleString()}`
                        : '—';
                });
            } catch (err) {
                console.error('Error fetching cryptocurrency prices:', err);
                [...primaryCoins, ...extraCoins].forEach(c => {
                    const el = document.getElementById(`${c.id}-price`);
                    if (el) el.textContent = 'Error';
                });
            }
        }

        // Toggle the “More” section
        $toggleBtn.addEventListener('click', () => {
            const expanded = $toggleBtn.getAttribute('aria-expanded') === 'true';
            $toggleBtn.setAttribute('aria-expanded', String(!expanded));
            if (expanded) {
                $moreWrap.hidden = true;
                $toggleBtn.querySelector('.label').textContent = 'More';
            } else {
                $moreWrap.hidden = false;
                $toggleBtn.querySelector('.label').textContent = 'Less';
            }
        });

        // Init
        renderCryptoLists();
        fetchCryptoPrices();
        setInterval(fetchCryptoPrices, 60_000);
    </script>


    <script type="module">
        import { getDatabase, database, ref, push, set, onValue, remove, update } from '../../apps/assets/js/firebase-init.js';

        document.addEventListener('DOMContentLoaded', () => {
            const linkInput = document.getElementById('linkInput');
            const titleInput = document.getElementById('titleInput');
            const categoryInput = document.getElementById('categoryInput');
            const saveBtn = document.getElementById('saveLinkButton');
            const updateBtn = document.getElementById('updateLinkButton');
            const categoryFilter = document.getElementById('categoryFilter');
            const linksContainer = document.getElementById('linksContainer');
            let editingLinkKey = null;

            saveBtn.addEventListener('click', () => {
                const url = linkInput.value.trim();
                const title = titleInput.value.trim();
                const cats = categoryInput.value
                    .split(',')
                    .map(c => c.trim())
                    .filter(c => c);
                if (!url) {
                    alert('Please enter a link.');
                    return;
                }

                const newRef = push(ref(database, 'share/bitveau/links'));
                const payload = {
                    url,
                    title: title.length ? title : null,
                    categories: cats.length ? cats : null
                };

                set(newRef, payload)
                    .then(() => {
                        clearForm();
                        fetchLinksFromFirebase();
                    })
                    .catch(console.error);
            });

            updateBtn.addEventListener('click', () => {
                const url = linkInput.value.trim();
                const title = titleInput.value.trim();
                const cats = categoryInput.value
                    .split(',')
                    .map(c => c.trim())
                    .filter(c => c);
                if (!url) {
                    alert('Please enter a link.');
                    return;
                }

                const linkRef = ref(database, 'share/bitveau/links/' + editingLinkKey);
                const payload = {
                    url,
                    title: title.length ? title : null,
                    categories: cats.length ? cats : null
                };

                update(linkRef, payload)
                    .then(() => {
                        clearForm();
                        fetchLinksFromFirebase();
                    })
                    .catch(console.error);
            });

            categoryFilter.addEventListener('change', fetchLinksFromFirebase);

            function fetchLinksFromFirebase() {
                const linksRef = ref(database, 'share/bitveau/links');
                onValue(linksRef, snapshot => {
                    const data = snapshot.val() || {};
                    populateCategoryFilter(data);
                    displayLinksByCategory(data);
                }, console.error);
            }

            function displayLinksByCategory(links) {
                linksContainer.innerHTML = '';
                const selCat = categoryFilter.value;
                const bucket = {};

                Object.entries(links).forEach(([key, link]) => {
                    const cats = link.categories || ['Uncategorized'];
                    if (selCat && !cats.includes(selCat)) return;
                    cats.forEach(cat => {
                        (bucket[cat] ||= []).push({
                            key,
                            url: link.url,
                            title: link.title,
                            categories: link.categories
                        });
                    });
                });

                Object.keys(bucket).sort().forEach(cat => {
                    const h3 = document.createElement('h3');
                    h3.textContent = cat;
                    linksContainer.appendChild(h3);

                    const ul = document.createElement('ul');
                    bucket[cat].forEach(item => {
                        const li = document.createElement('li');

                        const a = document.createElement('a');
                        a.href = item.url;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.textContent = item.title?.trim() ? item.title : item.url;

                        const editBtn = document.createElement('button');
                        editBtn.textContent = '✏';
                        editBtn.classList.add('edit-button');
                        editBtn.onclick = () => editLink(item.key, item);

                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'X';
                        delBtn.classList.add('clear-button');
                        delBtn.onclick = () => deleteLink(item.key);

                        li.append(a, editBtn, delBtn);
                        ul.appendChild(li);
                    });
                    linksContainer.appendChild(ul);
                });
            }

            function populateCategoryFilter(links) {
                const setCats = new Set(['All Categories']);
                Object.values(links).forEach(link => {
                    (link.categories || ['Uncategorized'])
                        .forEach(cat => setCats.add(cat));
                });

                const prior = categoryFilter.value;
                categoryFilter.innerHTML = '';
                Array.from(setCats).forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat === 'All Categories' ? '' : cat;
                    opt.textContent = cat;
                    categoryFilter.appendChild(opt);
                });
                categoryFilter.value = prior;
            }

            function deleteLink(key) {
                if (!confirm('Delete this link?')) return;
                remove(ref(database, 'share/bitveau/links/' + key))
                    .then(fetchLinksFromFirebase)
                    .catch(console.error);
            }

            function editLink(key, link) {
                editingLinkKey = key;
                linkInput.value = link.url;
                titleInput.value = link.title?.trim() ? link.title : link.url;
                categoryInput.value = (link.categories || []).join(', ');
                saveBtn.style.display = 'none';
                updateBtn.style.display = 'inline-block';

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function clearForm() {
                linkInput.value = '';
                titleInput.value = '';
                categoryInput.value = '';
                saveBtn.style.display = 'inline-block';
                updateBtn.style.display = 'none';
                editingLinkKey = null;
            }

            fetchLinksFromFirebase();
        });

    </script>

</body>

</html>