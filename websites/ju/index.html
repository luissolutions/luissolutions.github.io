<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Emporium - Home</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <link rel="stylesheet" href="assets/css/app-styles.css" />
</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="The Emporium" class="logo" />
        <h1>The Emporium</h1>
    </header>

    <nav>
        <a href="index.html" class="active">Home</a> |
        <a href="catalog.html">Shop</a> |
        <a href="sop.html">SOP</a> |
        <a href="about.html">About</a>
    </nav>

    <main>
        <section class="container">
            <div class="hero" style="text-align:center; padding:28px 16px;">
                <h2>Tools & Gear for Low‑Voltage Pros</h2>
                <p>Curated picks for technicians and integrators — testers, termination, racks, PoE and more.</p>
                <a href="catalog.html" class="cta-button">Shop Catalog</a>
            </div>

            <p class="affiliate-disclosure">
                <strong>Affiliate Disclosure:</strong> The Emporium participates in the Amazon Services LLC Associates
                Program.
                As an Amazon Associate, we earn from qualifying purchases made through links on this site.
            </p>

            <section class="content" style="margin-top:24px;">
                <h2>Featured Products</h2>
                <div class="product-grid" id="featuredGrid">
                    <!-- Featured cards rendered here -->
                </div>
                <p id="featuredEmpty" style="display:none; opacity:.8;">No featured items yet. Add products with an
                    Amazon link in your inventory.</p>
            </section>

            <section style="margin-top:36px;">
                <h2>Why Shop Here?</h2>
                <ul style="line-height:1.8;">
                    <li>Hand‑picked gear for structured cabling, CCTV, access control and networking.</li>
                    <li>Quick filters by category (Test & Certify, Termination, Rack & Power, Cameras, etc.).</li>
                    <li>Straightforward recommendations with clear specs and field‑proven picks.</li>
                </ul>
            </section>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Emporium. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="contact.html">Contact Us</a></li>
        </ul>
    </footer>

    <script type="module">
        // Uses your existing no-auth Firebase init
        import { ref, onValue, database } from '../../assets/js/firebase-init-noauth.js';

        const featuredGrid = document.getElementById('featuredGrid');
        const featuredEmpty = document.getElementById('featuredEmpty');

        document.addEventListener('DOMContentLoaded', loadFeaturedRandom);

        function loadFeaturedRandom() {
            const inventoryRef = ref(database, 'inventory');
            onValue(inventoryRef, (snap) => {
                const root = snap.val() || {};
                const all = collectAffiliateItems(root);
                if (!all.length) {
                    featuredGrid.innerHTML = '';
                    featuredEmpty.style.display = 'block';
                    return;
                }
                featuredEmpty.style.display = 'none';
                const picks = shuffle(all).slice(0, 6); // show up to 6
                renderCards(picks, featuredGrid);
            }, (err) => console.error('Failed to load inventory:', err));
        }

        function collectAffiliateItems(data) {
            const out = [];
            for (const category in data) {
                for (const component in data[category]) {
                    for (const partName in data[category][component]) {
                        const e = data[category][component][partName] || {};
                        if (!e.affiliateUrl) continue; // only items with affiliate links
                        out.push({
                            name: partName,
                            category,
                            component,
                            price: e.price,
                            description: e.description || '',
                            affiliateUrl: e.affiliateUrl,
                            asin: e.asin || '',
                            imageUrl: (e.imageUrl && e.imageUrl.trim()) ? e.imageUrl : `../../assets/img/database/${partName}.png`
                        });
                    }
                }
            }
            return out;
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function ensureAffiliateTag(url, tag) {
            try {
                const u = new URL(url, window.location.origin);
                u.searchParams.set('tag', tag); // replace or append
                return u.toString();
            } catch {
                return url;
            }
        }

        function renderCards(items, target) {
            target.innerHTML = '';
            items.forEach(p => {
                const price = parseFloat(p.price);
                const priceText = isNaN(price) ? '' : `$${price.toFixed(2)}`;
                const card = document.createElement('div');
                card.className = 'product-item';
                card.innerHTML = `
          <img src="${p.imageUrl}" alt="${escapeHtml(p.name)}" loading="lazy">
          <h3>${escapeHtml(p.name)}</h3>
          <p class="meta">${escapeHtml(p.category)} • ${escapeHtml(p.component)}</p>
          ${priceText ? `<p class="our-price">Our listed price: ${priceText}</p>` : ''}
          <a class="cta-button" href="${ensureAffiliateTag(p.affiliateUrl, 'YOURTAG-20')}" target="_blank" rel="sponsored nofollow noopener" data-asin="${p.asin}">View on Amazon</a>
          <small class="aff-note">As an Amazon Associate, we earn from qualifying purchases.</small>
        `;
                target.appendChild(card);
            });
        }

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c]));
        }
    </script>
</body>

</html>