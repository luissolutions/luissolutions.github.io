<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Emporium - Home</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <link rel="stylesheet" href="assets/css/app-styles.css" />

</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="The Emporium" class="logo" />
        <h1>The Emporium</h1>
    </header>

    <nav>
        <a href="index.html" class="active">Home</a> |
        <a href="catalog.html">Shop</a> |
        <a href="sop.html">SOP</a> |
        <a href="about.html">About</a>
    </nav>

    <!-- Appears only when a user is signed in so they can flip workspaces -->
    <div class="admin-bar" id="viewBar" style="display:none;">
        <small id="viewLabel">Viewing: Public</small>
        <label class="chip" id="viewToggleWrap" style="display:none;">
            <input type="checkbox" id="viewToggle" /> My Workspace
        </label>
    </div>

    <main>
        <section class="container">
            <div class="hero" style="text-align:center;padding:28px 16px;">
                <h2>Tools &amp; Gear for Low-Voltage Pros</h2>
                <p>Curated picks for technicians and integrators — testers, termination, racks, PoE and more.</p>
                <a href="catalog.html" class="cta-button">Shop Catalog</a>
            </div>

            <p class="affiliate-disclosure">
                <strong>Affiliate Disclosure:</strong> The Emporium participates in the Amazon Services LLC Associates
                Program.
                As an Amazon Associate, we earn from qualifying purchases made through links on this site.
            </p>

            <section class="content" style="margin-top:24px;">
                <h2>Featured Products</h2>
                <div class="product-grid" id="featuredGrid"></div>
                <p id="featuredEmpty" style="display:none;opacity:.8;">No featured items yet. Add products with an
                    Amazon link in your inventory.</p>
            </section>

            <section style="margin-top:36px;">
                <h2>Why Shop Here?</h2>
                <ul style="line-height:1.8;">
                    <li>Hand-picked gear for structured cabling, CCTV, access control and networking.</li>
                    <li>Quick filters by category (Test &amp; Certify, Termination, Rack &amp; Power, Cameras, etc.).
                    </li>
                    <li>Straightforward recommendations with clear specs and field-proven picks.</li>
                </ul>
            </section>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Emporium. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="contact.html">Contact Us</a></li>
        </ul>
    </footer>

    <script type="module">
        import {
            auth, database,
            ref, onValue, get, off,
            onAuthStateChanged
        } from "../../assets/js/firebase-init.js";

        // ----- Dynamic BASE: "public" by default; <uid> if user toggles -----
        let BASE = null;
        let signedInUID = null;
        let affiliateTag = "";
        let inventoryRefLive = null;

        const join = (...parts) => parts.filter(Boolean).map(String).join("/").replace(/\/+/g, "/");
        const dbRef = (...p) => ref(database, join(BASE, ...p));

        // UI
        const featuredGrid = document.getElementById("featuredGrid");
        const featuredEmpty = document.getElementById("featuredEmpty");
        const viewBar = document.getElementById("viewBar");
        const viewLabel = document.getElementById("viewLabel");
        const viewToggle = document.getElementById("viewToggle");
        const viewToggleWrap = document.getElementById("viewToggleWrap");

        // Auth -> show public by default; toggle available when signed in
        onAuthStateChanged(auth, (user) => {
            signedInUID = user ? user.uid : null;

            setBase("public"); // always land on public first

            viewBar.style.display = user ? "flex" : "none";
            viewToggleWrap.style.display = user ? "inline-flex" : "none";
            if (viewToggle) viewToggle.checked = false;
            viewLabel.textContent = "Viewing: Public";
        });

        viewToggle?.addEventListener("change", () => {
            if (!signedInUID) return;
            const next = viewToggle.checked ? signedInUID : "public";
            setBase(next);
            viewLabel.textContent = `Viewing: ${next === "public" ? "Public" : "My Workspace"}`;
        });

        // Bind for current BASE
        function setBase(newBase) {
            const needRebind = BASE !== newBase || !inventoryRefLive;
            BASE = newBase;

            if (!needRebind) return;

            // rebind inventory -> pick featured
            if (inventoryRefLive) off(inventoryRefLive);
            inventoryRefLive = dbRef("inventory");

            onValue(inventoryRefLive, (snap) => {
                const root = snap.val() || {};
                const all = collectAffiliateItems(root);
                if (!all.length) {
                    featuredGrid.innerHTML = "";
                    featuredEmpty.style.display = "block";
                } else {
                    featuredEmpty.style.display = "none";
                    const picks = shuffle(all).slice(0, 6);
                    renderCards(picks, featuredGrid);
                }
            }, (err) => console.error("Failed to load inventory:", err));

            // load affiliate tag for this base
            get(dbRef("settings/affiliateTag"))
                .then(s => { affiliateTag = s.val() || ""; renderCardsFromDom(); })
                .catch(() => { affiliateTag = ""; renderCardsFromDom(); });
        }

        // Initial bind so the page shows Public even before auth fires
        setBase("public");

        function collectAffiliateItems(data) {
            const out = [];
            for (const category in data) {
                for (const component in data[category]) {
                    for (const partName in data[category][component]) {
                        const e = data[category][component][partName] || {};
                        if (!e.affiliateUrl) continue;
                        out.push({
                            name: partName,
                            category, component,
                            price: e.price,
                            description: e.description || "",
                            affiliateUrl: e.affiliateUrl,
                            asin: e.asin || "",
                            imageUrl: (e.imageUrl && e.imageUrl.trim())
                                ? e.imageUrl
                                : `assets/img/database/${encodeURIComponent(partName)}.png`
                        });
                    }
                }
            }
            return out;
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function renderCards(items, target) {
            target.innerHTML = "";
            items.forEach(p => {
                const price = parseFloat(p.price);
                const priceText = isNaN(price) ? "" : `$${price.toFixed(2)}`;

                const card = document.createElement("div");
                card.className = "product-item";
                card.innerHTML = `
          <img src="${escapeAttr(p.imageUrl)}" alt="${escapeAttr(p.name)}" loading="lazy">
          <h3>${escapeHtml(p.name)}</h3>
          <p class="meta">${escapeHtml(p.category)} • ${escapeHtml(p.component)}</p>
          ${priceText ? `<p class="our-price">Our listed price: ${priceText}</p>` : ""}
          <a class="cta-button"
             href="${escapeAttr(ensureAffiliateTag(p.affiliateUrl, affiliateTag || ""))}"
             target="_blank" rel="sponsored nofollow noopener"
             data-asin="${escapeAttr(p.asin)}">View on Amazon</a>
          <small class="aff-note">As an Amazon Associate, we earn from qualifying purchases.</small>
        `;

                // graceful image fallback
                const img = card.querySelector("img");
                img.addEventListener("error", () => {
                    if (!img.dataset.fallback) {
                        img.dataset.fallback = "1";
                        img.src = "../../assets/img/placeholder.png";
                    }
                });

                target.appendChild(card);
            });
        }

        // When affiliateTag changes after first render, rebuild links in-place
        function renderCardsFromDom() {
            if (!affiliateTag) return;
            featuredGrid.querySelectorAll(".product-item a.cta-button").forEach(a => {
                try {
                    const u = new URL(a.href, window.location.origin);
                    u.searchParams.set("tag", affiliateTag);
                    a.href = u.toString();
                } catch { }
            });
        }

        function ensureAffiliateTag(url, tag) {
            try {
                const u = new URL(url, window.location.origin);
                if (tag) u.searchParams.set("tag", tag);
                return u.toString();
            } catch { return url; }
        }

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, c => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
            }[c]));
        }
        function escapeAttr(s = "") { return escapeHtml(String(s)); }
    </script>
</body>

</html>