<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Emporium - Admin</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <link rel="stylesheet" href="assets/css/app-styles.css" />
    <style>
        /* Admin-specific light tweaks that reuse your theme */
        .admin-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background: #2a2a2a
        }

        .admin-bar small {
            opacity: .85
        }

        .section-card {
            background: var(--entryBackground);
            color: #222;
            border: 1px solid var(--borderColor);
            border-radius: 12px;
            padding: 14px;
            margin: 14px 0
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px
        }

        .inline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .muted {
            color: #666
        }

        .chip {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            background: #eef2f3;
            color: #333;
            font-size: .8rem
        }

        .danger {
            background: #fef0f0;
            border: 1px solid #f4caca
        }

        .thumb {
            width: 160px;
            height: 120px;
            object-fit: contain;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px
        }

        .row-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .kicker {
            font-size: .9rem;
            opacity: .85;
            margin-top: 4px
        }

        #login-section {
            display: flex;
            justify-content: center;
            margin: 16px 0
        }

        #login-form {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px
        }

        #logout {
            margin-left: 10px
        }
    </style>
</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="The Emporium" class="logo" />
        <h1>Admin • The Emporium</h1>
    </header>

    <nav>
        <a href="index.html">Home</a> |
        <a href="catalog.html">Shop</a> |
        <a href="sop.html">SOP</a> |
        <a href="about.html">About</a> |
        <a href="admin.html" class="active">Admin</a>
    </nav>

    <!-- Login UI (handled by login.js) -->
    <section id="login-section">
        <form id="login-form">
            <label for="username">Email:</label>
            <input type="email" id="username" required>
            <label for="password">Password:</label>
            <input type="password" id="password" required>
            <button type="submit">Login</button>
        </form>
        <button id="logout" style="display:none;">Logout</button>
    </section>

    <main class="container">
        <!-- Status + role -->
        <div class="admin-bar">
            <small id="authStatus" class="muted">Not signed in</small>
            <span class="chip" id="roleChip" title="Only approved UIDs can write images">viewer</span>
        </div>

        <!-- Admin tools (hidden until signed in; change if you want browse access) -->
        <section id="adminContent" hidden>
            <!-- SETTINGS -->
            <section class="section-card">
                <h2>Store Settings</h2>
                <div class="grid-2">
                    <div>
                        <label for="affiliateTag"><strong>Amazon Associates Tag</strong></label><br />
                        <input type="text" id="affiliateTag" placeholder="YOURTAG-20" />
                        <button id="saveTagBtn">Save Tag</button>
                        <p class="muted kicker">Stored at <code>{base}/settings/affiliateTag</code>. Your storefront can
                            read the public base (<code>/public</code>) to attach <code>tag=</code>.</p>
                    </div>
                    <div>
                        <label><strong>Default Category / Sub-Category</strong></label>
                        <div class="inline">
                            <input id="defaultCategory" placeholder="e.g., Tools" />
                            <input id="defaultComponent" placeholder="e.g., Testers" />
                        </div>
                        <p class="muted kicker">Applied when creating new items or bulk importing.</p>
                    </div>
                </div>
            </section>

            <!-- CREATE NEW PRODUCT -->
            <section class="section-card">
                <h2>Add a Product</h2>
                <div class="grid-2">
                    <div>
                        <label>Category</label>
                        <input id="catInput" placeholder="Category" />
                        <label>Sub-Category</label>
                        <input id="compInput" placeholder="Sub-Category" />
                        <label>Part Name (unique key)</label>
                        <input id="nameInput" placeholder="Klein_VDV501-851" />
                        <label>Description</label>
                        <textarea id="descInput" rows="4"
                            placeholder="What makes this great for LV installs..."></textarea>
                    </div>
                    <div>
                        <label>Our Listed Price</label>
                        <input id="priceInput" type="number" step="0.01" />
                        <label>Cost</label>
                        <input id="actualPriceInput" type="number" step="0.01" />
                        <label>Quantity</label>
                        <input id="qtyInput" type="number" />
                        <label>Amazon Link</label>
                        <input id="affInput" type="url" placeholder="https://www.amazon.com/... or https://a.co/..." />
                        <div class="row-actions">
                            <input id="asinInput" placeholder="ASIN (optional)" />
                            <button id="fetchFromAmazonBtn" type="button">Auto-fill from Amazon</button>
                        </div>
                        <p class="muted kicker">Uses a Cloud Function <code>paapiFetch</code> (PA-API v5) in
                            <code>us-central1</code>.
                        </p>
                        <div class="row-actions">
                            <button id="createBtn">Create</button>
                            <button id="clearCreateBtn" class="clear-button">Clear</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- BULK IMPORT LINKS -->
            <section class="section-card">
                <h2>Bulk Import Amazon Links</h2>
                <p class="muted">Paste one URL per line. Items will be named <code>Item_YYYYMMDD_HHMMSS_N</code> if
                    PA-API can’t get a title. You can rename later.</p>
                <textarea id="bulkLinks" rows="6" placeholder="https://a.co/d/...
https://www.amazon.com/dp/...
..."></textarea>
                <div class="inline" style="margin-top:8px;">
                    <input id="bulkCat" placeholder="Category (uses Default if blank)" />
                    <input id="bulkComp" placeholder="Sub-Category (uses Default if blank)" />
                    <button id="bulkImportBtn">Import</button>
                </div>
                <pre id="bulkLog" class="muted" style="white-space:pre-wrap; max-height:220px; overflow:auto;"></pre>
            </section>

            <!-- FILTERS + LIST -->
            <section class="section-card">
                <h2>Products</h2>
                <div class="inline">
                    <select id="filterCat">
                        <option value="">All Categories</option>
                    </select>
                    <select id="filterComp">
                        <option value="">All Sub-Categories</option>
                    </select>
                    <input id="filterSearch" placeholder="Search name/desc/tags" />
                    <button id="refreshBtn">Refresh</button>
                </div>
                <div id="entriesContainer" class="entries-container" style="margin-top:12px;"></div>
                <p id="emptyState" class="muted" style="display:none;">Nothing here yet. Try changing filters.</p>
            </section>

            <section class="section-card danger">
                <h3>Danger Zone</h3>
                <p class="muted">Deleting a product removes it from the database. Images in Storage are not auto-deleted
                    unless the row has a stored <code>imageStoragePath</code>.</p>
            </section>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Emporium. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="contact.html">Contact Us</a></li>
        </ul>
    </footer>

    <!-- Your login handler (toggles #login-section UI) -->
    <script type="module" src="../../apps/assets/js/login.js"></script>

    <!-- Admin logic -->
    <script type="module">
        // Single source of truth: your v9 init module (adjust path)
        import {
            app, auth, database, storage,
            // db
            ref, onValue, off, set, update, remove, get,
            // auth
            onAuthStateChanged,
            // storage
            storageRef as sRef, uploadBytes, getDownloadURL, deleteObject,
            // functions
            getFunctions, httpsCallable
        } from "../../assets/js/firebase-init.js";

        // --- Dynamic base: /public when signed out, /<uid> when signed in
        let DATABASE_BASE_PATH = "public";

        const join = (...parts) => parts.filter(Boolean).map(String).join("/").replace(/\/+/g, "/");
        const dbRef = (...parts) => ref(database, join(DATABASE_BASE_PATH, ...parts));
        const storageKey = (...parts) => join("product-images", DATABASE_BASE_PATH, ...parts);

        // Callable (region must match deployment)
        const functions = getFunctions(app, "us-central1");
        const fetchFromAmazon = httpsCallable(functions, "paapiFetch");

        // Whitelist admin UIDs who can manage images (match your Storage rules)
        const ALLOWED_UIDS = ["7cIh8rrhVNOjjj5CBDgb3IlqzEh2"];

        // UI refs
        const adminContent = document.getElementById("adminContent");
        const authStatus = document.getElementById("authStatus");
        const roleChip = document.getElementById("roleChip");

        const affiliateTagEl = document.getElementById("affiliateTag");
        const saveTagBtn = document.getElementById("saveTagBtn");
        const defaultCategoryEl = document.getElementById("defaultCategory");
        const defaultComponentEl = document.getElementById("defaultComponent");

        const catInput = document.getElementById("catInput");
        const compInput = document.getElementById("compInput");
        const nameInput = document.getElementById("nameInput");
        const descInput = document.getElementById("descInput");
        const priceInput = document.getElementById("priceInput");
        const actualPriceInput = document.getElementById("actualPriceInput");
        const qtyInput = document.getElementById("qtyInput");
        const affInput = document.getElementById("affInput");
        const asinInput = document.getElementById("asinInput");
        const createBtn = document.getElementById("createBtn");
        const clearCreateBtn = document.getElementById("clearCreateBtn");
        const fetchFromAmazonBtn = document.getElementById("fetchFromAmazonBtn");

        const bulkLinks = document.getElementById("bulkLinks");
        const bulkCat = document.getElementById("bulkCat");
        const bulkComp = document.getElementById("bulkComp");
        const bulkImportBtn = document.getElementById("bulkImportBtn");
        const bulkLog = document.getElementById("bulkLog");

        const filterCat = document.getElementById("filterCat");
        const filterComp = document.getElementById("filterComp");
        const filterSearch = document.getElementById("filterSearch");
        const refreshBtn = document.getElementById("refreshBtn");
        const entriesContainer = document.getElementById("entriesContainer");
        const emptyState = document.getElementById("emptyState");

        let inventoryRefLive = null;

        onAuthStateChanged(auth, (user) => {
            // switch base path
            DATABASE_BASE_PATH = user ? user.uid : "public";

            authStatus.textContent = user ? `Signed in as ${user.email || user.uid}` : "Public mode";
            roleChip.textContent = user && ALLOWED_UIDS.includes(user.uid) ? "admin" : "public";

            // IMPORTANT: keep admin visible in public mode
            adminContent.hidden = false;

            // Rebind to the new base
            bindInventoryListener();
            loadSettings();
        });

        function bindInventoryListener() {
            if (inventoryRefLive) off(inventoryRefLive);
            inventoryRefLive = dbRef("inventory");

            onValue(inventoryRefLive, (snap) => {
                const data = snap.val() || {};
                const { items, cats, comps } = flatten(data);
                allItems = items;
                renderFilterOptions(cats, comps);
                renderList();
            }, (err) => console.error("Inventory load failed:", err));
        }

        async function loadSettings() {
            try {
                const tagSnap = await get(dbRef("settings/affiliateTag"));
                const defCatSnap = await get(dbRef("settings/defaultCategory"));
                const defCompSnap = await get(dbRef("settings/defaultComponent"));
                affiliateTagEl.value = tagSnap.val() || "";
                defaultCategoryEl.value = defCatSnap.val() || "";
                defaultComponentEl.value = defCompSnap.val() || "";
            } catch (e) { console.warn("Settings load failed", e); }
        }

        saveTagBtn.addEventListener("click", async () => {
            try {
                await update(dbRef("settings"), {
                    affiliateTag: (affiliateTagEl.value || "").trim(),
                    defaultCategory: (defaultCategoryEl.value || "").trim(),
                    defaultComponent: (defaultComponentEl.value || "").trim()
                });
                alert("Settings saved.");
            } catch (e) {
                alert("Failed to save settings: " + (e?.message || e));
            }
        });

        // ----- Create product
        createBtn.addEventListener("click", async () => {
            const category = sanitize(catInput.value) || sanitize(defaultCategoryEl.value);
            const component = sanitize(compInput.value) || sanitize(defaultComponentEl.value);
            const name = sanitize(nameInput.value);
            if (!category || !component || !name) return alert("Fill Category, Sub-Category, and Part Name");

            const data = {
                description: descInput.value || "",
                price: priceInput.value || "",
                actualPrice: actualPriceInput.value || "",
                quantity: Number(qtyInput.value || 0),
                affiliateUrl: affInput.value || "",
                asin: asinInput.value || "",
                tags: []
            };

            try {
                await set(dbRef("inventory", category, component, name), data);
                alert("Created. You can now upload an image in the row below.");
                clearCreateForm();
            } catch (e) {
                alert("Create failed: " + (e?.message || e));
            }
        });

        clearCreateBtn.addEventListener("click", clearCreateForm);
        function clearCreateForm() {
            catInput.value = compInput.value = nameInput.value = "";
            descInput.value = priceInput.value = actualPriceInput.value = qtyInput.value = "";
            affInput.value = asinInput.value = "";
        }

        // ----- Auto-fill from Amazon (PA-API via Cloud Function)
        fetchFromAmazonBtn.addEventListener("click", async () => {
            const url = (affInput.value || "").trim();
            const asin = (asinInput.value || "").trim();
            if (!url && !asin) return alert("Paste an Amazon URL or enter an ASIN first.");
            try {
                const { data } = await fetchFromAmazon(url ? { url } : { asin });

                if (data?.error) {
                    console.warn("PA-API error:", data);
                    return alert(`Amazon lookup failed: ${data.error}${data.message ? " — " + data.message : ""}`);
                }

                if (data?.title) nameInput.value = slugFromTitle(data.title);
                if (data?.asin) asinInput.value = data.asin;
                if (data?.detailPageURL) affInput.value = data.detailPageURL;
                if (Array.isArray(data?.features) && data.features.length) {
                    const bullets = data.features.slice(0, 6).map(b => `• ${b}`).join("\n");
                    descInput.value = (descInput.value ? descInput.value + "\n\n" : "") + bullets;
                }
                alert("Auto-fill complete. Review fields, then click Create.");
            } catch (e) {
                console.error(e);
                alert("Could not fetch details from Amazon. Check Cloud Function + keys.");
            }
        });

        function slugFromTitle(t) {
            return String(t)
                .replace(/[™®©]/g, "")
                .replace(/[^A-Za-z0-9]+/g, "_")
                .replace(/^_+|_+$/g, "")
                .slice(0, 60);
        }

        // ----- Bulk import (with PA-API enrichment when available)
        bulkImportBtn.addEventListener("click", async () => {
            const lines = (bulkLinks.value || "")
                .split(/\r?\n+/)
                .map(s => s.trim())
                .filter(Boolean);

            if (!lines.length) return alert("Paste at least one link.");

            const category = sanitize(bulkCat.value) || sanitize(defaultCategoryEl.value) || "Starter_Picks";
            const component = sanitize(bulkComp.value) || sanitize(defaultComponentEl.value) || "Unsorted";

            let ok = 0, fail = 0;
            bulkLog.textContent = "";

            const oldLabel = bulkImportBtn.textContent;
            bulkImportBtn.disabled = true;
            const setProgress = (i) => bulkImportBtn.textContent = `Importing ${i}/${lines.length}…`;

            for (let i = 0; i < lines.length; i++) {
                const url = lines[i];
                const stamp = new Date();
                setProgress(i + 1);

                try {
                    let meta = null;
                    try {
                        const resp = await fetchFromAmazon({ url });
                        meta = resp?.data || null;
                        if (meta?.error) {
                            bulkLog.textContent += `PA-API error for ${url}: ${meta.error}${meta.message ? " — " + meta.message : ""}\n`;
                            meta = null;
                        }
                    } catch (e) {
                        bulkLog.textContent += `PA-API failed for ${url}: ${(e?.message || e)}\n`;
                    }

                    const name = meta?.title
                        ? slugFromTitle(meta.title)
                        : `Item_${fmt(stamp)}_${String(i + 1).padStart(2, "0")}`;

                    const description = Array.isArray(meta?.features) && meta.features.length
                        ? meta.features.slice(0, 6).map(b => `• ${b}`).join("\n")
                        : "";

                    const record = {
                        description,
                        price: "",
                        actualPrice: "",
                        quantity: 0,
                        affiliateUrl: meta?.detailPageURL || url,
                        asin: meta?.asin || "",
                        imageUrl: meta?.imageUrl || "",
                        tags: []
                    };

                    await set(dbRef("inventory", category, component, name), record);
                    bulkLog.textContent += `✓ ${join(DATABASE_BASE_PATH, "inventory", category, component, name)}${meta ? " (enriched)" : ""}\n`;
                    ok++;

                    // ~1 req/sec throttle to be kind to PA-API quotas
                    await new Promise(r => setTimeout(r, 1200));
                } catch (e) {
                    bulkLog.textContent += `✗ ${url} :: ${(e?.message || e)}\n`;
                    fail++;
                }
            }

            bulkImportBtn.disabled = false;
            bulkImportBtn.textContent = oldLabel;
            bulkLog.textContent += `\nDone. Success: ${ok}  Failed: ${fail}`;
        });

        function fmt(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            const ss = String(d.getSeconds()).padStart(2, "0");
            return `${y}${m}${dd}_${hh}${mi}${ss}`;
        }

        // ----- List & edit products
        let allItems = [];

        function flatten(data) {
            const items = []; const catSet = new Set(); const compSet = new Set();
            for (const cat in data) {
                for (const comp in data[cat]) {
                    for (const name in data[cat][comp]) {
                        const e = data[cat][comp][name] || {};
                        catSet.add(cat); compSet.add(comp);
                        items.push({ cat, comp, name, ...e });
                    }
                }
            }
            return { items, cats: [...catSet].sort(), comps: [...compSet].sort() };
        }

        function renderFilterOptions(cats, comps) {
            filterCat.innerHTML = '<option value="">All Categories</option>' + cats.map(c => `<option>${escapeHtml(c)}</option>`).join("");
            filterComp.innerHTML = '<option value="">All Sub-Categories</option>' + comps.map(c => `<option>${escapeHtml(c)}</option>`).join("");
        }

        filterCat.addEventListener("change", renderList);
        filterComp.addEventListener("change", renderList);
        filterSearch.addEventListener("input", renderList);
        refreshBtn.addEventListener("click", renderList);

        function renderList() {
            const cat = filterCat.value;
            const comp = filterComp.value;
            const q = (filterSearch.value || "").toLowerCase();

            const filtered = allItems.filter(it => {
                const okCat = !cat || it.cat === cat;
                const okComp = !comp || it.comp === comp;
                const blob = `${it.name} ${it.cat} ${it.comp} ${it.description || ""} ${(it.tags || []).join(" ")}`.toLowerCase();
                const okQ = !q || blob.includes(q);
                return okCat && okComp && okQ;
            });

            entriesContainer.innerHTML = "";
            if (!filtered.length) { emptyState.style.display = "block"; return; }
            emptyState.style.display = "none";

            filtered.forEach(row => entriesContainer.appendChild(renderRow(row)));
        }

        function renderRow(e) {
            const card = document.createElement("div");
            card.className = "data";
            card.innerHTML = `
        <label>Category <input class="cat" value="${escapeAttr(e.cat)}"></label>
        <label>Sub-Category <input class="comp" value="${escapeAttr(e.comp)}"></label>
        <label>Part Name <input class="name" value="${escapeAttr(e.name)}"></label>
        <label>Description <textarea class="desc">${escapeHtml(e.description || "")}</textarea></label>
        <div class="grid-2">
          <div>
            <label>Our Listed Price $ <input class="price" type="number" step="0.01" value="${escapeAttr(e.price || "")}"></label>
            <label>Cost $ <input class="actualPrice" type="number" step="0.01" value="${escapeAttr(e.actualPrice || "")}"></label>
            <label>Quantity <input class="qty" type="number" value="${escapeAttr(e.quantity || 0)}"></label>
            <label>Amazon Link <input class="aff" type="url" value="${escapeAttr(e.affiliateUrl || "")}"></label>
            <label>ASIN <input class="asin" value="${escapeAttr(e.asin || "")}"></label>
          </div>
          <div>
            <img class="thumb" src="${escapeAttr(e.imageUrl || "")}" alt="Preview" style="${e.imageUrl ? "" : "display:none;"}">
            <div class="row-actions">
              <input type="file" class="imgfile" accept="image/*">
              <button class="uploadBtn">Upload Image</button>
              <button class="removeImgBtn" ${e.imageUrl ? "" : "disabled"}>Remove Image</button>
            </div>
            ${e.imageStoragePath ? `<small class="muted">${escapeHtml(e.imageStoragePath)}</small>` : ""}
          </div>
        </div>
        <div class="row-actions">
          <button class="saveBtn">Update</button>
          <button class="delete-button delBtn">Delete</button>
        </div>
      `;

            const catEl = card.querySelector(".cat");
            const compEl = card.querySelector(".comp");
            const nameEl = card.querySelector(".name");
            const descEl = card.querySelector(".desc");
            const priceEl = card.querySelector(".price");
            const actualEl = card.querySelector(".actualPrice");
            const qtyEl = card.querySelector(".qty");
            const affEl = card.querySelector(".aff");
            const asinEl = card.querySelector(".asin");
            const imgEl = card.querySelector(".thumb");

            // Save/update
            card.querySelector(".saveBtn").addEventListener("click", async () => {
                const newCat = sanitize(catEl.value);
                const newComp = sanitize(compEl.value);
                const newName = sanitize(nameEl.value);
                if (!newCat || !newComp || !newName) return alert("Category, Sub-Category, and Part Name are required.");

                const newData = {
                    description: descEl.value || "",
                    price: priceEl.value || "",
                    actualPrice: actualEl.value || "",
                    quantity: Number(qtyEl.value || 0),
                    affiliateUrl: affEl.value || "",
                    asin: asinEl.value || ""
                };

                const oldRef = dbRef("inventory", e.cat, e.comp, e.name);
                const newRef = dbRef("inventory", newCat, newComp, newName);

                try {
                    if (join(e.cat, e.comp, e.name) !== join(newCat, newComp, newName)) {
                        const carry = {};
                        if (e.imageUrl) carry.imageUrl = e.imageUrl;
                        if (e.imageStoragePath) carry.imageStoragePath = e.imageStoragePath;
                        await set(newRef, { ...newData, ...carry });
                        await remove(oldRef);
                    } else {
                        await update(oldRef, newData);
                    }
                    alert("Saved.");
                } catch (err) {
                    alert("Save failed: " + (err?.message || err));
                }
            });

            // Delete row
            card.querySelector(".delBtn").addEventListener("click", async () => {
                if (!confirm(`Delete ${e.name}?`)) return;
                try {
                    await remove(dbRef("inventory", e.cat, e.comp, e.name));
                    if (e.imageStoragePath) { try { await deleteObject(sRef(storage, e.imageStoragePath)); } catch { } }
                } catch (err) {
                    alert("Delete failed: " + (err?.message || err));
                }
            });

            // Upload image
            card.querySelector(".uploadBtn").addEventListener("click", async () => {
                const file = card.querySelector(".imgfile").files?.[0];
                if (!file) return alert("Choose an image file first.");

                const u = auth.currentUser;
                if (!u || !ALLOWED_UIDS.includes(u.uid)) return alert("You must be signed in as an admin to upload images.");

                const newCat = sanitize(catEl.value);
                const newComp = sanitize(compEl.value);
                const newName = sanitize(nameEl.value);
                if (!newCat || !newComp || !newName) return alert("Fill Category, Sub-Category, and Part Name first");

                const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
                const key = storageKey(newCat, newComp, `${newName}.${ext}`);
                const storageRefObj = sRef(storage, key);

                try {
                    await uploadBytes(storageRefObj, file);
                    const url = await getDownloadURL(storageRefObj);
                    await update(dbRef("inventory", newCat, newComp, newName), { imageUrl: url, imageStoragePath: key });
                    imgEl.src = url; imgEl.style.display = "block";
                    card.querySelector(".removeImgBtn").disabled = false;
                    alert("Image uploaded and linked.");
                } catch (err) {
                    alert("Upload failed: " + (err?.message || err));
                }
            });

            // Remove image
            card.querySelector(".removeImgBtn").addEventListener("click", async () => {
                if (!confirm("Remove image from this product?")) return;
                try {
                    if (e.imageStoragePath) { try { await deleteObject(sRef(storage, e.imageStoragePath)); } catch { } }
                    await update(dbRef("inventory", e.cat, e.comp, e.name), { imageUrl: null, imageStoragePath: null });
                    imgEl.src = ""; imgEl.style.display = "none";
                    card.querySelector(".removeImgBtn").disabled = true;
                } catch (err) {
                    alert("Failed to remove image: " + (err?.message || err));
                }
            });

            return card;
        }

        // Helpers
        function sanitize(s) { return String(s || "").replace(/[\/#?\[\]]/g, "_").trim(); }
        function escapeHtml(s = "") { return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
        function escapeAttr(s = "") { return escapeHtml(String(s)); }
    </script>
</body>

</html>