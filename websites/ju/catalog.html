<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Emporium - Catalog</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <link rel="stylesheet" href="assets/css/app-styles.css" />
</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="The Emporium" class="logo" />
        <h1>The Emporium</h1>
    </header>

    <nav>
        <a href="index.html">Home</a> |
        <a href="catalog.html" class="active">Shop</a> |
        <a href="sop.html">SOP</a> |
        <a href="about.html">About</a>
    </nav>

    <main>
        <section class="container">
            <h2>Shop Tools for Low‑Voltage Pros</h2>

            <div class="filters" role="search">
                <label class="visually-hidden" for="categoryFilter">Filter by Category</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>

                <label class="visually-hidden" for="componentFilter">Filter by Sub‑Category</label>
                <select id="componentFilter">
                    <option value="">All Sub‑Categories</option>
                </select>

                <input id="searchBox" type="search" placeholder="Search testers, crimpers, PoE…"
                    aria-label="Search products" />
            </div>

            <p class="affiliate-disclosure">
                <strong>Affiliate Disclosure:</strong> The Emporium participates in the Amazon Services LLC Associates
                Program.
                As an Amazon Associate, we earn from qualifying purchases made through links on this site.
            </p>

            <div class="product-grid" id="catalogGrid"></div>
            <p id="emptyState" style="display:none; opacity:.8;">No items match your filters yet. Try changing the
                category or search.</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Emporium. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="contact.html">Contact Us</a></li>
        </ul>
    </footer>

    <script type="module">
        import { ref, onValue, database } from '../../assets/js/firebase-init-noauth.js';

        const grid = document.getElementById('catalogGrid');
        const emptyState = document.getElementById('emptyState');
        const catSel = document.getElementById('categoryFilter');
        const compSel = document.getElementById('componentFilter');
        const searchBox = document.getElementById('searchBox');

        let allItems = [];

        onValue(ref(database, 'inventory'), (snap) => {
            const data = snap.val() || {};
            const { items, categories, components } = normalize(data);

            allItems = items;
            renderFilters(categories, components);
            render();
        }, (err) => console.error('Failed to load inventory:', err));

        function normalize(data) {
            const items = [];
            const catSet = new Set();
            const compSet = new Set();

            for (const category in data) {
                for (const component in data[category]) {
                    for (const partName in data[category][component]) {
                        const e = data[category][component][partName] || {};
                        if (!e.affiliateUrl) continue; // only show items that can be purchased via affiliate
                        catSet.add(category);
                        compSet.add(component);
                        items.push({
                            name: partName,
                            category,
                            component,
                            description: e.description || '',
                            price: e.price,
                            affiliateUrl: e.affiliateUrl,
                            asin: e.asin || '',
                            imageUrl: (e.imageUrl && e.imageUrl.trim()) ? e.imageUrl : `../../assets/img/database/${partName}.png`,
                            tags: e.tags || []
                        });
                    }
                }
            }
            return { items, categories: [...catSet].sort(), components: [...compSet].sort() };
        }

        function renderFilters(categories, components) {
            catSel.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option>${escapeHtml(c)}</option>`).join('');
            compSel.innerHTML = '<option value="">All Sub‑Categories</option>' + components.map(c => `<option>${escapeHtml(c)}</option>`).join('');
        }

        catSel.addEventListener('change', render);
        compSel.addEventListener('change', render);
        searchBox.addEventListener('input', render);

        function render() {
            const cat = catSel.value;
            const comp = compSel.value;
            const q = (searchBox.value || '').trim().toLowerCase();

            const filtered = allItems.filter(it => {
                const hitCat = !cat || it.category === cat;
                const hitComp = !comp || it.component === comp;
                const hay = `${it.name} ${it.category} ${it.component} ${it.description} ${(it.tags || []).join(' ')}`.toLowerCase();
                const hitQ = !q || hay.includes(q);
                return hitCat && hitComp && hitQ;
            });

            grid.innerHTML = '';
            if (!filtered.length) {
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            filtered.forEach(p => {
                const price = parseFloat(p.price);
                const priceText = isNaN(price) ? '' : `$${price.toFixed(2)}`;
                const el = document.createElement('div');
                el.className = 'product-item';
                el.innerHTML = `
          <img src="${p.imageUrl}" alt="${escapeHtml(p.name)}" loading="lazy">
          <h3>${escapeHtml(p.name)}</h3>
          <p class="meta">${escapeHtml(p.category)} • ${escapeHtml(p.component)}</p>
          ${priceText ? `<p class="our-price">Our listed price: ${priceText}</p>` : ''}
          <a class="cta-button" href="${ensureAffiliateTag(p.affiliateUrl, 'YOURTAG-20')}" target="_blank" rel="sponsored nofollow noopener" data-asin="${p.asin}">View on Amazon</a>
          <small class="aff-note">As an Amazon Associate, we earn from qualifying purchases.</small>
        `;
                grid.appendChild(el);
            });
        }

        function ensureAffiliateTag(url, tag) {
            try { const u = new URL(url, window.location.origin); u.searchParams.set('tag', tag); return u.toString(); }
            catch { return url; }
        }

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c]));
        }
    </script>
</body>

</html>