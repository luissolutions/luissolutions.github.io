<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Emporium - Catalog</title>

    <!-- Icons & manifest -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">

    <!-- Your main theme -->
    <link rel="stylesheet" href="assets/css/app-styles.css" />

</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="The Emporium" class="logo" />
        <h1>The Emporium</h1>
    </header>

    <nav>
        <a href="index.html">Home</a> |
        <a href="catalog.html" class="active">Shop</a> |
        <a href="about.html">About</a>
    </nav>

    <!-- Shows only if signed in -->
    <div class="admin-bar" id="viewBar" style="display:none;">
        <small id="viewLabel">Viewing: Public</small>
        <label class="chip" id="viewToggleWrap" style="display:none;">
            <input type="checkbox" id="viewToggle" />
            My Workspace
        </label>
    </div>

    <main>

        <section class="container">

            <label class="chip">
                <input type="checkbox" id="includeNoLink"> Include items without link
            </label>

            <h2>Shop Tools for Low-Voltage Pros</h2>

            <div class="filters" role="search">
                <label class="visually-hidden" for="categoryFilter">Filter by Category</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>

                <label class="visually-hidden" for="componentFilter">Filter by Sub-Category</label>
                <select id="componentFilter">
                    <option value="">All Sub-Categories</option>
                </select>

                <input id="searchBox" type="search" placeholder="Search testers, crimpers, PoE…"
                    aria-label="Search products" />
            </div>

            <p class="affiliate-disclosure">
                <strong>Affiliate Disclosure:</strong> The Emporium participates in the Amazon Services LLC Associates
                Program.
                As an Amazon Associate, we earn from qualifying purchases made through links on this site.
            </p>

            <div class="product-grid" id="catalogGrid"></div>
            <p id="emptyState" style="display:none;opacity:.8;">No items match your filters yet. Try changing the
                category or search.</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Emporium. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="contact.html">Contact Us</a></li>
        </ul>
    </footer>

    <script type="module">
        import {
            app, auth, database,
            ref, onValue, get, off,
            onAuthStateChanged
        } from "../../assets/js/firebase-init.js";

        // ---------- Dynamic base (public by default for logged-out) ----------
        let BASE = null;                // force first bind
        let inventoryRefLive = null;    // current listener ref
        let affiliateTag = "";          // from {BASE}/settings/affiliateTag
        let signedInUID = null;

        const join = (...parts) => parts.filter(Boolean).map(String).join("/").replace(/\/+/g, "/");
        const dbRef = (...p) => ref(database, join(BASE, ...p));

        // ---------- UI ----------
        const grid = document.getElementById("catalogGrid");
        const emptyState = document.getElementById("emptyState");
        const catSel = document.getElementById("categoryFilter");
        const compSel = document.getElementById("componentFilter");
        const searchBox = document.getElementById("searchBox");

        const viewBar = document.getElementById("viewBar");
        const viewLabel = document.getElementById("viewLabel");
        const viewToggleWrap = document.getElementById("viewToggleWrap");
        const viewToggle = document.getElementById("viewToggle");

        let allItems = [];

        // Auth -> default to Public view (but allow toggle when signed in)
        onAuthStateChanged(auth, (user) => {
            signedInUID = user ? user.uid : null;

            // Always start in Public
            setBase("public");

            // Show toggle bar only when signed in
            viewBar.style.display = user ? "flex" : "none";
            viewToggleWrap.style.display = user ? "inline-flex" : "none";
            viewToggle.checked = false;
            viewLabel.textContent = "Viewing: Public";
        });

        // Workspace toggle
        viewToggle?.addEventListener("change", () => {
            if (!signedInUID) return;
            const next = viewToggle.checked ? signedInUID : "public";
            setBase(next);
            viewLabel.textContent = `Viewing: ${next === "public" ? "Public" : "My Workspace"}`;
        });

        function setBase(newBase) {
            const needRebind = BASE !== newBase || !inventoryRefLive;
            BASE = newBase;
            if (!needRebind) return;

            // Rebind inventory
            if (inventoryRefLive) off(inventoryRefLive);
            inventoryRefLive = dbRef("inventory");
            onValue(inventoryRefLive, (snap) => {
                const data = snap.val() || {};
                const { items, categories, components } = normalize(data);
                allItems = items;
                renderFilters(categories, components);
                render();
            }, (err) => console.error("Inventory load failed:", err));

            // Get affiliate tag for this base
            get(dbRef("settings/affiliateTag"))
                .then(s => { affiliateTag = s.val() || ""; render(); })
                .catch(() => { affiliateTag = ""; });
        }

        const includeNoLink = document.getElementById('includeNoLink');

        function normalize(data) {
            const items = [];
            const catSet = new Set();
            const compSet = new Set();

            for (const category in data) {
                for (const component in data[category]) {
                    for (const partName in data[category][component]) {
                        const e = data[category][component][partName] || {};
                        catSet.add(category);
                        compSet.add(component);
                        items.push({
                            name: partName,
                            category,
                            component,
                            description: e.description || "",
                            price: e.price,
                            affiliateUrl: e.affiliateUrl || "",
                            asin: e.asin || "",
                            imageUrl: (e.imageUrl && e.imageUrl.trim())
                                ? e.imageUrl
                                : `assets/img/database/${encodeURIComponent(partName)}.png`,
                            tags: e.tags || []
                        });
                    }
                }
            }
            return { items, categories: [...catSet].sort(), components: [...compSet].sort() };
        }

        includeNoLink?.addEventListener('change', render);

        function renderFilters(categories, components) {
            catSel.innerHTML = '<option value="">All Categories</option>' +
                categories.map(c => `<option>${escapeHtml(c)}</option>`).join("");
            compSel.innerHTML = '<option value="">All Sub-Categories</option>' +
                components.map(c => `<option>${escapeHtml(c)}</option>`).join("");
        }

        catSel.addEventListener("change", render);
        compSel.addEventListener("change", render);
        searchBox.addEventListener("input", render);

        function render() {
            const cat = catSel.value;
            const comp = compSel.value;
            const q = (searchBox.value || "").trim().toLowerCase();
            const showNoLink = document.getElementById("includeNoLink")?.checked;

            const filtered = allItems.filter(it => {
                if (!showNoLink && !it.affiliateUrl) return false; // <-- filter here
                const hitCat = !cat || it.category === cat;
                const hitComp = !comp || it.component === comp;
                const hay = `${it.name} ${it.category} ${it.component} ${it.description} ${(it.tags || []).join(" ")}`.toLowerCase();
                const hitQ = !q || hay.includes(q);
                return hitCat && hitComp && hitQ;
            });

            grid.innerHTML = "";
            if (!filtered.length) {
                emptyState.style.display = "block";
                return;
            }
            emptyState.style.display = "none";

            filtered.forEach(p => {
                const price = parseFloat(p.price);
                const priceText = isNaN(price) ? "" : `$${price.toFixed(2)}`;

                const linkHtml = p.affiliateUrl
                    ? `<a class="cta-button"
                    href="${escapeAttr(ensureAffiliateTag(p.affiliateUrl, affiliateTag || 'YOURTAG-20'))}"
                    target="_blank" rel="sponsored nofollow noopener"
                    data-asin="${escapeAttr(p.asin)}">Link to Product</a>`
                    : `<span class="cta-button" style="opacity:.6;pointer-events:none;">No link yet</span>`;

                const el = document.createElement("div");
                el.className = "product-item";
                el.innerHTML = `
                <img src="${escapeAttr(p.imageUrl)}" alt="${escapeAttr(p.name)}" loading="lazy">
                <h3>${escapeHtml(p.name)}</h3>
                <p class="meta">${escapeHtml(p.category)} • ${escapeHtml(p.component)}</p>
                ${priceText ? `<p class="our-price">Our listed price: ${priceText}</p>` : ""}
                ${linkHtml}
                `;
                grid.appendChild(el);
            });
        }

        function ensureAffiliateTag(url, tag) {
            try {
                const u = new URL(url, window.location.origin);
                if (tag) u.searchParams.set("tag", tag);
                return u.toString();
            } catch {
                return url;
            }
        }

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }
        function escapeAttr(s = "") { return escapeHtml(String(s)); }

        // First bind immediately so logged-out users see /public
        setBase("public");
    </script>
</body>

</html>