<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Emporium - Catalog</title>

    <!-- Icons & manifest -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">

    <!-- Your main theme -->
    <link rel="stylesheet" href="assets/css/app-styles.css" />

    <style>
        /* small page-local bits */
        .admin-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background: #2a2a2a
        }

        .admin-bar small {
            color: #ccc
        }

        .admin-bar .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #eef2f3;
            color: #333;
            font-size: .85rem
        }

        .admin-bar input[type="checkbox"] {
            transform: scale(1.1)
        }

        .visually-hidden {
            position: absolute;
            left: -9999px
        }

        .cta-button {
            display: inline-block;
            padding: 10px 14px;
            background: var(--primaryColor);
            color: #fff;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700
        }

        .cta-button:hover {
            background: var(--secondaryColor)
        }

        .product-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 14px;
            width: 260px;
            text-align: left
        }

        .product-item img {
            width: 100%;
            height: 160px;
            object-fit: contain;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px
        }

        .product-item h3 {
            margin: .6rem 0 .25rem 0;
            font-size: 1.05rem;
            color: #222
        }

        .product-item .meta {
            opacity: .75;
            margin: .1rem 0 .4rem
        }

        .product-item .our-price {
            font-weight: 700;
            margin: .3rem 0 .7rem
        }

        .affiliate-disclosure {
            font-size: .9rem;
            opacity: .85
        }

        .filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 12px 0 18px
        }

        .filters select,
        .filters input[type="search"] {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-width: 180px
        }
    </style>
</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="The Emporium" class="logo" />
        <h1>The Emporium</h1>
    </header>

    <nav>
        <a href="index.html">Home</a> |
        <a href="catalog.html" class="active">Shop</a> |
        <a href="sop.html">SOP</a> |
        <a href="about.html">About</a>
    </nav>

    <!-- Shows only if signed in -->
    <div class="admin-bar" id="viewBar" style="display:none;">
        <small id="viewLabel">Viewing: Public</small>
        <label class="chip" id="viewToggleWrap" style="display:none;">
            <input type="checkbox" id="viewToggle" />
            My Workspace
        </label>
    </div>

    <main>
        <section class="container">
            <h2>Shop Tools for Low-Voltage Pros</h2>

            <div class="filters" role="search">
                <label class="visually-hidden" for="categoryFilter">Filter by Category</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>

                <label class="visually-hidden" for="componentFilter">Filter by Sub-Category</label>
                <select id="componentFilter">
                    <option value="">All Sub-Categories</option>
                </select>

                <input id="searchBox" type="search" placeholder="Search testers, crimpers, PoEâ€¦"
                    aria-label="Search products" />
            </div>

            <p class="affiliate-disclosure">
                <strong>Affiliate Disclosure:</strong> The Emporium participates in the Amazon Services LLC Associates
                Program.
                As an Amazon Associate, we earn from qualifying purchases made through links on this site.
            </p>

            <div class="product-grid" id="catalogGrid"></div>
            <p id="emptyState" style="display:none;opacity:.8;">No items match your filters yet. Try changing the
                category or search.</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Emporium. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="contact.html">Contact Us</a></li>
        </ul>
    </footer>

    <script type="module">
        // Adjust this import path if your init file lives elsewhere
        import {
            app, auth, database,
            // db
            ref, onValue, get, off,
            // auth
            onAuthStateChanged
        } from "../../assets/js/firebase-init.js";

        // ---------- Dynamic base (public by default for logged-out) ----------
        let BASE = null;                // force first bind
        let inventoryRefLive = null;    // current listener ref
        let affiliateTag = "";          // from {BASE}/settings/affiliateTag
        let signedInUID = null;

        const join = (...parts) => parts.filter(Boolean).map(String).join("/").replace(/\/+/g, "/");
        const dbRef = (...p) => ref(database, join(BASE, ...p));

        // ---------- UI ----------
        const grid = document.getElementById("catalogGrid");
        const emptyState = document.getElementById("emptyState");
        const catSel = document.getElementById("categoryFilter");
        const compSel = document.getElementById("componentFilter");
        const searchBox = document.getElementById("searchBox");

        const viewBar = document.getElementById("viewBar");
        const viewLabel = document.getElementById("viewLabel");
        const viewToggleWrap = document.getElementById("viewToggleWrap");
        const viewToggle = document.getElementById("viewToggle");

        let allItems = [];

        // Auth -> default to Public view (but allow toggle when signed in)
        onAuthStateChanged(auth, (user) => {
            signedInUID = user ? user.uid : null;

            // Always start in Public
            setBase("public");

            // Show toggle bar only when signed in
            viewBar.style.display = user ? "flex" : "none";
            viewToggleWrap.style.display = user ? "inline-flex" : "none";
            viewToggle.checked = false;
            viewLabel.textContent = "Viewing: Public";
        });

        // Workspace toggle
        viewToggle?.addEventListener("change", () => {
            if (!signedInUID) return;
            const next = viewToggle.checked ? signedInUID : "public";
            setBase(next);
            viewLabel.textContent = `Viewing: ${next === "public" ? "Public" : "My Workspace"}`;
        });

        function setBase(newBase) {
            const needRebind = BASE !== newBase || !inventoryRefLive;
            BASE = newBase;
            if (!needRebind) return;

            // Rebind inventory
            if (inventoryRefLive) off(inventoryRefLive);
            inventoryRefLive = dbRef("inventory");
            onValue(inventoryRefLive, (snap) => {
                const data = snap.val() || {};
                const { items, categories, components } = normalize(data);
                allItems = items;
                renderFilters(categories, components);
                render();
            }, (err) => console.error("Inventory load failed:", err));

            // Get affiliate tag for this base
            get(dbRef("settings/affiliateTag"))
                .then(s => { affiliateTag = s.val() || ""; render(); })
                .catch(() => { affiliateTag = ""; });
        }

        // Build items from nested structure
        function normalize(data) {
            const items = [];
            const catSet = new Set();
            const compSet = new Set();

            for (const category in data) {
                for (const component in data[category]) {
                    for (const partName in data[category][component]) {
                        const e = data[category][component][partName] || {};
                        if (!e.affiliateUrl) continue; // only show items with a buy link
                        catSet.add(category);
                        compSet.add(component);
                        items.push({
                            name: partName,
                            category,
                            component,
                            description: e.description || "",
                            price: e.price,
                            affiliateUrl: e.affiliateUrl,
                            asin: e.asin || "",
                            imageUrl: (e.imageUrl && e.imageUrl.trim())
                                ? e.imageUrl
                                : `assets/img/database/${encodeURIComponent(partName)}.png`,
                            tags: e.tags || []
                        });
                    }
                }
            }
            return { items, categories: [...catSet].sort(), components: [...compSet].sort() };
        }

        function renderFilters(categories, components) {
            catSel.innerHTML = '<option value="">All Categories</option>' +
                categories.map(c => `<option>${escapeHtml(c)}</option>`).join("");
            compSel.innerHTML = '<option value="">All Sub-Categories</option>' +
                components.map(c => `<option>${escapeHtml(c)}</option>`).join("");
        }

        catSel.addEventListener("change", render);
        compSel.addEventListener("change", render);
        searchBox.addEventListener("input", render);

        function render() {
            const cat = catSel.value;
            const comp = compSel.value;
            const q = (searchBox.value || "").trim().toLowerCase();

            const filtered = allItems.filter(it => {
                const hitCat = !cat || it.category === cat;
                const hitComp = !comp || it.component === comp;
                const hay = `${it.name} ${it.category} ${it.component} ${it.description} ${(it.tags || []).join(" ")}`.toLowerCase();
                const hitQ = !q || hay.includes(q);
                return hitCat && hitComp && hitQ;
            });

            grid.innerHTML = "";
            if (!filtered.length) {
                emptyState.style.display = "block";
                return;
            }
            emptyState.style.display = "none";

            filtered.forEach(p => {
                const price = parseFloat(p.price);
                const priceText = isNaN(price) ? "" : `$${price.toFixed(2)}`;
                const el = document.createElement("div");
                el.className = "product-item";
                el.innerHTML = `
          <img src="${escapeAttr(p.imageUrl)}" alt="${escapeAttr(p.name)}" loading="lazy">
          <h3>${escapeHtml(p.name)}</h3>
          <p class="meta">${escapeHtml(p.category)} â€¢ ${escapeHtml(p.component)}</p>
          ${priceText ? `<p class="our-price">Our listed price: ${priceText}</p>` : ""}
          <a class="cta-button"
             href="${escapeAttr(ensureAffiliateTag(p.affiliateUrl, affiliateTag || 'YOURTAG-20'))}"
             target="_blank" rel="sponsored nofollow noopener"
             data-asin="${escapeAttr(p.asin)}">View on Amazon</a>
          <small class="aff-note">As an Amazon Associate, we earn from qualifying purchases.</small>
        `;
                grid.appendChild(el);
            });
        }

        function ensureAffiliateTag(url, tag) {
            try {
                const u = new URL(url, window.location.origin);
                if (tag) u.searchParams.set("tag", tag);
                return u.toString();
            } catch {
                return url;
            }
        }

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }
        function escapeAttr(s = "") { return escapeHtml(String(s)); }

        // First bind immediately so logged-out users see /public
        setBase("public");
    </script>
</body>

</html>