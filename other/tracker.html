<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Job Information Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Auth / login UI -->
  <script type="module" src="../apps/assets/js/login.js" defer></script>

  <!-- Your existing CSS (walmart-tracker look) -->
  <link rel="stylesheet" href="./assets/css/tracker.css" />

  <style>
    .hidden {
      display: none !important;
    }

    .thumb-strip {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .thumb-wrapper {
      border: 1px solid var(--border-subtle, #202637);
      border-radius: 12px;
      padding: 8px;
      width: 180px;
    }

    .thumb-img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: 10px;
      cursor: pointer;
    }

    .thumb-delete {
      float: right;
      margin-top: 6px;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      cursor: pointer;
    }

    .thumb-note {
      width: 100%;
      margin-top: 6px;
      resize: vertical;
    }

    .project-links-card {
      margin-top: 12px;
      border: 1px solid var(--border-subtle, #202637);
      border-radius: 14px;
      padding: 10px;
    }

    .project-links-header {
      font-weight: 700;
      margin-bottom: 8px;
    }

    .project-links-list {
      list-style: none;
      padding: 0;
      margin: 0 0 10px 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .project-links-form {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .project-link-input {
      flex: 1;
      min-width: 180px;
    }

    .project-link-add-btn {
      white-space: nowrap;
    }
  </style>
</head>

<body>

  <header>
    <h1>Job Information Manager</h1>

    <div class="header-login">
      <div id="login-section">
        <form id="login-form" class="login-form">
          <input type="email" id="username" placeholder="Email" required>
          <input type="password" id="password" placeholder="Password" required>
          <button type="submit" class="login-btn">Login</button>
        </form>
        <button id="logout" class="logout-btn" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div class="app-shell">

      <!-- SIDEBAR -->
      <aside class="sidebar card">

        <div class="main-header">
          <div id="sectionTitle">Select a project</div>
          <div id="sectionMeta"></div>
        </div>

        <!-- Site name (saved to record.customerName) -->
        <div class="row">
          <div class="field" style="flex:1;">
            <label for="siteNameInput">Site Name</label>
            <input type="text" id="siteNameInput" placeholder="Enter site name..." />
          </div>
        </div>

        <div class="sidebar-header">

          <div class="field">
            <label for="projectDropdown">Select existing project:</label>
            <select id="projectDropdown" class="project-link-input">
              <option value="">(loading...)</option>
            </select>
          </div>

          <div class="project-row">
            <input id="projectNameInput" placeholder="New project" />
            <button id="setProjectBtn" type="button">Create</button>
          </div>

          <div class="small-muted" style="margin-top:6px;">
            Tip: Pick an existing project from the dropdown to load it. Use Set to create a new one.
          </div>
          <br>

          <div class="row">
            <button id="clearAppDataBtn" type="button" class="danger-btn">Clear App Data</button>
          </div>
          <br>

          <div class="pill-sub">
            Data path: <code id="dataPathLabel">public</code>
          </div>

          <!-- Project links -->
          <div class="project-links-card">
            <div class="project-links-header">Project links</div>
            <ul id="projectLinksList" class="project-links-list"></ul>

            <form id="projectLinksForm" class="project-links-form">
              <input type="text" id="projectLinkTitle" placeholder="Title" class="project-link-input">
              <input type="url" id="projectLinkUrl" placeholder="URL (https://...)" class="project-link-input">
              <button type="submit" class="project-link-add-btn">Add</button>
            </form>
          </div>

          <div class="progress-row">
            <span>Items summary</span>
            <span id="sidebarSummary">0 daily tasks • 0 lists • 0 items</span>
          </div>
        </div>

        <!-- Pills -->
        <div class="pill-list" id="sectionList"></div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main card">

        <!-- Global search -->
        <div class="camera-search-row">
          <input type="text" id="globalSearchInput"
            placeholder="Search daily tasks + list items (id, model, type, location, status, IP, MAC, notes)…">
        </div>

        <!-- DAILY TASKS PANEL -->
        <div id="dailyTasksPanel" class="detail-panel hidden">
          <div class="card">
            <div class="panel-toolbar">
              <div><strong>Daily Tasks / Notes</strong> <span class="small-muted" id="dailyTasksCountLabel"></span>
              </div>
              <div class="small-muted">Edits save on blur • Images optional</div>
            </div>

            <div style="overflow:auto;">
              <table class="detail-table" id="dailyTasksTable">
                <thead>
                  <tr>
                    <th style="width:180px;">Date/Time</th>
                    <th>Notes</th>
                    <th style="width:240px;">Images</th>
                    <th style="width:160px;">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <hr />

            <div class="panel-toolbar">
              <div><strong>Add new daily task</strong></div>
            </div>

            <div class="row">
              <input type="datetime-local" id="newDailyTaskDate" />
              <input type="text" id="newDailyTaskNotes" placeholder="Notes..." />
              <button id="addDailyTaskBtn" type="button">Add</button>
            </div>
          </div>
        </div>

        <!-- LISTS PANEL -->
        <div id="listsPanel" class="detail-panel hidden">
          <div class="card">

            <div class="panel-toolbar">
              <div>
                <strong id="activeListTitle">List</strong>
                <span class="small-muted" id="activeListCountLabel"></span>
              </div>

              <div class="inline-btns">
                <button id="deleteListBtn" type="button" class="danger-btn">Delete List</button>
              </div>
            </div>

            <div class="row" style="align-items:flex-end;">
              <div class="field" style="flex:1;">
                <label for="newListName">Create new list</label>
                <input id="newListName" placeholder="e.g. Cameras, Controllers, Maglocks..." />
              </div>
              <button id="createListBtn" type="button">Create</button>
            </div>

            <hr />

            <div class="panel-toolbar">
              <div><strong>Add item to this list</strong></div>
              <div class="small-muted">ID is the key • edits save on blur</div>
            </div>

            <div class="row" style="flex-wrap:wrap;">
              <input id="item_id" placeholder="ID (key)" style="width:140px;" />
              <input id="item_model" placeholder="Model" />
              <input id="item_type" placeholder="Type" />
              <input id="item_location" placeholder="Location" />
              <input id="item_status" placeholder="Status" />
              <input id="item_ip" placeholder="IP" style="width:160px;" />
              <input id="item_mac" placeholder="MAC" style="width:190px;" />
              <button id="addItemBtn" type="button">Add Item</button>
            </div>

            <div style="overflow:auto; margin-top:8px;">
              <table class="detail-table" id="activeListTable">
                <thead>
                  <tr>
                    <th style="width:120px;">ID</th>
                    <th>Model</th>
                    <th>Type</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th style="width:150px;">IP</th>
                    <th style="width:170px;">MAC</th>
                    <th style="width:240px;">Images</th>
                    <th style="width:210px;">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- Shared hidden file input -->
        <input type="file" id="imageUploadInput" accept="image/*" class="hidden" />
      </main>

    </div>
  </main>

  <script type="module">
    import {
      auth,
      onAuthStateChanged,
      database,
      storage,
      ref,
      set,
      update,
      remove,
      get,
      onValue,
      off,
      storageRef,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "../apps/assets/js/firebase-init.js";

    // ----------------------------
    // Base path
    // ----------------------------
    let DATABASE_BASE_PATH = "public";
    onAuthStateChanged(auth, (user) => {
      DATABASE_BASE_PATH = user ? `${user.uid}` : "public";
      dataPathLabel.textContent = DATABASE_BASE_PATH;

      startTasksDropdownListener();

      if (state.recordId) loadRecordById(state.recordId);
    });

    // {base}/tasks/{recordId}/...
    const TASKS_ROOT = () => `${DATABASE_BASE_PATH}/tasks`;
    const RECORD_PATH = (id = state.recordId) => `${TASKS_ROOT()}/${id}`;

    // ----------------------------
    // State
    // ----------------------------
    const state = {
      recordId: "",
      recordName: "",
      activePanel: "daily",   // daily | lists
      activeListId: "",
      globalQuery: "",

      recordListenerRef: null,
      recordListenerCb: null,
      dropdownListenerRef: null,

      projectFieldName: "", // record.project
      customerName: "",     // record.customerName (used as "Site Name")
      meta: { updatedAt: 0 }, // ONLY what we need

      links: [],
      lists: {},
      daily: {}
    };

    // ----------------------------
    // DOM
    // ----------------------------
    const sectionListEl = document.getElementById("sectionList");
    const sectionTitleEl = document.getElementById("sectionTitle");
    const sectionMetaEl = document.getElementById("sectionMeta");

    const projectDropdown = document.getElementById("projectDropdown");
    const projectNameInput = document.getElementById("projectNameInput");
    const setProjectBtn = document.getElementById("setProjectBtn");
    const clearAppDataBtn = document.getElementById("clearAppDataBtn");

    const sidebarSummary = document.getElementById("sidebarSummary");
    const dataPathLabel = document.getElementById("dataPathLabel");
    const globalSearchInput = document.getElementById("globalSearchInput");

    const siteNameInput = document.getElementById("siteNameInput");

    const dailyTasksPanel = document.getElementById("dailyTasksPanel");
    const listsPanel = document.getElementById("listsPanel");

    const dailyTasksTableBody = document.querySelector("#dailyTasksTable tbody");
    const dailyTasksCountLabel = document.getElementById("dailyTasksCountLabel");
    const newDailyTaskDate = document.getElementById("newDailyTaskDate");
    const newDailyTaskNotes = document.getElementById("newDailyTaskNotes");
    const addDailyTaskBtn = document.getElementById("addDailyTaskBtn");

    const projectLinksList = document.getElementById("projectLinksList");
    const projectLinksForm = document.getElementById("projectLinksForm");
    const projectLinkTitle = document.getElementById("projectLinkTitle");
    const projectLinkUrl = document.getElementById("projectLinkUrl");

    const activeListTitle = document.getElementById("activeListTitle");
    const activeListCountLabel = document.getElementById("activeListCountLabel");
    const newListName = document.getElementById("newListName");
    const createListBtn = document.getElementById("createListBtn");
    const deleteListBtn = document.getElementById("deleteListBtn");

    const itemInputs = {
      id: document.getElementById("item_id"),
      model: document.getElementById("item_model"),
      type: document.getElementById("item_type"),
      location: document.getElementById("item_location"),
      status: document.getElementById("item_status"),
      ipAddress: document.getElementById("item_ip"),
      macAddress: document.getElementById("item_mac"),
    };
    const addItemBtn = document.getElementById("addItemBtn");
    const activeListTableBody = document.querySelector("#activeListTable tbody");

    const imageUploadInput = document.getElementById("imageUploadInput");
    let pendingUploadTarget = null; // { kind:'daily'|'listItem', dailyKey?, listId?, itemId? }

    // ----------------------------
    // Helpers
    // ----------------------------
    function dbRef(path) { return ref(database, path); }

    function sanitizeKey(name) {
      return String(name || "")
        .trim()
        .toLowerCase()
        .replace(/[.#$/\[\]]/g, "_")
        .replace(/\s+/g, "_");
    }

    function matchesAny(...vals) {
      const q = (state.globalQuery || "").trim().toLowerCase();
      if (!q) return true;
      return vals.some(v => String(v || "").toLowerCase().includes(q));
    }

    function ensureImagesArray(obj) {
      if (!obj) return [];
      if (!Array.isArray(obj.images)) obj.images = [];
      return obj.images;
    }

    function collectImagePaths(obj) {
      const out = [];
      if (!obj) return out;
      if (Array.isArray(obj.images)) obj.images.forEach(img => { if (img?.path) out.push(img.path); });
      return out;
    }

    function resizeImageToJpeg(file, maxWidth = 2048, quality = 0.9) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            let w = img.width, h = img.height;
            if (w > maxWidth) { const s = maxWidth / w; w = maxWidth; h = Math.round(h * s); }
            const canvas = document.createElement("canvas");
            canvas.width = w; canvas.height = h;
            canvas.getContext("2d").drawImage(img, 0, 0, w, h);
            canvas.toBlob((blob) => blob ? resolve(blob) : reject(new Error("toBlob returned null")), "image/jpeg", quality);
          };
          img.onerror = () => reject(new Error("Image decode failed"));
          img.src = reader.result;
        };
        reader.onerror = () => reject(reader.error || new Error("FileReader failed"));
        reader.readAsDataURL(file);
      });
    }

    async function touchRecord() {
      if (!state.recordId) return;
      await update(dbRef(`${RECORD_PATH()}/meta`), { updatedAt: Date.now() });
    }

    async function dbUpdate(path, patch, touch = true) {
      await update(dbRef(path), patch);
      if (touch) await touchRecord();
    }
    async function dbSet(path, value, touch = true) {
      await set(dbRef(path), value);
      if (touch) await touchRecord();
    }
    async function dbRemove(path, touch = true) {
      await remove(dbRef(path));
      if (touch) await touchRecord();
    }

    function storageImagePath({ kind, dailyKey, listId, itemId }) {
      const ts = Date.now();
      if (kind === "daily") {
        return `images/${DATABASE_BASE_PATH}/tasks/${state.recordId}/daily/${encodeURIComponent(dailyKey)}/${ts}.jpg`;
      }
      return `images/${DATABASE_BASE_PATH}/tasks/${state.recordId}/lists/${listId}/${itemId}/${ts}.jpg`;
    }

    async function createNewProjectWithName(name) {
      const now = Date.now();
      const newId = String(now);

      // Create a fresh record at {base}/tasks/{timestamp}
      await set(dbRef(RECORD_PATH(newId)), {
        project: name,
        customerName: "",
        meta: { updatedAt: now },
        tasks: {},
        lists: {},
        links: []
      });

      await loadRecordById(newId);

      // Sync UI
      projectDropdown.value = newId;
      if (projectNameInput) projectNameInput.value = "";

      return newId;
    }

    // ----------------------------
    // Panels
    // ----------------------------
    function setActivePanel(panel) {
      state.activePanel = panel;

      dailyTasksPanel.classList.toggle("hidden", panel !== "daily");
      listsPanel.classList.toggle("hidden", panel !== "lists");

      renderHeader();
      renderSidebarPills();
      renderAll();
    }

    function renderHeader() {
      if (!state.recordId) {
        sectionTitleEl.textContent = "Select a project";
        sectionMetaEl.textContent = "";
        return;
      }

      const displayName = state.projectFieldName || state.recordName || state.recordId;
      const dailyCount = Object.keys(state.daily || {}).length;
      const listCount = Object.keys(state.lists || {}).length;

      if (state.activePanel === "daily") {
        sectionTitleEl.textContent = "Daily Tasks / Notes";
        sectionMetaEl.textContent = `Project: ${displayName} • ${dailyCount} daily task(s)`;
      } else {
        const list = state.lists[state.activeListId];
        const name = list?.meta?.name || "List";
        const itemCount = Object.keys(list?.items || {}).length;
        sectionTitleEl.textContent = name;
        sectionMetaEl.textContent = `Project: ${displayName} • ${itemCount} item(s) • ${listCount} list(s)`;
      }
    }

    function renderSidebarSummary() {
      const dailyCount = Object.keys(state.daily || {}).length;
      const listIds = Object.keys(state.lists || {});
      const listCount = listIds.length;
      const itemCount = listIds.reduce((acc, id) => acc + Object.keys(state.lists[id]?.items || {}).length, 0);
      sidebarSummary.textContent = `${dailyCount} daily tasks • ${listCount} lists • ${itemCount} items`;
    }

    function renderSidebarPills() {
      sectionListEl.innerHTML = "";
      renderSidebarSummary();

      const makePill = ({ title, right, isActive, onClick }) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "section-pill" + (isActive ? " active" : "");
        btn.innerHTML = `
          <span class="label">${title}</span>
          <span class="pill-progress">
            <span class="pill-dot ${right === "✓" ? "done" : ""}"></span>
            <span>${right}</span>
          </span>
        `;
        btn.addEventListener("click", onClick);
        sectionListEl.appendChild(btn);
      };

      makePill({
        title: "Daily Tasks",
        right: String(Object.keys(state.daily || {}).length),
        isActive: state.activePanel === "daily",
        onClick: () => setActivePanel("daily")
      });

      const listIds = Object.keys(state.lists || {}).sort((a, b) => {
        const an = (state.lists[a]?.meta?.name || a).toLowerCase();
        const bn = (state.lists[b]?.meta?.name || b).toLowerCase();
        return an.localeCompare(bn);
      });

      listIds.forEach(listId => {
        const list = state.lists[listId];
        const title = list?.meta?.name || listId;
        const count = Object.keys(list?.items || {}).length;
        makePill({
          title,
          right: String(count),
          isActive: state.activePanel === "lists" && state.activeListId === listId,
          onClick: () => {
            state.activeListId = listId;
            setActivePanel("lists");
          }
        });
      });

      if (!listIds.length) {
        makePill({
          title: "Lists",
          right: "0",
          isActive: state.activePanel === "lists",
          onClick: () => setActivePanel("lists")
        });
      }
    }

    // ----------------------------
    // Project links
    // ----------------------------
    function renderProjectLinks() {
      projectLinksList.innerHTML = "";

      if (!state.recordId) {
        const li = document.createElement("li");
        li.style.color = "var(--text-muted,#8d96a8)";
        li.textContent = "(No project selected)";
        projectLinksList.appendChild(li);
        return;
      }

      const links = Array.isArray(state.links) ? state.links : [];
      if (!links.length) {
        const li = document.createElement("li");
        li.style.color = "var(--text-muted,#8d96a8)";
        li.textContent = "(No links yet)";
        projectLinksList.appendChild(li);
        return;
      }

      const sorted = links.slice().sort((a, b) =>
        (a.title || "").localeCompare((b.title || ""), undefined, { sensitivity: "base" })
      );

      sorted.forEach((link) => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.alignItems = "center";
        li.style.justifyContent = "space-between";
        li.style.gap = "6px";

        const a = document.createElement("a");
        a.href = link.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = link.title || link.url;
        a.style.color = "var(--accent,#2f81f7)";
        a.style.textDecoration = "none";

        const del = document.createElement("button");
        del.textContent = "×";
        del.title = "Remove link";
        del.style.borderRadius = "999px";
        del.style.border = "1px solid var(--border-subtle,#202637)";
        del.style.background = "#050814";
        del.style.color = "var(--text,#e4e8f0)";
        del.style.cursor = "pointer";
        del.style.padding = "0 8px";

        del.addEventListener("click", async () => {
          const idx = (state.links || []).findIndex(l => l.title === link.title && l.url === link.url);
          if (idx < 0) return;
          const next = state.links.slice();
          next.splice(idx, 1);
          await dbUpdate(RECORD_PATH(), { links: next });
        });

        li.appendChild(a);
        li.appendChild(del);
        projectLinksList.appendChild(li);
      });
    }

    // ----------------------------
    // Thumb strip (shared)
    // ----------------------------
    function renderThumbStrip({ images, onOpen, onDelete, onNoteBlur }) {
      const wrap = document.createElement("div");
      wrap.className = "thumb-strip";

      (Array.isArray(images) ? images : []).forEach((img, idx) => {
        const w = document.createElement("div");
        w.className = "thumb-wrapper";

        const thumb = document.createElement("img");
        thumb.className = "thumb-img";
        thumb.src = img.url;
        thumb.addEventListener("click", () => onOpen(img.url));

        const del = document.createElement("button");
        del.className = "thumb-delete";
        del.textContent = "×";
        del.addEventListener("click", () => onDelete(idx));

        const note = document.createElement("textarea");
        note.className = "thumb-note";
        note.rows = 2;
        note.placeholder = "Notes…";
        note.value = img.note || "";
        note.addEventListener("blur", () => onNoteBlur(idx, note.value));

        w.appendChild(thumb);
        w.appendChild(del);
        w.appendChild(note);
        wrap.appendChild(w);
      });

      return wrap;
    }

    // ----------------------------
    // Daily tasks (record.tasks) + images
    // ----------------------------
    function renderDailyTasks() {
      dailyTasksTableBody.innerHTML = "";
      if (!state.recordId) return;

      const entries = Object.entries(state.daily || {})
        .map(([k, v]) => ({
          key: k,
          date: v?.date || "",
          notes: v?.notes || "",
          images: Array.isArray(v?.images) ? v.images : []
        }))
        .filter(t => matchesAny(t.key, t.date, t.notes))
        .sort((a, b) => String(b.date).localeCompare(String(a.date)));

      dailyTasksCountLabel.textContent = `(${entries.length})`;

      entries.forEach((t) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        const dateInput = document.createElement("input");
        dateInput.type = "datetime-local";
        dateInput.value = t.date || "";
        dateInput.addEventListener("blur", async () => {
          await dbUpdate(`${RECORD_PATH()}/tasks/${t.key}`, { date: dateInput.value || "" });
        });
        tdDate.appendChild(dateInput);

        const tdNotes = document.createElement("td");
        const notesArea = document.createElement("textarea");
        notesArea.value = t.notes || "";
        notesArea.placeholder = "Notes...";
        notesArea.addEventListener("blur", async () => {
          await dbUpdate(`${RECORD_PATH()}/tasks/${t.key}`, { notes: notesArea.value || "" });
        });
        tdNotes.appendChild(notesArea);

        const tdImg = document.createElement("td");
        const addImgBtn = document.createElement("button");
        addImgBtn.textContent = "Add Image";
        addImgBtn.addEventListener("click", () => {
          pendingUploadTarget = { kind: "daily", dailyKey: t.key };
          imageUploadInput.value = "";
          imageUploadInput.click();
        });
        tdImg.appendChild(addImgBtn);

        tdImg.appendChild(renderThumbStrip({
          images: t.images,
          onOpen: (url) => window.open(url, "_blank"),
          onDelete: async (index) => {
            if (!confirm("Delete this image?")) return;

            const currentObj = state.daily[t.key] || {};
            const imgs = ensureImagesArray(currentObj).slice();
            const [removed] = imgs.splice(index, 1);

            await dbUpdate(`${RECORD_PATH()}/tasks/${t.key}`, { images: imgs });

            if (removed?.path) {
              try { await deleteObject(storageRef(storage, removed.path)); } catch (e) { console.warn(e); }
            }
          },
          onNoteBlur: async (index, noteVal) => {
            const currentObj = state.daily[t.key] || {};
            const imgs = ensureImagesArray(currentObj).slice();
            if (!imgs[index]) return;
            imgs[index].note = noteVal || "";
            await dbUpdate(`${RECORD_PATH()}/tasks/${t.key}`, { images: imgs });
          }
        }));

        const tdActions = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "danger-btn";
        delBtn.addEventListener("click", async () => {
          if (!confirm("Delete this daily task (and its images)?")) return;

          const currentObj = state.daily[t.key] || {};
          const paths = collectImagePaths(currentObj);

          await dbRemove(`${RECORD_PATH()}/tasks/${t.key}`);

          for (const p of paths) {
            try { await deleteObject(storageRef(storage, p)); } catch (e) { console.warn(e); }
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdDate);
        tr.appendChild(tdNotes);
        tr.appendChild(tdImg);
        tr.appendChild(tdActions);
        dailyTasksTableBody.appendChild(tr);
      });
    }

    async function addDailyTask() {
      if (!state.recordId) return alert("Select a project first.");

      const dt = (newDailyTaskDate.value || "").trim();
      const notes = (newDailyTaskNotes.value || "").trim();
      if (!dt || !notes) return alert("Enter a date/time and notes.");

      const key = dt;
      await dbSet(`${RECORD_PATH()}/tasks/${key}`, { date: dt, notes, images: [] });

      newDailyTaskDate.value = "";
      newDailyTaskNotes.value = "";
    }

    // ----------------------------
    // Lists (record.lists) + items + images
    // ----------------------------
    function renderActiveList() {
      activeListTableBody.innerHTML = "";

      if (!state.recordId) {
        activeListTitle.textContent = "List";
        activeListCountLabel.textContent = "";
        return;
      }

      const listId = state.activeListId;
      const list = state.lists[listId];

      if (!list) {
        activeListTitle.textContent = "Lists";
        activeListCountLabel.textContent = " (create a list to begin)";
        return;
      }

      const listName = list.meta?.name || listId;
      activeListTitle.textContent = listName;

      const rows = Object.entries(list.items || {})
        .map(([k, v]) => ({
          key: k,
          id: v?.id ?? k,
          model: v?.model || "",
          type: v?.type || "",
          location: v?.location || "",
          status: v?.status || "",
          ipAddress: v?.ipAddress || "",
          macAddress: v?.macAddress || "",
          notes: v?.notes || "",
          images: Array.isArray(v?.images) ? v.images : []
        }))
        .filter(r => matchesAny(r.key, r.id, r.model, r.type, r.location, r.status, r.ipAddress, r.macAddress, r.notes))
        .sort((a, b) => String(a.id).localeCompare(String(b.id), undefined, { numeric: true }));

      activeListCountLabel.textContent = `(${rows.length})`;

      rows.forEach((r) => {
        const tr = document.createElement("tr");

        const mkTdInput = (val, onBlur, width = "") => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.value = val || "";
          if (width) input.style.width = width;
          input.addEventListener("blur", onBlur);
          td.appendChild(input);
          return { td, input };
        };

        const baseItemPath = `${RECORD_PATH()}/lists/${listId}/items/${r.key}`;

        const { td: tdId, input: idInput } = mkTdInput(r.id, async () => {
          await dbUpdate(baseItemPath, { id: idInput.value.trim() });
        });

        const { td: tdModel, input: modelInput } = mkTdInput(r.model, async () => {
          await dbUpdate(baseItemPath, { model: modelInput.value });
        });

        const { td: tdType, input: typeInput } = mkTdInput(r.type, async () => {
          await dbUpdate(baseItemPath, { type: typeInput.value });
        });

        const { td: tdLoc, input: locInput } = mkTdInput(r.location, async () => {
          await dbUpdate(baseItemPath, { location: locInput.value });
        });

        const { td: tdStatus, input: statusInput } = mkTdInput(r.status, async () => {
          await dbUpdate(baseItemPath, { status: statusInput.value });
        });

        const { td: tdIp, input: ipInput } = mkTdInput(r.ipAddress, async () => {
          await dbUpdate(baseItemPath, { ipAddress: ipInput.value });
        });

        const { td: tdMac, input: macInput } = mkTdInput(r.macAddress, async () => {
          await dbUpdate(baseItemPath, { macAddress: macInput.value });
        });

        const tdImg = document.createElement("td");
        const addImgBtn = document.createElement("button");
        addImgBtn.textContent = "Add Image";
        addImgBtn.addEventListener("click", () => {
          pendingUploadTarget = { kind: "listItem", listId, itemId: r.key };
          imageUploadInput.value = "";
          imageUploadInput.click();
        });
        tdImg.appendChild(addImgBtn);

        tdImg.appendChild(renderThumbStrip({
          images: r.images,
          onOpen: (url) => window.open(url, "_blank"),
          onDelete: async (index) => {
            if (!confirm("Delete this item image?")) return;

            const itemObj = state.lists[listId]?.items?.[r.key] || {};
            const imgs = ensureImagesArray(itemObj).slice();
            const [removed] = imgs.splice(index, 1);

            await dbUpdate(baseItemPath, { images: imgs });

            if (removed?.path) {
              try { await deleteObject(storageRef(storage, removed.path)); } catch (e) { console.warn(e); }
            }
          },
          onNoteBlur: async (index, noteVal) => {
            const itemObj = state.lists[listId]?.items?.[r.key] || {};
            const imgs = ensureImagesArray(itemObj).slice();
            if (!imgs[index]) return;
            imgs[index].note = noteVal || "";
            await dbUpdate(baseItemPath, { images: imgs });
          }
        }));

        const tdActions = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "danger-btn";
        delBtn.addEventListener("click", async () => {
          if (!confirm(`Delete item "${r.key}" (and images)?`)) return;

          const itemObj = state.lists[listId]?.items?.[r.key] || {};
          const paths = collectImagePaths(itemObj);

          await dbRemove(baseItemPath);

          for (const p of paths) {
            try { await deleteObject(storageRef(storage, p)); } catch (e) { console.warn(e); }
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdId);
        tr.appendChild(tdModel);
        tr.appendChild(tdType);
        tr.appendChild(tdLoc);
        tr.appendChild(tdStatus);
        tr.appendChild(tdIp);
        tr.appendChild(tdMac);
        tr.appendChild(tdImg);
        tr.appendChild(tdActions);

        activeListTableBody.appendChild(tr);
      });
    }

    async function createList() {
      if (!state.recordId) return alert("Select a project first.");
      const name = (newListName.value || "").trim();
      if (!name) return alert("Enter a list name.");

      const listId = sanitizeKey(name);

      await dbSet(`${RECORD_PATH()}/lists/${listId}`, {
        meta: { name, createdAt: Date.now() }, // list-level createdAt is fine; optional
        items: {}
      });

      state.activeListId = listId;
      newListName.value = "";
      setActivePanel("lists");
    }

    async function deleteActiveList() {
      if (!state.recordId) return alert("Select a project first.");
      if (!state.activeListId) return alert("No list selected.");

      const list = state.lists[state.activeListId];
      const name = list?.meta?.name || state.activeListId;

      if (!confirm(`Delete list "${name}" and all items/images?`)) return;

      const items = list?.items || {};
      const paths = [];
      Object.values(items).forEach(item => paths.push(...collectImagePaths(item)));

      await dbRemove(`${RECORD_PATH()}/lists/${state.activeListId}`);

      for (const p of paths) {
        try { await deleteObject(storageRef(storage, p)); } catch (e) { console.warn(e); }
      }

      state.activeListId = "";
      setActivePanel("daily");
    }

    async function addItemToActiveList() {
      if (!state.recordId) return alert("Select a project first.");
      if (!state.activeListId) return alert("Select or create a list first.");

      const listId = state.activeListId;
      const id = (itemInputs.id.value || "").trim();
      if (!id) return alert("ID is required.");

      const item = {
        id,
        model: itemInputs.model.value || "",
        type: itemInputs.type.value || "",
        location: itemInputs.location.value || "",
        status: itemInputs.status.value || "",
        ipAddress: itemInputs.ipAddress.value || "",
        macAddress: itemInputs.macAddress.value || "",
        notes: "",
        images: []
      };

      await dbSet(`${RECORD_PATH()}/lists/${listId}/items/${id}`, item);

      Object.values(itemInputs).forEach(el => el.value = "");
    }

    // ----------------------------
    // Upload handler
    // ----------------------------
    imageUploadInput.addEventListener("change", async () => {
      const file = imageUploadInput.files[0];
      if (!file || !pendingUploadTarget || !state.recordId) return;

      const target = pendingUploadTarget;
      pendingUploadTarget = null;

      try {
        const resizedBlob = await resizeImageToJpeg(file, 2048, 0.9);

        let storagePath;
        let dbNodePath;

        if (target.kind === "daily") {
          storagePath = storageImagePath({ kind: "daily", dailyKey: target.dailyKey });
          dbNodePath = `${RECORD_PATH()}/tasks/${target.dailyKey}`;
        } else {
          storagePath = storageImagePath({ kind: "listItem", listId: target.listId, itemId: target.itemId });
          dbNodePath = `${RECORD_PATH()}/lists/${target.listId}/items/${target.itemId}`;
        }

        const sRef = storageRef(storage, storagePath);
        await uploadBytes(sRef, resizedBlob, { contentType: "image/jpeg" });
        const url = await getDownloadURL(sRef);

        const snap = await get(dbRef(dbNodePath));
        const current = snap.val() || {};
        const images = Array.isArray(current.images) ? current.images.slice() : [];
        images.push({ url, path: storagePath, note: "" });

        await dbUpdate(dbNodePath, { images });
      } catch (err) {
        console.error(err);
        alert("Image upload failed (check console).");
      } finally {
        imageUploadInput.value = "";
      }
    });

    // ----------------------------
    // Ensure meta exists (NO createdAt, NO projectName)
    // ----------------------------
    async function ensureMetaExists() {
      if (!state.recordId) return;
      const metaRef = dbRef(`${RECORD_PATH()}/meta`);
      const snap = await get(metaRef);

      if (!snap.exists()) {
        await update(dbRef(RECORD_PATH()), {
          meta: { updatedAt: Date.now() }
        });
      }
    }

    // ----------------------------
    // Load a record by ID
    // ----------------------------
    async function loadRecordById(id) {
      if (!id) return;

      if (state.recordListenerRef && state.recordListenerCb) {
        try { off(state.recordListenerRef, "value", state.recordListenerCb); } catch { }
      }

      state.recordId = id;

      state.recordListenerRef = dbRef(RECORD_PATH(id));
      state.recordListenerCb = async (snap) => {
        if (!snap.exists()) return;

        const data = snap.val() || {};

        state.customerName = data.customerName || "";
        state.projectFieldName = data.project || "";
        state.recordName = state.projectFieldName || id;

        state.meta = data.meta || { updatedAt: 0 };
        state.links = Array.isArray(data.links) ? data.links : [];
        state.lists = data.lists || {};
        state.daily = data.tasks || {};

        const listIds = Object.keys(state.lists || {});
        if (state.activeListId && !state.lists[state.activeListId]) state.activeListId = "";
        if (!state.activeListId && listIds.length) state.activeListId = listIds[0];

        renderHeader();
        renderSidebarPills();
        renderAll();
      };

      onValue(state.recordListenerRef, state.recordListenerCb);

      await ensureMetaExists();
      setActivePanel("daily");
    }

    // ----------------------------
    // Dropdown listener: list all {base}/tasks/*
    // ----------------------------
    function startTasksDropdownListener() {
      if (state.dropdownListenerRef) {
        try { off(state.dropdownListenerRef); } catch { }
      }

      state.dropdownListenerRef = dbRef(TASKS_ROOT());

      onValue(state.dropdownListenerRef, (snap) => {
        projectDropdown.innerHTML = `<option value="">Select project</option>`;
        if (!snap.exists()) return;

        const rows = [];
        snap.forEach(child => {
          const id = child.key;
          const v = child.val() || {};
          const projectName = (v.project || "").trim();
          const customerName = (v.customerName || "").trim();
          const updatedAt = v.meta?.updatedAt || v.updatedAt || 0;

          rows.push({
            id,
            projectName: projectName || id,        // fallback if project is blank
            customerName: customerName || "—",     // fallback if site name blank
            updatedAt
          });
        });

        rows.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        rows.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = `${r.projectName} (${r.customerName})`;
          projectDropdown.appendChild(opt);
        });

        if (state.recordId) projectDropdown.value = state.recordId;
      });
    }

    // ----------------------------
    // Render all
    // ----------------------------
    function renderAll() {
      renderProjectLinks();

      if (!state.recordId) {
        dailyTasksTableBody.innerHTML = "";
        activeListTableBody.innerHTML = "";
        dailyTasksCountLabel.textContent = "";
        activeListCountLabel.textContent = "";
        return;
      }

      const siteVal = state.customerName || "";
      if (document.activeElement !== siteNameInput && siteNameInput.value !== siteVal) {
        siteNameInput.value = siteVal;
      }

      if (state.activePanel === "daily") renderDailyTasks();
      if (state.activePanel === "lists") renderActiveList();
    }

    // ----------------------------
    // Events
    // ----------------------------
    setProjectBtn.addEventListener("click", async () => {
      const name = (projectNameInput.value || "").trim();
      if (!name) return alert("Enter a project name to create.");

      await createNewProjectWithName(name);
    });

    projectNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        setProjectBtn.click();
      }
    });

    projectDropdown.addEventListener("change", async () => {
      const id = projectDropdown.value;
      if (!id) return;
      await loadRecordById(id);
    });

    // Clear only THIS APP's sections, not the main record fields (like project, startTime, etc.)
    clearAppDataBtn.addEventListener("click", async () => {
      if (!state.recordId) return alert("No project selected.");
      if (!confirm("Clear app data for this record? (customerName, daily tasks, lists, links)")) return;

      await dbUpdate(RECORD_PATH(), {
        customerName: "",
        meta: { ...state.meta, updatedAt: Date.now() },
        tasks: {},
        lists: {},
        links: []
      }, false);

      await touchRecord();

      state.activeListId = "";
      setActivePanel("daily");
    });

    // Save "Site Name" into customerName at the record root
    siteNameInput.addEventListener("blur", async () => {
      if (!state.recordId) return;
      const val = (siteNameInput.value || "").trim();
      await dbUpdate(RECORD_PATH(), { customerName: val });
    });

    addDailyTaskBtn.addEventListener("click", addDailyTask);

    createListBtn.addEventListener("click", createList);
    deleteListBtn.addEventListener("click", deleteActiveList);
    addItemBtn.addEventListener("click", addItemToActiveList);

    globalSearchInput.addEventListener("input", () => {
      state.globalQuery = globalSearchInput.value || "";
      renderAll();
    });

    // Links
    projectLinksForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!state.recordId) return alert("Select a project first.");

      const title = (projectLinkTitle.value || "").trim();
      const url = (projectLinkUrl.value || "").trim();
      if (!title || !url) return alert("Title and URL are required.");
      try { new URL(url); } catch { return alert("Invalid URL (include https://)"); }

      const next = Array.isArray(state.links) ? state.links.slice() : [];
      next.push({ title, url });

      projectLinkTitle.value = "";
      projectLinkUrl.value = "";

      await dbUpdate(RECORD_PATH(), { links: next });
    });

    // ----------------------------
    // Init
    // ----------------------------
    dataPathLabel.textContent = DATABASE_BASE_PATH;
    startTasksDropdownListener();
    renderSidebarPills();
    setActivePanel("daily");
  </script>

</body>

</html>