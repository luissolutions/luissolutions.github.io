<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radar Sensor Tracker</title>
    <link rel="stylesheet" href="../assets/css/app-styles.css" />
    <link rel="stylesheet" href="./assets/css/radar-styles.css" />
    <script type="module" src="../apps/assets/js/microsoftAuth.js"></script>
    <script type="module" src="../apps/assets/js/login.js"></script>
    <script src="assets/js/sidebar.js"></script>
</head>

<body>

    <header>
        <h1>Radar Job Tracker</h1>
        <span id="logins-section" class="logins-section">
            <section id="login-section">
                <form id="login-form">
                    <label for="username">Email:</label>
                    <input type="email" id="username" required>
                    <br>
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                    <br>
                    <button type="submit">Login</button>
                </form>
                <button id="logout" style="display: none;">Logout</button>
            </section>

            <div class="ms">
                <br>
                <button id="loginButton">Login to MS</button>
                <button id="logoutButton">Logout of MS</button>
                <p id="loginStatus">Login status...</p>
            </div>
        </span>
    </header>

    <div id="authScreen">
        <h2>Enter Project Code to Continue</h2>
        <input type="text" id="accessCode" placeholder="Project ID" />
        <button id="submitCode">Enter</button>

        <section class="instructions">
            <h2>Instructions</h2>
            <ul>
                <li>Enter a new Project ID and total sensors, then click “Save New Project”.</li>
                <li>Use the dropdown to switch between existing saved projects.</li>
                <li>Save project notes with a date and description.</li>
                <li>Select between Sensor Images or Deliverables view.</li>
                <li>Sensor uploads are resized and marked with the sensor number + serial.</li>
                <li>Deliverable uploads use the image name or markup as filename.</li>
                <li>Missing sensor images are shown below (2 required per sensor).</li>
                <li>Click an image to view, download, delete, or move it.</li>
                <li>Click ★ to favorite an image (favorites are shown first).</li>
            </ul>
        </section>
    </div>

    <main id="mainApp" class="hidden">

        <section>
            <label>Project ID: <input type="text" id="project" /></label> <br>
            <label>Total Sensors: <input type="number" id="sensorCount" min="1" /></label>
            <button id="saveProject">Save New Project</button>
            <br /><br />
            <label>Existing Projects:
                <select id="projectList">
                    <option value="">-- Choose a project --</option>
                </select>
            </label>
        </section>

        <section id="siteImagesSection">
            <h3>Site Images</h3>
            <input type="file" id="siteImageUploader" accept="image/*" />
            <button id="uploadSiteImage">Upload Site Image</button>

            <div id="siteImageNavTop" class="site-image-controls">
                <button class="prevSiteImage">◀︎ Previous</button>
                <button class="rotateSiteImage">↻ Rotate</button>
                <button class="nextSiteImage">Next ▶︎</button>
            </div>

            <div id="siteImageContainer">
                <div id="siteImageWrapper">
                    <img id="siteImageDisplay" src="" alt="Site Image" />
                </div>

                <div id="siteImageNav" class="site-image-controls">
                    <button class="prevSiteImage">◀︎ Previous</button>
                    <button class="rotateSiteImage">↻ Rotate</button>
                    <button id="downloadSiteImage">Download</button>
                    <button class="nextSiteImage">Next ▶︎</button>
                </div>

            </div>
        </section>

        <section>
            <h3>Project Notes:</h3>
            <div id="notesList" class="notes-section"></div>
            <label>Date: <input type="date" id="noteDate" /></label><br />
            <textarea id="noteText" rows="3" cols="50"></textarea><br />
            <button id="saveNote">Save Note</button>
        </section>

        <section>
            <h3>Sensor Details</h3>
            <label>Sensor #:
                <select id="sensorMetaNumberDropdown">
                    <option value="">Select a Sensor</option>
                </select>
            </label><br>
            <label>Serial #: <input type="text" id="sensorMetaSerial" /></label><br>
            <label>Measurement 1: <input type="text" id="sensorMetaM1" placeholder="Optional" /></label><br>
            <label>Measurement 2: <input type="text" id="sensorMetaM2" placeholder="Optional" /></label><br>
            <label>Measurement 3: <input type="text" id="sensorMetaM3" placeholder="Optional" /></label><br>
            <button id="saveSensorMeta">Save Sensor Info</button>
        </section>
        <br>
        <section class="radio-group">
            <label><input type="radio" name="viewMode" value="sensors" checked /> Sensor Images</label>
            <label><input type="radio" name="viewMode" value="deliverables" /> Other Deliverables</label>
        </section>

        <section id="sensorUploadSection">
            <h3>Upload Sensor Image</h3>
            <input type="file" id="sensorImage" /><br />

            <label>Sensor #:
                <select id="sensorNumberDropdown">
                    <option value="">Select a Sensor</option>
                </select>
            </label>
            <label>Serial: <input type="text" id="serialNumber" /></label><br />

            <label>
                <input type="checkbox" id="skipMarkupCheckbox" />
                No Markup
            </label>

            <button id="uploadImage">Upload</button>
        </section>

        <section id="deliverableUploadSection" style="display:none;">
            <h3>Upload Deliverable Image</h3>
            <input type="file" id="fileUploader" accept="image/*" /><br />
            <label>Name: <input type="text" id="imageNameInput" /></label> <br>
            <label>Markup: <input type="text" id="markupTextInput" /></label>
            <button id="uploadDeliverableImage">Upload Image</button>
        </section>

        <section>
            <h3>Missing Images</h3>
            <ul id="missingList"></ul>
        </section>

        <section>
            <h3>Gallery</h3>
            <label for="imageDropdown">Select an Image:</label>
            <select id="imageDropdown">
                <option value="">- Select an Image -</option>
            </select>
            <div id="gallery"></div>
        </section>

        <button id="uploadFolderToOneDrive">Upload to OneDrive</button>

        <div id="modal">
            <div id="modalContent">
                <img id="modalImage" src="" alt="Large View" />
                <p id="modalFileName"></p>
                <div class="modal-nav">
                    <button id="modalPrev">◀ Previous</button>
                    <button id="modalNext">Next ▶</button>
                </div>
                <button id="downloadButton">Download</button>
                <button class="clear-button" id="deleteButton">Delete</button>
                <button id="closeModalButton">Close</button>
            </div>
        </div>

    </main>

    <script type="module">
        import { auth, onAuthStateChanged, database, storage, ref as dbRef, set, update, get, storageRef, uploadBytes, getDownloadURL, listAll, deleteObject } from '../apps/assets/js/firebase-init.js';
        import { accessToken, isTokenExpired } from '../apps/assets/js/microsoftAuth.js';
        import { getIP, updateVisitCount } from '../assets/js/visitLogger.js';

        let currentProject = '';
        let expectedSensors = 0;
        let modalItems = [];
        let modalIndex = 0;
        let DATABASE_BASE_PATH = 'public';
        let isLoadingProject = false;
        let currentProjectName = '';

        onAuthStateChanged(auth, (user) => {
            DATABASE_BASE_PATH = user ? user.uid : 'public';
            populateProjects();
        });

        const sanitize = str => str.trim().replace(/\s+/g, '_');

        let validated = false;

        async function validateCode() {
            const input = document.getElementById('accessCode').value.trim().toLowerCase();
            const snapshot = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks`));
            if (!snapshot.exists()) return alert('No tasks found.');

            const tasks = snapshot.val();
            const matchEntry = Object.entries(tasks).find(([id, data]) => {
                return data.project?.trim().toLowerCase() === input;
            });

            if (matchEntry) {
                const [matchedID, matchedData] = matchEntry;
                localStorage.setItem('lastProject', matchedID);
                validated = true;

                document.getElementById('authScreen')?.remove();
                document.getElementById('mainApp')?.classList.remove('hidden');
                await populateProjects();
                document.getElementById('projectList').value = matchedID;
                await loadProject(matchedID);
            } else {
                alert('Invalid project name.');
            }
        }

        document.getElementById('submitCode').addEventListener('click', validateCode);
        document.getElementById('accessCode').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                validateCode();
            }
        });

        const resizeImage = (file, maxWidth) => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    let [w, h] = [img.width, img.height];
                    if (w > maxWidth) h *= maxWidth / w, w = maxWidth;
                    const canvas = Object.assign(document.createElement('canvas'), { width: w, height: h });
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(resolve, file.type);
                };
            };
            reader.readAsDataURL(file);
        });

        const addTextToImage = (blob, text) => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    const canvas = Object.assign(document.createElement('canvas'), {
                        width: img.width,
                        height: img.height + 100
                    });
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    ctx.fillStyle = 'white';
                    ctx.font = '80px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(text, canvas.width / 2, canvas.height - 20);
                    canvas.toBlob(resolve, 'image/jpeg');
                };
            };
            reader.readAsDataURL(blob);
        });

        async function populateProjects() {
            const snapshot = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks`));
            const dropdown = document.getElementById('projectList');
            dropdown.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Choose a project --';
            dropdown.appendChild(defaultOption);

            if (snapshot.exists()) {
                const data = snapshot.val();
                Object.entries(data).forEach(([id, task]) => {
                    const label = task.project || `(Unnamed - ${id})`;
                    const opt = new Option(label, id);
                    dropdown.appendChild(opt);
                });
            }
        }

        async function loadProject(id) {
            if (isLoadingProject) return;
            isLoadingProject = true;

            try {
                console.log(`[loadProject] Start loading project: ${id}`);
                currentProject = id;
                localStorage.setItem('lastProject', id);

                const dataSnap = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${id}`));
                if (!dataSnap.exists()) {
                    throw new Error(`No task found for ID ${id}`);
                }

                const data = dataSnap.val();

                currentProjectName = data.project || '';
                expectedSensors = data.sensorCount || 0;

                document.getElementById('project').value = currentProjectName;
                document.getElementById('sensorCount').value = expectedSensors;

                console.log(`[loadProject] Sensor count: ${expectedSensors}`);

                await updateSiteImages();
                await loadNotes();
                populateSensorDropdown(expectedSensors);
                await updateGallery();

            } catch (err) {
                console.error(`[loadProject] Failed:`, err);
                alert('Failed to load project. Check console for details.');
            } finally {
                isLoadingProject = false;
            }
        }

        function populateSensorDropdown(count) {
            const dropdowns = [document.getElementById('sensorMetaNumberDropdown'), document.getElementById('sensorNumberDropdown')];
            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = `<option value="">Select a Sensor</option>`;
                for (let i = 1; i <= count; i++) {
                    const padded = String(i).padStart(2, '0');
                    dropdown.innerHTML += `<option value="${i}">${padded}</option>`;
                }
            });
        }

        const getFavorites = () => JSON.parse(localStorage.getItem('favorites') || '{}');
        const toggleFavorite = path => {
            const favs = getFavorites();
            if (favs[path]) delete favs[path];
            else favs[path] = true;
            localStorage.setItem('favorites', JSON.stringify(favs));
        };

        async function updateGallery() {
            const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
            const base = `${DATABASE_BASE_PATH}/tasks/${currentProject}/${isSensor ? 'sensors' : 'deliverables'}`;
            const snapshot = await listAll(storageRef(storage, base));

            const items = await Promise.all(snapshot.items.map(async item => {
                const url = await getDownloadURL(item);
                return { name: item.name, url, fullPath: item.fullPath };
            }));

            const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
            items.sort((a, b) => (favorites[b.fullPath] ? 1 : 0) - (favorites[a.fullPath] ? 1 : 0));

            modalItems = items;

            const gallery = document.getElementById('gallery');
            const dropdown = document.getElementById('imageDropdown');
            const missingList = document.getElementById('missingList');

            gallery.innerHTML = '';
            dropdown.innerHTML = '<option value="">-- Select an Image --</option>';
            missingList.innerHTML = '';

            items.forEach(item => {
                const container = document.createElement('div');
                container.className = 'image-container';

                const img = document.createElement('img');
                img.src = item.url;
                img.loading = 'lazy';
                img.alt = item.name;
                img.onclick = () => showModal(item.url, item.name, base);

                const star = document.createElement('span');
                star.className = 'favorite-star';
                star.textContent = favorites[item.fullPath] ? '★' : '☆';
                if (favorites[item.fullPath]) star.classList.add('favorited');
                star.onclick = e => {
                    e.stopPropagation();
                    if (favorites[item.fullPath]) delete favorites[item.fullPath];
                    else favorites[item.fullPath] = true;
                    localStorage.setItem('favorites', JSON.stringify(favorites));
                    updateGallery();
                };

                container.append(img, star);
                gallery.appendChild(container);

                dropdown.appendChild(new Option(item.name, item.url));
            });

            if (isSensor) {
                const countMap = {};
                items.forEach(item => {
                    const m = item.name.match(/^[^_]+_(\d{2})-/);
                    if (m) {
                        const idx = parseInt(m[1], 10);
                        countMap[idx] = (countMap[idx] || 0) + 1;
                    }
                });

                for (let i = 1; i <= expectedSensors; i++) {
                    const padded = String(i).padStart(2, '0');
                    const have = countMap[i] || 0;
                    if (have < 2) {
                        const li = document.createElement('li');
                        li.textContent = `Sensor ${padded} - Missing ${2 - have} image(s)`;
                        missingList.appendChild(li);
                    }
                }
            }
        }

        async function uploadSensor() {
            const uploadBtn = document.getElementById('uploadImage');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const numEl = document.getElementById('sensorNumberDropdown');
            const serialEl = document.getElementById('serialNumber');
            const fileEl = document.getElementById('sensorImage');
            const skipMarkupEl = document.getElementById('skipMarkupCheckbox');

            const num = numEl.value;
            const serial = sanitize(serialEl.value);
            const file = fileEl.files[0];
            const skipMarkup = skipMarkupEl.checked;

            if (!currentProject || !num || !serial || !file) {
                alert('Fill out all fields');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
                return;
            }

            const paddedNum = String(num).padStart(2, '0');
            const safeProjectName = sanitize(currentProjectName || currentProject);
            const folderPath = `${DATABASE_BASE_PATH}/tasks/${currentProject}/sensors`;

            try {
                const files = await listAll(storageRef(storage, folderPath));
                const matchCount = files.items.filter(f => f.name.startsWith(`${safeProjectName}_${paddedNum}`)).length;

                if (matchCount >= 2) {
                    const proceed = confirm(`Sensor ${paddedNum} already has 2 uploads. Upload another?`);
                    if (!proceed) {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload';
                        return;
                    }
                }

                let blob = await resizeImage(file, 2048);
                if (!skipMarkup) {
                    blob = await addTextToImage(blob, `${currentProjectName} ${paddedNum} - ${serial}`);
                }

                const desired = `${safeProjectName}_${paddedNum}-${serial}.jpg`;
                const uniqueName = await getUniqueFilename(folderPath, desired);

                await uploadBytes(storageRef(storage, `${folderPath}/${uniqueName}`), blob);
                await updateGallery();
                alert(`Sensor image saved as “${uniqueName}”!`);

                fileEl.value = '';
                numEl.value = '';
                serialEl.value = '';
                skipMarkupEl.checked = false;

            } catch (err) {
                console.error('Upload failed:', err);
                alert('Sensor upload failed. See console for details.');
            }

            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
        }

        async function uploadDeliverable() {
            const uploadBtn = document.getElementById('uploadDeliverableImage');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const fileEl = document.getElementById('fileUploader');
            const nameEl = document.getElementById('imageNameInput');
            const markupEl = document.getElementById('markupTextInput');

            const file = fileEl.files[0];
            const rawName = nameEl.value.trim();
            const rawMarkup = markupEl.value.trim();

            const nameInput = sanitize(rawName);
            const markupInput = rawMarkup;

            if (!currentProject || !file || (!nameInput && !markupInput)) {
                alert('Please select a file and enter either a Name or Markup');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Image';
                return;
            }

            try {
                const baseName = nameInput || sanitize(rawMarkup);
                let blob = await resizeImage(file, 2048);

                if (rawMarkup) {
                    blob = await addTextToImage(blob, rawMarkup);
                }

                const folder = `${DATABASE_BASE_PATH}/tasks/${currentProject}/deliverables`;
                const desired = `${baseName}.jpg`;
                const uniqueName = await getUniqueFilename(folder, desired);

                await uploadBytes(storageRef(storage, `${folder}/${uniqueName}`), blob);
                await updateGallery();
                alert(`Deliverable saved as “${uniqueName}”!`);

                fileEl.value = '';
                nameEl.value = '';
                markupEl.value = '';
            } catch (err) {
                console.error('Upload failed:', err);
                alert('Deliverable upload failed. See console for details.');
            }

            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload Image';
        }

        async function saveNote() {
            const dateInput = document.getElementById('noteDate').value;
            const text = document.getElementById('noteText').value.trim();
            if (!currentProject || !dateInput || !text) return;

            const utcTimestamp = Date.now();
            await update(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${currentProject}/comments`), {
                [utcTimestamp]: text
            });;
            loadNotes();
            alert('Note saved successfully!');
        }

        async function loadNotes() {
            const snapshot = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${currentProject}/comments`));
            const list = document.getElementById('notesList');
            list.innerHTML = '';

            if (snapshot.exists()) {
                const notes = snapshot.val();

                Object.keys(notes)
                    .sort((a, b) => parseInt(b) - parseInt(a))
                    .forEach(timestamp => {
                        const dateStr = new Date(parseInt(timestamp)).toLocaleString();
                        const formattedNote = notes[timestamp].replace(/\n/g, "<br>");
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <strong>${dateStr}</strong><br>${formattedNote}
                            <button data-timestamp="${timestamp}" class="deleteNoteButton">🗑 Delete</button>
                            <hr>
                        `;
                        list.appendChild(div);
                    });

                document.querySelectorAll('.deleteNoteButton').forEach(button => {
                    button.addEventListener('click', async () => {
                        const timestamp = button.dataset.timestamp;
                        const confirmDelete = confirm(`Delete note from ${new Date(parseInt(timestamp)).toLocaleString()}?`);
                        if (confirmDelete) {
                            await set(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${currentProject}/comments/${timestamp}`), null);
                            loadNotes();
                        }
                    });
                });
            }
        }

        async function saveProject() {
            const projectName = sanitize(document.getElementById('project').value);
            const count = parseInt(document.getElementById('sensorCount').value);
            if (!projectName || isNaN(count)) return alert('Enter valid project ID and sensor count');

            const snapshot = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks`));
            const data = snapshot.exists() ? snapshot.val() : {};

            const existingEntry = Object.entries(data).find(([id, task]) => task.project === projectName);

            let id;
            if (existingEntry) {
                id = existingEntry[0];
                await update(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${id}`), {
                    project: projectName,
                    sensorCount: count
                });
            } else {
                id = Date.now().toString();
                await set(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${id}`), {
                    id,
                    project: projectName,
                    sensorCount: count
                });
            }

            await populateProjects();
            document.getElementById('projectList').value = id;
            await loadProject(id);
            alert(`Project ${projectName} saved successfully as ${id}!`);
        }

        function showModal(url, name, folderPath) {
            modalIndex = modalItems.findIndex(item => item.url === url);

            const modal = document.getElementById('modal');
            const img = document.getElementById('modalImage');
            const fn = document.getElementById('modalFileName');
            img.src = modalItems[modalIndex].url;
            fn.textContent = modalItems[modalIndex].name;
            modal.style.display = 'flex';

            document.getElementById('modalPrev').disabled = modalItems.length <= 1;
            document.getElementById('modalNext').disabled = modalItems.length <= 1;

            document.getElementById('downloadButton').onclick = () => window.open(url, '_blank');
            document.getElementById('closeModalButton').onclick = () => modal.style.display = 'none';
            modal.addEventListener('click', e => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        document.getElementById('deleteButton').onclick = async () => {
            const item = modalItems[modalIndex];
            if (!(await confirmWithPassword("deleting this image"))) {
                alert("Incorrect password. Action cancelled.");
                return;
            }

            const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
            const folder = isSensor ? 'sensors' : 'deliverables';
            const path = `${DATABASE_BASE_PATH}/tasks/${currentProject}/${folder}/${item.name}`;

            try {
                await deleteObject(storageRef(storage, path));
                modal.style.display = 'none';
                updateGallery();
            } catch (err) {
                console.error("Failed to delete image:", err);
                alert("Failed to delete image. Check console for details.");
            }
        };

        document.getElementById('modalPrev').onclick = () => {
            if (modalItems.length < 2) return;
            modalIndex = (modalIndex - 1 + modalItems.length) % modalItems.length;
            const { url, name } = modalItems[modalIndex];
            document.getElementById('modalImage').src = url;
            document.getElementById('modalFileName').textContent = name;
        };

        document.getElementById('modalNext').onclick = () => {
            if (modalItems.length < 2) return;
            modalIndex = (modalIndex + 1) % modalItems.length;
            const { url, name } = modalItems[modalIndex];
            document.getElementById('modalImage').src = url;
            document.getElementById('modalFileName').textContent = name;
        };

        // Event bindings
        projectList.onchange = e => e.target.value && loadProject(e.target.value);
        document.getElementById('saveProject').onclick = saveProject;
        document.getElementById('uploadImage').onclick = uploadSensor;
        document.getElementById('uploadDeliverableImage').onclick = uploadDeliverable;
        document.getElementById('saveNote').onclick = saveNote;
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
                document.getElementById('sensorUploadSection').style.display = isSensor ? 'block' : 'none';
                document.getElementById('deliverableUploadSection').style.display = isSensor ? 'none' : 'block';
                updateGallery();
            });
        });

        // Image dropdown opens modal
        document.getElementById('imageDropdown').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const url = selectedOption.value;
            const name = selectedOption.textContent;
            if (url) {
                const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
                const folder = isSensor ? 'sensors' : 'deliverables';
                showModal(url, name, `${DATABASE_BASE_PATH}/tasks/${currentProject}/${folder}`);
            }
        });

        document.getElementById("sensorMetaNumberDropdown").addEventListener("change", async (e) => {
            const num = e.target.value;
            if (!num || !currentProject) return;

            const snap = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${currentProject}/sensorMeta/${num}`));
            if (snap.exists()) {
                const data = snap.val();
                document.getElementById("sensorMetaSerial").value = data.serial || '';
                document.getElementById("sensorMetaM1").value = data.m1 || '';
                document.getElementById("sensorMetaM2").value = data.m2 || '';
                document.getElementById("sensorMetaM3").value = data.m3 || '';
            } else {

                document.getElementById("sensorMetaSerial").value = '';
                document.getElementById("sensorMetaM1").value = '';
                document.getElementById("sensorMetaM2").value = '';
                document.getElementById("sensorMetaM3").value = '';
            }
        });

        document.getElementById("saveSensorMeta").onclick = async () => {
            const num = document.getElementById("sensorMetaNumberDropdown").value;
            const serial = document.getElementById("sensorMetaSerial").value.trim();
            const m1 = document.getElementById("sensorMetaM1").value.trim();
            const m2 = document.getElementById("sensorMetaM2").value.trim();
            const m3 = document.getElementById("sensorMetaM3").value.trim();

            if (!num || !serial) return alert("Sensor number and serial are required.");

            const sensorData = { serial, m1, m2, m3 };
            await set(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${currentProject}/sensorMeta/${num}`), sensorData);
            alert("Sensor info saved!");
        };

        document.getElementById("sensorNumberDropdown").addEventListener("change", async (e) => {
            const num = e.target.value;
            const serialEl = document.getElementById("serialNumber");

            if (!num || !currentProject) {
                serialEl.value = '';
                return;
            }

            const snap = await get(dbRef(database, `${DATABASE_BASE_PATH}/tasks/${currentProject}/sensorMeta/${num}`));
            if (snap.exists()) {
                const data = snap.val();
                serialEl.value = data.serial || '';
            } else {
                serialEl.value = '';
            }
        });

        // Site images section
        let siteImages = [];
        let currentSiteIndex = 0;
        let siteImageRotation = 0;

        function getSiteIndex() {
            return parseInt(localStorage.getItem(`${currentProject}_siteIdx`) || '0', 10);
        }
        function saveSiteIndex(idx) {
            localStorage.setItem(`${currentProject}_siteIdx`, idx);
        }

        async function updateSiteImages() {
            siteImages = [];

            if (!currentProject) return;
            const base = `${DATABASE_BASE_PATH}/tasks/${currentProject}/siteImages`;
            try {
                const snap = await listAll(storageRef(storage, base));
                siteImages = await Promise.all(snap.items.map(async item => ({ name: item.name, url: await getDownloadURL(item) })));
            } catch { siteImages = []; }

            currentSiteIndex = Math.min(getSiteIndex(), siteImages.length - 1);
            if (currentSiteIndex < 0) currentSiteIndex = 0;
            renderSiteImage();
        }

        function renderSiteImage() {
            const img = document.getElementById('siteImageDisplay');
            const wrapper = document.getElementById('siteImageWrapper');
            const prevBtns = document.querySelectorAll('.prevSiteImage');
            const nextBtns = document.querySelectorAll('.nextSiteImage');
            const rotBtns = document.querySelectorAll('.rotateSiteImage');

            if (!siteImages.length) {
                wrapper.style.height = 'auto';
                prevBtns.forEach(btn => btn.disabled = true);
                nextBtns.forEach(btn => btn.disabled = true);
                rotBtns.forEach(btn => btn.disabled = true);
                img.src = '';
                return;
            }

            img.style.opacity = 0;
            img.src = `${siteImages[currentSiteIndex].url}?t=${Date.now()}`;
            img.alt = siteImages[currentSiteIndex].name;
            siteImageRotation = 0;
            img.style.transform = 'rotate(0deg)';

            img.onload = () => {
                img.style.opacity = 1;
                const dispW = wrapper.clientWidth;
                const dispH = img.clientHeight;
                wrapper.style.height = `${dispH}px`;
            };
        }

        function rotateSiteImage() {
            if (!siteImages.length) return;

            const img = document.getElementById('siteImageDisplay');
            const wrapper = document.getElementById('siteImageWrapper');

            siteImageRotation = (siteImageRotation + 90) % 360;
            img.style.transform = `rotate(${siteImageRotation}deg)`;

            const dispW = wrapper.clientWidth;
            const dispH = img.clientHeight;
            const θ = siteImageRotation * Math.PI / 180;
            const cos = Math.abs(Math.cos(θ));
            const sin = Math.abs(Math.sin(θ));
            const newH = dispW * sin + dispH * cos;

            wrapper.style.height = `${newH}px`;
        }

        function nextSiteImage() {
            if (!siteImages.length) return;
            currentSiteIndex = (currentSiteIndex + 1) % siteImages.length;
            saveSiteIndex(currentSiteIndex);
            renderSiteImage();
        }
        function prevSiteImage() {
            if (!siteImages.length) return;
            currentSiteIndex = (currentSiteIndex - 1 + siteImages.length) % siteImages.length;
            saveSiteIndex(currentSiteIndex);
            renderSiteImage();
        }

        async function uploadSiteImage() {
            if (!currentProject) return alert('Select a project first');
            const file = document.getElementById('siteImageUploader').files[0];
            if (!file) return alert('Pick an image!');

            const blob = await resizeImage(file, 2048);
            const folder = `${DATABASE_BASE_PATH}/tasks/${currentProject}/siteImages`;
            const uniqueName = await getUniqueFilename(folder, sanitize(file.name));
            const path = `${folder}/${uniqueName}`;

            await uploadBytes(storageRef(storage, path), blob);
            await updateSiteImages();
            alert(`Uploaded as “${uniqueName}”`);
        }

        document.getElementById('uploadSiteImage').onclick = uploadSiteImage;
        document.querySelectorAll('.nextSiteImage').forEach(btn => btn.onclick = nextSiteImage);
        document.querySelectorAll('.prevSiteImage').forEach(btn => btn.onclick = prevSiteImage);
        document.querySelectorAll('.rotateSiteImage').forEach(btn => btn.onclick = rotateSiteImage);

        async function getUniqueFilename(folderPath, filename) {
            const idx = filename.lastIndexOf('.');
            const base = idx >= 0 ? filename.slice(0, idx) : filename;
            const ext = idx >= 0 ? filename.slice(idx) : '';
            let name = base;
            let suffix = 1;

            while (true) {
                const path = `${folderPath}/${name}${ext}`;
                try {
                    await getDownloadURL(storageRef(storage, path));
                    name = `${base}_${suffix++}`;
                } catch (e) {
                    if (e.code === 'storage/object-not-found') {
                        return name + ext;
                    }
                    throw e;
                }
            }
        }

        // OneDrive upload code
        document.getElementById("uploadFolderToOneDrive").addEventListener("click", async () => {
            const uploadBtn = document.getElementById("uploadFolderToOneDrive");

            if (!currentProject) return alert("Select or load a project first.");
            if (!accessToken) return alert("You must be logged into Microsoft first.");

            if (isTokenExpired(accessToken)) {
                alert("Session expired. Please log in again.");
                logoutMicrosoft();
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.style.opacity = "0.5";
            uploadBtn.textContent = "Uploading...";

            const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
            const folderType = isSensor ? 'sensors' : 'deliverables';
            const firebaseFolder = `${DATABASE_BASE_PATH}/tasks/${currentProject}/${folderType}`;
            const safeName = sanitize(currentProjectName || currentProject);
            const oneDriveFolder = `JobPhotos/${safeName}/${folderType}`;

            try {
                const folderRef = storageRef(storage, firebaseFolder);
                const folderSnapshot = await listAll(folderRef);

                await ensureOneDriveFolder("JobPhotos");
                await ensureOneDriveFolder(`JobPhotos/${safeName}`);
                await ensureOneDriveFolder(oneDriveFolder);
                for (const item of folderSnapshot.items) {
                    const blob = await getBlob(item);
                    const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${oneDriveFolder}/${item.name}:/content`;
                    const res = await fetch(uploadUrl, {
                        method: "PUT",
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        },
                        body: blob
                    });
                    if (!res.ok) {
                        console.error(`Failed to upload ${item.name}:`, await res.text());
                    }
                }

                alert(`Uploaded all images to OneDrive folder: ${oneDriveFolder}`);
            } catch (err) {
                console.error("Upload error:", err);
                alert("Upload failed. See console for details.");
            }

            uploadBtn.disabled = false;
            uploadBtn.style.opacity = "1";
            uploadBtn.textContent = "Upload to OneDrive";
        });

        async function getBlob(storageItem) {
            const url = await getDownloadURL(storageItem);
            const res = await fetch(url);
            return await res.blob();
        }

        async function ensureOneDriveFolder(path) {
            const parts = path.split('/');
            let currentPath = '';
            for (const part of parts) {
                currentPath += (currentPath ? '/' : '') + part;
                const checkUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${currentPath}:/`;
                const res = await fetch(checkUrl, { headers: { Authorization: `Bearer ${accessToken}` } });

                if (res.status === 404) {
                    const parent = currentPath.substring(0, currentPath.lastIndexOf('/'));
                    const createUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${parent ? parent : ''}:/children`;
                    const createRes = await fetch(createUrl, {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            name: part,
                            folder: {},
                            "@microsoft.graph.conflictBehavior": "rename"
                        })
                    });

                    if (!createRes.ok) {
                        throw new Error(`Failed to create folder "${part}": ${await createRes.text()}`);
                    }
                }
            }
        }

        async function confirmWithPassword(actionDescription = "this action") {
            const input = prompt(`Enter password to confirm ${actionDescription}:`);
            if (!input) return false;
            const correctPassword = "telaidadmin";
            return input === correctPassword;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const ip = await getIP();
            updateVisitCount(ip);
        });

        let clickCount = 0;
        let clickTimer = null;

        document.getElementById('siteImageDisplay').addEventListener('click', () => {
            clickCount++;

            if (clickCount === 3) {
                rotateSiteImage();
                clearTimeout(clickTimer);
                clickCount = 0;
            }

            if (!clickTimer) {
                clickTimer = setTimeout(() => {
                    clickCount = 0;
                    clickTimer = null;
                }, 400);
            }
        });

        document.querySelector("h1").addEventListener("dblclick", () => {
            const loginSection = document.getElementById("logins-section");
            if (loginSection) {
                loginSection.style.display = (loginSection.style.display === "none" || loginSection.style.display === "") ? "flex" : "none";
            }
        });

        document.getElementById('downloadSiteImage').addEventListener('click', () => {
            if (!siteImages.length) return alert('No site image to download.');

            const currentImage = siteImages[currentSiteIndex];
            const link = document.createElement('a');
            link.href = currentImage.url;
            link.download = currentImage.name;
            link.click();
        });

    </script>
</body>

</html>