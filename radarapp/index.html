<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radar Sensor Tracker</title>
    <link rel="stylesheet" href="../assets/css/app-styles.css" />
    <link rel="stylesheet" href="./assets/css/radar-styles.css" />
    <script type="module" src="../apps/assets/js/microsoftAuth.js"></script>
    <script type="module" src="../apps/assets/js/login.js"></script>
</head>

<body>

    <header>
        <h1>Radar Job Tracker</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <br>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <br>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>

        <div class="ms" style="display: none;">
            <br>
            <button id="loginButton">Login to MS</button>
            <button id="logoutButton">Logout of MS</button>
            <p id="loginStatus">Login status...</p>
        </div>
    </header>

    <div id="authScreen">
        <h2>Enter Project Code to Continue</h2>
        <input type="text" id="accessCode" placeholder="Project ID" />
        <button id="submitCode">Enter</button>

        <section class="instructions">
            <h2>Instructions</h2>
            <ul>
                <li>Enter a new Project ID and total sensors, then click “Save New Project”.</li>
                <li>Use the dropdown to switch between existing saved projects.</li>
                <li>Save project notes with a date and description.</li>
                <li>Select between Sensor Images or Deliverables view.</li>
                <li>Sensor uploads are resized and marked with the sensor number + serial.</li>
                <li>Deliverable uploads use the image name or markup as filename.</li>
                <li>Missing sensor images are shown below (2 required per sensor).</li>
                <li>Click an image to view, download, delete, or move it.</li>
                <li>Click ★ to favorite an image (favorites are shown first).</li>
            </ul>
        </section>
    </div>

    <main id="mainApp" class="hidden">

        <section>
            <label>Project ID: <input type="text" id="projectId" /></label> <br>
            <label>Total Sensors: <input type="number" id="sensorCount" min="1" /></label>
            <button id="saveProject">Save New Project</button>
            <br /><br />
            <label>Existing Projects:
                <select id="projectList">
                    <option value="">-- Choose a project --</option>
                </select>
            </label>
        </section>

        <section id="siteImagesSection">
            <h3>Site Images</h3>
            <input type="file" id="siteImageUploader" accept="image/*" />
            <button id="uploadSiteImage">Upload Site Image</button>

            <div id="siteImageContainer">
                <div id="siteImageWrapper">
                    <img id="siteImageDisplay" src="" alt="Site Image" />
                </div>

                <div id="siteImageNav">
                    <button id="prevSiteImage">◀︎ Previous</button>
                    <button id="rotateSiteImage">↻ Rotate</button>
                    <button id="nextSiteImage">Next ▶︎</button>
                </div>
            </div>
        </section>

        <section>
            <h3>Project Notes:</h3>
            <div id="notesList" class="notes-section"></div>
            <label>Date: <input type="date" id="noteDate" /></label><br />
            <textarea id="noteText" rows="3" cols="50"></textarea><br />
            <button id="saveNote">Save Note</button>
        </section>
        <br>
        <section class="radio-group">
            <label><input type="radio" name="viewMode" value="sensors" checked /> Sensor Images</label>
            <label><input type="radio" name="viewMode" value="deliverables" /> Other Deliverables</label>
        </section>

        <section id="sensorUploadSection">
            <h3>Upload Sensor Image</h3>
            <input type="file" id="sensorImage" /><br />

            <label>Sensor #: <input type="number" id="sensorNumber" min="1" /></label> <br>
            <label>Serial: <input type="text" id="serialNumber" /></label><br />

            <label>
                <input type="checkbox" id="skipMarkupCheckbox" />
                No Markup
            </label>

            <button id="uploadImage">Upload</button>
        </section>

        <section id="deliverableUploadSection" style="display:none;">
            <h3>Upload Deliverable Image</h3>
            <input type="file" id="fileUploader" accept="image/*" /><br />
            <label>Name: <input type="text" id="imageNameInput" /></label>
            <label>Markup: <input type="text" id="markupTextInput" /></label>
            <button id="uploadDeliverableImage">Upload Image</button>
        </section>

        <section>
            <h3>Missing Images</h3>
            <ul id="missingList"></ul>
        </section>

        <section>
            <h3>Gallery</h3>
            <label for="imageDropdown">Select an Image:</label>
            <select id="imageDropdown">
                <option value="">- Select an Image -</option>
            </select>
            <div id="gallery"></div>
        </section>

        <button id="uploadFolderToOneDrive">Upload to OneDrive</button>

        <div id="modal">
            <div id="modalContent">
                <img id="modalImage" src="" alt="Large View" />
                <p id="modalFileName"></p>
                <div class="modal-nav">
                    <button id="modalPrev">◀ Previous</button>
                    <button id="modalNext">Next ▶</button>
                </div>
                <button id="downloadButton">Download</button>
                <button id="deleteButton">Delete</button>
                <button id="closeModalButton">Close</button>
            </div>
        </div>

    </main>

    <script type="module">
        import {
            database, storage, ref as dbRef, set, get, storageRef, uploadBytes, getDownloadURL, listAll, deleteObject
        } from '../apps/assets/js/firebase-init.js';

        let currentProjectId = '';
        let expectedSensors = 0;
        let modalItems = [];
        let modalIndex = 0;

        const sanitize = str => str.trim().replace(/\s+/g, '_');

        const resizeImage = (file, maxWidth) => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    let [w, h] = [img.width, img.height];
                    if (w > maxWidth) h *= maxWidth / w, w = maxWidth;
                    const canvas = Object.assign(document.createElement('canvas'), { width: w, height: h });
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(resolve, file.type);
                };
            };
            reader.readAsDataURL(file);
        });

        const addTextToImage = (blob, text) => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    const canvas = Object.assign(document.createElement('canvas'), {
                        width: img.width,
                        height: img.height + 100
                    });
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    ctx.fillStyle = 'white';
                    ctx.font = '80px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(text, canvas.width / 2, canvas.height - 20);
                    canvas.toBlob(resolve, 'image/jpeg');
                };
            };
            reader.readAsDataURL(blob);
        });

        async function validateCode() {
            const input = document.getElementById('accessCode').value.trim();
            if (!input) return alert('Please enter a project code.');

            try {
                const snapshot = await get(dbRef(database, 'public/projects'));
                if (!snapshot.exists()) {
                    return alert('No projects found in database.');
                }

                const projectIDs = Object.keys(snapshot.val());
                if (projectIDs.includes(input)) {
                    document.getElementById('authScreen').remove();
                    document.getElementById('mainApp').classList.remove('hidden');
                    populateProjects();
                } else {
                    alert('Invalid code.');
                }
            } catch (e) {
                console.error(e);
                alert('Error checking database.');
            }
        }

        document.getElementById('submitCode').addEventListener('click', validateCode);
        document.getElementById('accessCode').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                validateCode();
            }
        });

        async function populateProjects() {
            const snapshot = await get(dbRef(database, 'public/projects'));
            const dropdown = document.getElementById('projectList');
            dropdown.innerHTML = '<option value="">-- Choose a project --</option>';
            if (snapshot.exists()) {
                Object.keys(snapshot.val()).forEach(id => {
                    const opt = new Option(id, id);
                    dropdown.appendChild(opt);
                });
            }
            const last = localStorage.getItem('lastProject');
            if (last) dropdown.value = last, loadProject(last);
        }

        async function loadProject(id) {
            currentProjectId = id;
            localStorage.setItem('lastProject', id);

            document.getElementById('projectId').value = id;

            const snap = await get(dbRef(database, `public/projects/${id}/sensorCount`));
            expectedSensors = snap.exists() ? snap.val() : 0;
            document.getElementById('sensorCount').value = expectedSensors;
            updateGallery();
            loadNotes();
        }

        const getFavorites = () => JSON.parse(localStorage.getItem('favorites') || '{}');
        const toggleFavorite = path => {
            const favs = getFavorites();
            if (favs[path]) delete favs[path];
            else favs[path] = true;
            localStorage.setItem('favorites', JSON.stringify(favs));
        };

        async function updateGallery() {
            const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
            const base = `public/projects/${currentProjectId}/${isSensor ? 'sensors' : 'deliverables'}`;
            const snapshot = await listAll(storageRef(storage, base));

            const items = await Promise.all(snapshot.items.map(async item => {
                const url = await getDownloadURL(item);
                return { name: item.name, url, fullPath: item.fullPath };
            }));

            const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
            items.sort((a, b) => (favorites[b.fullPath] ? 1 : 0) - (favorites[a.fullPath] ? 1 : 0));

            modalItems = items;

            const gallery = document.getElementById('gallery');
            const dropdown = document.getElementById('imageDropdown');
            const missingList = document.getElementById('missingList');

            gallery.innerHTML = '';
            dropdown.innerHTML = '<option value="">-- Select an Image --</option>';
            missingList.innerHTML = '';

            items.forEach(item => {
                const container = document.createElement('div');
                container.className = 'image-container';

                const img = document.createElement('img');
                img.src = item.url;
                img.alt = item.name;
                img.onclick = () => showModal(item.url, item.name, base);

                const star = document.createElement('span');
                star.className = 'favorite-star';
                star.textContent = favorites[item.fullPath] ? '★' : '☆';
                if (favorites[item.fullPath]) star.classList.add('favorited');
                star.onclick = e => {
                    e.stopPropagation();
                    if (favorites[item.fullPath]) delete favorites[item.fullPath];
                    else favorites[item.fullPath] = true;
                    localStorage.setItem('favorites', JSON.stringify(favorites));
                    updateGallery();
                };

                container.append(img, star);
                gallery.appendChild(container);

                dropdown.appendChild(new Option(item.name, item.url));
            });

            if (isSensor) {
                const countMap = {};
                items.forEach(item => {
                    const m = item.name.match(/^[^_]+_(\d{2})-/);
                    if (m) {
                        const idx = parseInt(m[1], 10);
                        countMap[idx] = (countMap[idx] || 0) + 1;
                    }
                });

                for (let i = 1; i <= expectedSensors; i++) {
                    const padded = String(i).padStart(2, '0');
                    const have = countMap[i] || 0;
                    if (have < 2) {
                        const li = document.createElement('li');
                        li.textContent = `Sensor ${padded} - Missing ${2 - have} image(s)`;
                        missingList.appendChild(li);
                    }
                }
            }
        }

        async function uploadSensor() {
            const numEl = document.getElementById('sensorNumber');
            const serialEl = document.getElementById('serialNumber');
            const fileEl = document.getElementById('sensorImage');

            const num = document.getElementById('sensorNumber').value;
            const serial = sanitize(document.getElementById('serialNumber').value);
            const file = document.getElementById('sensorImage').files[0];
            const skipMk = document.getElementById('skipMarkupCheckbox')?.checked;

            if (!currentProjectId || !num || !serial || !file) {
                return alert('Fill out all fields');
            }

            const paddedNum = String(num).padStart(2, '0');

            let blob = await resizeImage(file, 2048);
            if (!skipMk) {
                blob = await addTextToImage(blob, `${currentProjectId} ${paddedNum} - ${serial}`);
            }

            const folder = `public/projects/${currentProjectId}/sensors`;
            const desired = `${currentProjectId}_${paddedNum}-${serial}.jpg`;
            const uniqueName = await getUniqueFilename(folder, desired);

            await uploadBytes(storageRef(storage, `${folder}/${uniqueName}`), blob);
            updateGallery();
            alert(`Sensor image saved as “${uniqueName}”!`);

            fileEl.value = '';
            numEl.value = '';
            serialEl.value = '';
            document.getElementById('skipMarkupCheckbox').checked = false;
        }

        async function uploadDeliverable() {
            const fileEl = document.getElementById('fileUploader');
            const nameEl = document.getElementById('imageNameInput');
            const markupEl = document.getElementById('markupTextInput');

            const file = document.getElementById('fileUploader').files[0];
            const nameInput = sanitize(document.getElementById('imageNameInput').value);
            const markupInput = sanitize(document.getElementById('markupTextInput').value);

            if (!currentProjectId || !file || (!nameInput && !markupInput)) {
                return alert('Please select a file and enter either a Name or Markup');
            }

            const baseName = markupInput || nameInput;
            let blob = await resizeImage(file, 2048);

            if (markupInput) {
                blob = await addTextToImage(blob, markupInput);
            }

            const folder = `public/projects/${currentProjectId}/deliverables`;
            const desired = `${baseName}.jpg`;
            const uniqueName = await getUniqueFilename(folder, desired);

            await uploadBytes(storageRef(storage, `${folder}/${uniqueName}`), blob);
            updateGallery();
            alert(`Deliverable saved as “${uniqueName}”!`);

            fileEl.value = '';
            nameEl.value = '';
            markupEl.value = '';
        }

        async function saveNote() {
            const date = document.getElementById('noteDate').value;
            const text = document.getElementById('noteText').value.trim();
            if (!currentProjectId || !date || !text) return;
            await set(dbRef(database, `public/projects/${currentProjectId}/notes/${date}`), text);
            loadNotes();
            alert('Note saved successfully!');
        }

        async function loadNotes() {
            const snapshot = await get(dbRef(database, `public/projects/${currentProjectId}/notes`));
            const list = document.getElementById('notesList');
            list.innerHTML = '';
            if (snapshot.exists()) {
                const notes = snapshot.val();
                Object.keys(notes).sort().reverse().forEach(date => {
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${date}</strong><br>${notes[date]}`;
                    list.appendChild(div);
                });
            }
        }

        async function saveProject() {
            const id = sanitize(document.getElementById('projectId').value);
            const count = parseInt(document.getElementById('sensorCount').value);
            if (!id || isNaN(count)) return alert('Enter valid project ID and sensor count');
            await set(dbRef(database, `public/projects/${id}`), { sensorCount: count });
            await populateProjects();
            projectList.value = id;
            loadProject(id);
            alert(`Project ${id} saved successfully!`);
        }

        function showModal(url, name, folderPath) {
            modalIndex = modalItems.findIndex(item => item.url === url);

            const modal = document.getElementById('modal');
            const img = document.getElementById('modalImage');
            const fn = document.getElementById('modalFileName');
            img.src = modalItems[modalIndex].url;
            fn.textContent = modalItems[modalIndex].name;
            modal.style.display = 'flex';

            document.getElementById('modalPrev').disabled = modalItems.length <= 1;
            document.getElementById('modalNext').disabled = modalItems.length <= 1;

            document.getElementById('downloadButton').onclick = () => window.open(url, '_blank');
            document.getElementById('closeModalButton').onclick = () => modal.style.display = 'none';
            modal.addEventListener('click', e => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            document.getElementById('deleteButton').onclick = async () => {
                if (!confirm(`Delete ${name}?`)) return;
                await deleteObject(storageRef(storage, `${folderPath}/${name}`));
                modal.style.display = 'none';
                updateGallery();
            };
        }

        document.getElementById('modalPrev').onclick = () => {
            if (modalItems.length < 2) return;
            modalIndex = (modalIndex - 1 + modalItems.length) % modalItems.length;
            const { url, name } = modalItems[modalIndex];
            document.getElementById('modalImage').src = url;
            document.getElementById('modalFileName').textContent = name;
        };

        document.getElementById('modalNext').onclick = () => {
            if (modalItems.length < 2) return;
            modalIndex = (modalIndex + 1) % modalItems.length;
            const { url, name } = modalItems[modalIndex];
            document.getElementById('modalImage').src = url;
            document.getElementById('modalFileName').textContent = name;
        };

        // Event bindings
        projectList.onchange = e => e.target.value && loadProject(e.target.value);
        document.getElementById('saveProject').onclick = saveProject;
        document.getElementById('uploadImage').onclick = uploadSensor;
        document.getElementById('uploadDeliverableImage').onclick = uploadDeliverable;
        document.getElementById('saveNote').onclick = saveNote;
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
                document.getElementById('sensorUploadSection').style.display = isSensor ? 'block' : 'none';
                document.getElementById('deliverableUploadSection').style.display = isSensor ? 'none' : 'block';
                updateGallery();
            });
        });

        // Image dropdown opens modal
        document.getElementById('imageDropdown').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const url = selectedOption.value;
            const name = selectedOption.textContent;
            if (url) {
                const isSensor = document.querySelector('input[name="viewMode"]:checked').value === 'sensors';
                const folder = isSensor ? 'sensors' : 'deliverables';
                showModal(url, name, `public/projects/${currentProjectId}/${folder}`);
            }
        });

        // --- SITE IMAGES SECTION ---
        let siteImages = [];
        let currentSiteIndex = 0;
        let siteImageRotation = 0;

        function getSiteIndex() {
            return parseInt(localStorage.getItem(`${currentProjectId}_siteIdx`) || '0', 10);
        }
        function saveSiteIndex(idx) {
            localStorage.setItem(`${currentProjectId}_siteIdx`, idx);
        }

        async function updateSiteImages() {
            if (!currentProjectId) return;
            const base = `public/projects/${currentProjectId}/siteImages`;
            try {
                const snap = await listAll(storageRef(storage, base));
                siteImages = await Promise.all(snap.items.map(async item => ({ name: item.name, url: await getDownloadURL(item) })));
            } catch { siteImages = []; }

            currentSiteIndex = Math.min(getSiteIndex(), siteImages.length - 1);
            if (currentSiteIndex < 0) currentSiteIndex = 0;
            renderSiteImage();
        }

        function renderSiteImage() {
            const img = document.getElementById('siteImageDisplay');
            const wrapper = document.getElementById('siteImageWrapper');
            const prevBtn = document.getElementById('prevSiteImage');
            const nextBtn = document.getElementById('nextSiteImage');
            const rotBtn = document.getElementById('rotateSiteImage');

            if (!siteImages.length) {
                wrapper.style.height = 'auto';
                prevBtn.disabled = nextBtn.disabled = rotBtn.disabled = true;
                img.src = '';
                return;
            }

            img.src = siteImages[currentSiteIndex].url;
            img.alt = siteImages[currentSiteIndex].name;
            siteImageRotation = 0;
            img.style.transform = 'rotate(0deg)';
            prevBtn.disabled = nextBtn.disabled = rotBtn.disabled = false;

            img.onload = () => {
                const dispW = wrapper.clientWidth;
                const dispH = img.clientHeight;
                wrapper.style.height = `${dispH}px`;
            };
        }

        function rotateSiteImage() {
            if (!siteImages.length) return;

            const img = document.getElementById('siteImageDisplay');
            const wrapper = document.getElementById('siteImageWrapper');

            siteImageRotation = (siteImageRotation + 90) % 360;
            img.style.transform = `rotate(${siteImageRotation}deg)`;

            const dispW = wrapper.clientWidth;
            const dispH = img.clientHeight;
            const θ = siteImageRotation * Math.PI / 180;
            const cos = Math.abs(Math.cos(θ));
            const sin = Math.abs(Math.sin(θ));
            const newH = dispW * sin + dispH * cos;

            wrapper.style.height = `${newH}px`;
        }

        function nextSiteImage() {
            if (!siteImages.length) return;
            currentSiteIndex = (currentSiteIndex + 1) % siteImages.length;
            saveSiteIndex(currentSiteIndex);
            renderSiteImage();
        }
        function prevSiteImage() {
            if (!siteImages.length) return;
            currentSiteIndex = (currentSiteIndex - 1 + siteImages.length) % siteImages.length;
            saveSiteIndex(currentSiteIndex);
            renderSiteImage();
        }

        async function uploadSiteImage() {
            if (!currentProjectId) return alert('Select a project first');
            const file = document.getElementById('siteImageUploader').files[0];
            if (!file) return alert('Pick an image!');

            const blob = await resizeImage(file, 2048);
            const folder = `public/projects/${currentProjectId}/siteImages`;
            const uniqueName = await getUniqueFilename(folder, sanitize(file.name));
            const path = `${folder}/${uniqueName}`;

            await uploadBytes(storageRef(storage, path), blob);
            await updateSiteImages();
            alert(`Uploaded as “${uniqueName}”`);
        }

        document.getElementById('uploadSiteImage').onclick = uploadSiteImage;
        document.getElementById('nextSiteImage').onclick = nextSiteImage;
        document.getElementById('prevSiteImage').onclick = prevSiteImage;
        document.getElementById('rotateSiteImage').onclick = rotateSiteImage;

        const _origLoad = loadProject;
        loadProject = async id => {
            await _origLoad(id);
            await updateSiteImages();
        };

        async function getUniqueFilename(folderPath, filename) {
            const idx = filename.lastIndexOf('.');
            const base = idx >= 0 ? filename.slice(0, idx) : filename;
            const ext = idx >= 0 ? filename.slice(idx) : '';
            let name = base;
            let suffix = 1;

            while (true) {
                const path = `${folderPath}/${name}${ext}`;
                try {
                    await getDownloadURL(storageRef(storage, path));
                    name = `${base}_${suffix++}`;
                } catch (e) {
                    if (e.code === 'storage/object-not-found') {
                        return name + ext;
                    }
                    throw e;
                }
            }
        }

        populateProjects();
    </script>
</body>

</html>