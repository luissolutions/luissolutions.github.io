<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Inventory</title>

    <link rel="stylesheet" href="../assets/css/app-styles.css" id="stylesheet">
    <link rel="stylesheet" href="./assets/css/inventory.css">

    <script type="module" src="./assets/js/login.js" defer></script>

    <style>
        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }

        .grow {
            flex: 1;
            min-width: 240px;
        }

        .tight {
            flex: 0;
            min-width: 160px;
        }

        .small {
            font-size: 0.92rem;
            margin-top: 8px;
        }

        .muted {
            opacity: 0.75;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 12px;
        }

        .card {
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.12);
            padding: 10px;
        }

        .top {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
        }

        .name {
            font-weight: 600;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.25);
            padding-bottom: 2px;
        }

        .amt {
            font-variant-numeric: tabular-nums;
            opacity: 0.95;
        }

        .thumb {
            width: 100%;
            height: 160px;
            margin-top: 10px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
        }

        .fields {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .field .label {
            font-size: 0.85rem;
            opacity: 0.75;
            margin-bottom: 4px;
        }

        .edit {
            border-bottom: 1px dashed rgba(255, 255, 255, 0.25);
            padding: 2px 0;
            min-height: 22px;
        }

        .expandBtn {
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.18);
            color: inherit;
            border-radius: 10px;
            padding: 4px 10px;
            cursor: pointer;
        }

        .expandArea {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.18);
        }
    </style>
</head>

<body>
    <header>
        <h1>Inventory</h1>

        <section id="login-section">
            <form id="login-form" class="row">
                <div>
                    <label>Email</label>
                    <input type="email" id="username" required>
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="tight">
                    <label>&nbsp;</label>
                    <button class="btn" type="submit">Login</button>
                </div>
            </form>

            <button id="logout" class="btn" style="display:none; margin-top:10px;">Logout</button>

        </section>

        <section>
            <div class="row">
                <div class="tight">
                    <label>Year</label>
                    <select id="yearSelect"></select>
                </div>

                <div class="grow">
                    <label>Search</label>
                    <input id="q" placeholder="Search name, tags, cat, sku…" />
                </div>

                <div class="tight">
                    <label>Show</label>
                    <select id="mode">
                        <option value="all" selected>All (expenses + income)</option>
                        <option value="expenses">Expenses only</option>
                        <option value="inv">Inventory only (tag: inv)</option>
                    </select>
                </div>
            </div>

            <div class="small" id="summary">Loading…</div>
        </section>
    </header>

    <main class="wrap">
        <section id="list" class="grid"></section>
        <p id="empty" class="muted" style="display:none;">No matches.</p>
    </main>

    <script type="module">
        import {
            auth, onAuthStateChanged,
            database, ref, onValue, set,
            storage, storageRef, uploadBytes, getDownloadURL, deleteObject
        } from '../assets/js/firebase-init.js';

        /* =========================
           CONFIG (year-separated)
        ========================== */
        const TX_NODE = 'ledgerTx';
        let DATABASE_BASE_PATH = 'public';
        let currentYear = new Date().getUTCFullYear();

        function txYearsRootPath() {
            return `${DATABASE_BASE_PATH}/${TX_NODE}`;
        }
        function txYearPath(year) {
            return `${txYearsRootPath()}/${year}`;
        }
        function txItemPath(year, id) {
            return `${txYearPath(year)}/${id}`;
        }
        function imgBasePath() {
            return `${DATABASE_BASE_PATH}/txImages`;
        }

        /* =========================
           HELPERS
        ========================== */
        const $ = (id) => document.getElementById(id);

        function pad2(n) { return String(n).padStart(2, '0'); }

        function ymdFromUtcTS(ts) {
            const dt = new Date(Number(ts));
            if (Number.isNaN(dt.getTime())) return '';
            return `${dt.getUTCFullYear()}-${pad2(dt.getUTCMonth() + 1)}-${pad2(dt.getUTCDate())}`;
        }

        function utcNoonTSFromYMD(ymd) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return Date.now();
            const y = +ymd.slice(0, 4);
            const m = +ymd.slice(5, 7) - 1;
            const d = +ymd.slice(8, 10);
            return Date.UTC(y, m, d, 12, 0, 0);
        }

        function fmtUSD(n) {
            return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' })
                .format(Number(n) || 0);
        }

        function parseTags(input) {
            if (!input) return [];
            return String(input).split(',').map(t => t.trim()).filter(Boolean).slice(0, 25);
        }

        function hasTag(tx, want) {
            const w = String(want || '').toLowerCase();
            return (tx.tags || []).some(t => String(t).toLowerCase() === w);
        }

        function safeURL(u) {
            const s = String(u || '').trim();
            if (!s) return '';
            if (/^https?:\/\//i.test(s)) return s;
            return '';
        }

        function roundMoney(n) {
            return Math.round((Number(n) || 0) * 100) / 100;
        }

        function normalizeTx(id, v) {
            if (!v || typeof v !== 'object') return null;

            const dateTS = Number(v.date);
            if (!Number.isFinite(dateTS)) return null;

            const type = String(v.type || '').toLowerCase();
            const normType = (type === 'income') ? 'income' : 'expense';
            const tags = Array.isArray(v.tags) ? v.tags.map(t => String(t).trim()).filter(Boolean) : [];

            return {
                id: String(id),
                amt: Number(v.amt ?? 0),
                altAmt: Number(v.altAmt ?? 0),
                cat: String(v.cat ?? ''),
                sub: String(v.sub ?? ''),
                sku: String(v.sku ?? ''),
                link: String(v.link ?? ''),
                img: (typeof v.img === 'string') ? v.img : (v.img?.url || ''),
                imgPath: (typeof v.imgPath === 'string') ? v.imgPath : (v.img?.path || ''),
                desc: String(v.desc ?? ''),
                name: String(v.name ?? ''),
                tags,
                type: normType,
                date: dateTS
            };
        }

        function stripTxForSave(t) {
            return {
                amt: Number(t.amt ?? 0),
                altAmt: Number(t.altAmt ?? 0),
                cat: String(t.cat ?? ''),
                sub: String(t.sub ?? ''),
                sku: String(t.sku ?? ''),
                link: String(t.link ?? ''),
                img: String(t.img ?? ''),
                imgPath: String(t.imgPath ?? ''),
                desc: String(t.desc ?? ''),
                name: String(t.name ?? ''),
                tags: Array.isArray(t.tags) ? t.tags : [],
                type: (String(t.type || '').toLowerCase() === 'income') ? 'income' : 'expense',
                date: Number(t.date ?? Date.now())
            };
        }

        async function writeTx(year, id, obj) {
            await set(ref(database, txItemPath(year, id)), obj);
        }

        async function deleteTx(year, id) {
            await set(ref(database, txItemPath(year, id)), null);
        }

        function groupKeyForTx(t) {
            const sku = String(t.sku || '').trim();
            if (sku) return `sku:${sku.toLowerCase()}`;
            const nm = String(t.name || '').trim();
            return `name:${nm.toLowerCase()}`;
        }

        function labelForGroup(t) {
            const sku = String(t.sku || '').trim();
            return sku ? sku : (t.name || '(no name)');
        }

        function buildGroups(list) {
            const map = new Map();

            for (const t of list) {
                const key = groupKeyForTx(t);
                if (!map.has(key)) {
                    map.set(key, {
                        key,
                        sku: String(t.sku || '').trim(),
                        name: String(t.name || '').trim(),
                        qty: 0,
                        total: 0,
                        prices: new Map(), // price -> count
                        latest: t,
                        all: []
                    });
                }

                const g = map.get(key);
                g.all.push(t);

                g.qty += 1;
                g.total += Math.abs(Number(t.amt) || 0);

                const price = roundMoney(Math.abs(Number(t.amt) || 0));
                g.prices.set(price, (g.prices.get(price) || 0) + 1);

                const isNewer =
                    (Number(t.date) > Number(g.latest?.date || 0)) ||
                    (Number(t.date) === Number(g.latest?.date || 0) && String(t.id) > String(g.latest?.id || ''));
                if (isNewer) g.latest = t;

                if (!g.sku && t.sku) g.sku = String(t.sku).trim();
                if (!g.name && t.name) g.name = String(t.name).trim();
            }

            const out = Array.from(map.values());
            for (const g of out) g.total = roundMoney(g.total);

            out.sort((a, b) => (Number(b.latest?.date || 0) - Number(a.latest?.date || 0)));
            return out;
        }

        /* =========================
           STATE + LISTENERS
        ========================== */
        let _yearTx = [];         // ONLY tx for the selected year
        let yearsUnsub = null;    // listener for years list
        let yearUnsub = null;     // listener for selected year records
        let uiBound = false;
        const _selectedPriceByGroup = new Map(); // groupKey -> number(price)

        onAuthStateChanged(auth, (user) => {
            DATABASE_BASE_PATH = user ? `${user.uid}` : 'public';

            if (typeof yearsUnsub === 'function') { yearsUnsub(); yearsUnsub = null; }
            if (typeof yearUnsub === 'function') { yearUnsub(); yearUnsub = null; }

            bindUIOnce();
            attachYearsListener();
        });

        function bindUIOnce() {
            if (uiBound) return;
            uiBound = true;

            $('yearSelect')?.addEventListener('change', () => {
                currentYear = parseInt($('yearSelect').value, 10) || currentYear;
                attachYearListener(currentYear);
            });

            $('q')?.addEventListener('input', renderAll);
            $('mode')?.addEventListener('change', renderAll);
        }

        function attachYearsListener() {
            const r = ref(database, txYearsRootPath());
            yearsUnsub = onValue(r, (snap) => {
                const raw = snap.exists() ? snap.val() : {};
                const years = Object.keys(raw || {})
                    .map(y => parseInt(y, 10))
                    .filter(n => Number.isFinite(n))
                    .sort((a, b) => a - b);

                // Ensure current year is present
                if (!years.includes(currentYear)) years.push(currentYear);

                // Populate dropdown without breaking selection
                const sel = $('yearSelect');
                const prev = parseInt(sel.value, 10) || currentYear;
                sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                sel.value = String(years.includes(prev) ? prev : currentYear);

                currentYear = parseInt(sel.value, 10) || currentYear;
                attachYearListener(currentYear);
            }, (err) => console.error('❌ years listener error:', err));
        }

        function attachYearListener(year) {
            if (typeof yearUnsub === 'function') { yearUnsub(); yearUnsub = null; }

            const r = ref(database, txYearPath(year));
            yearUnsub = onValue(r, (snap) => {
                const raw = snap.exists() ? snap.val() : {};
                const out = [];
                for (const [id, v] of Object.entries(raw || {})) {
                    const n = normalizeTx(id, v);
                    if (n) out.push(n);
                }
                _yearTx = out;
                renderAll();
            }, (err) => console.error('❌ year listener error:', err));
        }

        /* =========================
           FILTERS + RENDER
        ========================== */
        function applyMode(list) {
            const mode = $('mode')?.value || 'all';
            if (mode === 'expenses') return list.filter(t => t.type === 'expense');
            if (mode === 'inv') return list.filter(t => t.type === 'expense' && hasTag(t, 'inv'));
            return list;
        }

        function applySearch(list) {
            const q = String($('q')?.value || '').trim().toLowerCase();
            if (!q) return list;

            const m = q.match(/\btag\s*:\s*(?:"([^"]+)"|([^\s]+))/i);
            if (m) {
                const want = (m[1] || m[2] || '').toLowerCase();
                return list.filter(t => (t.tags || []).some(x => String(x).toLowerCase() === want));
            }

            return list.filter(t => {
                const blob = [
                    t.name, t.desc, t.cat, t.sub, t.sku, t.link, (t.tags || []).join(' ')
                ].join(' ').toLowerCase();
                return blob.includes(q);
            });
        }

        function setSummary(lines, groups) {
            let spend = 0, income = 0;
            for (const t of lines) {
                const v = Math.abs(Number(t.amt) || 0);
                if (t.type === 'income') income += v;
                else spend += v;
            }
            $('summary').innerHTML =
                `Year <b>${currentYear}</b> • Groups: <b>${groups.length}</b> • Lines: <b>${lines.length}</b> • Income: <b>${fmtUSD(income)}</b> • Spending: <b>${fmtUSD(spend)}</b>`;
        }

        function renderAll() {
            const lines = applySearch(applyMode(_yearTx.slice()));
            const groups = buildGroups(lines);

            setSummary(lines, groups);
            renderGroupList(groups);
        }

        function renderGroupList(groups) {
            const wrap = $('list');
            const empty = $('empty');
            wrap.innerHTML = '';

            if (!groups.length) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            for (const g of groups) wrap.appendChild(renderGroupCard(g));
        }

        /* =========================
           CARD UI (grouped)
        ========================== */
        function renderGroupCard(g) {
            // Sort group's lines newest -> oldest (stable)
            const sorted = g.all.slice().sort((a, b) =>
                (Number(b.date) - Number(a.date)) || String(b.id).localeCompare(String(a.id))
            );

            // Price options (distinct prices)
            const distinctPrices = Array.from(g.prices.entries())
                .sort((a, b) => a[0] - b[0]); // [price, count]

            // Determine selected price for this group
            const defaultPrice = roundMoney(Math.abs(Number(sorted[0]?.amt || 0)));
            let selectedPrice = _selectedPriceByGroup.has(g.key)
                ? _selectedPriceByGroup.get(g.key)
                : defaultPrice;

            // If selection isn't valid anymore, fall back
            const validPrices = new Set(distinctPrices.map(([p]) => p));
            if (!validPrices.has(selectedPrice)) selectedPrice = defaultPrice;

            const t = sorted[0];


            const card = document.createElement('div');
            card.className = 'card';

            // Header row
            const top = document.createElement('div');
            top.className = 'top';

            const title = document.createElement('div');
            title.className = 'name';
            title.textContent = labelForGroup(t);

            const right = document.createElement('div');
            right.className = 'amt';

            const qtyTxt = document.createElement('span');
            qtyTxt.textContent = `${g.qty} × • Total: ${fmtUSD(g.total)}`;

            // Only show expand for groups with multiples
            let expandBtn = null;
            if (g.qty > 1) {
                expandBtn = document.createElement('button');
                expandBtn.className = 'expandBtn';
                expandBtn.type = 'button';
                expandBtn.textContent = '▾';
                expandBtn.title = 'Show all lines in this group';
                right.append(qtyTxt, document.createTextNode(' '), expandBtn);
            } else {
                right.append(qtyTxt);
            }

            top.append(title, right);

            // Prices UI
            const priceWrap = document.createElement('div');
            priceWrap.className = 'small muted';

            // If only one price OR only one line, no dropdown
            if (g.qty <= 1 || distinctPrices.length <= 1) {
                const p = distinctPrices.length ? distinctPrices[0][0] : roundMoney(Math.abs(Number(t.amt || 0)));
                priceWrap.textContent = `Price: ${fmtUSD(p)}`;
            } else {
                const label = document.createElement('span');
                label.textContent = 'Prices: ';

                const sel = document.createElement('select');
                for (const [price, count] of distinctPrices) {
                    const opt = document.createElement('option');
                    opt.value = String(price);
                    opt.textContent = `${fmtUSD(price)} (${count})`;
                    sel.appendChild(opt);
                }
                sel.value = String(selectedPrice);

                const hint = document.createElement('span');
                hint.style.marginLeft = '8px';
                hint.textContent = 'Select a price to target a line (newest matching that price).';

                sel.addEventListener('change', () => {
                    const p = parseFloat(sel.value);
                    _selectedPriceByGroup.set(g.key, Number.isFinite(p) ? p : defaultPrice);
                    renderAll();
                });

                const priceWrap = document.createElement('div');
                priceWrap.className = 'small muted';
                priceWrap.textContent = (g.qty > 1)
                    ? `Grouped item • ${g.qty} lines`
                    : `Single item`;
            }

            // Main view (selected line)
            const mainLineCard = renderLineCard(t, g, { showMetaPrefix: 'Selected line' });

            // Expand area (ONLY for qty > 1)
            if (g.qty > 1) {
                const expandArea = document.createElement('div');
                expandArea.className = 'expandArea';

                const expandHdr = document.createElement('div');
                expandHdr.className = 'small muted';
                expandHdr.textContent = `All lines (${sorted.length}) — newest first`;
                expandArea.appendChild(expandHdr);

                // IMPORTANT: don't duplicate the main selected line in the expanded list
                const expandedLines = sorted.filter(x => String(x.id) !== String(t.id));

                for (const line of expandedLines) {
                    const sub = document.createElement('div');
                    sub.className = 'card';
                    sub.style.marginTop = '10px';
                    sub.appendChild(renderLineCard(line, g, { compact: true }));
                    expandArea.appendChild(sub);
                }

                expandBtn.addEventListener('click', () => {
                    const open = expandArea.style.display === 'block';
                    expandArea.style.display = open ? 'none' : 'block';
                    expandBtn.textContent = open ? '▾' : '▴';
                });

                card.append(top, priceWrap, mainLineCard, expandArea);
                return card;
            }

            // qty === 1 (no expand area)
            card.append(top, priceWrap, mainLineCard);
            return card;
        }

        function renderLineCard(t, g, opts = {}) {
            const wrap = document.createElement('div');

            // Image
            const img = document.createElement('img');
            img.className = 'thumb';
            img.alt = (t.name || t.sku || 'item');
            img.src = t.img ? t.img : 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="800" height="450">
                <rect width="100%" height="100%" fill="rgba(255,255,255,0.06)"/>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                    fill="rgba(255,255,255,0.55)" font-family="Arial" font-size="28">No Image</text>
                </svg>
            `);

            img.style.cursor = t.img ? 'pointer' : 'default';
            img.addEventListener('click', () => {
                if (!t.img) return;
                window.open(t.img, '_blank', 'noopener,noreferrer');
            });

            // Image controls (act on THIS line)
            const imgRow = document.createElement('div');
            imgRow.className = 'row';

            const file = document.createElement('input');
            file.type = 'file';
            file.accept = 'image/*';
            file.style.display = 'none';

            const upBtn = document.createElement('button');
            upBtn.className = 'btn';
            upBtn.textContent = t.img ? 'Replace Image' : 'Upload Image';
            upBtn.addEventListener('click', () => file.click());

            file.addEventListener('change', async () => {
                const f = file.files?.[0];
                file.value = '';
                if (!f) return;

                try {
                    upBtn.disabled = true;
                    upBtn.textContent = 'Uploading…';

                    const safeName = f.name.replace(/[^\w.\-]+/g, '_');
                    const storagePath = `${imgBasePath()}/${t.id}_${Date.now()}_${safeName}`;

                    const sref = storageRef(storage, storagePath);
                    await uploadBytes(sref, f);
                    const url = await getDownloadURL(sref);

                    await writeTx(currentYear, t.id, stripTxForSave({ ...t, img: url, imgPath: storagePath }));
                } catch (err) {
                    console.error(err);
                    alert('❌ Upload failed.');
                } finally {
                    upBtn.disabled = false;
                    upBtn.textContent = t.img ? 'Replace Image' : 'Upload Image';
                }
            });

            const delImgBtn = document.createElement('button');
            delImgBtn.className = 'btn danger';
            delImgBtn.textContent = 'Delete Image';
            delImgBtn.disabled = !t.img && !t.imgPath;

            delImgBtn.addEventListener('click', async () => {
                if (!confirm('Delete this image for THIS line?')) return;

                try {
                    if (t.imgPath) {
                        const sref = storageRef(storage, t.imgPath);
                        await deleteObject(sref);
                    }
                } catch (err) {
                    console.warn('Storage delete failed:', err);
                }

                await writeTx(currentYear, t.id, stripTxForSave({ ...t, img: '', imgPath: '' }));
            });

            imgRow.append(upBtn, delImgBtn, file);

            // Editable fields
            const fields = document.createElement('div');
            fields.className = 'fields';

            fields.appendChild(fieldText('Name', t.name, async (next) => {
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, name: next }));
            }));

            fields.appendChild(fieldText('SKU', t.sku, async (next) => {
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, sku: next }));
            }));

            fields.appendChild(fieldText('Price', String(roundMoney(Math.abs(Number(t.amt || 0)))), async (next) => {
                const v = roundMoney(Math.abs(Number(String(next).replace(/[^0-9.\-]/g, '')) || 0));
                const signed = (t.type === 'income') ? v : -v;
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, amt: signed }));
            }));

            fields.appendChild(fieldText('Alt Price', String(roundMoney(Math.abs(Number(t.altAmt || 0)))), async (next) => {
                const v = roundMoney(Math.abs(Number(String(next).replace(/[^0-9.\-]/g, '')) || 0));
                const signed = (t.type === 'income') ? v : -v;
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, altAmt: signed }));
            }));

            fields.appendChild(fieldText('Tags', (t.tags || []).join(', '), async (next) => {
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, tags: parseTags(next) }));
            }));

            fields.appendChild(fieldText('Category', t.cat, async (next) => {
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, cat: next }));
            }));

            fields.appendChild(fieldLink(t));

            // Meta
            const meta = document.createElement('div');
            meta.className = 'small muted';
            const prefix = opts.showMetaPrefix ? `${opts.showMetaPrefix}: ` : '';
            meta.textContent =
                `${prefix}${ymdFromUtcTS(t.date)} • Price: ${fmtUSD(Math.abs(t.amt || 0))} • ID: ${t.id}`;

            // Delete THIS line
            const bottom = document.createElement('div');
            bottom.className = 'row';

            const delTxBtn = document.createElement('button');
            delTxBtn.className = 'btn danger';
            delTxBtn.textContent = 'Delete Line';
            delTxBtn.addEventListener('click', async () => {
                if (!confirm('Delete THIS line?')) return;
                await deleteTx(currentYear, t.id);
            });

            bottom.append(delTxBtn);

            // Build
            wrap.append(img, imgRow, fields, meta, bottom);
            return wrap;
        }

        function fieldWrap(labelText) {
            const w = document.createElement('div');
            w.className = 'field';

            const l = document.createElement('div');
            l.className = 'label';
            l.textContent = labelText;

            const v = document.createElement('div');
            v.className = 'value';

            w.append(l, v);
            return { w, v };
        }

        function fieldText(label, value, onCommit) {
            const { w, v } = fieldWrap(label);

            const d = document.createElement('div');
            d.className = 'edit';
            d.contentEditable = 'true';
            d.spellcheck = false;
            d.textContent = value ?? '';

            d.addEventListener('focus', e => e.target.dataset.orig = e.target.innerText);
            d.addEventListener('blur', async (e) => {
                const next = e.target.innerText.trim();
                const prev = (e.target.dataset.orig || '').trim();
                if (next === prev) return;
                await onCommit(next);
            });

            v.appendChild(d);
            return w;
        }

        function fieldLink(t) {
            const { w, v } = fieldWrap('Link');

            const a = document.createElement('a');
            const href = safeURL(t.link);

            a.textContent = t.link ? t.link : '(none)';
            a.href = href || '#';
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            if (!href) a.className = 'muted';
            a.addEventListener('click', (e) => { if (!href) e.preventDefault(); });

            const inp = document.createElement('input');
            inp.placeholder = 'https://...';
            inp.value = t.link || '';
            inp.addEventListener('change', async () => {
                const next = inp.value.trim();
                await writeTx(currentYear, t.id, stripTxForSave({ ...t, link: next }));
            });

            v.append(a, document.createElement('div'), inp);
            return w;
        }

        document.addEventListener('DOMContentLoaded', () => {

            const headerTitle = document.querySelector('header h1');
            const loginSection = document.getElementById('login-section');

            headerTitle.addEventListener('dblclick', () => {
                loginSection.style.display =
                    loginSection.style.display === 'none' || getComputedStyle(loginSection).display === 'none'
                        ? 'block'
                        : 'none';
            });
        });

    </script>

</body>

</html>