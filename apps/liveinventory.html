<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            justify-content: space-between;
            border-radius: 4px;
            font-size: x-large;
        }

        body {
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 15px;
        }

        form {
            justify-content: center;
            display: grid;
            flex-direction: column;
        }

        table {
            margin: auto;
            border-collapse: collapse;
            border: 1px solid black;
            overflow-x: auto;
        }

        table td,
        th {
            border: 1px solid darkgray;
        }

        input {
            text-align: center;
        }

        input, button {
            padding: 12px 20px;
            border: 1px black solid;
            margin-top: 6px;
            margin-bottom: 6px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
        }

        .modal-content img {
            width: 100%;
            max-width: 100%;
            height: auto;
        }

        .item-container input {
            height: 30px;
            width: 30px;
        }

        .radios {
            display: block;
        }

        .radios input {
            margin-left: 15px;
        }
    </style>
</head>

<body>
    <main>
        <section>
            <div class="container">
                <h1>Inventory App</h1>

                <div>
                    <label for="category">Select Category:</label>
                </div>
                <div class="radios" id="categoryRadios">
                    <!-- Radios will be appended here -->
                </div>
                <br>
                <div class="image-container">
                    <label for="selectionImage">Selection Image:</label>
                    <br>
                    <img id="selectionImage" src="../assets/img/default.png" alt="Selected Selection Image"
                        width="280" />
                </div>
                <br>
                <label for="selectionSelect">Select Type:</label>
                <select id="selectionSelect"></select>
                <br>
                <div id="itemOptions"></div>

                <h3>Total Amount: <span id="totalAmount">0</span></h3>
            </div>
        </section>
        <form id="dataModifyForm">
            <label for="categoryInput">Category:</label>
            <input type="text" id="categoryInput" required>

            <label for="selectionInput">Type:</label>
            <input type="text" id="selectionInput" required>

            <label for="itemInput">Item:</label>
            <input type="text" id="itemInput">

            <label for="amountInput">Amount:</label>
            <input type="number" id="amountInput">

            <button type="button" id="clearButton">Clear</button>
            <br>
            <button type="submit">Submit</button>
            <button type="button" id="deleteButton">Delete</button>
            <button type="button" id="undoButton">Undo</button>
        </form>
    </main>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <img id="modalImage" src="" alt="Enlarged Image">
        </div>
    </div>

    <script type="module">
        const appSettings = {
            databaseURL: "https://inventory-54829-default-rtdb.firebaseio.com/"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getDatabase, ref, onValue, set, remove } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js';

        const app = initializeApp(appSettings);
        const database = getDatabase(app);

        const selectionSelect = document.getElementById('selectionSelect');
        const itemOptions = document.getElementById('itemOptions');
        const totalAmountElement = document.getElementById('totalAmount');
        const defaultImageSrc = '../assets/img/default.png';

        function loadCategories() {
            const categoriesRef = ref(database, 'Items');
            onValue(categoriesRef, (snapshot) => {
                const categories = snapshot.val();
                const categoryRadios = document.getElementById('categoryRadios');
                categoryRadios.innerHTML = '';

                for (let category in categories) {
                    const radioInput = document.createElement('input');
                    radioInput.type = 'radio';
                    radioInput.id = category;
                    radioInput.name = 'category';
                    radioInput.value = category;

                    const label = document.createElement('label');
                    label.htmlFor = category;
                    label.textContent = category;

                    categoryRadios.appendChild(radioInput);
                    categoryRadios.appendChild(label);

                    radioInput.addEventListener('change', function () {
                        loadData();
                        localStorage.setItem('selectedCategory', category);
                    });

                    const storedCategory = localStorage.getItem('selectedCategory');
                    if (storedCategory && storedCategory === category) {
                        radioInput.checked = true;
                    }
                }
                loadData();
            });
        }

        function loadData() {
            const selectedCategoryRadio = document.querySelector('input[name="category"]:checked');
            if (!selectedCategoryRadio) return;

            const selectedCategory = selectedCategoryRadio.value;
            const categoryRef = ref(database, `Items/${selectedCategory}`);

            onValue(categoryRef, (snapshot) => {
                const categoryData = snapshot.val();

                selectionSelect.innerHTML = '';
                itemOptions.innerHTML = '';
                totalAmountElement.textContent = '0';

                if (categoryData) {
                    const selections = Object.keys(categoryData).sort();

                    selections.forEach((selection) => {
                        const option = document.createElement('option');
                        option.value = selection;
                        option.textContent = selection;
                        selectionSelect.appendChild(option);
                    });

                    const storedSelection = localStorage.getItem('selectedSelection');
                    if (storedSelection && selections.includes(storedSelection)) {
                        selectionSelect.value = storedSelection;
                    }

                    selectionSelect.dispatchEvent(new Event('change'));
                }
            });
        }

        selectionSelect.addEventListener('change', () => {
            const selectedCategoryRadio = document.querySelector('input[name="category"]:checked');
            if (!selectedCategoryRadio) return;

            const selectedCategory = selectedCategoryRadio.value;
            const selectedSelection = selectionSelect.value;
            const selectionImage = document.getElementById('selectionImage');
            selectionImage.src = `../websites/kamehouse/img/${selectedSelection}.png`;
            selectionImage.onerror = () => {
                selectionImage.src = defaultImageSrc;
            };

            const itemRef = ref(database, `Items/${selectedCategory}/${selectedSelection}`);

            onValue(itemRef, (snapshot) => {
                const itemData = snapshot.val();

                if (itemData) {
                    itemOptions.innerHTML = '';
                    const items = Object.keys(itemData).sort();

                    items.forEach((item) => {
                        const itemAmount = itemData[item];

                        // Create a div to contain the checkbox, image, and label
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('item-container');

                        const itemCheckbox = document.createElement('input');
                        itemCheckbox.type = 'checkbox';
                        itemCheckbox.dataset.amount = itemAmount;

                        // Listen for changes on checkbox to update the total amount
                        itemCheckbox.addEventListener('change', updateTotalAmount);

                        const itemImg = document.createElement('img');
                        itemImg.src = `../websites/kamehouse/img/${item}.png`;
                        itemImg.alt = item;
                        itemImg.width = 50;
                        itemImg.onerror = () => {
                            itemImg.src = defaultImageSrc;
                        };
                        itemImg.classList.add('item-image');

                        // Add the elements to the item div
                        itemDiv.appendChild(itemCheckbox);
                        itemDiv.appendChild(itemImg);
                        itemDiv.appendChild(document.createTextNode(`${item} - Amount: ${itemAmount}`));

                        // Add the item div to the options container
                        itemOptions.appendChild(itemDiv);

                        // Event listener on itemDiv
                        itemDiv.addEventListener('click', (event) => {
                            if (event.target.classList.contains('item-image')) {
                                showImageModal(event.target.src);
                                event.stopPropagation();  // prevent the event from bubbling up to other elements
                            }
                        });
                    });
                }
            });
        });

        function updateTotalAmount() {
            const checkboxes = document.querySelectorAll('#itemOptions input[type="checkbox"]');
            let total = 0;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    total += parseFloat(checkbox.dataset.amount);
                }
            });

            totalAmountElement.textContent = total.toFixed(0); // Displaying the total with no decimal places
        }
        loadCategories();

        document.getElementById('dataModifyForm').addEventListener('submit', function (event) {
            event.preventDefault(); // prevent the default form submission behavior

            const category = document.getElementById('categoryInput').value;
            const selection = document.getElementById('selectionInput').value;
            const item = document.getElementById('itemInput').value;
            const amount = document.getElementById('amountInput').value;

            if (category && selection) {
                let path = `Items/${category}/${selection}`;

                if (item) {
                    path += `/${item}`;
                }

                set(ref(database, path), amount);
            } else {
                alert('Category and Selection are required!');
            }
        });

        // Function to store deleted data in localStorage
        function storeDeletedData(category, selection, itemName, itemAmount) {
            const deletedData = {
                category,
                selection,
                itemName,
                itemAmount,
            };
            localStorage.setItem('deletedData', JSON.stringify(deletedData));
        }

        // Function to restore deleted data from localStorage
        function restoreDeletedData() {
            const deletedData = localStorage.getItem('deletedData');
            if (deletedData) {
                const { category, selection, itemName, itemAmount } = JSON.parse(deletedData);

                // Restore the deleted data by adding it back to the database
                const path = `Items/${category}/${selection}/${itemName}`;
                set(ref(database, path), itemAmount)
                    .then(() => {
                        alert(`Data for item '${itemName}' restored successfully!`);
                        localStorage.removeItem('deletedData'); // Clear the deleted data from localStorage
                    })
                    .catch((error) => {
                        console.error(`Error restoring data for item '${itemName}':`, error);
                        alert(`Failed to restore data for item '${itemName}'!`);
                    });
            } else {
                alert('No deleted data to restore.');
            }
        }

        // Attach an event listener to the "Delete" button
        document.getElementById('deleteButton').addEventListener('click', function () {
            const category = document.getElementById('categoryInput').value;
            const selection = document.getElementById('selectionInput').value;
            const itemInput = document.getElementById('itemInput').value;

            if (category && selection) {
                let path = `Items/${category}/${selection}`;

                const checkedItems = Array.from(document.querySelectorAll('#itemOptions input[type="checkbox"]:checked'));

                if (checkedItems.length > 0) {
                    checkedItems.forEach((checkbox) => {
                        const itemName = checkbox.parentElement.querySelector('.item-image').alt;
                        const itemAmount = checkbox.dataset.amount;

                        // Store the deleted data in localStorage
                        storeDeletedData(category, selection, itemName, itemAmount);

                        // Remove the data from the database
                        path = `Items/${category}/${selection}/${itemName}`;
                        remove(ref(database, path))
                            .then(() => {
                                alert('Data deleted successfully!');
                            })
                            .catch((error) => {
                                console.error("Error deleting data: ", error);
                                alert('Failed to delete data!');
                            });
                    });
                } else if (itemInput) {
                    // Delete items specified in the "Item" input field
                    const itemsToDelete = itemInput.split(',').map(item => item.trim());
                    itemsToDelete.forEach(itemName => {
                        // Store the deleted data in localStorage
                        const itemAmount = 'unknown'; // You may need to fetch the amount from the database if it's unknown here
                        storeDeletedData(category, selection, itemName, itemAmount);

                        // Remove the data from the database
                        path = `Items/${category}/${selection}/${itemName}`;
                        remove(ref(database, path))
                            .then(() => {
                                alert(`Data for item '${itemName}' deleted successfully!`);
                            })
                            .catch((error) => {
                                console.error(`Error deleting data for item '${itemName}':`, error);
                                alert(`Failed to delete data for item '${itemName}'!`);
                            });
                    });
                } else {
                    alert('Please select items to delete or specify items in the "Item" field.');
                }
            } else {
                alert('Category and Selection are required to delete!');
            }
        });

        // Attach an event listener to the "Undo" button
        document.getElementById('undoButton').addEventListener('click', function () {
            restoreDeletedData();
        });

        itemOptions.addEventListener('change', (event) => {
            const selectedCategoryRadio = document.querySelector('input[name="category"]:checked');
            if (!selectedCategoryRadio) return;

            const selectedCategory = selectedCategoryRadio.value;
            const selectedSelection = selectionSelect.value;
            const checkboxes = document.querySelectorAll('#itemOptions input[type="checkbox"]:checked');

            if (checkboxes.length > 0) {
                const selectedItems = Array.from(checkboxes).map((checkbox) => {
                    const itemName = checkbox.parentElement.querySelector('.item-image').alt;
                    const itemAmount = checkbox.dataset.amount;
                    return { name: itemName, amount: itemAmount };
                });

                // Populate the input fields with the information of the checked items
                const categoryInput = document.getElementById('categoryInput');
                const selectionInput = document.getElementById('selectionInput');
                const itemInput = document.getElementById('itemInput');
                const amountInput = document.getElementById('amountInput');

                categoryInput.value = selectedCategory;
                selectionInput.value = selectedSelection;
                itemInput.value = selectedItems.map((item) => item.name).join(', ');
                amountInput.value = selectedItems.reduce((total, item) => total + parseFloat(item.amount), 0);
            } else {
                // If no items are checked, clear the input fields
                const categoryInput = document.getElementById('categoryInput');
                const selectionInput = document.getElementById('selectionInput');
                const itemInput = document.getElementById('itemInput');
                const amountInput = document.getElementById('amountInput');

                categoryInput.value = '';
                selectionInput.value = '';
                itemInput.value = '';
                amountInput.value = '';
            }
        });
    </script>
    <script>
        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            modalImage.src = imageSrc;
            modal.style.display = "block";
        }
        const modal = document.getElementById('imageModal');
        modal.addEventListener('click', function (event) {
            modal.style.display = 'none';
        });
        const itemImages = document.querySelectorAll('.image-container img, #itemOptions img');
        itemImages.forEach(img => {
            img.addEventListener('click', function () {
                showImageModal(img.src);
            });
        });
    </script>
</body>