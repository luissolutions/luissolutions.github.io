<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            justify-content: space-between;
        }
        body {
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 15px;
        }

        form {
            justify-content: center;
            display: grid;
            flex-direction: column;
        }

        table {
            margin: auto;
            border-collapse: collapse;
            border: 1px solid black;
            overflow-x: auto;
        }

        table td,
        th {
            border: 1px solid darkgray;
        }
        input {
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            /* Stay in place */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.7);
            /* Black w/ opacity */
            z-index: 1000;
            /* Sit on top */
        }

        .modal-content {
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
        }

        .modal-content img {
            width: 100%;
            max-width: 100%;
            height: auto;
        }
        
        .feature-container input {
            height: 25px;
            width: 25px;
        }
    </style>
</head>

<body>
    <main>
        <section>
            <div class="container">
                <h1>Inventory App</h1>

                <div>
                    <label for="category">Select Category:</label>
                </div>
                <div class="radios" id="categoryRadios">
                    <!-- Radios will be appended here -->
                </div>
                <div class="image-container">
                    <label for="itemImage">Item Image:</label>
                    <br>
                    <img id="itemImage" src="../assets/img/default.png" alt="Selected Item Image" width="280" />
                </div>

                <label for="itemSelect">Select Item:</label>
                <select id="itemSelect"></select>
                <br>
                <div id="featureOptions"></div>

                <h3>Total Amount: <span id="totalAmount">0</span></h3>
            </div>
        </section>
        <form id="dataModifyForm">
            <label for="categoryInput">Category:</label>
            <input type="text" id="categoryInput" required>

            <label for="itemInput">Item:</label>
            <input type="text" id="itemInput" required>

            <label for="featureInput">Feature:</label>
            <input type="text" id="featureInput">

            <label for="amountInput">Amount:</label>
            <input type="number" id="amountInput">

            <button type="submit">Submit</button>
            <button type="button" id="deleteButton">Delete</button>

        </form>
    </main>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <img id="modalImage" src="" alt="Enlarged Image">
        </div>
    </div>

    <script type="module">
        const appSettings = {
            databaseURL: "https://inventory-54829-default-rtdb.firebaseio.com/"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getDatabase, ref, onValue, set, remove } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js';

        const app = initializeApp(appSettings);
        const database = getDatabase(app);

        const itemSelect = document.getElementById('itemSelect');
        const featureOptions = document.getElementById('featureOptions');
        const totalAmountElement = document.getElementById('totalAmount');
        const defaultImageSrc = '../assets/img/default.png';

        function loadCategories() {
            const categoriesRef = ref(database, 'Items');
            onValue(categoriesRef, (snapshot) => {
                const categories = snapshot.val();
                const categoryRadios = document.getElementById('categoryRadios');
                categoryRadios.innerHTML = '';

                for (let category in categories) {
                    const radioInput = document.createElement('input');
                    radioInput.type = 'radio';
                    radioInput.id = category;
                    radioInput.name = 'category';
                    radioInput.value = category;

                    const label = document.createElement('label');
                    label.htmlFor = category;
                    label.textContent = category;

                    categoryRadios.appendChild(radioInput);
                    categoryRadios.appendChild(label);

                    radioInput.addEventListener('change', function () {
                        loadData();
                        localStorage.setItem('selectedCategory', category);
                    });

                    const storedCategory = localStorage.getItem('selectedCategory');
                    if (storedCategory && storedCategory === category) {
                        radioInput.checked = true;
                    }
                }
                loadData();
            });
        }

        function loadData() {
            const selectedCategoryRadio = document.querySelector('input[name="category"]:checked');
            if (!selectedCategoryRadio) return;

            const selectedCategory = selectedCategoryRadio.value;
            const categoryRef = ref(database, `Items/${selectedCategory}`);

            onValue(categoryRef, (snapshot) => {
                const categoryData = snapshot.val();

                itemSelect.innerHTML = '';
                featureOptions.innerHTML = '';
                totalAmountElement.textContent = '0';

                if (categoryData) {
                    const items = Object.keys(categoryData).sort();

                    items.forEach((item) => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        itemSelect.appendChild(option);
                    });

                    const storedItem = localStorage.getItem('selectedItem');
                    if (storedItem && items.includes(storedItem)) {
                        itemSelect.value = storedItem;
                    }

                    itemSelect.dispatchEvent(new Event('change'));
                }
            });
        }

        itemSelect.addEventListener('change', () => {
            const selectedCategoryRadio = document.querySelector('input[name="category"]:checked');
            if (!selectedCategoryRadio) return;

            const selectedCategory = selectedCategoryRadio.value;
            const selectedItem = itemSelect.value;
            const itemImage = document.getElementById('itemImage');
            itemImage.src = `kamehouse/img/${selectedItem}.png`;
            itemImage.onerror = () => {
                itemImage.src = defaultImageSrc;
            };


            const itemRef = ref(database, `Items/${selectedCategory}/${selectedItem}`);

            onValue(itemRef, (snapshot) => {
                const itemData = snapshot.val();

                if (itemData) {
                    featureOptions.innerHTML = '';
                    const features = Object.keys(itemData).sort();

                    features.forEach((feature) => {
                        const featureAmount = itemData[feature];

                        // Create a div to contain the checkbox, image, and label
                        const featureDiv = document.createElement('div');
                        featureDiv.classList.add('feature-container');

                        const featureCheckbox = document.createElement('input');
                        featureCheckbox.type = 'checkbox';
                        featureCheckbox.dataset.amount = featureAmount;

                        // Listen for changes on checkbox to update the total amount
                        featureCheckbox.addEventListener('change', updateTotalAmount);

                        const featureImg = document.createElement('img');
                        featureImg.src = `kamehouse/img/${feature}.png`;
                        featureImg.alt = feature;
                        featureImg.width = 50;
                        featureImg.onerror = () => {
                            featureImg.src = defaultImageSrc;
                        };
                        featureImg.classList.add('feature-image');

                        // Add the elements to the feature div
                        featureDiv.appendChild(featureCheckbox);
                        featureDiv.appendChild(featureImg);
                        featureDiv.appendChild(document.createTextNode(`${feature} - Amount: ${featureAmount}`));

                        // Add the feature div to the options container
                        featureOptions.appendChild(featureDiv);

                        // Event listener on featureDiv
                        featureDiv.addEventListener('click', (event) => {
                            if (event.target.classList.contains('feature-image')) {
                                showImageModal(event.target.src);
                                event.stopPropagation();  // prevent the event from bubbling up to other elements
                            }
                        });
                    });
                }

            });
        });

        function updateTotalAmount() {
            const checkboxes = document.querySelectorAll('#featureOptions input[type="checkbox"]');
            let total = 0;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    total += parseFloat(checkbox.dataset.amount);
                }
            });

            totalAmountElement.textContent = total.toFixed(0); // Displaying the total with no decimal places
        }
        loadCategories();

        document.getElementById('dataModifyForm').addEventListener('submit', function (event) {
            event.preventDefault(); // prevent the default form submission behavior

            const category = document.getElementById('categoryInput').value;
            const item = document.getElementById('itemInput').value;
            const feature = document.getElementById('featureInput').value;
            const amount = document.getElementById('amountInput').value;

            if (category && item) {
                let path = `Items/${category}/${item}`;

                if (feature) {
                    path += `/${feature}`;
                }

                set(ref(database, path), amount);
            } else {
                alert('Category and Item are required!');
            }
        });

        document.getElementById('deleteButton').addEventListener('click', function () {
            const category = document.getElementById('categoryInput').value;
            const item = document.getElementById('itemInput').value;
            const feature = document.getElementById('featureInput').value;

            if (category && item) {
                let path = `Items/${category}/${item}`;

                if (feature) {
                    path += `/${feature}`;
                }

                // Confirm with the user before deletion
                if (confirm("Are you sure you want to delete this data?")) {
                    remove(ref(database, path))
                        .then(() => {
                            alert('Data deleted successfully!');
                        })
                        .catch((error) => {
                            console.error("Error deleting data: ", error);
                            alert('Failed to delete data!');
                        });
                }
            } else {
                alert('Category and Item are required to delete!');
            }
        });

    </script>
    <script>
        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            modalImage.src = imageSrc;
            modal.style.display = "block";
        }
        const modal = document.getElementById('imageModal');
        modal.addEventListener('click', function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        const featureImages = document.querySelectorAll('.image-container img, #featureOptions img');
        featureImages.forEach(img => {
            img.addEventListener('click', function () {
                showImageModal(img.src);
            });
        });

    </script>
</body>