<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Viewer</title>
    <link rel="stylesheet" href="./assets/css/app-styles.css" id="stylesheet">
    <style>
        body {
            height: 1000px;
            text-align: center;
            font-family: Arial, sans-serif;
        }

        .photoGrid {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #photoWrapper {
            display: flex;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            align-items: center;
            margin-bottom: 10px;
            justify-content: center;
        }

        #photoContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo {
            width: 95%;
            height: auto;
            margin: 5px;
            cursor: pointer;
        }

        #loadingIndicator {
            display: none;
            font-size: 18px;
            margin-top: 20px;
        }

        #rememberCheckbox {
            display: none;
        }

        .star {
            font-size: 40px;
            color: lightgray;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }

        #rememberCheckbox:checked+.star {
            color: yellow;
        }
    </style>
</head>

<body>
    <header>
        <h1>Gallery</h1>
    </header>
    <main>
        <section>
            <br>
            <label>Select a folder:
                <select id="folderSelect"></select>
            </label>
            <div>
                <label for="newSubfolderInput">Create folder:</label>
                <input type="text" id="newSubfolderInput" placeholder="Folder Name">
                <button id="createSubfolderButton">Create Folder</button>
                <div id="subfolderStatus"></div>
            </div>
            <input type="file" id="fileUploader" accept="image/*">
            <button id="uploadButton">Upload Image</button>
            <div id="uploadStatus"></div>

            <div class="photoGrid">
                <div id="photoWrapper">
                    <button id="prevButton">Previous</button>
                    <button id="nextButton">Next</button>
                    <label>
                        <input type="checkbox" id="rememberCheckbox">
                        <span class="star">&#9733;</span>
                    </label>
                </div>
                <div id="loadingIndicator">Loading...</div>
                <p id="fileName"></p>
                <div class="gridContainer" id="photoContainer"></div>

                <div id="fileInfo" style="display: none;">
                    <input type="text" id="renameInput" placeholder="New file name">
                    <button id="renameButton">Rename</button>
                </div>
            </div>
            <button id="deleteButton">Delete Photo</button>
        </section>
    </main>

    <script type="module">
        import { ref, app, database, storage, getStorage, storageRef, getDownloadURL, listAll, uploadBytesResumable, deleteObject } from './assets/js/firebase-init.js';

        document.addEventListener('DOMContentLoaded', function () {
            const photoContainer = document.getElementById('photoContainer');
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const deleteButton = document.getElementById('deleteButton');
            const rememberCheckbox = document.getElementById('rememberCheckbox');
            const folderSelect = document.getElementById('folderSelect');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const fileNameDisplay = document.getElementById('fileName');
            const renameInput = document.getElementById('renameInput');
            const renameButton = document.getElementById('renameButton');
            const fileUploader = document.getElementById('fileUploader');
            const uploadButton = document.getElementById('uploadButton');
            const uploadStatus = document.getElementById('uploadStatus');
            const createSubfolderButton = document.getElementById('createSubfolderButton');
            const newSubfolderInput = document.getElementById('newSubfolderInput');
            const subfolderStatus = document.getElementById('subfolderStatus');

            let currentPhotoIndex = 0;
            let photoUrls = [];
            let photoNames = [];

            function fetchPhotoUrls() {
                loadingIndicator.style.display = 'block';
                const subfoldersRef = storageRef(storage, '/share/images');

                listAll(subfoldersRef)
                    .then(result => {
                        const subfolders = result.prefixes.map(folderRef => folderRef.name);
                        populateSubfolders(subfolders);

                        const lastSelectedFolder = localStorage.getItem('lastSelectedFolder');

                        if (lastSelectedFolder && !subfolders.includes(lastSelectedFolder)) {
                            createFolderIfNotExists(lastSelectedFolder, () => {
                                loadImagesFromSubfolder(lastSelectedFolder);
                            });
                        } else {
                            if (lastSelectedFolder) {
                                folderSelect.value = lastSelectedFolder;
                            } else {
                                folderSelect.value = subfolders[0];
                            }
                            loadImagesFromSubfolder(folderSelect.value);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading photo URLs:', error);
                    })
                    .finally(() => {
                        loadingIndicator.style.display = 'none';
                    });
            }

            function createFolderIfNotExists(folderName, callback) {
                const folderRef = storageRef(storage, `/share/images/${folderName}/.keep`);

                const emptyFile = new Blob();
                uploadBytesResumable(folderRef, emptyFile)
                    .then(() => {
                        subfolderStatus.textContent = `Subfolder "${folderName}" created!`;
                        localStorage.setItem('lastSelectedFolder', folderName);

                        folderSelect.innerHTML = '';
                        fetchPhotoUrls();
                        if (callback) {
                            callback();
                        }
                    })
                    .catch(error => {
                        console.error('Error creating subfolder:', error);
                        subfolderStatus.textContent = 'Failed to create subfolder.';
                    });
            }

            function populateSubfolders(subfolders) {
                folderSelect.innerHTML = '';
                subfolders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder;
                    option.textContent = folder;
                    folderSelect.appendChild(option);
                });

                const lastSelectedFolder = localStorage.getItem('lastSelectedFolder');

                if (lastSelectedFolder && subfolders.includes(lastSelectedFolder)) {
                    folderSelect.value = lastSelectedFolder;
                } else {
                    folderSelect.value = subfolders[0];
                }

                loadImagesFromSubfolder(folderSelect.value);
            }

            function loadImagesFromSubfolder(subfolder) {
                const folderRef = storageRef(storage, `/share/images/${subfolder}`);
                photoUrls = [];
                photoNames = [];

                listAll(folderRef)
                    .then(result => {
                        const promises = result.items.map(itemRef => {
                            photoNames.push(itemRef.name);
                            return getDownloadURL(itemRef);
                        });
                        return Promise.all(promises);
                    })
                    .then(urls => {
                        photoUrls = urls;
                        currentPhotoIndex = 0;
                        displayCurrentPhoto();
                    })
                    .catch(error => {
                        console.error('Error loading images from subfolder:', error);
                    });
            }

            function displayCurrentPhoto() {
                photoContainer.innerHTML = '';

                if (currentPhotoIndex >= 0 && currentPhotoIndex < photoUrls.length) {
                    const img = createPhotoElement(photoUrls[currentPhotoIndex]);
                    photoContainer.appendChild(img);

                    fileNameDisplay.textContent = `File: ${photoNames[currentPhotoIndex]}`;

                    rememberCheckbox.checked = localStorage.getItem(photoUrls[currentPhotoIndex]) === 'true';
                } else {
                    photoContainer.innerHTML = '<p>No photos available for this subfolder.</p>';
                }
            }

            function createPhotoElement(src) {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'photo';

                img.addEventListener('click', function (event) {
                    const clickX = event.clientX - img.getBoundingClientRect().left;
                    const imgWidth = img.offsetWidth;

                    if (clickX < imgWidth / 2) {
                        loadPreviousImage();
                    } else {
                        loadNextImage();
                    }
                });

                img.onerror = function () {
                    img.src = './assets/img/default.png';
                };

                return img;
            }

            function loadNextImage() {
                currentPhotoIndex = (currentPhotoIndex + 1) % photoUrls.length;
                displayCurrentPhoto();
            }

            function loadPreviousImage() {
                currentPhotoIndex = (currentPhotoIndex - 1 + photoUrls.length) % photoUrls.length;
                displayCurrentPhoto();
            }

            folderSelect.addEventListener('change', () => {
                localStorage.setItem('lastSelectedFolder', folderSelect.value);
                loadImagesFromSubfolder(folderSelect.value);
            });

            nextButton.addEventListener('click', loadNextImage);
            prevButton.addEventListener('click', loadPreviousImage);

            rememberCheckbox.addEventListener('change', () => {
                if (currentPhotoIndex >= 0 && currentPhotoIndex < photoUrls.length) {
                    localStorage.setItem(photoUrls[currentPhotoIndex], rememberCheckbox.checked);
                }
            });

            renameButton.addEventListener('click', () => {
                const newFileName = renameInput.value.trim();
                if (newFileName && currentPhotoIndex >= 0 && currentPhotoIndex < photoUrls.length) {
                    const selectedFolder = folderSelect.value;
                    const oldFileName = photoNames[currentPhotoIndex];
                    const oldFileRef = storageRef(storage, `/share/images/${selectedFolder}/${oldFileName}`);
                    const newFileRef = storageRef(storage, `/share/images/${selectedFolder}/${newFileName}`);

                    getDownloadURL(oldFileRef).then((url) => {
                        fetch(url).then(res => res.blob()).then((blob) => {
                            uploadBytesResumable(newFileRef, blob).then(() => {
                                deleteObject(oldFileRef).then(() => {
                                    console.log('File renamed successfully');
                                    photoNames[currentPhotoIndex] = newFileName;
                                    displayCurrentPhoto();
                                }).catch(error => {
                                    console.error('Error deleting old file:', error);
                                });
                            }).catch(error => {
                                console.error('Error uploading new file:', error);
                            });
                        });
                    });
                } else {
                    alert('Please enter a valid new name.');
                }
            });

            uploadButton.addEventListener('click', () => {
                const file = fileUploader.files[0];
                const selectedFolder = folderSelect.value;

                if (file && selectedFolder) {
                    const img = new Image();
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        img.src = e.target.result;

                        img.onload = function () {
                            const MAX_WIDTH = 1024;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height = (MAX_WIDTH / width) * height;
                                width = MAX_WIDTH;
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');

                            ctx.drawImage(img, 0, 0, width, height);

                            canvas.toBlob((blob) => {
                                const timestamp = Date.now();
                                const uniqueFileName = `${timestamp}_${file.name}`;
                                const fileRef = storageRef(storage, `/share/images/${selectedFolder}/${uniqueFileName}`);

                                const uploadTask = uploadBytesResumable(fileRef, blob);

                                uploadTask.on('state_changed',
                                    (snapshot) => {
                                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                        uploadStatus.textContent = `Upload is ${progress}% done`;
                                    },
                                    (error) => {
                                        console.error('Upload failed:', error);
                                        uploadStatus.textContent = 'Upload failed!';
                                    },
                                    () => {
                                        getDownloadURL(fileRef).then((downloadURL) => {
                                            uploadStatus.textContent = 'Upload successful!';

                                            photoUrls.push(downloadURL);
                                            currentPhotoIndex = photoUrls.length - 1;
                                            displayCurrentPhoto();

                                            const keepFileRef = storageRef(storage, `/share/images/${selectedFolder}/.keep`);
                                            deleteObject(keepFileRef)
                                                .then(() => {
                                                    console.log('.keep file deleted successfully!');
                                                })
                                                .catch((error) => {
                                                    console.error('Error deleting .keep file:', error);
                                                });
                                        }).catch((error) => {
                                            console.error('Error getting download URL:', error);
                                        });
                                    }
                                );
                            }, file.type);
                        };
                    };

                    reader.readAsDataURL(file);
                } else {
                    uploadStatus.textContent = 'Please select an image and a subfolder.';
                }
            });

            deleteButton.addEventListener('click', () => {
                const photoUrl = photoUrls[currentPhotoIndex];
                if (photoUrl) {
                    const fileRef = storageRef(storage, photoUrl);

                    deleteObject(fileRef)
                        .then(() => {
                            uploadStatus.textContent = 'Photo deleted successfully!';
                            photoUrls.splice(currentPhotoIndex, 1);
                            currentPhotoIndex = currentPhotoIndex % photoUrls.length;
                            displayCurrentPhoto();
                        })
                        .catch(error => {
                            console.error('Error deleting photo:', error);
                            uploadStatus.textContent = 'Failed to delete photo!';
                        });
                } else {
                    uploadStatus.textContent = 'No photo to delete.';
                }
            });

            createSubfolderButton.addEventListener('click', () => {
                const newSubfolderName = newSubfolderInput.value.trim();
                if (newSubfolderName) {
                    const folderRef = storageRef(storage, `/share/images/${newSubfolderName}/.keep`);

                    const emptyFile = new Blob();
                    uploadBytesResumable(folderRef, emptyFile).then(() => {
                        subfolderStatus.textContent = `Subfolder "${newSubfolderName}" created!`;

                        localStorage.setItem('lastSelectedFolder', newSubfolderName);

                        folderSelect.innerHTML = '';
                        fetchPhotoUrls();
                    }).catch(error => {
                        console.error('Error creating subfolder:', error);
                        subfolderStatus.textContent = 'Failed to create subfolder.';
                    });
                } else {
                    subfolderStatus.textContent = 'Please enter a subfolder name.';
                }
            });

            fetchPhotoUrls();
        });
    </script>

</body>