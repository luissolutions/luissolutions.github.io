<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory & Database</title>
    <link rel="stylesheet" href="./assets/css/app-styles.css" id="stylesheet">
    <script type="module" src="./assets/js/login.js" defer></script>
    <style>
        input,
        textarea {
            resize: vertical;
            white-space: normal;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            display: contents;
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            position: relative;
            max-width: 600px;
            text-align: center;
        }

        .modal-content img {
            max-width: 100%;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
            }

            table {
                font-size: 14px;
            }

            td img {
                width: 40px;
                height: 40px;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Inventory & Database</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>
    </header>

    <main>
        <section class="app-section">
            <div class="entry-container">
                <form>
                    <label>Category: </label><input type="text" id="category" required>
                    <label>Sub-Category: </label><input type="text" id="component" required>
                    <label>Item: </label><input type="text" id="partName" required>
                    <label>Price: </label><input type="number" id="price" step="0.01">
                    <label>Cost: </label><input type="number" id="actualPrice" step="0.01">
                    <label>Quantity: </label><input type="number" id="quantity">
                    <label>Description: </label><textarea id="description"></textarea>
                    <label>Upload Image: <input type="file" id="imageInput" accept="image/*"></label>
                    <button id="save-data-button">Save</button>
                </form>
                <br>
            </div>

            <div">
                <label>Filter by Category:
                    <select id="category-filter">
                        <option value="">All</option>
                    </select>
                </label>
                <input type="text" id="search-input" placeholder="Search Items">
                </div>

                <div id="entries-container" class="table"></div>
        </section>

        <section id="modal" class="modal">
            <div class="modal-content">
                <img id="part-image" src="" alt="Part Image">
            </div>
        </section>
    </main>
</body>

<script type="module">
    import { storageRef, getStorage, ref, uploadBytesResumable, getDownloadURL, auth, database, storage, set, remove, update, get, onValue, onAuthStateChanged } from "./assets/js/firebase-init.js";

    let DATABASE_BASE_PATH = 'public';

    onAuthStateChanged(auth, (user) => {
        DATABASE_BASE_PATH = user ? `${user.uid}` : 'public';
        loadDatabaseEntries();
    });

    function loadDatabaseEntries() {
        const inventoryRef = ref(database, `${DATABASE_BASE_PATH}/inventory`);
        onValue(inventoryRef, (snapshot) => {
            const entries = snapshot.val() || {};
            updateCategoryFilter(entries);
            displayEntries(entries);
        });
    }

    function updateCategoryFilter(entries) {
        const categoryFilter = document.getElementById('category-filter');
        categoryFilter.innerHTML = '<option value="">All</option>';
        Object.keys(entries).forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.innerText = category;
            categoryFilter.appendChild(option);
        });
    }

    document.getElementById('category-filter').addEventListener('change', filterEntries);
    document.getElementById('search-input').addEventListener('input', filterEntries);

    function displayEntries(entries) {
        const container = document.getElementById('entries-container');
        container.innerHTML = `
        <table id="task-log">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Sub-Category</th>
                    <th>Item Name</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Quantity</th>
                    <th>Description</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventory-body"></tbody>
        </table>
    `;

        const tbody = document.getElementById('inventory-body');
        Object.entries(entries).forEach(([category, components]) => {
            Object.entries(components).forEach(([component, items]) => {
                Object.entries(items).forEach(([timestampKey, data]) => {
                    const imageUrl = data.imageUrl || './assets/img/default.png';
                    const partName = data.partName || "Unnamed Item";

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td><input type="text" value="${category}" data-key="category"></td>
                    <td><input type="text" value="${component}" data-key="component"></td>
                    <td><input type="text" value="${partName}" data-key="partName"></td>
                    <td><input type="number" value="${data.price}" data-key="price"></td>
                    <td><input type="number" value="${data.actualPrice}" data-key="actualPrice"></td>
                    <td><input type="number" value="${data.quantity}" data-key="quantity"></td>
                    <td><textarea data-key="description">${data.description || ''}</textarea></td>
                    <td>
                        <img src="${imageUrl}" width="50" height="50" class="view-image" data-imageurl="${imageUrl}">
                        <input type="file" class="image-upload" data-category="${category}" data-component="${component}" data-timestampKey="${timestampKey}">
                    </td>
                    <td>
                        <button class="delete-button">Delete</button>
                    </td>
                `;

                    row.querySelector('.image-upload').addEventListener('change', (event) => uploadImage(event, category, component, timestampKey));
                    row.querySelector('.delete-button').addEventListener('click', () => deleteEntry(category, component, timestampKey));
                    row.querySelector('.view-image').addEventListener('click', (event) => showImageModal(event.target.dataset.imageurl));

                    tbody.appendChild(row);
                });
            });
        });

        filterEntries();
    }

    function filterEntries() {
        const selectedCategory = document.getElementById('category-filter').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();

        document.querySelectorAll('#inventory-body tr').forEach(row => {
            const category = row.children[0].querySelector('input').value;
            const partName = row.children[2].querySelector('input').value.toLowerCase();

            const matchesCategory = selectedCategory === '' || category === selectedCategory;
            const matchesSearch = searchTerm === '' || partName.includes(searchTerm);

            row.style.display = matchesCategory && matchesSearch ? '' : 'none';
        });
    }

    function updateInventoryField(event, oldCategory, oldComponent, oldPartName) {
        const input = event.target;
        const key = input.dataset.key;
        const newValue = input.value.trim();

        if (!newValue) return;

        const newCategory = input.closest('tr').querySelector('[data-key="category"]').value.trim();
        const newComponent = input.closest('tr').querySelector('[data-key="component"]').value.trim();
        const newPartName = input.closest('tr').querySelector('[data-key="partName"]').value.trim();

        const oldRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${oldCategory}/${oldComponent}/${oldPartName}`);

        get(oldRef).then((snapshot) => {
            if (!snapshot.exists()) return;

            const existingData = snapshot.val();

            existingData[key] = newValue;

            const newRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${newCategory}/${newComponent}/${newPartName}`);
            set(newRef, existingData).then(() => {
                if (newCategory !== oldCategory || newComponent !== oldComponent || newPartName !== oldPartName) {
                    remove(oldRef);
                }
            }).catch((error) => {
                console.error("Error updating entry:", error);
            });
        }).catch((error) => {
            console.error("Error retrieving existing data:", error);
        });
    }

    function uploadImage(event, category, component, timestampKey) {
        const file = event.target.files[0];
        if (!file) return;

        console.log(`Uploading image for existing entry: ${category} / ${component} / ${timestampKey}`);

        const imagePath = `${DATABASE_BASE_PATH}/images/${category}/${component}/${file.name}`;
        const fileRef = storageRef(storage, imagePath);

        const uploadTask = uploadBytesResumable(fileRef, file);

        uploadTask.on(
            "state_changed",
            null,
            (error) => console.error("Upload failed:", error),
            async () => {
                try {
                    const imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    console.log("File uploaded:", imageUrl);
                    const entryRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${timestampKey}`);
                    await update(entryRef, { imageUrl });
                    loadDatabaseEntries(); // Refresh list
                } catch (error) {
                    console.error("Error getting image URL:", error);
                }
            }
        );
    }

    function deleteEntry(category, component, partName) {
        if (confirm(`Are you sure you want to delete ${partName}?`)) {
            remove(ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${partName}`))
                .then(() => loadDatabaseEntries());
        }
    }

    function showImageModal(imageUrl) {
        const modal = document.getElementById('modal');
        document.getElementById('part-image').src = imageUrl;
        modal.style.display = 'block';
    }

    document.getElementById('modal').addEventListener('click', () => {
        document.getElementById('modal').style.display = 'none';
    });

    document.getElementById('save-data-button').addEventListener('click', saveData);

    function saveData() {
        const category = document.getElementById('category').value.trim();
        const component = document.getElementById('component').value.trim();
        const partName = document.getElementById('partName').value.trim();
        const price = parseFloat(document.getElementById('price').value) || 0;
        const actualPrice = parseFloat(document.getElementById('actualPrice').value) || 0;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const description = document.getElementById('description').value.trim();
        const fileInput = document.getElementById('imageInput');
        const file = fileInput.files[0];
        const timestampKey = Date.now().toString();

        if (!category || !component || !partName) {
            alert("Category, Sub-Category, and Item fields are required.");
            return;
        }

        let imageUrl = "./assets/img/default.png";

        if (file) {
            const imagePath = `${DATABASE_BASE_PATH}/images/${category}/${component}/${file.name}`;
            const fileRef = storageRef(storage, imagePath);
            const uploadTask = uploadBytesResumable(fileRef, file);

            uploadTask.on(
                "state_changed",
                null,
                (error) => {
                    console.error("Upload failed:", error);
                    alert("Image upload failed.");
                },
                async () => {
                    try {
                        imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log("File uploaded:", imageUrl);
                        saveEntryToDatabase(timestampKey, category, component, partName, price, actualPrice, quantity, description, imageUrl);
                    } catch (error) {
                        console.error("Error getting image URL:", error);
                    }
                }
            );
        } else {
            saveEntryToDatabase(timestampKey, category, component, partName, price, actualPrice, quantity, description, imageUrl);
        }
    }

    function saveEntryToDatabase(timestampKey, category, component, partName, price, actualPrice, quantity, description, imageUrl) {
        const newEntry = {
            partName,
            price,
            actualPrice,
            quantity,
            description,
            imageUrl
        };

        const entryRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${timestampKey}`);
        set(entryRef, newEntry)
            .then(() => {
                alert("Entry saved successfully!");
                document.querySelector('form').reset();
                loadDatabaseEntries();
            })
            .catch(error => {
                console.error("Error saving entry:", error);
            });
    }

</script>

</html>