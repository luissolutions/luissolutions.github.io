<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory & Database</title>
    <link rel="stylesheet" href="./assets/css/app-styles.css" id="stylesheet">
    <script type="module" src="./assets/js/login.js" defer></script>
    <style>
        .entry label,
        .filter label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .entry input,
        .entry textarea,
        .filter select,
        .filter input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .entry button {
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            color: white;
            text-transform: uppercase;
        }

        td input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        td img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

        td img:hover {
            transform: scale(1.2);
        }

        .image-upload {
            display: block;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            position: relative;
            max-width: 600px;
        }

        .modal-content img {
            max-width: 100%;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
            }

            table {
                font-size: 14px;
            }

            td img {
                width: 40px;
                height: 40px;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Inventory & Database</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>
    </header>

    <main>
        <section class="container">
            <div class="entry">
                <label>Category: <input type="text" id="category" required></label>
                <label>Sub-Category: <input type="text" id="component" required></label>
                <label>Item: <input type="text" id="partName" required></label>
                <label>Price: <input type="number" id="price" step="0.01"></label>
                <label>Cost: <input type="number" id="actualPrice" step="0.01"></label>
                <label>Quantity: <input type="number" id="quantity"></label>
                <label>Description: <textarea id="description"></textarea></label>
                <label>Upload Image: <input type="file" id="imageInput" accept="image/*"></label>
                <button id="save-data-button">Save</button>
            </div>

            <div class="filter">
                <label>Filter by Category:
                    <select id="category-filter">
                        <option value="">All</option>
                    </select>
                </label>
                <input type="text" id="search-input" placeholder="Search Items">
            </div>

            <div id="entries-container"></div>
        </section>

        <section id="modal" class="modal">
            <div class="modal-content">
                <img id="part-image" src="" alt="Part Image">
            </div>
        </section>
    </main>
</body>

<script type="module">
    import { auth, database, storage, ref, set, remove, update, get, onValue, onAuthStateChanged } from "./assets/js/firebase-init.js";

    let DATABASE_BASE_PATH = 'public';

    onAuthStateChanged(auth, (user) => {
        DATABASE_BASE_PATH = user ? `${user.uid}` : 'public';
        loadDatabaseEntries();
    });

    function loadDatabaseEntries() {
        const inventoryRef = ref(database, `${DATABASE_BASE_PATH}/inventory`);
        onValue(inventoryRef, (snapshot) => {
            const entries = snapshot.val() || {};
            updateCategoryFilter(entries);
            displayEntries(entries);
        });
    }

    function updateCategoryFilter(entries) {
        const categoryFilter = document.getElementById('category-filter');
        categoryFilter.innerHTML = '<option value="">All</option>';
        Object.keys(entries).forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.innerText = category;
            categoryFilter.appendChild(option);
        });
    }

    document.getElementById('category-filter').addEventListener('change', filterEntries);
    document.getElementById('search-input').addEventListener('input', filterEntries);

    function displayEntries(entries) {
        const container = document.getElementById('entries-container');
        container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Sub-Category</th>
                    <th>Item</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Quantity</th>
                    <th>Description</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventory-body"></tbody>
        </table>
    `;

        const tbody = document.getElementById('inventory-body');
        Object.entries(entries).forEach(([category, components]) => {
            Object.entries(components).forEach(([component, parts]) => {
                Object.entries(parts).forEach(([partName, data]) => {
                    const imageUrl = data.imageUrl || './assets/img/default.png';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td><input type="text" value="${category}" data-key="category"></td>
                    <td><input type="text" value="${component}" data-key="component"></td>
                    <td><input type="text" value="${partName}" data-key="partName"></td>
                    <td><input type="number" value="${data.price}" data-key="price"></td>
                    <td><input type="number" value="${data.actualPrice}" data-key="actualPrice"></td>
                    <td><input type="number" value="${data.quantity}" data-key="quantity"></td>
                    <td><input type="text" value="${data.description || ''}" data-key="description"></td>
                    <td>
                        <img src="${imageUrl}" width="50" height="50" class="view-image" data-imageurl="${imageUrl}">
                        <input type="file" class="image-upload" data-category="${category}" data-component="${component}" data-partName="${partName}">
                    </td>
                    <td>
                        <button class="delete-button">Delete</button>
                    </td>
                `;

                    row.querySelectorAll('input').forEach(input => {
                        input.addEventListener('blur', (event) => updateInventoryField(event, category, component, partName));
                    });

                    row.querySelector('.image-upload').addEventListener('change', (event) => uploadImage(event, category, component, partName));

                    row.querySelector('.delete-button').addEventListener('click', () => deleteEntry(category, component, partName));

                    row.querySelector('.view-image').addEventListener('click', (event) => showImageModal(event.target.dataset.imageurl));

                    tbody.appendChild(row);
                });
            });
        });

        filterEntries();
    }

    function filterEntries() {
        const selectedCategory = document.getElementById('category-filter').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();

        document.querySelectorAll('#inventory-body tr').forEach(row => {
            const category = row.children[0].querySelector('input').value;
            const partName = row.children[2].querySelector('input').value.toLowerCase();

            const matchesCategory = selectedCategory === '' || category === selectedCategory;
            const matchesSearch = searchTerm === '' || partName.includes(searchTerm);

            row.style.display = matchesCategory && matchesSearch ? '' : 'none';
        });
    }

    function updateInventoryField(event, oldCategory, oldComponent, oldPartName) {
        const input = event.target;
        const key = input.dataset.key;
        const newValue = input.value.trim();

        if (!newValue) return;

        const newCategory = input.closest('tr').querySelector('[data-key="category"]').value.trim();
        const newComponent = input.closest('tr').querySelector('[data-key="component"]').value.trim();
        const newPartName = input.closest('tr').querySelector('[data-key="partName"]').value.trim();

        if (newCategory !== oldCategory || newComponent !== oldComponent || newPartName !== oldPartName) {
            remove(ref(database, `${DATABASE_BASE_PATH}/inventory/${oldCategory}/${oldComponent}/${oldPartName}`));
        }

        const entryRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${newCategory}/${newComponent}/${newPartName}`);
        update(entryRef, { [key]: newValue });
    }

    function uploadImage(event, category, component, partName) {
        const file = event.target.files[0];
        if (!file) return;

        const imagePath = `${DATABASE_BASE_PATH}/images/${category}/${component}/${file.name}`;
        const storageRef = ref(storage, imagePath);

        const uploadTask = uploadBytesResumable(storageRef, file);
        uploadTask.on('state_changed', null, null, () => {
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                const entryRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${partName}`);
                update(entryRef, { imageUrl: downloadURL }).then(() => loadDatabaseEntries());
            });
        });
    }

    function deleteEntry(category, component, partName) {
        if (confirm(`Are you sure you want to delete ${partName}?`)) {
            remove(ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${partName}`))
                .then(() => loadDatabaseEntries());
        }
    }

    function showImageModal(imageUrl) {
        const modal = document.getElementById('modal');
        document.getElementById('part-image').src = imageUrl;
        modal.style.display = 'block';
    }

    document.getElementById('modal').addEventListener('click', () => {
        document.getElementById('modal').style.display = 'none';
    });

    document.getElementById('save-data-button').addEventListener('click', loadDatabaseEntries);
</script>

</html>