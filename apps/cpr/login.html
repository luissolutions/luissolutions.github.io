<!DOCTYPE html>
<html>

<head>
    <title>Login Page</title>
    <link href="css/styles.css" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="img/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="img/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
</head>

<body>
    <header>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="repair.html">Price Calc</a></li>
            <li><a href="editor.html">Price Editor</a></li>
            <li><a href="info-pages/more.html">Info</a></li>
            <li class="dropdown">
                <a href="javascript:void(0)">Links</a>
                <div class="dropdown-content">
                    <a href="https://cpr.parts" target="_blank">CPR Parts</a>
                    <a href="https://www.injuredgadgets.com/" target="_blank">Injured Gadgets</a>
                    <a href="https://laptopscreens.com" target="_blank">Laptop Screens</a>
                    <a href="https://gsx2.apple.com/" target="_blank">Apple GSX</a>
                    <a href="https://diagnostics.apple.com/" target="_blank">Apple Diagnostics</a>
                    <a href="https://imeicheck.com/" target="_blank">IMEI Check</a>
                    <a href="https://app.slack.com/" target="_blank">Slack</a>
                    <a href="https://www.apple.com/shop/browse/overlay/tradein_landing/iphone_values"
                        target="_blank">Apple
                        Trade-in</a>
                    <a href="new.html" target="_blank">Iphones Prices</a>
                </div>
            </li>
        </ul>
    </header>
    <main>
        <section>
            <div class="container">
                <h2>Login</h2>
                <br>
                <form id="loginForm">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required><br>
                    <label for="password">Password:</label>
                    <input type="password" id="password" required><br>
                    <input type="submit" value="Login">
                </form>
            </div>
        </section>
    </main>
    <footer>
        <ul>
            <li>Â© of <a href="../../index.html">Luis</a></li>
        </ul>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://persinfo-df93f-default-rtdb.firebaseio.com/"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const handleLoginFormSubmit = () => {
            document.getElementById("loginForm").addEventListener("submit", event => {
                event.preventDefault();
                var username = document.getElementById("username").value;
                var password = document.getElementById("password").value;

                var usersRef = ref(database, "users");
                const usersListener = onValue(usersRef, snapshot => {
                    var users = snapshot.val();

                    if (users) {
                        var matchingUser = Object.values(users).find(user => user.username === username && user.password === password);

                        if (matchingUser) {
                            const token = "1234567890";
                            const expirationMinutes = 480;
                            const expirationTime = new Date().getTime() + (expirationMinutes * 60 * 1000);
                            const tokenData = { token, expiresAt: expirationTime };
                            localStorage.setItem("token", JSON.stringify(tokenData));

                            const delay = expirationTime - new Date().getTime();
                            setTimeout(() => localStorage.removeItem("token"), delay);
                            window.location.href = "index.html";
                        } else {
                            alert("Invalid username or password. Please try again.");
                        }
                    } else {
                        alert("No user data found.");
                    }
                    off(usersRef, usersListener);
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            handleLoginFormSubmit();
        });
    </script>


</body>

</html>