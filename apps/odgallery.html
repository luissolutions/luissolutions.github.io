<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Photo Upload & Show with OneDrive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/app-styles.css" id="stylesheet">
    <style>
        .thumbnail {
            max-width: 150px;
            cursor: pointer;
            border-radius: 15px;
            transition: transform 0.2s;
            width: 100%;
        }

        .thumbnail:hover {
            transform: scale(1.1);
        }

        .thumbnailItem {
            position: relative;
            text-align: center;
            margin: 5px;
        }

        #gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        #modalContent {
            position: relative;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
        }

        #modalImage {
            max-width: 90vw;
            max-height: 80vh;
            display: block;
            margin-bottom: 10px;
        }

        #modalFileName {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .favorite-star {
            cursor: pointer;
            font-size: 20px;
            user-select: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 255, 255, 0.7);
            width: 30px;
            border-radius: 50%;
        }

        .favorite-star:hover {
            background-color: lightskyblue;
        }

        .favorite-star.favorited {
            color: gold;
        }

        @media (max-width: 439px) {
            .thumbnail {
                max-width: 145px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Photo Gallery (OneDrive)</h1>
        <div>
            <button id="loginButton">Login to Microsoft</button>
            <button id="logoutButton">Logout</button>
        </div>
    </header>

    <main>
        <section>
            <h2>Upload Image</h2>
            <input type="file" id="fileUploader" accept="image/*"><br>
            <label>Image Name:</label>
            <input type="text" id="imageNameInput" placeholder="Enter image name"><br>
            <label>Folder Name:</label>
            <input type="text" id="imageLabel" placeholder="Enter folder name" value="default"><br>
            <label for="markupTextInput">Markup Text:</label>
            <input type="text" id="markupTextInput" placeholder="Enter markup text"><br>
            <button id="uploadButton">Upload Image</button><br>
            <label>Browse Folder:</label>
            <select id="folderDropdown">
            </select>
        </section>

        <hr>

        <section>
            <h2>Gallery</h2>
            <div id="gallery"></div>
        </section>
    </main>


    <div id="modal">
        <div id="modalContent">
            <img id="modalImage" style="margin: 0 auto;" src="" alt="Large View">
            <p id="modalFileName"></p>
            <button id="downloadButton">Download</button>
            <button id="deleteButton" class="clear-button">Delete</button>
            <button id="closeModalButton">Close</button>
            <button id="moveButton">Move Photo</button>
            <br>
            <label for="moveToFolder">To Folder:</label>
            <select id="moveToFolder"></select>

            <div id="modalNavLeft" style="position:absolute;top:0;left:0;width:40%;height:80%;cursor:pointer;"></div>
            <div id="modalNavRight" style="position:absolute;top:0;right:0;width:40%;height:80%;cursor:pointer;"></div>

        </div>
    </div>

</body>
<script type="module">
    import { accessToken, loginToMicrosoft, logoutFromMicrosoft } from './assets/js/onenoteGalleryAuth.js';

    const ROOT_FOLDER = "JobPhotos";

    document.getElementById("loginButton").addEventListener("click", loginToMicrosoft);
    document.getElementById("logoutButton").addEventListener("click", logoutFromMicrosoft);

    document.getElementById("uploadButton").addEventListener("click", async () => {
        const fileInput = document.getElementById("fileUploader");
        const folder = sanitizeInput(document.getElementById("imageLabel").value) || "default";
        const markupText = document.getElementById("markupTextInput").value.trim();
        let nameInput = document.getElementById("imageNameInput").value.trim();

        if (!fileInput.files.length) return alert("Select a file");
        const file = fileInput.files[0];
        const blob = await resizeImage(file, 2048);

        if (!nameInput && markupText) {
            nameInput = markupText;
        } else if (!nameInput) {
            nameInput = file.name.split('.').slice(0, -1).join('_');
        }

        const ext = file.name.split('.').pop();
        const baseFileName = markupText ? `${nameInput}_m` : nameInput;
        const finalFileName = `${baseFileName}.${ext}`;

        try {
            await ensurePhotosFolder();
            await createSubFolderIfNeeded(folder);

            const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/${folder}/${finalFileName}:/content`;
            const res = await fetch(uploadUrl, {
                method: "PUT",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: blob
            });

            if (!res.ok) throw new Error("Upload failed");
            alert("Uploaded to OneDrive!");

            await listFolders();
            await listImages(folder);
        } catch (err) {
            console.error("Upload error:", err);
            alert("Error uploading: " + err.message);
        }
    });

    async function resizeImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    const canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;
                    canvas.getContext("2d").drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, file.type);
                };
            };
            reader.readAsDataURL(file);
        });
    }

    async function listImages(folder) {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        try {
            const listUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/${folder}:/children`;
            const res = await fetch(listUrl, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            if (res.status === 404) {
                await createSubFolderIfNeeded(folder);
                return listImages(folder);
            }

            if (!res.ok) throw new Error("Failed to list images");
            const data = await res.json();

            data.value.forEach(item => {
                if (item.file && item.file.mimeType.startsWith("image/")) {
                    const container = document.createElement("div");
                    container.className = "thumbnailItem";

                    const img = document.createElement("img");
                    img.src = item['@microsoft.graph.downloadUrl'];
                    img.className = "thumbnail";
                    img.title = item.name;

                    const caption = document.createElement("p");
                    caption.textContent = item.name;
                    caption.style.fontSize = "14px";
                    caption.style.margin = "0";

                    container.appendChild(img);
                    container.appendChild(caption);
                    gallery.appendChild(container);
                }
            });
        } catch (err) {
            console.error("Error loading images:", err);
            alert("Error loading gallery");
        }
    }

    async function listFolders() {
        const dropdown = document.getElementById("folderDropdown");
        const moveDropdown = document.getElementById("moveToFolder");
        dropdown.innerHTML = "";
        moveDropdown.innerHTML = "";

        try {
            await ensurePhotosFolder();

            const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/children`;
            const res = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            if (!res.ok) throw new Error("Failed to fetch folders");
            const data = await res.json();

            const currentFolder = document.getElementById("imageLabel").value.trim() || "default";
            let folderExists = false;

            data.value.forEach(item => {
                if (item.folder) {
                    const name = item.name;
                    const opt1 = new Option(name, name);
                    const opt2 = new Option(name, name);
                    dropdown.add(opt1);
                    moveDropdown.add(opt2);

                    if (name === currentFolder) folderExists = true;
                }
            });

            dropdown.value = folderExists ? currentFolder : dropdown.options[0]?.value;
            await listImages(dropdown.value);
        } catch (err) {
            console.error("Error listing folders:", err);
            alert("Could not load folder list.");
        }
    }

    async function ensurePhotosFolder() {
        const checkUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}`;
        const res = await fetch(checkUrl, {
            headers: { Authorization: `Bearer ${accessToken}` }
        });

        if (res.status === 404) {
            const createRes = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root/children`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    name: ROOT_FOLDER,
                    folder: {},
                    "@microsoft.graph.conflictBehavior": "rename"
                })
            });

            if (!createRes.ok) {
                console.error("Error creating root folder:", await createRes.text());
                throw new Error("Failed to create root folder.");
            }
        }
    }

    async function createSubFolderIfNeeded(subFolder) {
        const checkUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/${subFolder}`;
        const res = await fetch(checkUrl, {
            headers: { Authorization: `Bearer ${accessToken}` }
        });

        if (res.status === 404) {
            const createUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}:/children`;
            const createRes = await fetch(createUrl, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    name: subFolder,
                    folder: {},
                    "@microsoft.graph.conflictBehavior": "rename"
                })
            });

            if (!createRes.ok) {
                console.error("Error creating folder:", await createRes.text());
                throw new Error("Failed to create subfolder");
            }
        }
    }

    function sanitizeInput(input) {
        return input.replace(/[^a-zA-Z0-9-_ ]/g, '').trim().replace(/\s+/g, '_');
    }

    window.addEventListener("load", () => {
        listFolders();
    });

    document.getElementById("folderDropdown").addEventListener("change", (e) => {
        const selectedFolder = e.target.value;
        listImages(selectedFolder);
    });

</script>

</html>