<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Photo Upload & Show with OneDrive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/app-styles.css" id="stylesheet">
    <style>
        .thumbnail {
            max-width: 150px;
            cursor: pointer;
            border-radius: 15px;
            transition: transform 0.2s;
            width: 100%;
        }

        .thumbnail:hover {
            transform: scale(1.1);
        }

        .thumbnailItem {
            position: relative;
            text-align: center;
            margin: 5px;
        }

        #gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        #modalContent {
            position: relative;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
        }

        #modalImage {
            max-width: 90vw;
            max-height: 80vh;
            display: block;
            margin-bottom: 10px;
        }

        #modalFileName {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        @media (max-width: 439px) {
            .thumbnail {
                max-width: 145px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Photo Gallery (OneDrive)</h1>
        <div>
            <button id="loginButton">Login to Microsoft</button>
            <button id="logoutButton">Logout</button>
        </div>
    </header>

    <main>
        <section>
            <h2>Upload Image</h2>
            <input type="file" id="fileUploader" accept="image/*"><br>
            <label>Image Name:</label>
            <input type="text" id="imageNameInput" placeholder="Enter image name"><br>
            <label>Folder Name:</label>
            <input type="text" id="imageLabel" placeholder="Enter folder name" value="default"><br>
            <label for="markupTextInput">Markup Text:</label>
            <input type="text" id="markupTextInput" placeholder="Enter markup text"><br>
            <button id="uploadButton">Upload Image</button><br>
            <label>Browse Folder:</label>
            <select id="folderDropdown"></select>
        </section>

        <hr>

        <section>
            <h2>Gallery</h2>
            <div id="gallery"></div>
        </section>
    </main>

    <div id="modal">
        <div id="modalContent">
            <img id="modalImage" style="margin: 0 auto;" src="" alt="Large View">
            <p id="modalFileName"></p>
            <button id="downloadButton">Download</button>
            <button id="closeModalButton">Close</button>
            <div id="modalNavLeft" style="position:absolute;top:0;left:0;width:40%;height:100%;cursor:pointer;"></div>
            <div id="modalNavRight" style="position:absolute;top:0;right:0;width:40%;height:100%;cursor:pointer;"></div>
        </div>
    </div>

    <script type="module">
        import { accessToken, loginToMicrosoft, logoutFromMicrosoft } from './assets/js/onenoteGalleryAuth.js';

        const ROOT_FOLDER = "JobPhotos";
        let currentImages = [], currentIndex = 0;

        document.getElementById("loginButton").addEventListener("click", loginToMicrosoft);
        document.getElementById("logoutButton").addEventListener("click", logoutFromMicrosoft);

        document.getElementById("uploadButton").addEventListener("click", async () => {
            const fileInput = document.getElementById("fileUploader");
            const folder = sanitizeInput(document.getElementById("imageLabel").value) || "default";
            const markupText = document.getElementById("markupTextInput").value.trim();
            let nameInput = document.getElementById("imageNameInput").value.trim();

            if (!fileInput.files.length) return alert("Select a file");
            const file = fileInput.files[0];
            let imageBlob = await resizeImage(file, 2048);
            if (!nameInput && markupText) nameInput = markupText;
            else if (!nameInput) nameInput = file.name.split('.').slice(0, -1).join('_');

            const ext = file.name.split('.').pop();
            const baseFileName = markupText ? `${nameInput}_m` : nameInput;
            const finalFileName = `${baseFileName}.${ext}`;
            if (markupText) imageBlob = await addTextToImage(imageBlob, markupText);

            try {
                await ensurePhotosFolder();
                await createSubFolderIfNeeded(folder);
                const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/${folder}/${finalFileName}:/content`;
                const res = await fetch(uploadUrl, {
                    method: "PUT",
                    headers: { Authorization: `Bearer ${accessToken}` },
                    body: imageBlob
                });
                if (!res.ok) throw new Error("Upload failed");
                alert("Uploaded to OneDrive!");
                await listFolders();
                await listImages(folder);
            } catch (err) {
                console.error("Upload error:", err);
                alert("Error uploading: " + err.message);
            }
        });

        async function resizeImage(file, maxWidth) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.src = reader.result;
                    img.onload = () => {
                        let width = img.width, height = img.height;
                        if (width > maxWidth) height *= maxWidth / width, width = maxWidth;
                        const canvas = document.createElement("canvas");
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext("2d").drawImage(img, 0, 0, width, height);
                        canvas.toBlob(resolve, file.type);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function addTextToImage(blob, text) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.src = reader.result;
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        canvas.width = img.width;
                        canvas.height = img.height + 100;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);
                        ctx.fillStyle = 'white';
                        ctx.font = '80px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(text, canvas.width / 2, canvas.height - 20);
                        canvas.toBlob(resolve, 'image/jpeg');
                    };
                };
                reader.readAsDataURL(blob);
            });
        }

        async function ensurePhotosFolder() {
            const checkUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}`;
            const res = await fetch(checkUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
            if (res.status === 404) {
                const createRes = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root/children`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        name: ROOT_FOLDER,
                        folder: {},
                        "@microsoft.graph.conflictBehavior": "rename"
                    })
                });
                if (!createRes.ok) throw new Error("Failed to create root folder");
            }
        }

        async function createSubFolderIfNeeded(subFolder) {
            const checkUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/${subFolder}`;
            const res = await fetch(checkUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
            if (res.status === 404) {
                const createRes = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}:/children`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        name: subFolder,
                        folder: {},
                        "@microsoft.graph.conflictBehavior": "rename"
                    })
                });
                if (!createRes.ok) throw new Error("Failed to create subfolder");
            }
        }

        async function listFolders() {
            const dropdown = document.getElementById("folderDropdown");
            dropdown.innerHTML = "";
            await ensurePhotosFolder();
            const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}:/children`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
            const data = await res.json();
            data.value.forEach(item => {
                if (item.folder) {
                    dropdown.add(new Option(item.name, item.name));
                }
            });

            if (dropdown.options.length > 0) {
                dropdown.selectedIndex = 0;
                await listImages(dropdown.value);
            }
        }

        async function listImages(folder) {
            const gallery = document.getElementById("gallery");
            gallery.innerHTML = "";
            const listUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${ROOT_FOLDER}/${folder}:/children`;
            const res = await fetch(listUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
            const data = await res.json();
            currentImages = [];
            data.value.forEach((item, index) => {
                if (item.file && item.file.mimeType.startsWith("image/")) {
                    currentImages.push({ url: item['@microsoft.graph.downloadUrl'], name: item.name });
                    const container = document.createElement("div");
                    container.className = "thumbnailItem";
                    const img = document.createElement("img");
                    img.src = item['@microsoft.graph.downloadUrl'];
                    img.className = "thumbnail";
                    img.title = item.name;
                    img.addEventListener('click', () => openModal(img.src, item.name, index));
                    const caption = document.createElement("p");
                    caption.textContent = item.name;
                    container.appendChild(img);
                    container.appendChild(caption);
                    gallery.appendChild(container);
                }
            });
        }

        function openModal(imageUrl, fileName, index) {
            currentIndex = index;
            const modal = document.getElementById("modal");
            const modalImage = document.getElementById("modalImage");
            const modalFileName = document.getElementById("modalFileName");
            modal.style.display = "flex";
            modalImage.src = imageUrl;
            modalFileName.textContent = fileName;
        }

        document.getElementById("closeModalButton").addEventListener("click", () => {
            document.getElementById("modal").style.display = "none";
        });

        document.getElementById("modal").addEventListener("click", (e) => {
            if (e.target === e.currentTarget) e.currentTarget.style.display = "none";
        });

        document.getElementById("modalNavLeft").addEventListener("click", () => {
            if (currentIndex > 0) {
                const prev = currentImages[currentIndex - 1];
                openModal(prev.url, prev.name, currentIndex - 1);
            }
        });

        document.getElementById("modalNavRight").addEventListener("click", () => {
            if (currentIndex < currentImages.length - 1) {
                const next = currentImages[currentIndex + 1];
                openModal(next.url, next.name, currentIndex + 1);
            }
        });

        function sanitizeInput(input) {
            return input.replace(/[^a-zA-Z0-9-_ ]/g, '').trim().replace(/\s+/g, '_');
        }

        window.addEventListener("load", listFolders);
        document.getElementById("folderDropdown").addEventListener("change", (e) => listImages(e.target.value));
    </script>
</body>

</html>