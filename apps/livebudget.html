<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Planner (2026+)</title>
  <link rel="stylesheet" href="../assets/css/app-styles.css" />
  <style>
    :root {
      --gap: 10px;
    }

    .grid {
      display: grid;
      gap: var(--gap);
    }

    .two {
      grid-template-columns: 1fr 1fr;
    }

    .three {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    .muted {
      opacity: .75;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #e3e3e3;
      padding: 6px 8px;
      text-align: right;
    }

    th.sticky {
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 2;
    }

    td:first-child,
    th:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 1;
    }

    thead th:first-child {
      background: #fafafa;
    }

    .right {
      text-align: right;
    }

    .center {
      text-align: center;
    }

    .ok {
      color: #10893e;
    }

    .warn {
      color: #b71c1c;
    }

    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
    }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .toolbar>* {
      margin: 4px 0;
    }

    .btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
    }

    .btn.primary {
      background: #2563eb;
      color: #fff;
      border-color: #1d4ed8;
    }

    .btn.danger {
      background: #ef4444;
      color: #fff;
      border-color: #dc2626;
    }

    .totals {
      font-weight: 700;
    }

    .scroll-x {
      overflow-x: auto;
    }

    .small {
      font-size: .9rem;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
    }
  </style>

  <!-- Main app script -->
  <script type="module">
    import { auth, onAuthStateChanged, database, ref, get, set } from './assets/js/firebase-init.js';

    /* ======== Config ======== */
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Default baseline (uses next year by default)
    const DEFAULT_BASE = {
      year: new Date().getFullYear() + 1,
      categories: [
        { name: 'Rent/Main bills', monthly: 835.39 },
        { name: 'Phone', monthly: 77.44 },
        { name: 'Vehicle gas', monthly: 120.57 },
        { name: 'Groceries', monthly: 122.16 },
        { name: 'Restaurants', monthly: 140.00 },
        { name: 'Entertainment', monthly: 50.00 },
        { name: 'Insurance', monthly: 166.67 },
      ],
      budgetOverrides: {},
      actuals: {}
    };

    /* ======== State ======== */
    let DATABASE_BASE_PATH = 'public';
    let STATE = structuredClone(DEFAULT_BASE);
    let DOM_READY = false;
    let AUTH_READY = false;

    function ensureShapes() {
      if (!Array.isArray(STATE.categories)) STATE.categories = [];
      if (!STATE.budgetOverrides) STATE.budgetOverrides = {};
      if (!STATE.actuals) STATE.actuals = {};
    }

    async function loadFromDB() {
      const yearSel = document.getElementById('year');
      const wantYear = Number(yearSel?.value || DEFAULT_BASE.year);
      const snap = await get(ref(database, `${DATABASE_BASE_PATH}/budgetPlan/${wantYear}`));
      STATE = snap.exists() ? snap.val() : structuredClone(DEFAULT_BASE);
      if (!STATE.year) STATE.year = wantYear;
      ensureShapes();
    }

    async function saveToDB() {
      try {
        await set(ref(database, `${DATABASE_BASE_PATH}/budgetPlan/${STATE.year}`), STATE);
      } catch (e) { console.error('Save failed', e); }
    }

    /* ======== Utilities ======== */
    const fmt = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' });
    const toNum = v => Math.max(0, Number(v) || 0);

    function planForMonth(catName, mIndex) {
      const key = `${catName}::${mIndex}`;
      const ov = STATE.budgetOverrides[key];
      if (ov != null) return toNum(ov);
      const cat = STATE.categories.find(c => c.name === catName);
      return toNum(cat?.monthly);
    }

    function actualForMonth(catName, mIndex) {
      const mKey = months[mIndex];
      return toNum(STATE.actuals?.[mKey]?.[catName]);
    }

    function setActual(catName, mIndex, val) {
      const mKey = months[mIndex];
      if (!STATE.actuals[mKey]) STATE.actuals[mKey] = {};
      STATE.actuals[mKey][catName] = toNum(val);
    }

    function setBudgetMonthly(catName, monthly) {
      const cat = STATE.categories.find(c => c.name === catName);
      if (cat) cat.monthly = toNum(monthly);
    }

    function setBudgetOverride(catName, mIndex, val) {
      const key = `${catName}::${mIndex}`;
      if (val === '' || val == null) delete STATE.budgetOverrides[key];
      else STATE.budgetOverrides[key] = toNum(val);
    }

    function totals() {
      const perMonth = months.map((_, mi) => {
        let budget = 0, actual = 0;
        for (const c of STATE.categories) {
          budget += planForMonth(c.name, mi);
          actual += actualForMonth(c.name, mi);
        }
        return { budget, actual, variance: actual - budget };
      });
      const yearBudget = perMonth.reduce((s, m) => s + m.budget, 0);
      const yearActual = perMonth.reduce((s, m) => s + m.actual, 0);
      return { perMonth, yearBudget, yearActual, yearVariance: yearActual - yearBudget };
    }

    /* ======== Rendering ======== */
    function renderAll() {
      const yearEl = document.getElementById('year');
      if (yearEl) yearEl.value = STATE.year;
      renderHeader();
      renderCategoriesEditor();
      renderBudgetTable();
      renderMonthTotals();
      renderYearTotals();
    }

    function renderHeader() {
      const hdr = document.getElementById('budget-header-row');
      if (!hdr) return;
      hdr.innerHTML = '<th class="sticky">Category</th>' + months.map(m => `<th class="sticky">${m}</th>`).join('');
    }

    function renderCategoriesEditor() {
      const wrap = document.getElementById('cats');
      if (!wrap) return;
      wrap.innerHTML = '';

      STATE.categories.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'grid two';
        row.innerHTML = `
          <div>
            <label class="small">Category</label>
            <input type="text" value="${c.name}" />
          </div>
          <div>
            <label class="small">Monthly Budget</label>
            <input type="number" min="0" step="0.01" value="${c.monthly}" />
          </div>
        `;
        const [nameEl, monthlyEl] = row.querySelectorAll('input');

        nameEl.addEventListener('blur', () => {
          const newName = nameEl.value.trim() || `Category ${idx + 1}`;
          if (newName !== c.name) {
            // migrate overrides + actuals keys
            for (let mi = 0; mi < months.length; mi++) {
              const oldKey = `${c.name}::${mi}`;
              const newKey = `${newName}::${mi}`;
              if (STATE.budgetOverrides[oldKey] != null) {
                STATE.budgetOverrides[newKey] = STATE.budgetOverrides[oldKey];
                delete STATE.budgetOverrides[oldKey];
              }
              const mKey = months[mi];
              if (STATE.actuals[mKey]?.[c.name] != null) {
                STATE.actuals[mKey][newName] = STATE.actuals[mKey][c.name];
                delete STATE.actuals[mKey][c.name];
              }
            }
            c.name = newName;
            saveToDB();
            renderAll();
          }
        });

        monthlyEl.addEventListener('input', () => {
          setBudgetMonthly(c.name, monthlyEl.value);
          renderBudgetTable();
          renderMonthTotals();
          renderYearTotals();
        });

        wrap.appendChild(row);
      });

      const add = document.createElement('button');
      add.className = 'btn';
      add.textContent = '+ Add Category';
      add.addEventListener('click', () => {
        STATE.categories.push({ name: `Category ${STATE.categories.length + 1}`, monthly: 0 });
        renderAll();
        saveToDB();
      });
      wrap.appendChild(add);
    }

    function renderBudgetTable() {
      const tbody = document.querySelector('#budget-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      STATE.categories.forEach(c => {
        const tr = document.createElement('tr');
        const nameTd = document.createElement('td');
        nameTd.textContent = c.name;
        tr.appendChild(nameTd);

        months.forEach((m, mi) => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number'; input.min = '0'; input.step = '0.01';
          input.value = planForMonth(c.name, mi);
          input.title = 'Budget (override this month). Leave blank to use category monthly.';
          input.addEventListener('input', () => {
            const v = input.value;
            if (v === '') setBudgetOverride(c.name, mi, '');
            else setBudgetOverride(c.name, mi, v);
            renderMonthTotals();
            renderYearTotals();
          });
          td.appendChild(input);
          tr.appendChild(td);
        });

        // Actuals row under each category
        const tr2 = document.createElement('tr');
        const name2 = document.createElement('td');
        name2.innerHTML = `<span class="muted">Actual — ${c.name}</span>`;
        tr2.appendChild(name2);

        months.forEach((m, mi) => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number'; input.min = '0'; input.step = '0.01';
          const v = actualForMonth(c.name, mi);
          input.value = v ? v : '';
          input.placeholder = '0.00';
          input.addEventListener('input', () => {
            setActual(c.name, mi, input.value);
            renderMonthTotals();
            renderYearTotals();
          });
          td.appendChild(input);
          tr2.appendChild(td);
        });

        tbody.appendChild(tr);
        tbody.appendChild(tr2);
      });
    }

    function renderMonthTotals() {
      const tfoot = document.querySelector('#budget-table tfoot');
      if (!tfoot) return;
      tfoot.innerHTML = '';
      const { perMonth } = totals();

      const trBudget = document.createElement('tr');
      trBudget.className = 'totals';
      trBudget.innerHTML = `<td>Monthly Budget Total</td>` + perMonth.map(m => `<td>${fmt.format(m.budget)}</td>`).join('');

      const trActual = document.createElement('tr');
      trActual.className = 'totals';
      trActual.innerHTML = `<td>Monthly Actual Total</td>` + perMonth.map(m => `<td>${fmt.format(m.actual)}</td>`).join('');

      const trVar = document.createElement('tr');
      trVar.className = 'totals';
      trVar.innerHTML = `<td>Variance (Actual - Budget)</td>` + perMonth.map(m => {
        const cls = m.variance <= 0 ? 'ok' : 'warn';
        return `<td class="${cls}">${fmt.format(m.variance)}</td>`;
      }).join('');

      tfoot.appendChild(trBudget);
      tfoot.appendChild(trActual);
      tfoot.appendChild(trVar);
    }

    function renderYearTotals() {
      const box = document.getElementById('yearTotals');
      if (!box) return;
      const { yearBudget, yearActual, yearVariance } = totals();
      box.innerHTML = `
        <div><span class="pill">Year:</span> <strong>${STATE.year}</strong></div>
        <div>Budget: <strong>${fmt.format(yearBudget)}</strong></div>
        <div>Actual: <strong>${fmt.format(yearActual)}</strong></div>
        <div>Variance: <strong class="${yearVariance <= 0 ? 'ok' : 'warn'}">${fmt.format(yearVariance)}</strong></div>
      `;
    }

    /* ======== CSV ======== */
    function exportCSV() {
      const { perMonth, yearVariance } = totals();
      const header = ['Category', ...months.map(m => `${m} Budget`), ...months.map(m => `${m} Actual`)];
      const rows = [header];

      for (const c of STATE.categories) {
        const bRow = [c.name];
        for (let mi = 0; mi < 12; mi++) bRow.push(planForMonth(c.name, mi));
        for (let mi = 0; mi < 12; mi++) bRow.push(actualForMonth(c.name, mi));
        rows.push(bRow);
      }

      rows.push(['Totals (Budget)', ...perMonth.map(m => m.budget), ...Array(12).fill('')]);
      rows.push(['Totals (Actual)', ...perMonth.map(m => m.actual), ...Array(12).fill('')]);
      rows.push(['Year Variance', yearVariance]);

      const csv = rows.map(r => r.map(csvEscape).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `budget_${STATE.year}.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    const csvEscape = (v) => {
      const s = String(v ?? '');
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    };

    /* ======== Init / Event wiring ======== */
    function maybeInit() {
      if (!(DOM_READY && AUTH_READY)) return;
      // Attach button handlers once
      document.addEventListener('click', (e) => {
        if (e.target.matches('#save')) saveToDB();
        if (e.target.matches('#reset-defaults')) {
          if (!confirm('Reset this year to default baseline?')) return;
          const keepYear = STATE.year;
          STATE = structuredClone(DEFAULT_BASE);
          STATE.year = keepYear;
          ensureShapes();
          renderAll();
          saveToDB();
        }
        if (e.target.matches('#export-csv')) exportCSV();
      });

      const yearSelEl = document.getElementById('year');
      if (yearSelEl && !yearSelEl._wired) {
        yearSelEl.addEventListener('change', async (e) => {
          STATE.year = Number(e.target.value);
          await loadFromDB();
          renderAll();
        });
        yearSelEl._wired = true;
      }

      // First load now that both auth+DOM are ready
      (async () => {
        await loadFromDB();
        renderAll();
      })();

      // Persist on navigation
      window.addEventListener('beforeunload', () => saveToDB());
    }

    document.addEventListener('DOMContentLoaded', () => {
      DOM_READY = true;
      maybeInit();
    });

    onAuthStateChanged(auth, async (user) => {
      DATABASE_BASE_PATH = user ? `${user.uid}` : 'public';
      AUTH_READY = true;
      maybeInit();
    });
  </script>
</head>

<body>
  <header class="grid two">
    <div>
      <h1>Budget Planner</h1>
      <p class="muted">Plan monthly budgets for next year, enter actuals each month, and see variances live. Auto-saves
        to Firebase under <code>/budgetPlan/&lt;year&gt;</code>.</p>
      <!-- Minimal login block to satisfy login.js (guarded in that file too) -->
      <section id="login-section" class="small">
        <form id="login-form">
          <label for="username">Email:</label>
          <input type="email" id="username" required>
          <label for="password">Password:</label>
          <input type="password" id="password" required>
          <button type="submit">Login</button>
        </form>
        <button id="logout" style="display:none;">Logout</button>
      </section>
    </div>
    <div class="card">
      <div class="toolbar">
        <label>Year:
          <select id="year">
            <option value="2025">2025</option>
            <option value="2026" selected>2026</option>
            <option value="2027">2027</option>
          </select>
        </label>
        <button id="save" class="btn primary">Save now</button>
        <button id="export-csv" class="btn">Export CSV</button>
        <button id="reset-defaults" class="btn danger">Reset to defaults</button>
      </div>
      <div id="yearTotals" style="margin-top:8px"></div>
    </div>
  </header>

  <main class="grid two" style="margin-top:16px; align-items:start;">
    <section class="card">
      <h2>Categories & Base Monthly Budgets</h2>
      <p class="small muted">Tip: adjust a category's <strong>Monthly Budget</strong> to change all months at once. In
        the big table, you can override specific months for a category.</p>
      <div id="cats" class="grid" style="gap:14px"></div>
    </section>

    <section class="card scroll-x">
      <h2>Budget vs Actual (by Month)</h2>
      <table id="budget-table">
        <thead>
          <tr id="budget-header-row">
            <!-- header cells injected by JS -->
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </section>
  </main>

  <footer class="muted" style="margin-top:16px">
    <p>• <strong>Budget cells</strong> (first line per category) are editable and act as per-month overrides.<br>
      • <strong>Actual cells</strong> (second line) are where you type what you actually spent.<br>
      • The right panel shows <strong>live totals</strong> and <strong>variance</strong> (green is under budget).
    </p>
  </footer>

  <!-- Keep login.js last so it finds DOM hooks -->
  <script type="module" src="./assets/js/login.js"></script>
</body>

</html>