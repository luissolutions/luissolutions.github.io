<!DOCTYPE html>
<html lang="en">

<head>
  <title>Invoice Maker</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script type="module" src="./assets/js/login.js" defer></script>

  <style>
    html,
    body {
      margin: 0;
      overflow-x: hidden;
    }

    .name {
      font-size: 40px;
      background: none;
      border: none;
      text-align: center;
      width: 100%;
    }

    main {
      display: flex;
      color: var(--secondaryTextColor);
      flex-direction: column;
      margin: 0 auto;
    }

    section {
      display: flex;
      flex-direction: column;
    }

    footer,
    header {
      text-align: center;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      background: lightgray;
    }

    label {
      padding: 5px;
    }

    textarea {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 98%;
    }

    table {
      border-collapse: collapse;
      flex-direction: column;
      margin-top: 1em;
      width: 100%;
    }

    thead {
      display: flex;
      flex-direction: row;
    }

    tbody {
      display: flex;
      flex-direction: column;
    }

    tr {
      display: flex;
      flex-direction: row;
      flex: 1;
      overflow: hidden;
    }

    th,
    td {
      display: flex;
      flex-direction: row;
      flex-shrink: 1;
      text-align: left;
      justify-content: center;
    }

    th {
      width: 100%;
    }

    td,
    td input {
      flex: 1;
      min-width: 0;
      border-width: 1px;
      border-style: inset;
      border-color: rgb(133, 133, 133);
      border-radius: 3px;
      align-items: center;
    }

    td input {
      border: none;
      text-align: center;
    }

    button {
      margin: 5px;
      padding: 5px;
      border-radius: 5px;
      cursor: pointer;
      background: var(--primaryColor);
      color: var(--textColor);
      border: 1px solid black;
    }

    button:hover {
      background: var(--secondaryColor);
      color: var(--textColor);
    }

    form {
      padding: 15px;
    }

    .title-container {
      display: flex;
      justify-content: space-evenly;
      width: auto;
    }

    .no-print,
    #no-print {
      color: darkred;
    }

    .notes {
      margin-top: 20px;
      height: 100px;
    }

    .remaining {
      display: none;
      max-width: 800px;
      margin-top: 10px;
    }

    .total {
      display: flex;
      flex-wrap: wrap;
    }

    .total label {
      width: 200px;
    }

    .entry {
      margin: 0 auto;
      box-sizing: border-box;
      border-radius: 5px;
    }

    .data {
      box-sizing: border-box;
      border: 1px solid var(--primaryColor);
      border-radius: 5px;
      display: grid;
      justify-content: center;
    }

    .entry-container {
      margin: 0 auto;
      border: 1px solid var(--primaryColor);
      padding: 5px;
      border-radius: 5px;
    }

    .copyright a {
      text-decoration: none;
      color: var(--textColor);
    }

    .padding {
      padding: 5px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 19px;
      border: none;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .category {
      margin: none;
      padding: none;
    }

    .labor-table,
    .parts-table {
      display: flex;
    }

    .final-total {
      font-weight: bold;
      align-items: center;
    }

    @media print {

      #page-break-before {
        page-break-before: auto;
      }

      .header-container .header-container input {
        color: black;
        text-shadow: none;
      }

      body,
      header,
      footer,
      section,
      nav {
        box-shadow: none;
        padding: 0;
        margin: 0;
        background-color: none;
      }

      button,
      nav,
      img,
      footer,
      .dark-container,
      .no-print,
      #no-print,
      .checkbox,
      .filter-switch,
      .actual-price-hide,
      .hide-parent-checkbox {
        display: none;
      }

      input,
      label,
      #customer-address,
      #customer-phone,
      #customer-email,
      #invoice-type {
        border: none;
      }

      header {
        height: auto;
        z-index: 2;
      }

      body {
        filter: none;
      }
    }

    #customer-address,
    #customer-name,
    #customer-phone,
    #customer-email {
      width: 98%;
      margin-bottom: 20px;
    }

    #entries-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    #invoice-number,
    #invoice-date {
      margin-bottom: 20px;
    }

    #total {
      font-weight: bold;
      align-items: center;
    }

    .input {
      max-width: 100px;
    }

    #unfinished {
      display: none;
    }

    #save-data-button {
      width: 97%;
    }

    #login-form {
      flex-direction: column;
      padding: 10px;
    }

    #sidebar {
      position: fixed;
      top: 0;
      right: -303px;
      width: 300px;
      height: 100%;
      background: white;
      transition: right 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .sidebar-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #sidebar.open {
      right: 0;
    }

    iframe {
      height: 99vh;
    }

    header {
      position: relative;
      z-index: 100;
    }
  </style>
</head>

<body>
  <header>
    <div class="no-print">
      <input type="text" class="input" id="invoice-search" placeholder="Search">
      <select id="invoice-dropdown">
        <option value="">Select File</option>
      </select>
      <button id="load-invoice-button" type="button">Load Invoice</button>
      <button id="menu-toggle" class="menu-button">Menu</button>
    </div>

    <section class="no-print" id="login-section">
      <form id="login-form">
        <label for="username">Email:</label>
        <input type="email" id="username" required>
        <br>
        <label for="password">Password:</label>
        <input type="password" id="password" required>
        <br>
        <button type="submit">Login</button>
      </form>
      <button id="logout" style="display: none;">Logout</button>
    </section>
  </header>

  <main>
    <section>
      <div class="title-container">
        <input class="name" id="title-input" value="...">
      </div>

      <form>
        <div>
          <div>
            <select id="invoice-type" name="invoice-type">
              <option value="quote">Quote:</option>
              <option value="invoice">Invoice #</option>
            </select>
            <input type="text" id="invoice-number" name="invoice-number" data-id="">
          </div>

          <label class="no-print" for="customer-name">Customer Name:</label>
          <input type="text" id="customer-name" name="customer-name">
          <br>

          <div>
            <label class="no-print" for="customer-phone">Customer Phone:</label>
            <input type="checkbox" class="hide-parent-checkbox" name="phone-hide" id="phone-hide">
            <label id="no-print" for="phone-hide"> Hide Phone Field</label>
            <input type="tel" id="customer-phone" name="customer-phone">
          </div>

          <div>
            <label class="no-print" for="customer-email">Customer Email:</label>
            <input type="checkbox" class="hide-parent-checkbox" name="email-hide" id="email-hide">
            <label id="no-print" for="email-hide"> Hide Email Field</label>
            <input type="email" id="customer-email" name="customer-email">
          </div>

          <div>
            <label class="no-print" for="customer-address">Customer Address:</label>
            <input type="checkbox" class="hide-parent-checkbox" name="address-hide" id="address-hide">
            <label id="no-print" for="address-hide"> Hide Address Field</label>
            <textarea id="customer-address" name="customer-address"></textarea>
          </div>

          <label class="no-print" for="invoice-date">Date:</label>
          <input type="datetime-local" id="invoice-date" name="invoice-date">
        </div>

        <div>
          <div class="no-print">
            <label for="part-category">Select Category:</label>
            <select id="part-category"></select>

            <label for="part-subcategory">Select Subcategory:</label>
            <select id="part-subcategory"></select>

            <label for="part-selector">Select Part:</label>
            <select id="part-selector"></select>

            <label class="price-difference" id="price-difference-display">Profit on Parts: $<span
                id="price-difference"></span></label>
          </div>

          <div>
            <table class="parts-table">
              <button type="button" id="add-part-row">Add Part</button>
              <button type="button" id="del-part-row">Undo Part</button>
              <thead>
                <tr>
                  <th>Parts:</th>
                  <th>Quantity:</th>
                  <th>Price:</th>
                  <th class="actual-price-hide">Actual Price:</th>
                  <th>Total:</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <input type="checkbox" class="hide-parent-checkbox" name="parts-hide" id="parts-hide">
            <label id="no-print" for="parts-hide"> Hide Parts Field</label>
          </div>

          <br>

          <div>
            <button type="button" id="add-labor-row">Add Labor</button>
            <table class="labor-table">
              <thead>
                <tr>
                  <th>Labor:</th>
                  <th>Quantity:</th>
                  <th>Rate:</th>
                  <th>Total:</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <input type="checkbox" class="hide-parent-checkbox" name="labor-hide" id="labor-hide">
            <label id="no-print" for="labor-hide"> Hide Labor Field</label>
          </div>

          <div>
            <div>
              <textarea class="notes" name="notes" id="notes" cols="30" rows="10"></textarea>
              <br>
              <input type="checkbox" class="hide-parent-checkbox" name="notes-hide" id="notes-hide">
              <label id="no-print" for="notes-hide"> Hide Notes Field</label>
            </div>
          </div>
        </div>

        <div class="total">
          <label>Subtotal: $<input type="number" id="subtotal" readonly></label>
          <label>Tax (%): <input type="number" id="tax-percent"></label>
          <label>Tax Amount $: <input type="number" id="tax" readonly></label>
          <label class="final-total">Total: $<input type="number" id="total" readonly></label>
        </div>

        <br>

        <div class="checkbox">
          <input type="checkbox" name="remaining" id="remaining">
          <label id="no-print" for="remaining">Check if theres a remaining Balance</label>
        </div>

        <div class="remaining">
          <label>Amount Paid: $ <input type="number" id="amount-paid"></label>

          <label class="no-print" for="paid-date">Paid Date:</label>
          <input type="datetime-local" id="paid-date" name="paid-date">

          <label class="final-total">Remaining Balance: $<span id="remaining-balance">0.00</span></label>
        </div>

        <br>
      </form>
    </section>

    <aside id="sidebar" class="no-print">
      <div class="sidebar-content">
        <iframe id="linkAppIframe" src="./liveanalytics.html"></iframe>
      </div>
    </aside>
  </main>

  <footer>
    <button type="button" id="save-button" class="action-btn">Save Data</button>
    <button id="deleteButton">Delete Data</button>
    <button id="exportButton">Export Data</button>
    <button type="button" id="print-button" class="action-btn" onClick="window.print();">Print Invoice</button>
    <button id="reset-button" class="action-btn" onClick="clearInvoice();">Reset Layout</button>
  </footer>

  <!-- =========================
       MODULE SCRIPT (Firebase + Invoice + NEW Inventory DB)
  ========================== -->
  <script type="module">
    import { auth, onAuthStateChanged, database, ref, onValue, set, remove, get, update } from './assets/js/firebase-init.js';

    let DATABASE_BASE_PATH = 'public';

    const partsTableBody = document.querySelector('.parts-table tbody');
    const subtotalInput = document.getElementById('subtotal');
    const taxPercentInput = document.getElementById('tax-percent');
    const taxInput = document.getElementById('tax');
    const totalInput = document.getElementById('total');

    const addPartRowButton = document.getElementById('add-part-row');
    const delPartRowButton = document.getElementById('del-part-row');

    const partCategory = document.getElementById('part-category');
    const partSubcategory = document.getElementById('part-subcategory');
    const partSelector = document.getElementById('part-selector');

    const addLaborRowButton = document.getElementById('add-labor-row');
    const laborTableBody = document.querySelector('.labor-table tbody');

    const remainingCheckbox = document.getElementById('remaining');
    const remainingDiv = document.querySelector('.remaining');
    const amountPaidInput = document.getElementById('amount-paid');
    const remainingBalanceSpan = document.getElementById('remaining-balance');

    const saveButton = document.getElementById('save-button');
    const invoiceDropdown = document.getElementById('invoice-dropdown');
    const deleteButton = document.getElementById('deleteButton');
    const searchInput = document.getElementById('invoice-search');

    /* =========================================================
       NEW INVENTORY DB (ledgerTx) -> category/sub/parts dropdowns
       - Reads:  ${BASE}/ledgerTx/{year}/{id}
       - Uses:   only expense lines tagged "inv"
       - Groups: sku if present else name (newest wins)
       - Allows missing category/subcategory
    ========================================================= */
    const INV_NODE = 'ledgerTx';
    const INV_TAG = 'inv';
    const ALL = '__ALL__';
    const NO_CATEGORY = '__NO_CATEGORY__';
    const NO_SUBCATEGORY = '__NO_SUBCATEGORY__';

    let INVENTORY_ITEMS = []; // grouped inventory list

    function safeStr(v) { return (typeof v === 'string' ? v.trim() : ''); }

    function hasTag(tags, want) {
      const w = String(want || '').toLowerCase();
      return (Array.isArray(tags) ? tags : []).some(t => String(t).toLowerCase() === w);
    }

    function roundMoney(n) {
      return Math.round((Number(n) || 0) * 100) / 100;
    }

    function setSelectOptions(selectEl, options, placeholderText) {
      selectEl.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = placeholderText || 'Select...';
      selectEl.appendChild(ph);

      for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        selectEl.appendChild(o);
      }
    }

    function buildInventoryFromLedgerTx(rawYearsObj) {
      const allLines = [];

      for (const [year, yearObj] of Object.entries(rawYearsObj || {})) {
        if (!yearObj || typeof yearObj !== 'object') continue;

        for (const [id, v] of Object.entries(yearObj)) {
          if (!v || typeof v !== 'object') continue;

          const type = String(v.type || '').toLowerCase();
          if (type !== 'expense') continue;
          if (!hasTag(v.tags, INV_TAG)) continue;

          const name = safeStr(v.name);
          const sku = safeStr(v.sku);
          if (!name && !sku) continue;

          const date = Number(v.date || 0);

          allLines.push({
            id: String(id),
            date,
            part: name || sku,
            sku,
            category: safeStr(v.cat),
            subcategory: safeStr(v.sub),
            price: roundMoney(Math.abs(Number(v.amt || 0))),
            actualPrice: roundMoney(Math.abs(Number(v.altAmt || 0))),
          });
        }
      }

      // Group by sku else name; newest line wins
      const map = new Map();
      for (const line of allLines) {
        const key = line.sku ? `sku:${line.sku.toLowerCase()}` : `name:${line.part.toLowerCase()}`;
        const cur = map.get(key);

        if (!cur) { map.set(key, line); continue; }

        const isNewer =
          (Number(line.date) > Number(cur.date)) ||
          (Number(line.date) === Number(cur.date) && String(line.id) > String(cur.id));

        if (isNewer) map.set(key, line);
      }

      const items = Array.from(map.values());
      items.sort((a, b) => a.part.localeCompare(b.part));
      return items;
    }

    function buildCategoryOptions(items) {
      const cats = new Set();
      let hasNoCat = false;

      for (const it of items) {
        if (it.category) cats.add(it.category);
        else hasNoCat = true;
      }

      const opts = [{ value: ALL, label: 'All Categories' }];
      if (hasNoCat) opts.push({ value: NO_CATEGORY, label: '(No Category)' });

      [...cats].sort((a, b) => a.localeCompare(b)).forEach(c => opts.push({ value: c, label: c }));
      return opts;
    }

    function buildSubcategoryOptions(items, categoryValue) {
      const subs = new Set();
      let hasNoSub = false;

      const filtered = items.filter(it => {
        if (!categoryValue || categoryValue === ALL) return true;
        if (categoryValue === NO_CATEGORY) return !it.category;
        return it.category === categoryValue;
      });

      for (const it of filtered) {
        if (it.subcategory) subs.add(it.subcategory);
        else hasNoSub = true;
      }

      const opts = [{ value: ALL, label: 'All Subcategories' }];
      if (hasNoSub) opts.push({ value: NO_SUBCATEGORY, label: '(No Subcategory)' });

      [...subs].sort((a, b) => a.localeCompare(b)).forEach(s => opts.push({ value: s, label: s }));
      return opts;
    }

    function populatePartSelector(items, categoryValue, subcategoryValue) {
      partSelector.innerHTML = '';

      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = 'Select Part';
      partSelector.appendChild(ph);

      const filtered = items.filter(it => {
        // category filter
        let catOk = true;
        if (!categoryValue || categoryValue === ALL) catOk = true;
        else if (categoryValue === NO_CATEGORY) catOk = !it.category;
        else catOk = (it.category === categoryValue);

        // subcategory filter
        let subOk = true;
        if (!subcategoryValue || subcategoryValue === ALL) subOk = true;
        else if (subcategoryValue === NO_SUBCATEGORY) subOk = !it.subcategory;
        else subOk = (it.subcategory === subcategoryValue);

        return catOk && subOk;
      });

      if (!filtered.length) {
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'No Parts Available';
        partSelector.appendChild(o);
        return;
      }

      for (const it of filtered) {
        const option = document.createElement('option');
        option.value = it.id;
        option.textContent = it.part;

        // used by addPartRow()
        option.dataset.price = String(it.price || 0);
        option.dataset.actualPrice = String(it.actualPrice || 0);
        option.dataset.category = it.category || '';
        option.dataset.component = it.subcategory || '';

        partSelector.appendChild(option);
      }
    }

    function loadInventoryFromLedgerTx() {
      const rootRef = ref(database, `${DATABASE_BASE_PATH}/${INV_NODE}`);

      onValue(rootRef, (snapshot) => {
        const raw = snapshot.exists() ? snapshot.val() : {};
        INVENTORY_ITEMS = buildInventoryFromLedgerTx(raw);

        if (!INVENTORY_ITEMS.length) {
          setSelectOptions(partCategory, [], 'No Categories Available');
          setSelectOptions(partSubcategory, [], 'No Subcategories Available');
          partSelector.innerHTML = '<option value="">No Parts Available</option>';
          return;
        }

        setSelectOptions(partCategory, buildCategoryOptions(INVENTORY_ITEMS), 'Select Category');
        setSelectOptions(partSubcategory, buildSubcategoryOptions(INVENTORY_ITEMS, ALL), 'Select Subcategory');
        partSubcategory.value = ALL;

        populatePartSelector(INVENTORY_ITEMS, ALL, ALL);
      }, (err) => console.error('❌ inventory ledgerTx listener error:', err));
    }

    partCategory.addEventListener('change', () => {
      const catVal = partCategory.value || ALL;

      setSelectOptions(
        partSubcategory,
        buildSubcategoryOptions(INVENTORY_ITEMS, catVal),
        'Select Subcategory'
      );

      partSubcategory.value = ALL;
      populatePartSelector(INVENTORY_ITEMS, catVal, ALL);
    });

    partSubcategory.addEventListener('change', () => {
      const catVal = partCategory.value || ALL;
      const subVal = partSubcategory.value || ALL;
      populatePartSelector(INVENTORY_ITEMS, catVal, subVal);
    });

    // =========================
    // Ledger TX helpers (for "Amount Paid" -> ledgerTx income entry)
    // =========================
    const TX_NODE = 'ledgerTx';

    function pad2(n) { return String(n).padStart(2, '0'); }

    // invoice-date is datetime-local (local time). We only care about the date bucket.
    // We'll store ledger date as UTC noon timestamp (same pattern as your ledger app).
    function utcNoonTSFromLocalDateTime(localDT) {
      // localDT like "2026-01-07T14:30"
      if (!localDT || typeof localDT !== 'string') return Date.UTC(new Date().getUTCFullYear(), 0, 1, 12, 0, 0);

      const ymd = localDT.slice(0, 10); // "YYYY-MM-DD"
      if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return Date.now();

      const y = +ymd.slice(0, 4);
      const m = +ymd.slice(5, 7) - 1;
      const d = +ymd.slice(8, 10);
      return Date.UTC(y, m, d, 12, 0, 0);
    }

    function yearFromTS(ts) {
      return new Date(Number(ts)).getUTCFullYear();
    }

    async function upsertInvoicePaymentTx({ invoiceId, existingInvoice = {}, invoiceData }) {
      const amountPaidNum = Math.round((Math.abs(Number(invoiceData.amountPaid || 0)) * 100)) / 100;

      const prevTxId = existingInvoice.paymentTxId || '';
      const prevTxYear = Number(existingInvoice.paymentTxYear || 0) || null;

      // If amountPaid cleared/0 -> delete prior payment tx (optional but usually desired)
      if (!amountPaidNum) {
        if (prevTxId && prevTxYear) {
          await set(ref(database, `${DATABASE_BASE_PATH}/${TX_NODE}/${prevTxYear}/${prevTxId}`), null);
        } else if (prevTxId && !prevTxYear) {
          // best-effort search not available here; just clear meta
        }

        // clear meta fields on the invoice
        await update(ref(database, `${DATABASE_BASE_PATH}/tasks/${invoiceId}`), {
          paymentTxId: '',
          paymentTxYear: ''
        });

        return;
      }

      // pick date for the ledger entry
      const paidSourceDT = (invoiceData.paidDate || invoiceData.startTime || '');
      const dateTS = utcNoonTSFromLocalDateTime(paidSourceDT);
      const year = yearFromTS(dateTS);

      // reuse existing txId if present, else create one
      const txId = prevTxId || String(Date.now());

      // if year changed since last save, delete old location first
      if (prevTxId && prevTxYear && prevTxYear !== year) {
        await set(ref(database, `${DATABASE_BASE_PATH}/${TX_NODE}/${prevTxYear}/${prevTxId}`), null);
      }

      const customer = (invoiceData.customerName || '').trim();
      const project = (invoiceData.project || '').trim();
      const title = (invoiceData.invoiceTitle || '').trim();

      // Build a nice ledger name
      const name =
        `Invoice Payment — ${customer || 'Unknown'}`
        + (project ? ` (${project})` : '')
        + (title ? ` • ${title}` : '');

      // Keep tags simple; you can change these any time
      const tags = ['invoice', 'payment'];

      const tx = {
        amt: amountPaidNum,
        cat: '',
        sub: '',
        sku: '',
        link: '',
        img: '',
        imgPath: '',
        desc: `Source invoiceId: ${invoiceId}`,
        name,
        tags,
        type: 'income',
        date: dateTS
      };

      await set(ref(database, `${DATABASE_BASE_PATH}/${TX_NODE}/${year}/${txId}`), tx);

      // persist tx link on the invoice so future saves update (not duplicate)
      await update(ref(database, `${DATABASE_BASE_PATH}/tasks/${invoiceId}`), {
        paymentTxId: txId,
        paymentTxYear: year
      });
    }

    /* =========================
       AUTH + INIT
    ========================== */
    onAuthStateChanged(auth, (user) => {
      DATABASE_BASE_PATH = user ? `${user.uid}` : 'public';

      loadInventoryFromLedgerTx();
      populateInvoiceDropdown();
    });

    /* =========================
       INVOICE SAVE / LOAD
    ========================== */
    async function saveInvoice() {
      const projectInput = document.getElementById('invoice-number');
      let invoiceId = projectInput.dataset.id;

      if (!invoiceId) {
        invoiceId = String(Date.now());
        projectInput.dataset.id = invoiceId;
      }

      const invoiceType = document.getElementById('invoice-type').value;
      const amountPaid = document.getElementById('amount-paid').value;
      const startTime = document.getElementById('invoice-date').value;
      const paidDate = document.getElementById('paid-date').value;

      const partsData = Array.from(partsTableBody.querySelectorAll('tr')).map(row => ({
        part: row.dataset.part || '',
        quantity: row.querySelector('input[name="part-quantity"]').value || 0,
        price: row.querySelector('input[name="part-price"]').value || 0,
        actualPrice: row.querySelector('input[name="part-actual-price"]').value || 0,
        total: row.querySelector('input[name="part-total"]').value || 0,
        category: row.dataset.category || '',
        component: row.dataset.component || '',
      }));

      const laborData = Array.from(laborTableBody.querySelectorAll('tr')).map(row => ({
        description: row.querySelector('input[name="labor-description"]').value.trim() || '',
        hours: row.querySelector('input[name="labor-hours"]').value || 0,
        rate: row.querySelector('input[name="labor-rate"]').value || 0,
        total: row.querySelector('input[name="labor-total"]').value || 0,
      }));

      const newInvoiceData = {
        id: invoiceId,
        invoiceType,
        invoiceTitle: document.getElementById('title-input').value,
        customerName: document.getElementById('customer-name').value,
        customerPhone: document.getElementById('customer-phone').value,
        customerEmail: document.getElementById('customer-email').value,
        customerAddress: document.getElementById('customer-address').value,
        project: projectInput.value.trim(),
        notes: document.getElementById('notes').value,
        startTime,
        parts: partsData,
        labor: laborData,
        taxPercent: taxPercentInput.value,
        paidDate,
        amountPaid,
      };

      const invoiceRef = ref(database, `${DATABASE_BASE_PATH}/tasks/${invoiceId}`);

      try {
        const snapshot = await get(invoiceRef);
        const existingData = snapshot.exists() ? snapshot.val() : {};

        const updatedInvoiceData = { ...existingData, ...newInvoiceData };
        await update(invoiceRef, updatedInvoiceData);

        // ✅ Create/update ONE income transaction in ledgerTx based on Amount Paid
        await upsertInvoicePaymentTx({
          invoiceId,
          existingInvoice: existingData,
          invoiceData: updatedInvoiceData
        });

        console.log(`Invoice ${invoiceId} saved/updated successfully.`);
        clearInvoice();
        populateInvoiceDropdown();

      } catch (error) {
        console.error("Error saving/updating invoice:", error);
      }
    }

    async function addPartRow(partData = null) {
      let part, price, actualPrice, category, component, quantity;

      if (partData) {
        part = partData.part;
        price = parseFloat(partData.price) || 0;
        actualPrice = parseFloat(partData.actualPrice) || 0;
        category = partData.category || '';
        component = partData.component || '';
        quantity = parseInt(partData.quantity) || 1;
      } else {
        const selectedOption = partSelector.options[partSelector.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
          console.warn("⚠️ No part selected.");
          return;
        }

        part = selectedOption.textContent;
        price = parseFloat(selectedOption.dataset.price) || 0;
        actualPrice = parseFloat(selectedOption.dataset.actualPrice) || 0;
        category = selectedOption.dataset.category || '';
        component = selectedOption.dataset.component || '';
        quantity = 1;
      }

      // merge if same part name already exists
      const existingRow = Array.from(partsTableBody.querySelectorAll('tr')).find(row => row.dataset.part === part);

      if (existingRow) {
        const quantityInput = existingRow.querySelector('input[name="part-quantity"]');
        const currentQuantity = parseInt(quantityInput.value) || 0;
        quantityInput.value = currentQuantity + quantity;
        updatePartRowTotal(existingRow);
        return;
      }

      const newRow = document.createElement('tr');
      newRow.dataset.part = part;
      newRow.dataset.category = category;
      newRow.dataset.component = component;

      newRow.innerHTML = `
        <td>${part}</td>
        <td><input type="number" name="part-quantity" min="1" value="${quantity}"></td>
        <td><input type="number" name="part-price" min="0" value="${price}" class="part-price-input"></td>
        <td class="actual-price-hide"><input type="number" name="part-actual-price" min="0" value="${actualPrice}" class="actual-price-input"></td>
        <td><input type="number" name="part-total" min="0" value="${(price * quantity).toFixed(2)}" readonly></td>
      `;

      partsTableBody.appendChild(newRow);

      const priceInput = newRow.querySelector('input[name="part-price"]');
      const quantityInput = newRow.querySelector('input[name="part-quantity"]');

      priceInput.addEventListener('input', () => updatePartRowTotal(newRow));
      quantityInput.addEventListener('input', () => updatePartRowTotal(newRow));

      updateTotals();
      updatePriceDifference();
      updateRemainingBalance();
    }

    addPartRowButton.addEventListener('click', () => {
      const selectedOption = partSelector.options[partSelector.selectedIndex];
      if (selectedOption && selectedOption.value) {
        addPartRow({
          part: selectedOption.textContent,
          price: selectedOption.dataset.price,
          actualPrice: selectedOption.dataset.actualPrice,
          category: selectedOption.dataset.category,
          component: selectedOption.dataset.component,
          quantity: 1
        });
      } else {
        alert("Please select a part first.");
      }
    });

    function delPartRow() {
      const lastRow = partsTableBody.querySelector('tr:last-child');
      if (!lastRow) {
        console.warn('⚠️ No parts available to undo.');
        return;
      }

      const partName = lastRow.cells[0].textContent.trim();
      lastRow.remove();

      updateTotals();
      updatePriceDifference();
      updateRemainingBalance();

      const invoiceId = document.getElementById('invoice-number').dataset.id;
      if (!invoiceId) return;

      const invoiceRef = ref(database, `${DATABASE_BASE_PATH}/tasks/${invoiceId}/parts`);
      get(invoiceRef).then((snapshot) => {
        if (snapshot.exists()) {
          const parts = snapshot.val();
          const updatedParts = (Array.isArray(parts) ? parts : []).filter(p => p.part !== partName);

          update(ref(database, `${DATABASE_BASE_PATH}/tasks/${invoiceId}`), { parts: updatedParts })
            .then(() => console.log(`✅ Removed part: ${partName} from Firebase.`))
            .catch(error => console.error('❌ Error updating parts in Firebase:', error));
        }
      }).catch(error => console.error('❌ Error fetching parts:', error));
    }

    delPartRowButton.addEventListener('click', delPartRow);

    function addLaborRow(description = '', hours = 0, rate = 0) {
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" name="labor-description" value="${description}"></td>
        <td><input type="number" name="labor-hours" min="0" value="${hours}"></td>
        <td><input type="number" name="labor-rate" min="0" value="${rate}"></td>
        <td><input type="number" name="labor-total" readonly></td>
      `;
      laborTableBody.appendChild(newRow);

      const hoursInput = newRow.querySelector('input[name="labor-hours"]');
      const rateInput = newRow.querySelector('input[name="labor-rate"]');
      const totalInput = newRow.querySelector('input[name="labor-total"]');

      const recalc = () => updateLaborTotal(hoursInput, rateInput, totalInput);
      hoursInput.addEventListener('input', recalc);
      rateInput.addEventListener('input', recalc);
      recalc();
    }

    addLaborRowButton.addEventListener('click', () => addLaborRow());

    function updatePriceDifference() {
      let totalDifference = 0;
      const rows = partsTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const quantity = parseInt(row.querySelector('input[name="part-quantity"]').value) || 0;
        const price = parseFloat(row.querySelector('input[name="part-price"]').value) || 0;
        const actualPrice = parseFloat(row.querySelector('input[name="part-actual-price"]').value) || 0;
        totalDifference += (quantity * price) - (quantity * actualPrice);
      });
      document.getElementById('price-difference').innerText = totalDifference.toFixed(2);
    }

    function updateLaborTotal(hoursInput, rateInput, totalInput) {
      const hours = parseFloat(hoursInput.value) || 0;
      const rate = parseFloat(rateInput.value) || 0;
      totalInput.value = (hours * rate).toFixed(2);
      updateTotals();
      updateRemainingBalance();
    }

    function updatePartRowTotal(row) {
      const quantity = parseInt(row.querySelector('input[name="part-quantity"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name="part-price"]').value) || 0;
      row.querySelector('input[name="part-total"]').value = (quantity * price).toFixed(2);

      updateTotals();
      updatePriceDifference();
      updateRemainingBalance();
    }

    function updateRemainingBalance() {
      const amountPaid = parseFloat(amountPaidInput.value) || 0;
      const total = parseFloat(totalInput.value) || 0;
      remainingBalanceSpan.textContent = (total - amountPaid).toFixed(2);
    }

    function updateTotals() {
      let partsTotal = 0;
      let laborTotal = 0;

      document.querySelectorAll('.parts-table tbody tr').forEach(row => {
        partsTotal += parseFloat(row.querySelector('input[name="part-total"]').value) || 0;
      });

      document.querySelectorAll('.labor-table tbody tr').forEach(row => {
        laborTotal += parseFloat(row.querySelector('input[name="labor-total"]').value) || 0;
      });

      const subtotal = partsTotal + laborTotal;
      const taxPercent = parseFloat(taxPercentInput.value) || 0;
      const tax = partsTotal * (taxPercent / 100);
      const total = subtotal + tax;

      subtotalInput.value = subtotal.toFixed(2);
      taxInput.value = tax.toFixed(2);
      totalInput.value = total.toFixed(2);
    }

    remainingCheckbox.addEventListener('change', function () {
      remainingDiv.style.display = this.checked ? 'block' : 'none';
    });

    amountPaidInput.addEventListener('input', updateRemainingBalance);

    taxPercentInput.addEventListener('input', () => {
      updateTotals();
      updateRemainingBalance();
    });

    saveButton.addEventListener('click', async () => {
      await saveInvoice();
    });

    /* =========================
       INVOICE DROPDOWN + SEARCH
    ========================== */
    function populateInvoiceDropdown() {
      const dropdown = document.getElementById('invoice-dropdown');
      dropdown.innerHTML = '';

      const invoiceRef = ref(database, `${DATABASE_BASE_PATH}/tasks`);

      onValue(invoiceRef, (snapshot) => {
        dropdown.innerHTML = '';
        if (snapshot.exists()) {
          const invoices = snapshot.val();
          const fragment = document.createDocumentFragment();

          const sorted = Object.entries(invoices).sort((a, b) => {
            const dateA = new Date(a[1].startTime || 0);
            const dateB = new Date(b[1].startTime || 0);
            return dateB - dateA;
          });

          sorted.forEach(([id, invoice]) => {
            const customerName = invoice.customerName || 'Unknown';
            const startTime = invoice.startTime ? new Date(invoice.startTime).toLocaleDateString() : 'No Date';

            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${customerName} - ${startTime}`;
            fragment.appendChild(option);
          });

          dropdown.appendChild(fragment);

          if (!dropdown.options.length) {
            const noResults = document.createElement('option');
            noResults.textContent = 'No invoices found';
            dropdown.appendChild(noResults);
          }
        } else {
          const noResults = document.createElement('option');
          noResults.textContent = 'No invoices found';
          dropdown.appendChild(noResults);
        }
      }, (error) => {
        console.error("Error fetching invoices:", error);
      });
    }

    searchInput.addEventListener('input', () => {
      // simplest behavior: re-run populate (you can add client-side filtering later)
      populateInvoiceDropdown();
    });

    /* =========================
       DELETE INVOICE
    ========================== */
    deleteButton.addEventListener('click', async () => {
      const selectedId = invoiceDropdown.value;
      if (!selectedId) return;

      const isConfirmed = confirm(`Are you sure you want to delete invoice ${selectedId}? This action cannot be undone.`);
      if (!isConfirmed) return;

      const invoiceRef = ref(database, `${DATABASE_BASE_PATH}/tasks/${selectedId}`);
      try {
        await remove(invoiceRef);
        console.log(`Invoice ${selectedId} deleted successfully`);
        populateInvoiceDropdown();
      } catch (error) {
        console.error(`Error deleting invoice ${selectedId}:`, error);
      }
    });

    /* =========================
       LOAD INVOICE
    ========================== */
    document.getElementById('load-invoice-button').addEventListener('click', function () {
      const selectedId = invoiceDropdown.value;
      if (!selectedId) {
        alert('Please select an invoice to load.');
        return;
      }

      clearInvoice();

      const invoiceRef = ref(database, `${DATABASE_BASE_PATH}/tasks/${selectedId}`);

      get(invoiceRef).then((snapshot) => {
        if (!snapshot.exists()) {
          alert('Invoice not found.');
          return;
        }

        const invoiceData = snapshot.val() || {};

        document.getElementById('invoice-number').dataset.id = invoiceData.id || selectedId;
        document.getElementById('invoice-type').value = invoiceData.invoiceType || 'invoice';
        document.getElementById('title-input').value = invoiceData.invoiceTitle || '';
        document.getElementById('customer-name').value = invoiceData.customerName || '';
        document.getElementById('customer-phone').value = invoiceData.customerPhone || '';
        document.getElementById('customer-email').value = invoiceData.customerEmail || '';
        document.getElementById('customer-address').value = invoiceData.customerAddress || '';
        document.getElementById('invoice-number').value = invoiceData.project || '';
        document.getElementById('notes').value = invoiceData.notes || '';

        if (invoiceData.startTime) {
          const startTime = new Date(invoiceData.startTime);
          const localStart = new Date(startTime.getTime() - startTime.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
          document.getElementById('invoice-date').value = localStart;
        }

        if (invoiceData.paidDate) {
          const dt = new Date(invoiceData.paidDate);
          const localDT = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
          document.getElementById('paid-date').value = localDT;
        } else {
          document.getElementById('paid-date').value = '';
        }

        document.getElementById('amount-paid').value = invoiceData.amountPaid || '';
        document.getElementById('tax-percent').value = invoiceData.taxPercent || '';

        if (Array.isArray(invoiceData.parts)) invoiceData.parts.forEach(p => addPartRow(p));
        if (Array.isArray(invoiceData.labor)) invoiceData.labor.forEach(l => addLaborRow(l.description || '', l.hours || 0, l.rate || 0));

        updateTotals();
        updateRemainingBalance();
      }).catch((error) => {
        console.error('Error fetching selected invoice:', error);
      });
    });

    /* =========================
       EXPORT INVOICE
    ========================== */
    document.getElementById('exportButton').addEventListener('click', function () {
      const selectedId = invoiceDropdown.value;
      if (!selectedId) {
        alert('Please select a file to export.');
        return;
      }

      const invoiceRef = ref(database, `${DATABASE_BASE_PATH}/tasks/${selectedId}`);
      get(invoiceRef).then((snapshot) => {
        if (!snapshot.exists()) {
          alert('No data available for selected invoice');
          return;
        }

        const invoiceData = snapshot.val();
        const blob = new Blob([JSON.stringify(invoiceData, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `invoice-${selectedId}.json`;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }).catch((error) => console.error('Error fetching invoice:', error));
    });

    /* =========================
       NOTES AUTO-RESIZE
    ========================== */
    document.addEventListener('DOMContentLoaded', function () {
      const textarea = document.getElementById('notes');
      textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      }, false);

      taxPercentInput.addEventListener('input', updateTotals);
      updatePriceDifference();
    });

    document.addEventListener('input', function (event) {
      if (event.target.classList.contains('actual-price-input') || event.target.classList.contains('part-price-input')) {
        updatePriceDifference();
        updateTotals();
      }
    });
  </script>

  <!-- =========================
       NON-MODULE SCRIPT (UI helpers + localStorage + sidebar)
  ========================== -->
  <script>
    const hideParentCheckboxes = document.querySelectorAll('.hide-parent-checkbox');

    hideParentCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const parentDiv = checkbox.closest('div');
        if (parentDiv) parentDiv.style.display = checkbox.checked ? 'none' : 'block';
      });
    });

    function saveDataToLocalStorage() {
      const inputData = {
        invoiceTitle: document.getElementById('title-input').value,
        customerName: document.getElementById('customer-name').value,
        customerPhone: document.getElementById('customer-phone').value,
        customerEmail: document.getElementById('customer-email').value,
        customerAddress: document.getElementById('customer-address').value,
        startTime: document.getElementById('invoice-date').value,
        project: document.getElementById('invoice-number').value,
        notes: document.getElementById('notes').value,
        paidDate: document.getElementById('paid-date').value,
      };

      localStorage.setItem('inputData', JSON.stringify(inputData));
    }

    function loadDataFromLocalStorage() {
      const savedData = localStorage.getItem('inputData');
      if (!savedData) return;

      const inputData = JSON.parse(savedData);
      document.getElementById('title-input').value = inputData.invoiceTitle || '';
      document.getElementById('customer-name').value = inputData.customerName || '';
      document.getElementById('customer-phone').value = inputData.customerPhone || '';
      document.getElementById('customer-email').value = inputData.customerEmail || '';
      document.getElementById('customer-address').value = inputData.customerAddress || '';
      document.getElementById('invoice-date').value = inputData.startTime || '';
      document.getElementById('invoice-number').value = inputData.project || '';
      document.getElementById('notes').value = (inputData.notes || '').replace(/\r?\n/g, " ");
      document.getElementById('paid-date').value = inputData.paidDate || '';

    }

    document.getElementById('title-input').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('customer-name').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('customer-phone').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('customer-email').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('customer-address').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('invoice-date').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('invoice-number').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('notes').addEventListener('input', saveDataToLocalStorage);
    document.getElementById('paid-date').addEventListener('input', saveDataToLocalStorage);

    document.addEventListener('DOMContentLoaded', loadDataFromLocalStorage);

    function clearInvoice() {
      ['title-input', 'customer-name', 'customer-phone', 'customer-email',
        'customer-address', 'invoice-date', 'paid-date', 'invoice-number', 'notes']

        .forEach(id => document.getElementById(id).value = '');

      document.getElementById('invoice-number').dataset.id = '';
      document.querySelector('.parts-table tbody').innerHTML = '';
      document.querySelector('.labor-table tbody').innerHTML = '';

      ['subtotal', 'tax-percent', 'tax', 'total', 'amount-paid'].forEach(id => {
        document.getElementById(id).value = '';
      });

      document.getElementById('remaining').checked = false;
      document.querySelector('.remaining').style.display = 'none';

      localStorage.removeItem('inputData');
    }

    document.getElementById('menu-toggle').addEventListener('click', function () {
      document.getElementById('sidebar').classList.toggle('open');
    });
  </script>
</body>

</html>