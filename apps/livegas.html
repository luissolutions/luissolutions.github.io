<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Gas Tracker</title>

    <link rel="stylesheet" href="../assets/css/app-styles.css" id="stylesheet" />
    <script type="module" src="./assets/js/login.js" defer></script>

    <style>
        .cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .col-notes textarea {
            min-height: 60px;
        }
    </style>
</head>

<body>
    <header>
        <h1>⛽ Gas Tracker (Finance)</h1>

        <section id="login-section">
            <form id="login-form">
                <label for="username">Email</label>
                <input type="email" id="username" required>
                <label for="password">Password</label>
                <input type="password" id="password" required>
                <button type="submit">Sign in</button>
            </form>
            <button id="logout" style="display:none;">Logout</button>
        </section>
    </header>

    <main>
        <!-- Controls -->
        <section class="panel">
            <div class="row">
                <div class="tight">
                    <label for="yearSelect">Year</label>
                    <select id="yearSelect"></select>
                </div>

                <div class="grow">
                    <label for="vehicleFilter">Vehicle Filter</label>
                    <select id="vehicleFilter">
                        <option value="">All vehicles</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Summary -->
        <section class="panel">
            <div class="cards">
                <div class="card">
                    <div class="k">Total Fill-ups</div>
                    <div class="v" id="sumFillups">0</div>
                </div>
                <div class="card">
                    <div class="k">Total Spend</div>
                    <div class="v" id="sumSpend">$0.00</div>
                </div>
                <div class="card">
                    <div class="k">Total Volume</div>
                    <div class="v" id="sumVolume">0</div>
                </div>
                <div class="card">
                    <div class="k">Avg $ / Unit</div>
                    <div class="v" id="sumAvgCpu">$0.00</div>
                </div>
                <div class="card">
                    <div class="k">Avg MPG</div>
                    <div class="v" id="sumAvgMpg">—</div>
                </div>
            </div>
        </section>

        <!-- Add Entry -->
        <section class="panel">
            <h2>Add Gas Entry</h2>
            <form id="addForm">
                <div class="row">
                    <div class="grow">
                        <label for="addVehicle">Vehicle</label>
                        <input id="addVehicle" type="text" required />
                    </div>

                    <div class="tight">
                        <label for="addDate">Date</label>
                        <input id="addDate" type="date" required />
                    </div>

                    <div class="tight">
                        <label for="addOdo">Odometer</label>
                        <input id="addOdo" type="number" min="0" step="1" required />
                    </div>

                    <div class="tight">
                        <label for="addVol">Volume</label>
                        <input id="addVol" type="number" min="0" step="0.001" required />
                    </div>

                    <div class="tight">
                        <label for="addUnit">Unit</label>
                        <select id="addUnit" required>
                            <option value="gal">Gallons</option>
                            <option value="L">Liters</option>
                        </select>
                    </div>

                    <div class="tight">
                        <label for="addCpu">$ / Unit</label>
                        <input id="addCpu" type="number" min="0" step="0.001" required />
                    </div>

                    <div class="grow">
                        <label for="addLocation">Location</label>
                        <input id="addLocation" type="text" />
                    </div>

                    <div class="grow col-notes">
                        <label for="addNotes">Notes</label>
                        <input id="addNotes" type="text" placeholder="optional" />
                    </div>

                    <div class="tight">
                        <label for="addImage">Receipt/Image</label>
                        <input id="addImage" type="file" accept="image/*" />
                    </div>

                    <div class="tight">
                        <label>&nbsp;</label>
                        <button type="submit">Add</button>
                    </div>
                </div>

                <div class="small" id="addHint"></div>
            </form>
        </section>

        <!-- Table -->
        <section class="panel">
            <h2>Entries</h2>

            <div class="toggles">
                <span class="small">Columns:</span>
                <label><input type="checkbox" class="col-toggle" data-col="col-location" checked> Location</label>
                <label><input type="checkbox" class="col-toggle" data-col="col-notes" checked> Notes</label>
                <label><input type="checkbox" class="col-toggle" data-col="col-image" checked> Image</label>
            </div>

            <div class="table">
                <table id="gasTable">
                    <thead>
                        <tr>
                            <th>Vehicle</th>
                            <th>Date</th>
                            <th>Odometer</th>
                            <th>Volume</th>
                            <th>Unit</th>
                            <th>$ / Unit</th>
                            <th>Total</th>
                            <th class="col-location">Location</th>
                            <th>MPG</th>
                            <th class="col-notes">Notes</th>
                            <th class="col-image">Image</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="small" id="countLabel" style="margin-top:8px;"></div>

            <div class="tight" style="margin-top:10px;">
                <button id="exportGasCsv" type="button">Export Gas CSV</button>
            </div>
        </section>
    </main>

    <script type="module">
        import {
            auth, onAuthStateChanged,
            database, ref, onValue, set,
            storage, storageRef, uploadBytes, getDownloadURL, deleteObject
        } from "../assets/js/firebase-init.js";

        /* =========================
           Constants
        ========================== */
        const TX_NODE = "ledgerTx";            // same as Finance Ledger
        const GAS_TAG = "⛽";
        const YEAR_KEY = "gasTracker.selectedYear.v1";
        const VEHICLE_KEY = "gasTracker.selectedVehicle.v1";
        const COL_KEY = "gasTracker.columnToggles.v1";

        /* =========================
           State
        ========================== */
        let DATABASE_BASE_PATH = "public";
        let currentYear = new Date().getUTCFullYear();
        let currentVehicle = "";
        let _allTx = [];        // all ledgerTx across years
        let _gasTx = [];        // all gas tx (filtered from _allTx)
        let _unsub = null;
        let _handlersBound = false;

        /* =========================
           Helpers (dates, formatting)
        ========================== */
        function pad2(n) { return String(n).padStart(2, "0"); }

        function ymdFromUtcTS(ts) {
            const dt = new Date(Number(ts));
            if (Number.isNaN(dt.getTime())) return "";
            return `${dt.getUTCFullYear()}-${pad2(dt.getUTCMonth() + 1)}-${pad2(dt.getUTCDate())}`;
        }

        function utcNoonTSFromYMD(ymd) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return Date.now();
            const y = +ymd.slice(0, 4);
            const m = +ymd.slice(5, 7) - 1;
            const d = +ymd.slice(8, 10);
            return Date.UTC(y, m, d, 12, 0, 0);
        }

        function yearFromTS(ts) { return new Date(Number(ts)).getUTCFullYear(); }

        function fmtUSD(n) {
            return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" })
                .format(Number(n) || 0);
        }

        function safeJsonParse(s) {
            try {
                const v = JSON.parse(String(s || ""));
                return (v && typeof v === "object") ? v : null;
            } catch {
                return null;
            }
        }

        function slugifyFilename(s) {
            return String(s || "")
                .normalize("NFKD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9]+/g, "_")
                .replace(/^_+|_+$/g, "")
                .slice(0, 60) || "item";
        }

        // prefer stored total; otherwise compute from volume & costPerUnit
        function getTotal(t, meta) {
            const stored = Number(t?.amt);
            if (Number.isFinite(stored) && stored > 0) return stored;

            const vol = Number(meta?.volume);
            const cpu = Number(meta?.costPerUnit);
            if (Number.isFinite(vol) && Number.isFinite(cpu)) return vol * cpu;

            return 0;
        }

        /* =========================
           Paths
        ========================== */
        function ledgerBasePath() { return `${DATABASE_BASE_PATH}/${TX_NODE}`; }
        function txYearPath(year) { return `${ledgerBasePath()}/${year}`; }
        function txItemPath(year, id) { return `${txYearPath(year)}/${id}`; }
        function imgBasePath() { return `${DATABASE_BASE_PATH}/images`; }

        /* =========================
           Normalize ledger tx -> local
        ========================== */
        function normalizeTx(id, v) {
            if (!v || typeof v !== "object") return null;
            const dateTS = Number(v.date);
            if (!Number.isFinite(dateTS)) return null;

            const type = String(v.type || "").toLowerCase();
            const normType = (type === "income") ? "income" : "expense";

            const tags = Array.isArray(v.tags) ? v.tags.map(t => String(t).trim()).filter(Boolean) : [];

            const img = (typeof v.img === "string") ? v.img : (v.img?.url || "");
            const imgPath = (typeof v.imgPath === "string") ? v.imgPath : (v.img?.path || "");

            return {
                id: String(id),
                amt: Number(v.amt ?? 0),
                name: String(v.name ?? ""),
                type: normType,
                date: dateTS,
                tags,
                img: String(img || ""),
                imgPath: String(imgPath || ""),
                desc: String(v.desc ?? "")
            };
        }

        function stripTxForSave(t) {
            return {
                amt: Number(t.amt ?? 0),
                name: String(t.name ?? ""),
                type: (String(t.type || "").toLowerCase() === "income") ? "income" : "expense",
                date: Number(t.date ?? Date.now()),
                tags: Array.isArray(t.tags) ? t.tags : [],
                img: String(t.img ?? ""),
                imgPath: String(t.imgPath ?? ""),
                desc: String(t.desc ?? "")
            };
        }

        /* =========================
           GAS meta model in tx.desc
        ========================== */
        function isGasTx(t) {
            return (t.type === "expense") && Array.isArray(t.tags) && t.tags.includes(GAS_TAG);
        }

        function gasMetaFromTx(t) {
            const meta = safeJsonParse(t.desc) || {};
            return {
                vehicle: String(meta.vehicle ?? ""),
                odometer: Number(meta.odometer ?? NaN),
                volume: Number(meta.volume ?? NaN),
                volumeUnit: String(meta.volumeUnit ?? "gal"),
                costPerUnit: Number(meta.costPerUnit ?? NaN),
                location: String(meta.location ?? ""),
                notes: String(meta.notes ?? "")
            };
        }

        function txFromGasMeta(prevTx, meta) {
            const dateTS = Number(prevTx?.date ?? Date.now());
            const vehicle = String(meta.vehicle || "").trim();
            const name = vehicle ? `⛽ ${vehicle}` : "⛽ Gas";

            return {
                ...(prevTx || {}),
                type: "expense",
                date: dateTS,

                // if vol/cpu are valid, use them; otherwise keep stored amt
                amt: (() => {
                    const vol = Number(meta.volume);
                    const cpu = Number(meta.costPerUnit);
                    if (Number.isFinite(vol) && Number.isFinite(cpu)) return vol * cpu;
                    return Number(prevTx?.amt ?? 0) || 0;
                })(),

                // ✅ ONLY ONE TAG
                tags: [GAS_TAG],

                name,
                desc: JSON.stringify({
                    vehicle,
                    odometer: Number(meta.odometer || 0),
                    volume: Number(meta.volume || 0),
                    volumeUnit: String(meta.volumeUnit || "gal"),
                    costPerUnit: Number(meta.costPerUnit || 0),
                    location: String(meta.location || ""),
                    notes: String(meta.notes || "")
                })
            };
        }

        /* =========================
           DB ops (year-aware)
        ========================== */
        async function upsertTx(prevTx, nextTx) {
            const next = stripTxForSave(nextTx);
            const nextYear = yearFromTS(next.date);

            if (prevTx) {
                const prevYear = yearFromTS(prevTx.date);
                if (prevYear !== nextYear) {
                    await set(ref(database, txItemPath(prevYear, prevTx.id)), null);
                }
            }

            await set(ref(database, txItemPath(nextYear, nextTx.id)), next);
        }

        async function deleteTxFull(tx) {
            const y = yearFromTS(tx.date);
            await set(ref(database, txItemPath(y, tx.id)), null);

            if (tx.imgPath) {
                try { await deleteObject(storageRef(storage, tx.imgPath)); }
                catch (e) { console.warn("Storage delete failed:", e); }
            }
        }

        /* =========================
           Image handling
        ========================== */
        async function fileToJpegMaxWidth(file, maxW = 2048, quality = 0.9) {
            if (!file?.type?.startsWith("image/")) {
                return { blob: file, contentType: file?.type || "application/octet-stream", didResize: false };
            }

            const bmp = await createImageBitmap(file);
            if (bmp.width <= maxW) {
                bmp.close?.();
                return { blob: file, contentType: file.type || "image/*", didResize: false };
            }

            const scale = maxW / bmp.width;
            const w = Math.round(bmp.width * scale);
            const h = Math.round(bmp.height * scale);

            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(bmp, 0, 0, w, h);
            bmp.close?.();

            const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", quality));
            return { blob, contentType: "image/jpeg", didResize: true };
        }

        async function saveItemWithImage(tx, url, path) {
            await upsertTx(tx, { ...tx, img: url, imgPath: path });
        }

        async function uploadImage(tx) {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.style.display = "none";
            document.body.appendChild(input);

            input.addEventListener("change", async () => {
                const file = input.files?.[0];
                input.remove();
                if (!file) return;

                try {
                    const { blob, contentType } = await fileToJpegMaxWidth(file, 2048, 0.9);

                    const meta = gasMetaFromTx(tx);
                    const vehiclePart = slugifyFilename(meta.vehicle || "vehicle");
                    const ymd = ymdFromUtcTS(tx.date || Date.now());
                    const y = yearFromTS(tx.date || Date.now());

                    const storagePath = `${imgBasePath()}/${y}/gas_${vehiclePart}_${ymd}_${Date.now()}.jpg`;

                    if (tx.imgPath) {
                        try { await deleteObject(storageRef(storage, tx.imgPath)); }
                        catch (e) { console.warn("Old image delete failed (continuing):", e); }
                    }

                    const sref = storageRef(storage, storagePath);
                    await uploadBytes(sref, blob, { contentType: contentType || "image/jpeg" });
                    const url = await getDownloadURL(sref);

                    await saveItemWithImage(tx, url, storagePath);
                } catch (err) {
                    console.error(err);
                    alert("❌ Image upload failed.");
                }
            });

            input.click();
        }

        async function deleteImage(tx) {
            if (!confirm("Delete this image? (Clears fields and deletes file if possible)")) return;

            try {
                if (tx.imgPath) await deleteObject(storageRef(storage, tx.imgPath));
            } catch (e) {
                console.warn("Storage delete failed (still clearing):", e);
            }

            await upsertTx(tx, { ...tx, img: "", imgPath: "" });
        }

        /* =========================
           Local storage
        ========================== */
        function loadSavedYear() {
            const v = parseInt(localStorage.getItem(YEAR_KEY) || "", 10);
            return Number.isFinite(v) ? v : null;
        }
        function saveYear(y) { try { localStorage.setItem(YEAR_KEY, String(y)); } catch { } }

        function loadSavedVehicle() { return localStorage.getItem(VEHICLE_KEY) || ""; }
        function saveVehicle(v) { try { localStorage.setItem(VEHICLE_KEY, v || ""); } catch { } }

        function loadCols() {
            try {
                const v = JSON.parse(localStorage.getItem(COL_KEY) || "null");
                return v && typeof v === "object" ? v : null;
            } catch { return null; }
        }
        function saveCols(obj) { try { localStorage.setItem(COL_KEY, JSON.stringify(obj)); } catch { } }

        function applyColToggles() {
            const toggles = document.querySelectorAll(".col-toggle");
            toggles.forEach(cb => {
                const col = cb.dataset.col;
                document.querySelectorAll("." + col).forEach(el => {
                    el.style.display = cb.checked ? "" : "none";
                });
            });
        }

        function initColToggles() {
            const saved = loadCols();
            const toggles = document.querySelectorAll(".col-toggle");
            toggles.forEach(cb => {
                if (saved && cb.dataset.col in saved) cb.checked = !!saved[cb.dataset.col];
                cb.addEventListener("change", () => {
                    const out = {};
                    document.querySelectorAll(".col-toggle").forEach(x => out[x.dataset.col] = !!x.checked);
                    saveCols(out);
                    applyColToggles();
                });
            });
            applyColToggles();
        }

        /* =========================
           Derived lists for current filters
        ========================== */
        function gasInYear(y) { return _gasTx.filter(t => yearFromTS(t.date) === y); }

        function gasFiltered() {
            let list = gasInYear(currentYear);
            if (currentVehicle) list = list.filter(t => (gasMetaFromTx(t).vehicle || "") === currentVehicle);
            list.sort((a, b) => Number(a.date) - Number(b.date) || a.id.localeCompare(b.id));
            return list;
        }

        function uniqueVehiclesForYear(y) {
            const set = new Set();
            for (const t of gasInYear(y)) {
                const v = (gasMetaFromTx(t).vehicle || "").trim();
                if (v) set.add(v);
            }
            return Array.from(set).sort((a, b) => a.localeCompare(b));
        }

        /* =========================
           Rendering
        ========================== */
        function populateYearDropdown() {
            const sel = document.getElementById("yearSelect");
            if (!sel) return;

            const years = new Set(_gasTx.map(t => yearFromTS(t.date)));
            years.add(new Date().getUTCFullYear());

            const arr = Array.from(years).filter(Number.isFinite).sort((a, b) => a - b);

            const saved = loadSavedYear();
            if (saved && arr.includes(saved)) currentYear = saved;

            sel.innerHTML = arr.map(y => `<option value="${y}" ${y === currentYear ? "selected" : ""}>${y}</option>`).join("");
        }

        function populateVehicleDropdown() {
            const sel = document.getElementById("vehicleFilter");
            if (!sel) return;

            const saved = loadSavedVehicle();
            const vehicles = uniqueVehiclesForYear(currentYear);

            sel.innerHTML = [
                `<option value="">All vehicles</option>`,
                ...vehicles.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`)
            ].join("");

            if (saved && vehicles.includes(saved)) currentVehicle = saved;
            else currentVehicle = "";

            sel.value = currentVehicle;
        }

        function renderSummary() {
            const list = gasFiltered();

            const fillups = list.length;

            let spend = 0;
            let vol = 0;
            let cpuWeightedTotal = 0;
            let mpgSum = 0;
            let mpgCount = 0;

            const byVehicle = new Map();

            for (const t of list) {
                const m = gasMetaFromTx(t);
                spend += Math.abs(getTotal(t, m));

                if (Number.isFinite(Number(m.volume))) {
                    vol += Number(m.volume);
                    cpuWeightedTotal += (Number(m.volume) * (Number(m.costPerUnit) || 0));
                }

                const v = (m.vehicle || "").trim();
                if (!v) continue;

                if (!byVehicle.has(v)) byVehicle.set(v, []);
                byVehicle.get(v).push({ tx: t, meta: m });
            }

            for (const [veh, arr] of byVehicle.entries()) {
                arr.sort((a, b) => Number(a.tx.date) - Number(b.tx.date));
                for (let i = 1; i < arr.length; i++) {
                    const cur = arr[i].meta;
                    const prev = arr[i - 1].meta;

                    const odoCur = Number(cur.odometer);
                    const odoPrev = Number(prev.odometer);
                    const volCur = Number(cur.volume);

                    if (!Number.isFinite(odoCur) || !Number.isFinite(odoPrev) || !Number.isFinite(volCur) || volCur <= 0) continue;

                    const dist = Math.abs(odoCur - odoPrev);
                    const mpg = dist / volCur;
                    if (Number.isFinite(mpg) && mpg > 0 && mpg < 200) {
                        mpgSum += mpg;
                        mpgCount++;
                    }
                }
            }

            const avgCpu = vol > 0 ? (cpuWeightedTotal / vol) : 0;
            const avgMpg = mpgCount ? (mpgSum / mpgCount) : null;

            document.getElementById("sumFillups").textContent = String(fillups);
            document.getElementById("sumSpend").textContent = fmtUSD(spend);
            document.getElementById("sumVolume").textContent = (vol ? vol.toFixed(3) : "0");
            document.getElementById("sumAvgCpu").textContent = fmtUSD(avgCpu);
            document.getElementById("sumAvgMpg").textContent = (avgMpg ? avgMpg.toFixed(2) : "—");
        }

        function renderTable() {
            const tbody = document.querySelector("#gasTable tbody");
            if (!tbody) return;
            tbody.innerHTML = "";

            const list = gasFiltered();
            document.getElementById("countLabel").textContent =
                `${list.length} entr${list.length === 1 ? "y" : "ies"} shown for ${currentYear}` +
                (currentVehicle ? ` • Vehicle: ${currentVehicle}` : "");

            const prevByVehicle = new Map();

            for (const t of list) {
                const meta = gasMetaFromTx(t);
                const tr = document.createElement("tr");

                // Vehicle
                const tdVeh = document.createElement("td");
                const inpVeh = document.createElement("input");
                inpVeh.type = "text";
                inpVeh.value = meta.vehicle || "";
                wireInputCommit(inpVeh, meta.vehicle || "", async (next) => {
                    const nextMeta = { ...meta, vehicle: next };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdVeh.appendChild(inpVeh);

                // Date
                const tdDate = document.createElement("td");
                const inpDate = document.createElement("input");
                inpDate.type = "date";
                inpDate.value = ymdFromUtcTS(t.date);
                inpDate.addEventListener("change", async (e) => {
                    const ymd = e.target.value;
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) {
                        e.target.value = ymdFromUtcTS(t.date);
                        return;
                    }
                    const nextTS = utcNoonTSFromYMD(ymd);
                    await upsertTx(t, { ...t, date: nextTS });
                });
                tdDate.appendChild(inpDate);

                // Odometer
                const tdOdo = document.createElement("td");
                const inpOdo = document.createElement("input");
                inpOdo.type = "number";
                inpOdo.step = "1";
                inpOdo.min = "0";
                inpOdo.value = Number.isFinite(meta.odometer) ? String(meta.odometer) : "";
                wireNumberCommit(inpOdo, meta.odometer, async (nextNum) => {
                    const nextMeta = { ...meta, odometer: nextNum };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdOdo.appendChild(inpOdo);

                // Volume
                const tdVol = document.createElement("td");
                const inpVol = document.createElement("input");
                inpVol.type = "number";
                inpVol.step = "0.001";
                inpVol.min = "0";
                inpVol.value = Number.isFinite(meta.volume) ? String(meta.volume) : "";
                wireNumberCommit(inpVol, meta.volume, async (nextNum) => {
                    const nextMeta = { ...meta, volume: nextNum };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdVol.appendChild(inpVol);

                // Unit
                const tdUnit = document.createElement("td");
                const selUnit = document.createElement("select");
                selUnit.innerHTML = `
          <option value="gal">Gallons</option>
          <option value="L">Liters</option>
        `;
                selUnit.value = (meta.volumeUnit === "L") ? "L" : "gal";
                selUnit.addEventListener("change", async (e) => {
                    const nextMeta = { ...meta, volumeUnit: e.target.value };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdUnit.appendChild(selUnit);

                // $/Unit
                const tdCpu = document.createElement("td");
                const inpCpu = document.createElement("input");
                inpCpu.type = "number";
                inpCpu.step = "0.001";
                inpCpu.min = "0";
                inpCpu.value = Number.isFinite(meta.costPerUnit) ? String(meta.costPerUnit) : "";
                wireNumberCommit(inpCpu, meta.costPerUnit, async (nextNum) => {
                    const nextMeta = { ...meta, costPerUnit: nextNum };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdCpu.appendChild(inpCpu);

                // Total (prefer stored; else compute)
                const tdTotal = document.createElement("td");
                const total = getTotal(t, meta);
                tdTotal.textContent = total.toFixed(2);

                // Location
                const tdLoc = document.createElement("td");
                tdLoc.className = "col-location";
                const inpLoc = document.createElement("input");
                inpLoc.type = "text";
                inpLoc.value = meta.location || "";
                wireInputCommit(inpLoc, meta.location || "", async (next) => {
                    const nextMeta = { ...meta, location: next };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdLoc.appendChild(inpLoc);

                // MPG
                const tdMpg = document.createElement("td");
                const vehKey = (meta.vehicle || "").trim();
                let mpgText = "N/A";
                if (vehKey && prevByVehicle.has(vehKey)) {
                    const prev = prevByVehicle.get(vehKey);
                    const odoCur = Number(meta.odometer);
                    const odoPrev = Number(prev.odometer);
                    const volCur = Number(meta.volume);

                    if (Number.isFinite(odoCur) && Number.isFinite(odoPrev) && Number.isFinite(volCur) && volCur > 0) {
                        const dist = Math.abs(odoCur - odoPrev);
                        const mpg = dist / volCur;
                        mpgText = (Number.isFinite(mpg) && mpg > 0 && mpg < 200) ? mpg.toFixed(2) : "N/A";
                    }
                }
                tdMpg.textContent = mpgText;
                if (vehKey) prevByVehicle.set(vehKey, meta);

                // Notes
                const tdNotes = document.createElement("td");
                tdNotes.className = "col-notes";
                const inpNotes = document.createElement("textarea");
                inpNotes.value = meta.notes || "";
                wireTextareaCommit(inpNotes, meta.notes || "", async (next) => {
                    const nextMeta = { ...meta, notes: next };
                    const nextTx = txFromGasMeta(t, nextMeta);
                    await upsertTx(t, nextTx);
                });
                tdNotes.appendChild(inpNotes);

                // Image
                const tdImg = document.createElement("td");
                tdImg.className = "col-image";
                if (t.img) {
                    const img = document.createElement("img");
                    img.className = "thumbnail";
                    img.src = t.img;
                    img.alt = "Gas image";
                    img.style.cursor = "pointer";
                    img.addEventListener("click", () => {
                        const sep = t.img.includes("?") ? "&" : "?";
                        window.open(`${t.img}${sep}t=${Date.now()}`, "_blank", "noopener");
                    });
                    tdImg.appendChild(img);
                } else {
                    tdImg.innerHTML = `<span class="small">No image</span>`;
                }

                // Actions
                const tdAct = document.createElement("td");
                const row = document.createElement("div");
                row.className = "btnrow";

                const btnUp = document.createElement("button");
                btnUp.type = "button";
                btnUp.textContent = t.img ? "Replace Img" : "Add Img";
                btnUp.addEventListener("click", () => uploadImage(t));
                row.appendChild(btnUp);

                // ONLY show delete image if an image exists
                if (t.img || t.imgPath) {
                    const btnDelImg = document.createElement("button");
                    btnDelImg.type = "button";
                    btnDelImg.textContent = "Del Img";
                    btnDelImg.className = "clear-button";
                    btnDelImg.addEventListener("click", () => deleteImage(t));
                    row.appendChild(btnDelImg);
                }

                const btnDel = document.createElement("button");
                btnDel.type = "button";
                btnDel.textContent = "Delete";
                btnDel.className = "clear-button";
                btnDel.addEventListener("click", async () => {
                    if (!confirm("Delete this gas entry?")) return;
                    await deleteTxFull(t);
                });

                row.appendChild(btnDel);
                tdAct.appendChild(row);

                tr.append(tdVeh, tdDate, tdOdo, tdVol, tdUnit, tdCpu, tdTotal, tdLoc, tdMpg, tdNotes, tdImg, tdAct);
                tbody.appendChild(tr);
            }

            applyColToggles();
        }

        function renderAll() {
            _gasTx = _allTx.filter(isGasTx);
            populateYearDropdown();
            populateVehicleDropdown();
            renderSummary();
            renderTable();
            fillAddFormHints();
        }

        /* =========================
           Editable wiring (blur-first, Enter commits, Esc cancels)
        ========================== */
        function wireInputCommit(inputEl, originalValue, onCommit) {
            inputEl.dataset.original = String(originalValue ?? "");

            inputEl.addEventListener("focus", (e) => {
                e.target.dataset.original = e.target.value;
            });

            inputEl.addEventListener("keydown", (e) => {
                if (e.key === "Enter") { e.preventDefault(); e.target.blur(); }
                if (e.key === "Escape") {
                    e.preventDefault();
                    e.target.value = e.target.dataset.original ?? "";
                    e.target.blur();
                }
            });

            inputEl.addEventListener("blur", async (e) => {
                const next = String(e.target.value ?? "").trim();
                const prev = String(e.target.dataset.original ?? "").trim();
                if (next === prev) return;
                await onCommit(next);
            });
        }

        function wireTextareaCommit(textareaEl, originalValue, onCommit) {
            textareaEl.dataset.original = String(originalValue ?? "");

            textareaEl.addEventListener("focus", (e) => {
                e.target.dataset.original = e.target.value;
            });

            textareaEl.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    e.target.blur();
                }
                if (e.key === "Escape") {
                    e.preventDefault();
                    e.target.value = e.target.dataset.original ?? "";
                    e.target.blur();
                }
            });

            textareaEl.addEventListener("blur", async (e) => {
                const next = String(e.target.value ?? "").trim();
                const prev = String(e.target.dataset.original ?? "").trim();
                if (next === prev) return;
                await onCommit(next);
            });
        }

        function wireNumberCommit(inputEl, originalValue, onCommit) {
            inputEl.dataset.original = String(Number.isFinite(Number(originalValue)) ? Number(originalValue) : "");

            inputEl.addEventListener("focus", (e) => {
                e.target.dataset.original = e.target.value;
            });

            inputEl.addEventListener("keydown", (e) => {
                if (e.key === "Enter") { e.preventDefault(); e.target.blur(); }
                if (e.key === "Escape") {
                    e.preventDefault();
                    e.target.value = e.target.dataset.original ?? "";
                    e.target.blur();
                }
            });

            inputEl.addEventListener("blur", async (e) => {
                const raw = String(e.target.value ?? "").trim();
                const prevRaw = String(e.target.dataset.original ?? "").trim();

                if (raw === prevRaw) return;

                const v = raw === "" ? NaN : parseFloat(raw);
                if (raw !== "" && Number.isNaN(v)) {
                    e.target.value = prevRaw;
                    return;
                }

                await onCommit(raw === "" ? NaN : v);
            });
        }

        /* =========================
           Add entry
        ========================== */
        function fillAddFormHints() {
            const hint = document.getElementById("addHint");
            if (!hint) return;

            const vehs = uniqueVehiclesForYear(currentYear);
            hint.textContent = vehs.length
                ? `Tip: vehicles seen this year: ${vehs.slice(0, 8).join(", ")}${vehs.length > 8 ? "…" : ""}`
                : `Tip: first time? Put a vehicle name like "RAM 1500" then add ⛽ entries.`;
        }

        async function handleAdd(e) {
            e.preventDefault();

            const vehicle = document.getElementById("addVehicle").value.trim();
            const dateYMD = document.getElementById("addDate").value;
            const odometer = parseFloat(document.getElementById("addOdo").value);
            const volume = parseFloat(document.getElementById("addVol").value);
            const unit = document.getElementById("addUnit").value;
            const cpu = parseFloat(document.getElementById("addCpu").value);
            const location = document.getElementById("addLocation").value.trim();
            const notes = document.getElementById("addNotes").value.trim();
            const imageFile = document.getElementById("addImage").files?.[0] || null;

            if (!vehicle) { alert("Vehicle is required."); return; }
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateYMD)) { alert("Date is required."); return; }
            if (!Number.isFinite(odometer)) { alert("Odometer is required."); return; }
            if (!Number.isFinite(volume) || volume <= 0) { alert("Volume must be > 0."); return; }
            if (!Number.isFinite(cpu) || cpu <= 0) { alert("$ / Unit must be > 0."); return; }

            const id = String(Date.now());
            const dateTS = utcNoonTSFromYMD(dateYMD);
            const year = yearFromTS(dateTS);

            const baseTx = {
                id,
                date: dateTS,
                type: "expense",
                amt: Math.abs(volume * cpu),
                name: `⛽ ${vehicle}`,
                tags: [GAS_TAG],
                img: "",
                imgPath: "",
                desc: ""
            };

            const meta = {
                vehicle,
                odometer,
                volume,
                volumeUnit: unit,
                costPerUnit: cpu,
                location,
                notes
            };

            let tx = txFromGasMeta(baseTx, meta);

            if (imageFile) {
                try {
                    const { blob, contentType } = await fileToJpegMaxWidth(imageFile, 2048, 0.9);
                    const vehiclePart = slugifyFilename(vehicle);
                    const storagePath = `${imgBasePath()}/${year}/gas_${vehiclePart}_${dateYMD}_${Date.now()}.jpg`;
                    const sref = storageRef(storage, storagePath);
                    await uploadBytes(sref, blob, { contentType: contentType || "image/jpeg" });
                    const url = await getDownloadURL(sref);
                    tx = { ...tx, img: url, imgPath: storagePath };
                } catch (err) {
                    console.error(err);
                    alert("Image upload failed (entry will still be saved).");
                }
            }

            await set(ref(database, txItemPath(year, id)), stripTxForSave(tx));

            document.getElementById("addOdo").value = "";
            document.getElementById("addVol").value = "";
            document.getElementById("addCpu").value = "";
            document.getElementById("addLocation").value = "";
            document.getElementById("addNotes").value = "";
            document.getElementById("addImage").value = "";
        }

        /* =========================
           CSV export
        ========================== */
        function csvEscape(v) {
            const s = String(v ?? "");
            return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
        }

        function downloadCSV(filename, rows) {
            const csv = rows.map(r => r.map(csvEscape).join(",")).join("\r\n");
            const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportGasCSV() {
            const list = gasFiltered();
            const prevByVehicle = new Map();

            const rows = [[
                "Date", "Vehicle", "Odometer", "Volume", "Unit", "CostPerUnit", "Total", "MPG", "Location", "Notes", "TxID", "ImgURL"
            ]];

            for (const t of list) {
                const m = gasMetaFromTx(t);
                const total = Math.abs(getTotal(t, m));

                let mpg = "";
                const vehKey = (m.vehicle || "").trim();
                if (vehKey && prevByVehicle.has(vehKey)) {
                    const prev = prevByVehicle.get(vehKey);
                    const odoCur = Number(m.odometer);
                    const odoPrev = Number(prev.odometer);
                    const volCur = Number(m.volume);
                    if (Number.isFinite(odoCur) && Number.isFinite(odoPrev) && Number.isFinite(volCur) && volCur > 0) {
                        const dist = Math.abs(odoCur - odoPrev);
                        const v = dist / volCur;
                        mpg = (Number.isFinite(v) && v > 0 && v < 200) ? v.toFixed(2) : "";
                    }
                }
                if (vehKey) prevByVehicle.set(vehKey, m);

                rows.push([
                    ymdFromUtcTS(t.date),
                    m.vehicle || "",
                    Number.isFinite(m.odometer) ? m.odometer : "",
                    Number.isFinite(m.volume) ? m.volume : "",
                    m.volumeUnit || "",
                    Number.isFinite(m.costPerUnit) ? m.costPerUnit : "",
                    total.toFixed(2),
                    mpg,
                    m.location || "",
                    m.notes || "",
                    t.id,
                    t.img || ""
                ]);
            }

            if (rows.length === 1) {
                alert("No gas entries for the current filters.");
                return;
            }

            const vehPart = currentVehicle ? `_${slugifyFilename(currentVehicle)}` : "";
            downloadCSV(`gas_${currentYear}${vehPart}.csv`, rows);
        }

        /* =========================
           HTML escape
        ========================== */
        function escapeHtml(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        /* =========================
           Events wiring
        ========================== */
        function bindOnce() {
            if (_handlersBound) return;
            _handlersBound = true;

            initColToggles();

            document.getElementById("yearSelect")?.addEventListener("change", () => {
                currentYear = parseInt(document.getElementById("yearSelect").value, 10) || currentYear;
                saveYear(currentYear);
                currentVehicle = "";
                saveVehicle("");
                renderAll();
            });

            document.getElementById("vehicleFilter")?.addEventListener("change", () => {
                currentVehicle = document.getElementById("vehicleFilter").value || "";
                saveVehicle(currentVehicle);
                renderSummary();
                renderTable();
            });

            document.getElementById("addForm")?.addEventListener("submit", handleAdd);
            document.getElementById("exportGasCsv")?.addEventListener("click", exportGasCSV);
        }

        /* =========================
           Listener
        ========================== */
        function attachListener() {
            if (typeof _unsub === "function") { _unsub(); _unsub = null; }

            const r = ref(database, ledgerBasePath());
            _unsub = onValue(r, (snap) => {
                const root = snap.exists() ? snap.val() : {};
                const out = [];

                for (const [, yearObj] of Object.entries(root || {})) {
                    if (!yearObj || typeof yearObj !== "object") continue;
                    for (const [id, v] of Object.entries(yearObj || {})) {
                        const n = normalizeTx(id, v);
                        if (n) out.push(n);
                    }
                }

                _allTx = out;

                const savedY = loadSavedYear();
                if (savedY) currentYear = savedY;
                const savedV = loadSavedVehicle();
                if (savedV) currentVehicle = savedV;

                renderAll();
            }, (err) => console.error("❌ ledger onValue error:", err));
        }

        /* =========================
           Auth -> base path
        ========================== */
        onAuthStateChanged(auth, (user) => {
            DATABASE_BASE_PATH = user ? `${user.uid}` : "public";

            const savedY = loadSavedYear();
            if (savedY) currentYear = savedY;

            const savedV = loadSavedVehicle();
            if (savedV) currentVehicle = savedV;

            bindOnce();
            attachListener();
        });

        /* =========================
           Default add date
        ========================== */
        document.addEventListener("DOMContentLoaded", () => {
            const d = new Date();
            const ymd = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
            const addDate = document.getElementById("addDate");
            if (addDate && !addDate.value) addDate.value = ymd;
        });
    </script>
</body>

</html>