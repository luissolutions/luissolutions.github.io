<!DOCTYPE html>
<html lang="en">

<head>
    <title>Live Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="../assets/css/app-styles.css" id="stylesheet">
</head>

<body>
    <header>
        <h1>Notes</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <br>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <br>
                <button type="submit">Login</button>
            </form>
        </section>
        <button id="logout" style="display: none;">Logout</button>
    </header>

    <main>
        <section id="main-window">
            <form class="notes">
                <label for="input-name">Name</label>
                <input required type="text" id="input-name" name="input-name" placeholder="Name">
                <label for="notes">Notes</label>
                <textarea name="notes" id="notes" cols="30" rows="10"></textarea>
            </form>
            <button id="copy-btn">ğŸ“°</button>
            <button id="paste-btn">ğŸ“‹</button>
            <button id="save-btn">ğŸ’¾</button>
            <button class="clear-button" id="delete-btn">âŒ</button>
            <button id="undo-btn">â†©ï¸</button>
            <label for="autosave-checkbox">Auto-ğŸ’¾:</label>
            <input type="checkbox" id="autosave-checkbox" checked>
            <section id="note-list"></section>
            <button class="clear-button" id="clear-btn">Clear</button>
        </section>
    </main>

    <script type="module">
        import { database, ref, onValue, set, get, push, remove, auth, initializeAuth  } from '../assets/js/firebase-init.js';

        class LiveNotesApp {
            constructor() {
                this.nameInput = document.getElementById('input-name');
                this.notesTextarea = document.getElementById('notes');
                this.noteList = document.getElementById('note-list');
                this.deletedNotes = [];
                this.autoSaveInterval = null;
                this.dbRef = null;
                this.notesData = [];
                this.isAuthenticated = false;

                this.setupEventListeners();
                initializeAuth(this);
                this.loadLocalData();
                this.startAutoSave();
            }

            initializeFirebase() {
                const user = auth.currentUser;
                if (user) {
                    const uid = user.uid;
                    this.dbRef = ref(database, `${uid}/notesData`);
                    this.clearNoteInputs();
                    this.listenForDataChanges();
                }
            }

            listenForDataChanges() {
                if (!this.dbRef) return;
                onValue(this.dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.notesData = Object.entries(data).map(([key, value]) => ({ key, ...value }));
                    } else {
                        this.notesData = [];
                    }
                    this.populateNoteList();
                });
            }

            setupEventListeners() {
                document.getElementById('copy-btn').addEventListener('click', this.copyNote.bind(this));
                document.getElementById('paste-btn').addEventListener('click', this.pasteNote.bind(this));
                document.getElementById('save-btn').addEventListener('click', this.saveNote.bind(this));
                document.getElementById('delete-btn').addEventListener('click', this.deleteNote.bind(this));
                document.getElementById('clear-btn').addEventListener('click', this.clearNoteInputs.bind(this));
                document.getElementById('undo-btn').addEventListener('click', this.undoDelete.bind(this));
                document.getElementById('autosave-checkbox').addEventListener('change', this.toggleAutoSave.bind(this));
                document.addEventListener("keydown", this.handleKeyboardShortcuts.bind(this));
                this.notesTextarea.addEventListener('input', () => this.autoResizeTextarea('notes'));
            }

            copyNote() {
                this.notesTextarea.select();
                document.execCommand('copy');
                console.log('Copied to clipboard');
            }

            async pasteNote() {
                const clipboardData = await navigator.clipboard.readText();
                this.notesTextarea.value += clipboardData;
            }

            async saveNote() {
                const nameToSave = this.nameInput.value.trim();
                const noteToSave = this.notesTextarea.value.trim();
                const saveBtn = document.getElementById('save-btn');
                const timestamp = new Date().toISOString();

                if (nameToSave && noteToSave) {
                    const newEntry = {
                        name: nameToSave,
                        note: noteToSave,
                        timestamp
                    };

                    if (this.isAuthenticated) {
                        const newNoteRef = push(this.dbRef);
                        await set(newNoteRef, newEntry);
                    } else {
                        this.saveToLocal(nameToSave, newEntry);
                    }

                    this.updateSaveButton(saveBtn);
                    this.populateNoteList();
                    this.clearNoteInputs();
                } else {
                    console.log('Please enter both the name and note before saving');
                }
            }

            saveToLocal(key, data) {
                let offlineData = JSON.parse(localStorage.getItem('offlineNotesData')) || {};
                offlineData[key] = data;
                localStorage.setItem('offlineNotesData', JSON.stringify(offlineData));
                this.loadLocalData();
            }

            loadLocalData() {
                const offlineData = JSON.parse(localStorage.getItem('offlineNotesData')) || {};
                this.notesData = Object.entries(offlineData).map(([key, value]) => ({ key, ...value }));
                this.populateNoteList();
            }

            updateSaveButton(button) {
                button.textContent = 'Saved';
                button.style.backgroundColor = 'lightblue';
                setTimeout(() => {
                    button.textContent = 'ğŸ’¾';
                    button.style.backgroundColor = '';
                }, 2000);
            }

            async saveNote() {
                const nameToSave = this.nameInput.value.trim();
                const noteToSave = this.notesTextarea.value.trim();
                const saveBtn = document.getElementById('save-btn');
                const timestamp = new Date().toISOString();

                if (nameToSave && noteToSave) {
                    const newEntry = {
                        name: nameToSave,
                        note: noteToSave,
                        timestamp
                    };

                    if (this.isAuthenticated) {
                        const newNoteRef = push(this.dbRef);
                        await set(newNoteRef, newEntry);
                    } else {
                        this.saveToLocal(nameToSave, newEntry);
                    }

                    this.updateSaveButton(saveBtn);
                    this.populateNoteList();
                    this.clearNoteInputs();
                } else {
                    console.log('Please enter both the name and note before saving');
                }
            }

            async deleteNote() {
                const nameToDelete = this.nameInput.value.trim();

                if (nameToDelete) {
                    const userConfirmed = confirm(`Are you sure you want to delete the note with name: ${nameToDelete}?`);
                    if (!userConfirmed) {
                        console.log('Note deletion cancelled.');
                        return;
                    }

                    const note = this.notesData.find(note => note.name === nameToDelete);
                    if (note) {
                        this.storeDeletedNote(note.name, note.note);

                        if (this.isAuthenticated) {
                            await remove(ref(this.dbRef, note.key));
                        } else {
                            this.deleteFromLocal(note.key);
                        }

                        this.clearNoteInputs();
                        this.populateNoteList();
                        console.log(`Deleted the note with name: ${nameToDelete}`);
                    } else {
                        console.log('Note not found.');
                    }
                } else {
                    console.log('Please enter the name of the note to delete.');
                }
            }

            deleteFromLocal(key) {
                let offlineData = JSON.parse(localStorage.getItem('offlineNotesData')) || {};
                delete offlineData[key];
                localStorage.setItem('offlineNotesData', JSON.stringify(offlineData));
                this.loadLocalData();
            }

            storeDeletedNote(name, note) {
                this.deletedNotes.push({ name, note });
            }

            async undoDelete() {
                if (this.deletedNotes.length > 0) {
                    const lastDeletedNote = this.deletedNotes.pop();
                    const { name, note } = lastDeletedNote;
                    const newEntry = { name, note, timestamp: new Date().toISOString() };

                    if (this.isAuthenticated) {
                        const newNoteRef = push(this.dbRef);
                        await set(newNoteRef, newEntry);
                    } else {
                        this.saveToLocal(name, newEntry);
                    }

                    this.populateNoteList();
                    console.log(`Undone the deletion of the note with name: ${name}`);
                } else {
                    console.log('No deleted notes to undo');
                }
            }

            autoResizeTextarea(id) {
                const textarea = document.getElementById(id);
                textarea.style.height = textarea.scrollHeight + 'px';
            }

            toggleAutoSave(event) {
                if (event.target.checked) {
                    this.startAutoSave();
                } else {
                    clearInterval(this.autoSaveInterval);
                }
            }

            startAutoSave() {
                this.autoSaveInterval = setInterval(() => this.saveNote(), 40000);
            }

            handleKeyboardShortcuts(event) {
                if (event.ctrlKey && event.key === "s") {
                    event.preventDefault();
                    document.getElementById("save-btn").click();
                }
            }

            populateNoteList() {
                this.noteList.innerHTML = '';

                if (this.notesData.length > 0) {
                    const sortedNotes = this.notesData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedNotes.forEach(note => this.createNoteListItem(note));
                } else {
                    this.noteList.innerHTML = '<li>No notes found</li>';
                }
            }


            clearNoteInputs() {
                this.nameInput.value = '';
                this.notesTextarea.value = '';
            }

            createNoteListItem(note) {
                const listItem = document.createElement('li');

                const nameSpan = document.createElement('span');
                nameSpan.style.fontWeight = 'bold';
                nameSpan.textContent = note.name;

                const timestampSpan = document.createElement('span');
                timestampSpan.style.fontWeight = 'normal';
                timestampSpan.style.marginLeft = '10px';
                timestampSpan.textContent = ` (${new Date(note.timestamp).toLocaleString()})`;

                listItem.appendChild(nameSpan);
                listItem.appendChild(timestampSpan);

                listItem.addEventListener('click', () => {
                    this.nameInput.value = note.name;
                    this.notesTextarea.value = note.note;
                });

                this.noteList.appendChild(listItem);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            new LiveNotesApp();
        });
    </script>
</body>

</html>