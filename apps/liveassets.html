<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Database</title>
    <link rel="stylesheet" href="../assets/css/app-styles.css" id="stylesheet">
    <script type="module" src="./assets/js/login.js" defer></script>
    <style>
        input,
        textarea {
            resize: vertical;
            white-space: normal;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .category-icon,
        .part-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            margin: 10px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #ccc;
            transition: transform 0.2s;
        }

        .category-icon:hover,
        .part-image:hover {
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 540px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
            position: relative;
            box-sizing: border-box;
        }

        .modal-content img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            display: block;
            margin: 0 auto 10px;
        }

        #entries-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            padding: 16px;
        }

        .item-card {
            width: 180px;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 8px;
            background-color: white;
            transition: transform 0.2s ease;
            text-align: center;
        }

        .item-card:hover {
            transform: scale(1.05);
        }

        .item-card img {
            width: 100%;
            border-radius: 5px;
        }

        .item-card p {
            margin: 0;
            overflow: auto;
            font-weight: bold;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin: 8px 0;
        }

        .qty-controls {
            display: inline-flex;
            gap: 4px;
            align-items: center;
            margin-top: 4px;
        }

        .qty-controls input[type="number"] {
            width: 80px;
        }

        .muted {
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
            }

            table {
                font-size: 14px;
            }

            td img {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Inventory Database</h1>
        <section id="login-section">
            <form id="login-form">
                <label>Email:</label><input type="email" id="username" required>
                <label>Password:</label><input type="password" id="password" required>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>
    </header>

    <main>
        <section class="app-section">
            <div class="entry-container">
                <form id="create-form">
                    <label>Category: </label><input type="text" id="category" required>
                    <label>Sub-Category: </label><input type="text" id="component" required>
                    <label>Item: </label><input type="text" id="part" required>
                    <label>Price: </label><input type="number" id="price" step="0.01">
                    <label>Cost: </label><input type="number" id="actualPrice" step="0.01">
                    <label>Quantity: </label><input type="number" id="quantity">
                    <label>Link: </label><input type="url" id="affiliateUrl" placeholder="https://...">
                    <label>Description: </label><textarea id="description"></textarea>
                    <label>Upload Image: </label><input type="file" id="imageInput" accept="image/*">
                    <button id="save-data-button">Save</button>
                </form>
            </div>

            <div class="toolbar">
                <label for="viewToggle">Mode:</label>
                <select id="viewToggle">
                    <option value="view">View Mode</option>
                    <option value="edit">Edit Mode</option>
                </select>

                <label>Filter Category:
                    <select id="category-filter">
                        <option value="">All</option>
                    </select>
                </label>
                <input type="text" id="search-input" placeholder="Search Items / Desc / Link">

                <button id="exportCsvBtn" type="button" title="Export currently shown items">Export CSV</button>

                <div style="display: none;">
                    <button id="autoNameFromNodeBtn" type="button">Auto-name from node</button>
                    <label title="Preview without saving">
                        <input type="checkbox" id="dryRunNode" checked> Preview only
                    </label>
                </div>

            </div>

            <div class="checkbox">
                <label><input type="checkbox" class="toggle-column" value="category-column" checked> Category |</label>
                <label><input type="checkbox" class="toggle-column" value="component-column" checked> Sub-Category
                    |</label>
                <label><input type="checkbox" class="toggle-column" value="item-column" checked> Item |</label>
                <label><input type="checkbox" class="toggle-column" value="price-column"> Price |</label>
                <label><input type="checkbox" class="toggle-column" value="cost-column"> Cost |</label>
                <label><input type="checkbox" class="toggle-column" value="quantity-column" checked> Quantity |</label>
                <label><input type="checkbox" class="toggle-column" value="link-column" checked> Link |</label>
                <label><input type="checkbox" class="toggle-column" value="description-column"> Description
                    |</label>
                <label><input type="checkbox" class="toggle-column" value="image-column" checked> Image |</label>
                <label><input type="checkbox" class="toggle-column" value="actions-column" checked> Actions</label>
            </div>

            <div class="table">
                <div id="entries-container"></div>
            </div>
        </section>

        <section id="modal" class="modal">
            <div class="modal-content">
                <button id="closeModal">&times;</button>
                <img id="part-image" src="" alt="Part Image">
                <h3 id="modal-title"></h3>
                <p><strong>Category:</strong> <span id="modal-category"></span></p>
                <p><strong>Sub-Category:</strong> <span id="modal-component"></span></p>
                <p><strong>Price:</strong> $<span id="modal-price"></span></p>
                <p><strong>Cost:</strong> $<span id="modal-cost"></span></p>
                <p><strong>Quantity:</strong> <span id="modal-quantity"></span></p>
                <p><strong>Link:</strong> <a id="modal-link" href="#" target="_blank" rel="noopener noreferrer"></a></p>
                <p><strong>Description:</strong> <span id="modal-description"></span></p>
            </div>
        </section>

    </main>
</body>

<script type="module">
    import {
        auth, onAuthStateChanged,
        storage, storageRef, uploadBytesResumable, deleteObject, getDownloadURL,
        database, ref, set, remove, update, get, onValue, push, runTransaction
    } from "./assets/js/firebase-init.js";

    let DATABASE_BASE_PATH = 'public';
    let inventoryEntries = {};
    let lastFilteredEntries = {}; // for CSV export

    onAuthStateChanged(auth, (user) => {
        DATABASE_BASE_PATH = user ? `${user.uid}` : 'public';
        loadDatabaseEntries();
    });

    function loadDatabaseEntries() {
        const inventoryRef = ref(database, `${DATABASE_BASE_PATH}/inventory`);
        const mode = document.getElementById('viewToggle').value;
        toggleColumnControlsVisibility(mode);

        onValue(inventoryRef, (snapshot) => {
            inventoryEntries = snapshot.val() || {};
            updateCategoryFilter(inventoryEntries);
            filterEntries();
            loadColumnVisibility();
            applyColumnVisibility();
        });
    }

    function updateCategoryFilter(entries) {
        const categoryFilter = document.getElementById('category-filter');
        categoryFilter.innerHTML = '<option value="">All</option>';
        Object.keys(entries).forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.innerText = category;
            categoryFilter.appendChild(option);
        });
    }

    function displayEntries(entries) {
        const container = document.getElementById('entries-container');
        const mode = document.getElementById('viewToggle').value;

        container.innerHTML = "";

        if (mode === 'view') {
            renderViewMode(entries, container);
        } else {
            renderEditMode(entries, container);
        }
    }

    // --------- Image fetch cache ----------
    const imageCache = {};

    async function fetchImageForPart(category, component, partName, row) {
        const sanitizedPartName = partName.trim().replace(/[^a-zA-Z0-9_-]/g, "_");
        const storagePathBase = `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${sanitizedPartName}`;

        if (imageCache[storagePathBase]) {
            row.querySelector('img').src = imageCache[storagePathBase];
            return;
        }

        const possibleExtensions = ['png', 'jpg', 'jpeg', 'webp'];

        for (let ext of possibleExtensions) {
            const storagePath = `${storagePathBase}.${ext}`;
            const fileReference = storageRef(storage, storagePath);

            try {
                const downloadURL = await getDownloadURL(fileReference);
                imageCache[storagePathBase] = downloadURL;
                row.querySelector('img').src = downloadURL;
                return;
            } catch (error) {
                if (error.code !== 'storage/object-not-found') {
                    console.error(`Error fetching image for ${sanitizedPartName}:`, error);
                }
            }
        }

        imageCache[storagePathBase] = "./assets/img/default.png";
        row.querySelector('img').src = "./assets/img/default.png";
    }

    // --------- Edit listeners ----------
    function attachEventListeners() {
        document.querySelectorAll('[contenteditable="true"]').forEach(cell => {
            cell.addEventListener('blur', (event) => {
                const row = event.target.closest("tr");
                updateInventoryField(event, row);
            });
        });

        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const row = event.target.closest("tr");
                deleteEntry(row);
            });
        });

        document.querySelectorAll('.image-upload').forEach(input => {
            input.addEventListener('change', uploadImage);
        });

        // Live qty controls
        document.querySelectorAll('.inc-btn').forEach(btn => {
            btn.addEventListener('click', () => adjustQuantity(btn.closest('tr'), +1));
        });
        document.querySelectorAll('.dec-btn').forEach(btn => {
            btn.addEventListener('click', () => adjustQuantity(btn.closest('tr'), -1));
        });
        document.querySelectorAll('.set-qty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tr = btn.closest('tr');
                const v = tr.querySelector('.set-qty-input').value;
                setExactQuantity(tr, v);
            });
        });
    }

    function rowPath(row) {
        const category = row.dataset.category;
        const component = row.dataset.component;
        const uniqueKey = row.dataset.uniqueKey;
        return `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${uniqueKey}`;
    }

    async function adjustQuantity(row, delta) {
        const qRef = ref(database, `${rowPath(row)}/quantity`);
        try {
            await runTransaction(qRef, (cur) => {
                const n = parseInt(cur || 0, 10) || 0;
                return n + delta;
            });
        } catch (e) {
            alert("Adjust failed: " + (e?.message || e));
        }
    }

    async function setExactQuantity(row, val) {
        const n = Number(val);
        if (!Number.isFinite(n)) return alert("Enter a valid number to Set.");
        const qRef = ref(database, `${rowPath(row)}/quantity`);
        try {
            await runTransaction(qRef, () => n);
        } catch (e) {
            alert("Set failed: " + (e?.message || e));
        }
    }

    function updateInventoryField(event, row) {
        const key = event.target.dataset.key;
        const newValue = event.target.innerText.trim();

        // quantity edited directly: set exact value via transaction
        if (key === 'quantity') {
            setExactQuantity(row, newValue);
            return;
        }

        const selectedCategory = document.getElementById('category-filter').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();

        const originalValue = event.target.getAttribute("data-original");
        if (newValue === originalValue) return;

        update(ref(database, rowPath(row)), { [key]: newValue })
            .then(() => {
                event.target.setAttribute("data-original", newValue);
                // keep filters sticky on re-render
                setTimeout(() => {
                    document.getElementById('category-filter').value = selectedCategory;
                    document.getElementById('search-input').value = searchTerm;
                    filterEntries();
                }, 50);
            })
            .catch(error => console.error("Error updating entry:", error));
    }

    async function deleteEntry(row) {
        const category = row.dataset.category;
        const component = row.dataset.component;
        const uniqueKey = row.dataset.uniqueKey;
        const partName = row.dataset.part;

        const confirmation = confirm(`Delete "${partName}"? This action cannot be undone.`);
        if (!confirmation) return;

        await deletePreviousImage(category, component, partName);

        remove(ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${uniqueKey}`))
            .then(() => row.remove())
            .catch(error => console.error("Error deleting entry:", error));
    }

    // --------- Filtering with smarter name fallback ----------
    function smartName(data = {}) {
        const first =
            (data.part && String(data.part).trim()) ||
            (data.name && String(data.name).trim()) ||
            (data.title && String(data.title).trim()) ||
            (data.displayName && String(data.displayName).trim());

        if (first) return first;

        const url = (data.affiliateUrl || "").trim();
        if (url) {
            const slug = decodeURIComponent((url.split("?")[0] || "").split("/").filter(Boolean).pop() || "")
                .replace(/[-_]+/g, " ").trim();
            if (slug) return slug;
        }
        return "Unnamed Item";
    }

    function filterEntries() {
        const mode = document.getElementById('viewToggle').value;
        const selectedCategory = document.getElementById('category-filter').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();

        const filteredEntries = {};

        Object.entries(inventoryEntries).forEach(([category, components]) => {
            if (selectedCategory && category !== selectedCategory) return;

            Object.entries(components).forEach(([component, items]) => {
                Object.entries(items).forEach(([uniqueKey, data]) => {
                    const nameBlob = smartName(data).toLowerCase();
                    const descBlob = (data.description || "").toLowerCase();
                    const linkBlob = (data.affiliateUrl || "").toLowerCase();
                    const searchBlob = `${nameBlob} ${descBlob} ${linkBlob}`;

                    if (searchTerm && !searchBlob.includes(searchTerm)) return;

                    if (!filteredEntries[category]) filteredEntries[category] = {};
                    if (!filteredEntries[category][component]) filteredEntries[category][component] = {};
                    filteredEntries[category][component][uniqueKey] = data;
                });
            });
        });

        lastFilteredEntries = filteredEntries;
        displayEntries(filteredEntries);
    }

    // --------- Image handling ----------
    async function uploadImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const row = event.target.closest("tr");
        const category = row.dataset.category;
        const component = row.dataset.component;
        const uniqueKey = row.dataset.uniqueKey;
        const partName = row.dataset.part.trim().replace(/[^a-zA-Z0-9_-]/g, "_");

        if (!category || !component || !partName) {
            alert("Error: Missing entry information for image upload.");
            return;
        }

        const storagePath = `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${partName}.png`;
        const fileReference = storageRef(storage, storagePath);

        try {
            await deletePreviousImage(category, component, partName);

            const uploadTask = await uploadBytesResumable(fileReference, file);
            const imageUrl = await getDownloadURL(uploadTask.ref);

            await update(ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${uniqueKey}`), {
                imageUrl: imageUrl
            });

            row.querySelector("img").src = imageUrl;
        } catch (error) {
            console.error("Error uploading image:", error);
        }
        filterEntries();
    }

    async function deletePreviousImage(category, component, partName) {
        const storagePathBase = `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${partName}`;
        const exts = ['png', 'jpg', 'jpeg', 'webp'];
        for (const ext of exts) {
            const fullPath = `${storagePathBase}.${ext}`;
            const fileRef = storageRef(storage, fullPath);
            try {
                await deleteObject(fileRef);
                break;
            } catch (err) {
                if (err.code !== 'storage/object-not-found') {
                    console.error(`Error deleting ${fullPath}:`, err);
                    return;
                }
            }
        }
    }

    // --------- Create new item ----------
    document.getElementById('save-data-button').addEventListener('click', async (event) => {
        event.preventDefault();

        const category = document.getElementById('category').value.trim();
        const component = document.getElementById('component').value.trim();
        const partNameRaw = document.getElementById('part').value || "";
        const partName = partNameRaw.trim();
        if (!category || !component || !partName) {
            alert("Category, Sub-Category, and Item are required.");
            return;
        }

        const price = parseFloat(document.getElementById('price').value) || 0;
        const actualPrice = parseFloat(document.getElementById('actualPrice').value) || 0;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const description = document.getElementById('description').value.trim();
        const affiliateUrl = document.getElementById('affiliateUrl').value.trim();
        const imageFile = document.getElementById('imageInput').files[0];

        const uniqueKey = Date.now().toString();
        const inventoryRef = ref(database, `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${uniqueKey}`);

        let imageUrl = null;

        if (imageFile) {
            try {
                const sanitizedPartForFile = partName.replace(/[^a-zA-Z0-9_-]/g, "_");
                imageUrl = await uploadImageForNewEntry(imageFile, category, component, sanitizedPartForFile);
            } catch (error) {
                console.error("Image upload failed:", error);
                alert("Failed to upload image. Try again.");
                return;
            }
        }

        const itemData = {
            part: partName,
            price,
            actualPrice,
            quantity,
            description,
            affiliateUrl: affiliateUrl || "",
            imageUrl
        };

        set(inventoryRef, itemData)
            .then(() => {
                resetForm();
                loadDatabaseEntries();
            })
            .catch(error => console.error("Error saving item:", error));
    });

    function resetForm() {
        document.getElementById('create-form').reset();
    }

    async function uploadImageForNewEntry(file, category, component, partNameSanitized) {
        const storagePath = `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${partNameSanitized}.png`;
        const fileReference = storageRef(storage, storagePath);

        await deletePreviousImage(category, component, partNameSanitized);
        const uploadTask = await uploadBytesResumable(fileReference, file);
        const imageUrl = await getDownloadURL(uploadTask.ref);
        return imageUrl;
    }

    // --------- Modal ----------
    function attachImageClickEvent() {
        document.querySelectorAll("#inventory-body img").forEach(img => {
            img.addEventListener("click", function () {
                const modal = document.getElementById("modal");
                const modalImg = document.getElementById("part-image");
                modal.style.display = "flex";
                modalImg.src = this.src;
            });
        });

        document.getElementById("modal").addEventListener("click", function (event) {
            if (event.target === this) {
                this.style.display = "none";
            }
        });
    }

    function showDetailsModal(data, category, component, partName, imageUrl) {
        const modal = document.getElementById("modal");
        modal.style.display = "flex";

        document.getElementById("part-image").src = imageUrl;
        document.getElementById("modal-title").innerText = smartName(data);
        document.getElementById("modal-category").innerText = category ?? "Unknown Category";
        document.getElementById("modal-component").innerText = component ?? "Unknown Sub-Category";
        document.getElementById("modal-price").innerText = (data.price ?? "0").toString();
        document.getElementById("modal-cost").innerText = (data.actualPrice ?? "0").toString();
        document.getElementById("modal-quantity").innerText = (data.quantity ?? "0").toString();

        const link = data.affiliateUrl?.trim() || "";
        const linkEl = document.getElementById("modal-link");
        linkEl.textContent = link || "—";
        linkEl.href = link || "#";

        document.getElementById("modal-description").innerText = data.description?.trim() || "No description available";
    }

    document.getElementById("closeModal").addEventListener("click", () => {
        document.getElementById("modal").style.display = "none";
    });

    document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
            document.getElementById("modal").style.display = "none";
        }
    });

    // --------- Renderers ----------
    function renderViewMode(entries, container) {
        const selectedCategory = document.getElementById('category-filter').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();

        container.innerHTML = "";
        container.style.display = "flex";
        container.style.flexWrap = "wrap";
        container.style.gap = "16px";
        container.style.justifyContent = "center";

        Object.entries(entries).forEach(([category, components]) => {
            Object.entries(components).forEach(([component, items]) => {
                Object.entries(items).forEach(([uniqueKey, data]) => {
                    const displayName = smartName(data);
                    const imageUrl = data.imageUrl || "./assets/img/default.png";

                    const matchesCategory = selectedCategory === '' || category === selectedCategory;
                    const blob = `${displayName} ${(data.description || "")} ${(data.affiliateUrl || "")}`.toLowerCase();
                    const matchesSearch = searchTerm === '' || blob.includes(searchTerm);
                    if (!(matchesCategory && matchesSearch)) return;

                    const partName = displayName.replace(/[^a-zA-Z0-9_-]/g, "_");

                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.dataset.category = category;
                    card.dataset.component = component;
                    card.dataset.uniqueKey = uniqueKey;
                    card.dataset.part = partName;

                    card.innerHTML = `
            <img src="${imageUrl}" alt="${partName}">
            <p>${displayName}</p>
            <p class="muted">${category} / ${component}</p>
          `;

                    card.addEventListener('click', () => {
                        showDetailsModal(data, category, component, partName, imageUrl);
                    });

                    container.appendChild(card);
                });
            });
        });
    }

    function renderEditMode(entries, container) {
        container.style.display = "block";
        container.innerHTML = `<table id="inventory-table">
        <thead>
            <tr>
                <th class="category-column">Category</th>
                <th class="component-column">Sub-Category</th>
                <th class="item-column">Item Name</th>
                <th class="price-column">Price</th>
                <th class="cost-column">Cost</th>
                <th class="quantity-column">Quantity</th>
                <th class="link-column">Link</th>
                <th class="description-column">Description</th>
                <th class="image-column">Image</th>
                <th class="actions-column">Actions</th>
            </tr>
        </thead>
        <tbody id="inventory-body"></tbody>
    </table>`;

        const tbody = document.getElementById('inventory-body');

        Object.entries(entries).forEach(([category, components]) => {
            Object.entries(components).forEach(([component, items]) => {
                Object.entries(items).forEach(([uniqueKey, data]) => {
                    const nameForAttr = (data.part || '').replace(/[^a-zA-Z0-9_-]/g, "_");
                    const imageUrl = data.imageUrl ? data.imageUrl : "./assets/img/default.png";

                    const row = document.createElement('tr');
                    row.dataset.uniqueKey = uniqueKey;
                    row.dataset.category = category;
                    row.dataset.component = component;
                    row.dataset.part = nameForAttr;

                    row.innerHTML = `
              <td class="category-column">${category}</td>
              <td class="component-column">${component}</td>
              <!-- NOTE: no placeholder here; empty cell if missing, and data-original is empty -->
              <td class="item-column" contenteditable="true" data-key="part" data-original="${(data.part || '').replace(/"/g, '&quot;')}">${data.part || ''}</td>
              <td class="price-column" contenteditable="true" data-key="price" data-original="${data.price || 0}">${data.price || 0}</td>
              <td class="cost-column" contenteditable="true" data-key="actualPrice" data-original="${data.actualPrice || 0}">${data.actualPrice || 0}</td>
              <td class="quantity-column">
                  <div contenteditable="true" data-key="quantity" data-original="${data.quantity || 0}" style="display:inline-block; min-width:44px; border-bottom:1px dotted #bbb;">${data.quantity || 0}</div>
                  <div class="qty-controls">
                      <button type="button" class="dec-btn">−1</button>
                      <button type="button" class="inc-btn">+1</button>
                      <input type="number" class="set-qty-input" placeholder="Set…">
                      <button type="button" class="set-qty-btn">Set</button>
                  </div>
              </td>
              <td class="link-column" contenteditable="true" data-key="affiliateUrl" data-original="${(data.affiliateUrl || '').replace(/"/g, '&quot;')}">${data.affiliateUrl || ''}</td>
              <td class="description-column" contenteditable="true" data-key="description" data-original="${(data.description || '').replace(/"/g, '&quot;')}">${data.description || ''}</td>
              <td class="image-column">
                  <img src="${imageUrl}" width="50" height="50" style="cursor: pointer;" data-part="${nameForAttr}">
                  <input type="file" class="image-upload" accept="image/*">
              </td>
              <td class="actions-column">
                  <button class="delete-button clear-button" type="button">Delete</button>
              </td>
          `;
                    tbody.appendChild(row);
                });
            });
        });

        attachEventListeners();
        attachImageClickEvent();
    }

    // --------- Column visibility ----------
    document.getElementById('category-filter').addEventListener('change', filterEntries);
    document.getElementById('search-input').addEventListener('input', filterEntries);
    document.getElementById('viewToggle').addEventListener('change', loadDatabaseEntries);

    document.querySelectorAll('.toggle-column').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            saveColumnVisibility();
            applyColumnVisibility();
        });
    });

    function saveColumnVisibility() {
        const checkboxStates = {};
        document.querySelectorAll('.toggle-column').forEach(checkbox => {
            checkboxStates[checkbox.value] = checkbox.checked;
        });
        localStorage.setItem('inventoryColumnVisibility', JSON.stringify(checkboxStates));
    }

    function loadColumnVisibility() {
        const savedStates = JSON.parse(localStorage.getItem('inventoryColumnVisibility'));
        if (savedStates) {
            document.querySelectorAll('.toggle-column').forEach(checkbox => {
                checkbox.checked = savedStates[checkbox.value] !== undefined ? savedStates[checkbox.value] : checkbox.checked;
            });
        }
    }

    function applyColumnVisibility() {
        document.querySelectorAll('.toggle-column').forEach(checkbox => {
            const columnClass = checkbox.value;
            document.querySelectorAll(`.${columnClass}`).forEach(cell => {
                cell.style.display = checkbox.checked ? '' : 'none';
            });
        });
    }

    function toggleColumnControlsVisibility(mode) {
        const columnControls = document.querySelector('.checkbox');
        columnControls.style.display = (mode === 'edit') ? 'block' : 'none';
    }

    // --------- CSV Export (exports what’s currently shown) ----------
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
        const rows = [["Category", "Sub-Category", "Item", "Quantity", "Price", "Cost", "Link", "Description", "ImageURL", "Key"]];
        Object.entries(lastFilteredEntries).forEach(([category, components]) => {
            Object.entries(components).forEach(([component, items]) => {
                Object.entries(items).forEach(([uniqueKey, data]) => {
                    rows.push([
                        category,
                        component,
                        smartName(data),
                        String(data.quantity ?? 0),
                        String(data.price ?? ""),
                        String(data.actualPrice ?? ""),
                        String(data.affiliateUrl ?? ""),
                        (data.description || "").replace(/\r?\n/g, " ").trim(),
                        String(data.imageUrl ?? ""),
                        uniqueKey
                    ]);
                });
            });
        });

        const csv = rows.map(r =>
            r.map(field => {
                const s = String(field ?? "");
                return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            }).join(",")
        ).join("\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `inventory_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    });


    // --- Auto-name missing items using their node key (uniqueKey) ---
    document.getElementById('autoNameFromNodeBtn').addEventListener('click', autoNameFromNode);

    async function autoNameFromNode() {
        try {
            const dryRun = document.getElementById('dryRunNode')?.checked ?? true;

            // Pull current inventory tree
            const rootRef = ref(database, `${DATABASE_BASE_PATH}/inventory`);
            const snap = await get(rootRef);
            const inv = snap.val() || {};

            const updates = {};
            const preview = [];

            // Walk: category -> component -> uniqueKey -> data
            for (const [category, components] of Object.entries(inv)) {
                for (const [component, items] of Object.entries(components || {})) {
                    for (const [uniqueKey, data] of Object.entries(items || {})) {
                        const currentName = String(data?.part || '').trim();
                        if (currentName) continue; // skip items that already have a name

                        // Use the node key directly as the name
                        const candidate = String(uniqueKey);

                        const path = `${DATABASE_BASE_PATH}/inventory/${category}/${component}/${uniqueKey}/part`;
                        updates[path] = candidate;
                        preview.push({ category, component, uniqueKey, name: candidate });
                    }
                }
            }

            if (preview.length === 0) {
                alert('No unnamed items found.');
                return;
            }

            if (dryRun) {
                console.table(preview);
                alert(`Preview: ${preview.length} items would be named from their node key. Open the console for details. Uncheck "Preview only" to apply.`);
                return;
            }

            // One atomic fan-out update
            await update(ref(database), updates);
            alert(`Named ${preview.length} items from their node key.`);
            // Re-apply your current filters/render
            filterEntries?.();
        } catch (err) {
            console.error('Auto-name from node failed:', err);
            alert(`Auto-name from node failed: ${err?.message || err}`);
        }
    }

</script>

</html>