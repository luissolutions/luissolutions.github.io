<!DOCTYPE html>
<html lang="en">

<head>
    <title>Online Task Manager</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/css/app-styles.css" id="stylesheet">
    <script type="module" src="./assets/js/login.js" defer></script>
    <style>
        @media (max-width: 768px) {

            input,
            button,
            textarea {
                width: 95%;
            }

            header button,
            .checkbox input {
                width: auto;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>
</head>

<body>
    <header>
        <h1>Online Task Manager</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <br>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <br>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>
        <div id="wbutton">
            <button id="goToBottomBtn">â¤“</button>
        </div>
    </header>

    <main>
        <section id="task-manager" class="app-section">
            <h2>Create Task</h2>
            <input type="text" id="taskName" placeholder="Task Name" maxlength="40">
            <textarea id="taskNotes" placeholder="Notes"></textarea>

            <p>Upload Image (Optional)</p>
            <input type="file" id="fileUploader" accept="image/*">
            <input type="text" id="imageNameInput" placeholder="Enter Image Name (Optional)">
            <input type="text" id="markupTextInput" placeholder="Markup Text (Optional)">
            <button id="uploadButton">Save Task</button>

            <h2>Saved Tasks</h2>
            <table id="task-log">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Notes</th>
                        <th>Image</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>

    <script type="module">
import { auth, database, ref, set, push, onValue, storageRef, uploadBytesResumable, getDownloadURL } from './assets/js/firebase-init.js';

// UI Elements
const taskNameInput = document.getElementById('taskName');
const taskNotesTextarea = document.getElementById('taskNotes');
const fileUploader = document.getElementById('fileUploader');
const uploadButton = document.getElementById('uploadButton');
const taskLogTable = document.getElementById('task-log').getElementsByTagName('tbody')[0];
const imageNameInput = document.getElementById('imageNameInput');
const markupTextInput = document.getElementById('markupTextInput');

let currentUser = null;

// Listen for authentication state
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user.uid;
        loadTasks();
    } else {
        currentUser = null;
    }
});

// Save Task to Firebase
async function saveTask(task) {
    if (!currentUser) return alert("Please log in first.");
    const taskRef = push(ref(database, `${currentUser}/tasks`));
    set(taskRef, task);
}

// Upload Image and Save Task
uploadButton.addEventListener('click', async () => {
    if (!currentUser) {
        alert("Please log in first.");
        return;
    }

    const taskName = taskNameInput.value.trim();
    const taskNotes = taskNotesTextarea.value.trim();
    const file = fileUploader.files[0];
    const markupText = markupTextInput.value.trim();

    if (!taskName) {
        alert("Task name is required.");
        return;
    }

    let imageUrl = "";
    if (file) {
        let fileName = imageNameInput.value.trim() || file.name.split('.').slice(0, -1).join('.');
        const fileExtension = file.name.split('.').pop();
        const finalFileName = markupText ? `${fileName}_markup.${fileExtension}` : `${fileName}.${fileExtension}`;

        const fileRef = storageRef(storage, `${currentUser}/tasks/${finalFileName}`);
        await uploadBytesResumable(fileRef, file);
        imageUrl = await getDownloadURL(fileRef);
    }

    const task = {
        name: taskName,
        notes: taskNotes,
        imageUrl,
        createdAt: new Date().toISOString(),
    };

    saveTask(task);

    // Clear inputs
    taskNameInput.value = "";
    taskNotesTextarea.value = "";
    fileUploader.value = "";
    imageNameInput.value = "";
    markupTextInput.value = "";

    alert("Task saved successfully!");
});

// Load Tasks
function loadTasks() {
    if (!currentUser) return;

    const taskRef = ref(database, `${currentUser}/tasks`);
    onValue(taskRef, (snapshot) => {
        taskLogTable.innerHTML = "";
        snapshot.forEach((childSnapshot) => {
            const task = childSnapshot.val();
            addTaskToTable(task);
        });
    });
}

// Display Task in Table
function addTaskToTable(task) {
    const row = taskLogTable.insertRow();
    const nameCell = row.insertCell(0);
    const notesCell = row.insertCell(1);
    const imageCell = row.insertCell(2);

    nameCell.innerText = task.name || "";
    notesCell.innerText = task.notes || "";

    if (task.imageUrl) {
        const img = document.createElement("img");
        img.src = task.imageUrl;
        img.style.width = "100px";
        imageCell.appendChild(img);
    } else {
        imageCell.innerText = "No Image";
    }
}

    </script>

</body>

</html>