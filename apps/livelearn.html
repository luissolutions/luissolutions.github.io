<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,  user-scalable=no">
  <title>Information Learning App</title>
  <link rel="stylesheet" href="../assets/css/gray-styles.css" id="stylesheet">
  <link rel="icon" type="image/png" href="../assets/img/t_logo.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="../assets/img/t_logo.png" sizes="16x16" />
</head>

<body>
  <header>
    <div>
      <img src="../assets/img/logo.png" alt="Logo">
      <h1>Learn what you want.</h1>
    </div>

    <nav>
      <div>
        <input type="text" placeholder="insert link" id="linkInput">
        <button id="saveLinkButton">Save</button>
      </div>
      <ul id="linksList">
        <!-- Links will be loaded here -->
      </ul>
    </nav>

  </header>

  <main>

    <div>
      <input type="text" id="filterInput" placeholder="Filter questions">
      <button id="filterButton">Filter</button>
    </div>
    <section>
      <label>
        <input type="radio" name="questionType" value="textInput" checked> Text Input
      </label>
      <label>
        <input type="radio" name="questionType" value="multipleChoice"> Multiple Choice
      </label>
    </section>
    <div id="questionCounter">Questions Remaining: 0</div> <!-- Counter Display -->

    <section id="quizSection">
      <!-- Questions will be loaded here -->
    </section>
    <button id="submitAnswer">Submit Answer</button>
    <button id="nextQuestion">Next Question</button>

    <section id="addQuestion">
      <h2>Add a New Question</h2>
      <div>
        <input type="text" id="newDescription" placeholder="Enter description" />
        <br>
        <input type="text" id="newQuestion" placeholder="Enter question" />
        <br>
        <input type="text" id="option1" placeholder="Option 1" />
        <input type="text" id="option2" placeholder="Option 2" />
        <input type="text" id="option3" placeholder="Option 3" />
        <input type="text" id="correctAnswer" placeholder="Correct answer" />
        <button id="addQuestionButton">Add Question</button>
        <button id="deleteQuestionButton">Delete Question</button>
      </div>
    </section>

    <section style="display: none;">
      <input type="file" id="jsonFileInput" accept=".json">
      <button id="loadJsonButton">Load JSON File</button>
    </section>

  </main>

  <footer>
    <p>JavaScript Learning App Â© <a href="../index.html"> 2023</a></p>
  </footer>

  <script type="module">
    import { getDatabase, database, ref, onValue, push, set, remove } from '../assets/js/firebase-init.js';

    let currentQuestionIndex = 0;
    let totalQuestions = 0;
    let questions = [];
    let allQuestions = [];
    let answeredQuestions = {};
    let currentQuestionId = null;

    document.addEventListener('DOMContentLoaded', () => {
      const savedAnsweredQuestions = localStorage.getItem('answeredQuestions');
      if (savedAnsweredQuestions) {
        answeredQuestions = JSON.parse(savedAnsweredQuestions);
      }

      fetchQuestions();
      document.getElementById('submitAnswer').addEventListener('click', submitAnswer);
      document.getElementById('nextQuestion').addEventListener('click', displayNextQuestion);
      document.getElementById('filterButton').addEventListener('click', filterQuestions);
      document.querySelectorAll('input[name="questionType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          if (questions.length > 0) {
            displayQuestion(questions[currentQuestionIndex]);
          }
        });
      });
      const savedIndex = localStorage.getItem('currentQuestionIndex');
      if (savedIndex) {
        currentQuestionIndex = parseInt(savedIndex);
      }
    });

    function fetchQuestions() {
      const questionsRef = ref(database, 'questions');
      onValue(questionsRef, (snapshot) => {
        const data = snapshot.val();
        allQuestions = Object.keys(data).map(key => {
          return {
            id: key,
            ...data[key]
          };
        });
        questions = allQuestions.filter(q => !answeredQuestions[q.id]);
        totalQuestions = questions.length;
        updateQuestionCounter();
        shuffleArray(questions);
        displayQuestion(questions[currentQuestionIndex]);
      }, (error) => {
        console.error('Error fetching questions:', error);
      });
    }

    function displayQuestion(question) {
      const quizSection = document.getElementById('quizSection');
      const questionType = document.querySelector('input[name="questionType"]:checked').value;
      currentQuestionId = question.id; // Store the current question ID

      let optionsHTML = '';
      if (questionType === 'multipleChoice') {
        optionsHTML = question.options.map(option =>
          `<label><input type="radio" name="question" value="${option}">${option}</label>`
        ).join('<br>');
      } else {
        optionsHTML = `<input type="text" id="textInputAnswer" placeholder="Type your answer">`;
      }

      quizSection.innerHTML = `<p>${question.question}</p>${optionsHTML}`;
    }

    function submitAnswer() {
      const questionType = document.querySelector('input[name="questionType"]:checked').value;
      let userAnswer;
      if (questionType === 'multipleChoice') {
        const selectedOption = document.querySelector('input[name="question"]:checked');
        userAnswer = selectedOption ? selectedOption.value : null;
      } else {
        userAnswer = document.getElementById('textInputAnswer').value;
      }

      if (userAnswer) {
        const correctAnswer = questions[currentQuestionIndex].correctAnswer;
        if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
          console.log('Correct!');
          answeredQuestions[questions[currentQuestionIndex].id] = true;
          localStorage.setItem('answeredQuestions', JSON.stringify(answeredQuestions));

          totalQuestions--;
          updateQuestionCounter();
          displayNextQuestion();
        } else {
          console.log('Incorrect. The correct answer was:', correctAnswer);
        }
      } else {
        console.log('Please provide an answer.');
      }
    }

    function displayNextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        displayQuestion(questions[currentQuestionIndex]);
        localStorage.setItem('currentQuestionIndex', currentQuestionIndex);
      } else {
        console.log('End of Quiz');
        resetQuiz();
      }
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function updateQuestionCounter() {
      const counterElement = document.getElementById('questionCounter');
      counterElement.textContent = `Questions Remaining: ${totalQuestions}`;
    }

    function resetQuiz() {
      currentQuestionIndex = 0;
      totalQuestions = questions.length;
      shuffleArray(questions);
      updateQuestionCounter();
      displayQuestion(questions[currentQuestionIndex]);

      const quizSection = document.getElementById('quizSection');
      quizSection.innerHTML += '<p>Quiz completed! Starting over...</p>';

      answeredQuestions = {};
      localStorage.removeItem('answeredQuestions');
      localStorage.removeItem('currentQuestionIndex');
    }

    document.getElementById('addQuestionButton').addEventListener('click', () => {
      const newQuestion = document.getElementById('newQuestion').value;
      const newDescription = document.getElementById('newDescription').value;
      const options = [
        document.getElementById('option1').value,
        document.getElementById('option2').value,
        document.getElementById('option3').value
      ];
      const correctAnswer = document.getElementById('correctAnswer').value;

      if (newQuestion && newDescription && options.every(option => option) && correctAnswer) {
        addQuestionToFirebase(newQuestion, newDescription, options, correctAnswer);
      } else {
        console.log('Please fill in all fields.');
      }
    });

    function addQuestionToFirebase(question, description, options, correctAnswer) {
      const questionsRef = ref(database, 'questions');
      const newQuestionRef = push(questionsRef);
      set(newQuestionRef, {
        question,
        description,
        options,
        correctAnswer
      }).then(() => {
        console.log('Question added successfully');
        updateQuestionCounter();
      }).catch(error => {
        console.error('Error adding new question:', error);
      });
    }

    function filterQuestions() {
      const filterText = document.getElementById('filterInput').value.toLowerCase();
      questions = allQuestions.filter(q => q.description.toLowerCase().includes(filterText));
      totalQuestions = questions.length;
      updateQuestionCounter();
      currentQuestionIndex = 0;
      displayQuestion(questions[currentQuestionIndex]);
    }

    function fetchLinksFromFirebase() {
      const linksRef = ref(database, 'links');
      onValue(linksRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          displayLinks(data);
        }
      }, (error) => {
        console.error('Error fetching links:', error);
      });
    }

    document.getElementById('deleteQuestionButton').addEventListener('click', () => {
    if (currentQuestionId) {
        deleteQuestionFromFirebase(currentQuestionId);
    } else {
        console.log('No question selected for deletion.');
    }
});

    function deleteQuestionFromFirebase(questionId) {
    const questionRef = ref(database, `questions/${questionId}`);
    remove(questionRef).then(() => {
        console.log('Question removed successfully');
        // Update the local state and UI
        fetchQuestions(); // Refetch questions or update the local state as needed
    }).catch(error => {
        console.error('Error removing question:', error);
    });
}

    const saveLinkButton = document.getElementById('saveLinkButton');

    saveLinkButton.addEventListener('click', () => {
      const linkUrl = linkInput.value;
      if (!linkUrl) {
        alert('Please enter a link.');
        return;
      }

      const newLinkRef = push(ref(database, 'links'));
      set(newLinkRef, { url: linkUrl })
        .then(() => {
          console.log('Link saved successfully!');
          linkInput.value = '';
          fetchLinksFromFirebase();
        })
        .catch((error) => {
          console.error('Error saving link:', error);
        });
    });

    function displayLinks(links) {
      const linksList = document.getElementById('linksList');
      linksList.innerHTML = '';

      Object.keys(links).forEach(key => {
        const link = links[key];
        const listItem = document.createElement('li');
        const aTag = document.createElement('a');
        aTag.href = link.url;
        aTag.target = "_blank";
        aTag.rel = "noopener noreferrer";
        aTag.textContent = link.url;

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'X';
        deleteButton.onclick = () => deleteLink(key);

        listItem.appendChild(aTag);
        listItem.appendChild(deleteButton);
        linksList.appendChild(listItem);
      });
    }

    function deleteLink(key) {
      const linkRef = ref(database, 'links/' + key);
      remove(linkRef).then(() => {
        console.log('Link removed successfully');
        fetchLinksFromFirebase();
      }).catch(error => {
        console.error('Error removing link:', error);
      });
    }

    window.addEventListener('load', () => {
      fetchLinksFromFirebase();
    });

  </script>
</body>

</html>