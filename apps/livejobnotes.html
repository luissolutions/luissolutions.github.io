<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager with Images</title>
    <link rel="stylesheet" href="./assets/css/app-styles.css">
    <script type="module" src="./assets/js/login.js" defer></script>
</head>

<body>
    <header>
        <h1>Job Notes with Images</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <br>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <br>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>
    </header>

    <main>
        <section id="taskFormSection" class="task-form">
            <h2>Create or Edit Job</h2>
            <label for="taskSelect">Select a Job to edit:</label>
            <select id="taskSelect">
                <option value="" disabled selected>Select a Project</option>
            </select>

            <input type="text" id="customerName" placeholder="Task Name" required>
            <input type="text" id="project" placeholder="Project" required>
            <textarea id="taskNotes" placeholder="Notes"></textarea>
            <button id="saveTaskButton">Save Task</button>
        </section>

        <section id="imageUploadSection" class="hidden">
            <h2>Manage Images for Task</h2>
            <input type="file" id="fileUploader" accept="image/*">
            <input type="text" id="imageNameInput" placeholder="Enter Image Name">
            <button id="uploadButton">Upload Image</button>
            <br>
            <label for="imageSelect">Existing Images:</label>
            <select id="imageSelect">
                <option value="" disabled selected>Select Image</option>
            </select>
            <div style="display: none;" id="imageControls">
                <button id="prevImage">Previous</button>
                <button id="nextImage">Next</button>
                <button id="showAllImages">Show All</button>
            </div>
            <div class="photoGrid">
                <div id="photoContainer"></div>
            </div>
            <button id="deleteImageButton">Delete Selected Image</button>
        </section>

        <section id="taskLogSection">
            <h2>Task Log</h2>
            <div>
                <label for="searchTask">Search Tasks:</label>
                <input type="text" id="searchTask" placeholder="Enter Name">
            </div>
            <table id="taskLog">
                <thead>
                    <tr>
                        <th>Job Name</th>
                        <th>Project</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>

    <script type="module">
        import { database, ref, set, get, push, onValue, remove, update, storageRef, uploadBytesResumable, getDownloadURL, deleteObject, listAll, getStorage, storage } from './assets/js/firebase-init.js';

        const customerNameInput = document.getElementById('customerName');
        const projectInput = document.getElementById('project');
        const taskNotesInput = document.getElementById('taskNotes');
        const saveTaskButton = document.getElementById('saveTaskButton');
        const taskLogTable = document.querySelector('#taskLog tbody');
        const fileUploader = document.getElementById('fileUploader');
        const uploadButton = document.getElementById('uploadButton');
        const photoContainer = document.getElementById('photoContainer');
        const imageNameInput = document.getElementById('imageNameInput');
        const imageUploadSection = document.getElementById('imageUploadSection');
        const taskSelect = document.getElementById('taskSelect');
        const imageSelect = document.getElementById('imageSelect');
        const deleteImageButton = document.getElementById('deleteImageButton');

        let currentTaskId = null;
        let isEditing = false;

        const toggleVisibility = (element, show) => {
            element.classList.toggle('hidden', !show);
        };

        const removeFileExtension = (fileName) => {
            return fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
        };

        const addImageToContainer = (name, url) => {
            const img = document.createElement('img');
            img.src = url;
            img.alt = name;
            img.className = 'thumbnail';
            img.addEventListener('click', () => displaySelectedImage(url));
            photoContainer.appendChild(img);
        };

        const loadTaskForEditing = async (taskId) => {
            currentTaskId = taskId;
            isEditing = true;
            const taskRef = ref(database, `share/tasks/${taskId}`);
            const snapshot = await get(taskRef);
            if (snapshot.exists()) {
                const taskData = snapshot.val();
                customerNameInput.value = taskData.customerName;
                projectInput.value = taskData.project;
                taskNotesInput.value = taskData.notes;
                loadTaskImages(taskId);
                toggleVisibility(imageUploadSection, true);
            } else {
                console.error('No task data found');
            }
        };

        const loadTasks = async () => {
            taskLogTable.innerHTML = '';
            taskSelect.innerHTML = '<option value="" disabled selected>Select</option>';
            try {
                const tasksSnapshot = await get(ref(database, 'share/tasks'));
                if (!tasksSnapshot.exists()) {
                    console.log('No tasks found.');
                    return;
                }

                const tasks = tasksSnapshot.val();
                for (const task of Object.values(tasks)) {
                    addTaskToTable(task);
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        };

        const addTaskToTable = (task) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="name-column">${task.customerName}</td>
                <td class="project-column">${task.project}</td>
                <td class="notes-column">${task.notes}</td>
                <td>
                    <button data-task-id="${task.id}" class="view-task-btn">View</button>
                    <button data-task-id="${task.id}" class="delete-task-btn">Delete</button>
                </td>
            `;
            taskLogTable.appendChild(row);

            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = `${task.customerName} - ${task.project}`;
            taskSelect.appendChild(option);

            row.querySelector('.view-task-btn').addEventListener('click', () => loadTaskForEditing(task.id));
            row.querySelector('.delete-task-btn').addEventListener('click', () => deleteTask(task.id));
        };

        const saveTask = async () => {
            const customerName = customerNameInput.value.trim();
            const project = projectInput.value.trim();
            const notes = taskNotesInput.value.trim();

            if (!customerName || !project) {
                alert('Please provide a task name and project.');
                return;
            }

            const taskData = { customerName, project, notes };

            try {
                if (isEditing && currentTaskId) {
                    await update(ref(database, `share/tasks/${currentTaskId}`), taskData);
                    console.log(`Task ${currentTaskId} updated successfully`);
                } else {
                    const newTaskRef = push(ref(database, 'share/tasks'));
                    currentTaskId = newTaskRef.key;
                    await set(newTaskRef, { id: currentTaskId, ...taskData, images: {} });
                    console.log(`Task ${currentTaskId} created successfully`);
                    toggleVisibility(imageUploadSection, true);
                }
                loadTasks();
                clearTaskForm();
            } catch (error) {
                console.error('Error saving task:', error);
            }
        };

        const uploadImage = async () => {
            const files = fileUploader.files;
            let customImageName = imageNameInput.value.trim();

            if (!files.length || !currentTaskId) {
                alert('Please select an image and a task.');
                return;
            }

            const file = files[0];

            let imageName = customImageName || file.name;

            imageName = imageName.substring(0, imageName.lastIndexOf('.')) || imageName;

            try {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = async (e) => {
                    img.src = e.target.result;

                    img.onload = async () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > 1024) {
                            height = Math.floor((1024 / width) * height);
                            width = 1024;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(async (blob) => {
                            const storageReference = storageRef(storage, `share/tasks/${currentTaskId}/images/${imageName}`);
                            const uploadTask = uploadBytesResumable(storageReference, blob);

                            await uploadTask;
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

                            await set(ref(database, `share/tasks/${currentTaskId}/images/${imageName}`), downloadURL);

                            photoContainer.innerHTML = '';
                            addImageToDropdown(imageName, downloadURL);
                            addImageToContainer(imageName, downloadURL);
                        }, file.type);
                    };
                };

                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error uploading image:', error);
            }
        };

        const deleteSelectedImage = async () => {
            const selectedImageUrl = imageSelect.value;
            if (!selectedImageUrl || !currentTaskId) return;

            try {
                const imageRef = storageRef(storage, selectedImageUrl);
                await deleteObject(imageRef);

                const taskImagesRef = ref(database, `share/tasks/${currentTaskId}/images`);
                const imagesSnapshot = await get(taskImagesRef);
                const images = imagesSnapshot.val();
                const imageKey = Object.keys(images).find(key => images[key] === selectedImageUrl);

                if (imageKey) {
                    await remove(ref(database, `share/tasks/${currentTaskId}/images/${imageKey}`));
                    loadTaskImages(currentTaskId);
                    photoContainer.innerHTML = '';
                }
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        };

        const deleteTask = async (taskId) => {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                const taskImagesRef = ref(database, `share/tasks/${taskId}/images`);
                const imagesSnapshot = await get(taskImagesRef);

                if (imagesSnapshot.exists()) {
                    const images = imagesSnapshot.val();
                    for (const url of Object.values(images)) {
                        const imageRef = storageRef(storage, url);
                        await deleteObject(imageRef);
                    }
                }

                await remove(ref(database, `share/tasks/${taskId}`));
                loadTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
            }
        };

        const clearTaskForm = () => {
            customerNameInput.value = '';
            projectInput.value = '';
            taskNotesInput.value = '';
            isEditing = false;
        };

        document.getElementById('searchTask').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#taskLog tbody tr');

            rows.forEach(row => {
                const name = row.querySelector('.name-column').innerText.toLowerCase();
                const project = row.querySelector('.project-column').innerText.toLowerCase();
                const notes = row.querySelector('.notes-column').innerText.toLowerCase();

                if (name.includes(searchTerm) || project.includes(searchTerm) || notes.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        let currentImageIndex = 0;
        let imageUrls = [];

        const displayImageByIndex = (index) => {
            const url = imageUrls[index];
            displaySelectedImage(url);
        };

        const displayAllImages = () => {
            photoContainer.innerHTML = '';
            imageUrls.forEach((url) => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'thumbnail';
                img.addEventListener('click', () => displaySelectedImage(url));
                photoContainer.appendChild(img);
            });
        };

        document.getElementById('nextImage').addEventListener('click', () => {
            currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
            displayImageByIndex(currentImageIndex);
        });

        document.getElementById('prevImage').addEventListener('click', () => {
            currentImageIndex = (currentImageIndex - 1) % imageUrls.length;
            displayImageByIndex(currentImageIndex);
        });

        document.getElementById('showAllImages').addEventListener('click', () => {
            displayAllImages();
        });

        const displaySelectedImage = (url) => {
            photoContainer.innerHTML = '';
            const img = document.createElement('img');
            img.src = url;
            img.className = 'photo';
            photoContainer.appendChild(img);

            const options = imageSelect.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === url) {
                    imageSelect.selectedIndex = i;
                    currentImageIndex = i;
                    break;
                }
            }
        };

        const loadTaskImages = async (taskId) => {
            const taskImagesRef = ref(database, `share/tasks/${taskId}/images`);
            const storageImagesRef = storageRef(storage, `share/tasks/${taskId}/images`);

            try {
                const storageSnapshot = await listAll(storageImagesRef);
                const databaseSnapshot = await get(taskImagesRef);

                let databaseImages = {};
                if (databaseSnapshot.exists()) {
                    databaseImages = databaseSnapshot.val();
                }

                photoContainer.innerHTML = '';
                imageSelect.innerHTML = '<option value="" disabled selected>Select an image</option>';
                imageUrls = [];

                for (const item of storageSnapshot.items) {
                    const fileNameWithoutExtension = removeFileExtension(item.name);
                    let imageUrl;

                    if (!databaseImages[fileNameWithoutExtension]) {
                        imageUrl = await getDownloadURL(item);
                        await set(ref(database, `share/tasks/${taskId}/images/${fileNameWithoutExtension}`), imageUrl);
                    } else {
                        imageUrl = databaseImages[fileNameWithoutExtension];
                    }

                    imageUrls.push(imageUrl);

                    addImageToDropdown(fileNameWithoutExtension, imageUrl);
                }

                displayAllImages();

                if (imageUrls.length > 0) {
                    currentImageIndex = 0;
                }
            } catch (error) {
                console.error('Error loading task images:', error);
            }
        };

        const addImageToDropdown = (name, url) => {
            const option = document.createElement('option');
            option.value = url;
            option.textContent = name;
            imageSelect.appendChild(option);
        };

        imageSelect.addEventListener('change', (e) => {
            const selectedUrl = e.target.value;
            displaySelectedImage(selectedUrl);
        });

        saveTaskButton.addEventListener('click', saveTask);
        uploadButton.addEventListener('click', uploadImage);
        taskSelect.addEventListener('change', (e) => loadTaskForEditing(e.target.value));
        imageSelect.addEventListener('change', (e) => displaySelectedImage(e.target.value));
        deleteImageButton.addEventListener('click', deleteSelectedImage);

        window.addEventListener('DOMContentLoaded', loadTasks);
    </script>

</body>

</html>