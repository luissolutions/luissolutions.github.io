<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Information - Task Manager</title>
    <link rel="stylesheet" href="./assets/css/app-styles.css">
    <script type="module" src="./assets/js/login.js" defer></script>
</head>

<body>
    <header>
        <h1>Job Information - Task Manager</h1>
        <section id="login-section">
            <form id="login-form">
                <label for="username">Email:</label>
                <input type="email" id="username" required>
                <br>
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <br>
                <button type="submit">Login</button>
            </form>
            <button id="logout" style="display: none;">Logout</button>
        </section>
    </header>

    <main>
        <section>
            <h2>Job Info</h2>
            <label for="site-name-input">Site Name:</label>
            <input type="text" id="site-name-input">
            <br>
            <label for="project-name-input">Project:</label>
            <input type="text" id="project-name-input">

            <h3>Tasks</h3>
            <ul id="task-list"></ul>

            <h4>Add New Task</h4>
            <label for="task-date-input">Date:</label>
            <input type="datetime-local" id="task-date-input">
            <label for="task-notes-input">Notes:</label>
            <input type="text" id="task-notes-input">
            <button id="add-task-btn">Add Task</button>

            <h3>List 1</h3>
            <input type="text" id="search-list1" placeholder="Search List 1...">
            <div class="table">
                <table id="listitem1-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Model</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>IP Address</th>
                            <th>MAC Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="tbody"></tbody>
                </table>
            </div>
            <h4>Add New List 1 Item</h4>
            <label for="list1-id-input">ID:</label>
            <input type="text" id="list1-id-input">
            <label for="list1-model-input">Model:</label>
            <input type="text" id="list1-model-input">
            <label for="list1-type-input">Type:</label>
            <input type="text" id="list1-type-input">
            <label for="list1-location-input">Location:</label>
            <input type="text" id="list1-location-input">
            <label for="list1-status-input">Status:</label>
            <input type="text" id="list1-status-input">
            <label for="list1-ip-input">IP Address:</label>
            <input type="text" id="list1-ip-input">
            <label for="list1-mac-input">MAC Address:</label>
            <input type="text" id="list1-mac-input">
            <button id="add-listitem1-btn">Add List Item 1</button>

            <h3>List 2</h3>
            <input type="text" id="search-list2" placeholder="Search List 2...">
            <div class="table">
                <table id="listitem2-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Model</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>IP Address</th>
                            <th>MAC Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="tbody"></tbody>
                </table>
            </div>

            <h4>Add New List 2 Item</h4>
            <label for="list2-id-input">ID:</label>
            <input type="text" id="list2-id-input">
            <label for="list2-model-input">Model:</label>
            <input type="text" id="list2-model-input">
            <label for="list2-type-input">Type:</label>
            <input type="text" id="list2-type-input">
            <label for="list2-location-input">Location:</label>
            <input type="text" id="list2-location-input">
            <label for="list2-status-input">Status:</label>
            <input type="text" id="list2-status-input">
            <label for="list2-ip-input">IP Address:</label>
            <input type="text" id="list2-ip-input">
            <label for="list2-mac-input">MAC Address:</label>
            <input type="text" id="list2-mac-input">
            <button id="add-listitem2-btn">Add List Item 2</button>
        </section>
    </main>

    <script type="module">
        import { database, ref, onValue, update, set, get, remove, getStorage, uploadBytes, getDownloadURL } from './assets/js/firebase-init.js';

        const jobRef = ref(database, 'public/jobs/');

        function getElement(id) {
            return document.getElementById(id);
        }

        function filterTable(listNum) {
            const input = getElement(`search-list${listNum}`);
            const filter = input.value.toLowerCase();
            const table = getElement(`listitem${listNum}-table`);
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                const tds = tr[i].getElementsByTagName("td");
                let match = false;

                for (let j = 0; j < tds.length; j++) {
                    if (tds[j]) {
                        const inputField = tds[j].querySelector('input');
                        const txtValue = inputField ? inputField.value : (tds[j].textContent || tds[j].innerText);

                        if (txtValue.toLowerCase().indexOf(filter) > -1) {
                            match = true;
                            break;
                        }
                    }
                }

                tr[i].style.display = match ? "" : "none";
            }
        }

        onValue(jobRef, (snapshot) => {
            if (snapshot.exists()) {
                const jobData = snapshot.val();
                console.log("Job Data loaded:", jobData);
                displayJobInfo(jobData);
            } else {
                console.error("No data available at this location! Initializing data.");
                initializeJobInfo();
            }
        }, (error) => {
            console.error("Error fetching data:", error);
        });

        function initializeJobInfo() {
            const initialData = {
                siteName: "Enter Site Name",
                project: "Enter Project Name",
                tasks: [],
                list1: {},
                list2: {}
            };
            set(jobRef, initialData)
                .then(() => console.log("Job data initialized"))
                .catch((error) => console.error("Error initializing job data:", error));
        }

        function displayJobInfo(jobInfo) {
            getElement('site-name-input').value = jobInfo.siteName || '';
            getElement('project-name-input').value = jobInfo.project || '';

            getElement('site-name-input').addEventListener('change', (e) => {
                updateField('public/jobs/siteName', e.target.value);
            });
            getElement('project-name-input').addEventListener('change', (e) => {
                updateField('public/jobs/project', e.target.value);
            });

            const taskList = getElement('task-list');
            taskList.innerHTML = '';
            if (jobInfo.tasks) {
                Object.keys(jobInfo.tasks).forEach((key) => {
                    const task = jobInfo.tasks[key];
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <label>Date: <input type="datetime-local" value="${new Date(task.date).toISOString().substring(0, 16)}"></label><br>
                        <label>Notes: <input type="text" value="${task.notes}" data-id="${key}" data-field="notes"></label><br>
                    `;

                    const notesInput = li.querySelector('input[data-field="notes"]');
                    notesInput.addEventListener('change', () => {
                        updateTaskField(key, 'notes', notesInput.value);
                    });

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete Task';
                    deleteButton.addEventListener('click', () => deleteTask(key));
                    li.appendChild(deleteButton);

                    taskList.appendChild(li);
                });
            }

            populateListTable(jobInfo.list1, 1);
            populateListTable(jobInfo.list2, 2);
        }

        function populateListTable(listData, listNum) {
            const tableBody = getElement(`listitem${listNum}-table`).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            const sortedList = Object.keys(listData)
                .map(key => ({ id: key, ...listData[key] }))
                .sort((a, b) => a.id.localeCompare(b.id));

            sortedList.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${item.id}" data-id="${item.id}" data-list="${listNum}" data-field="id"></td>
                    <td><input type="text" value="${item.model || ''}" data-id="${item.id}" data-list="${listNum}" data-field="model"></td>
                    <td><input type="text" value="${item.type || ''}" data-id="${item.id}" data-list="${listNum}" data-field="type"></td>
                    <td><input type="text" value="${item.location || ''}" data-id="${item.id}" data-list="${listNum}" data-field="location"></td>
                    <td><input type="text" value="${item.status || ''}" data-id="${item.id}" data-list="${listNum}" data-field="status"></td>
                    <td><input type="text" value="${item.ipAddress || ''}" data-id="${item.id}" data-list="${listNum}" data-field="ipAddress"></td>
                    <td><input type="text" value="${item.macAddress || ''}" data-id="${item.id}" data-list="${listNum}" data-field="macAddress"></td>
                    <td>
                        <button class="delete-item-btn" data-list="${listNum}" data-id="${item.id}">Delete</button>
                        <button class="open-file-btn" data-list="${listNum}" data-id="${item.id}">Image</button>
                    </td>
                `;

                const inputs = row.getElementsByTagName('input');
                Array.from(inputs).forEach(input => {
                    input.addEventListener('change', (e) => {
                        const field = e.target.getAttribute('data-field');
                        const id = e.target.getAttribute('data-id');
                        const listNum = e.target.getAttribute('data-list');

                        if (field === 'id') {
                            const oldId = id;
                            const newId = e.target.value.trim();

                            updateListItemField(listNum, oldId, field, newId)
                                .then(() => {
                                    remove(ref(database, `public/jobs/list${listNum}/${oldId}`));
                                    const newItemData = {
                                        model: row.cells[1].querySelector('input').value,
                                        type: row.cells[2].querySelector('input').value,
                                        location: row.cells[3].querySelector('input').value,
                                        status: row.cells[4].querySelector('input').value,
                                        ipAddress: row.cells[5].querySelector('input').value,
                                        macAddress: row.cells[6].querySelector('input').value
                                    };
                                    set(ref(database, `public/jobs/list${listNum}/${newId}`), { id: newId, ...newItemData });
                                });
                        } else {
                            updateListItemField(listNum, id, field, e.target.value);
                        }
                    });
                });

                const deleteButton = row.querySelector('.delete-item-btn');
                deleteButton.addEventListener('click', () => {
                    deleteListItem(listNum, item.id);
                });

                const openFileButton = row.querySelector('.open-file-btn');
                openFileButton.addEventListener('click', () => {
                    const projectName = getElement('project-name-input').value.trim(); // Get the project name
                    const projectId = database.app.options.projectId; // Dynamically obtain the project ID from the Firebase config
                    const filePath = `share/images/${projectName}/${item.id}.jpg`; // Construct the path with .jpg extension
                    const fileUrl = `https://firebasestorage.googleapis.com/v0/b/${projectId}.appspot.com/o/${encodeURIComponent(filePath)}?alt=media`;
                    window.open(fileUrl, '_blank'); // Open the file in a new tab
                });
            });
        }

        function deleteListItem(listNum, itemId) {
            const path = `public/jobs/list${listNum}/${itemId}`;
            updateField(path, null)
                .then(() => {
                    console.log(`List item ${itemId} deleted successfully.`);
                    refreshJobInfo();
                })
                .catch((error) => {
                    console.error(`Error deleting list item ${itemId}:`, error);
                });
        }

        function refreshJobInfo() {
            onValue(jobRef, (snapshot) => {
                if (snapshot.exists()) {
                    const jobData = snapshot.val();
                    displayJobInfo(jobData);
                }
            });
        }

        function updateField(path, value) {
            const updates = {};
            updates[path] = value;
            return update(ref(database), updates)
                .then(() => console.log(`${path} updated successfully.`))
                .catch((error) => console.error(`Error updating ${path}:`, error));
        }

        function updateTaskField(taskId, field, value) {
            updateField(`public/jobs/tasks/${taskId}/${field}`, value);
        }

        function updateListItemField(listNum, itemId, field, value) {
            const path = `public/jobs/list${listNum}/${itemId}/${field}`;
            return updateField(path, value);
        }

        function deleteTask(taskId) {
            updateField(`public/jobs/tasks/${taskId}`, null);
        }

        function addTask() {
            const taskDate = getElement('task-date-input').value;
            const taskNotes = getElement('task-notes-input').value;

            if (taskDate && taskNotes) {
                const newTask = { date: taskDate, notes: taskNotes };
                set(ref(database, `public/jobs/tasks/${taskDate}`), newTask)
                    .catch((error) => console.error('Error adding task:', error));
            } else {
                alert('Please enter both date and notes for the task.');
            }
        }

        function addListItem(listNum) {
            const id = getElement(`list${listNum}-id-input`).value.trim();
            const newItem = {
                id,
                model: getElement(`list${listNum}-model-input`).value || undefined,
                type: getElement(`list${listNum}-type-input`).value || undefined,
                location: getElement(`list${listNum}-location-input`).value || undefined,
                status: getElement(`list${listNum}-status-input`).value || undefined,
                ipAddress: getElement(`list${listNum}-ip-input`).value || undefined,
                macAddress: getElement(`list${listNum}-mac-input`).value || undefined
            };

            if (id) {
                set(ref(database, `public/jobs/list${listNum}/${id}`), newItem)
                    .then(() => {
                        clearInputs(listNum);
                    })
                    .catch((error) => console.error('Error adding list item:', error));
            } else {
                alert('Please enter an ID for the new list item.');
            }
        }

        function clearInputs(listNum) {
            getElement(`list${listNum}-id-input`).value = '';
            getElement(`list${listNum}-model-input`).value = '';
            getElement(`list${listNum}-type-input`).value = '';
            getElement(`list${listNum}-location-input`).value = '';
            getElement(`list${listNum}-status-input`).value = '';
            getElement(`list${listNum}-ip-input`).value = '';
            getElement(`list${listNum}-mac-input`).value = '';
        }

        getElement('search-list1').addEventListener('keyup', () => filterTable(1));
        getElement('search-list2').addEventListener('keyup', () => filterTable(2));
        getElement('add-task-btn').addEventListener('click', addTask);
        getElement('add-listitem1-btn').addEventListener('click', () => addListItem(1));
        getElement('add-listitem2-btn').addEventListener('click', () => addListItem(2));
    </script>

</body>

</html>